<properties 
	pageTitle="Иерархическая модель ресурсов и концепции DocumentDB | Microsoft Azure" 
	description="Ознакомьтесь с иерархической моделью базы данных, коллекций, определяемых пользователем функций (UDF), документов, разрешений на управление ресурсами DocumentDB и т. д."
	keywords="иерархическая модель, documentdb, azure, Microsoft azure"	
	services="documentdb" 
	documentationCenter="" 
	authors="AndrewHoh" 
	manager="jhubbard" 
	editor="monicar"/>

<tags 
	ms.service="documentdb" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="09/15/2016" 
	ms.author="anhoh"/>

# Иерархическая модель ресурсов и понятия DocumentDB

Объекты базы данных, которыми управляет DocumentDB, называются **ресурсами**. Каждый ресурс однозначно идентифицируется своими логическим URI. Разработчики могут взаимодействовать с ресурсами, используя стандартные команды HTTP, заголовки запросов/ответов и коды состояний.

Прочитав данную статью, вы сможете ответить на следующие вопросы.

- Что такое модель ресурсов DocumentDB?
- Чем ресурсы, определяемые системой, отличаются от ресурсов, определяемых пользователем?
- Как получить доступ к ресурсу?
- Как работать с коллекциями?
- Как работать с хранимыми процедурами, триггерами и пользовательскими функциями?

## Иерархическая модель ресурсов
Как показано на следующей схеме, **иерархическая модель ресурсов** DocumentDB состоит из наборов ресурсов в учетной записи базы данных, каждый из которых имеет логический постоянный идентификатор URI. Набор ресурсов в этой статье называется **каналом**.

>[AZURE.NOTE] Кроме того, DocumentDB также предлагает весьма эффективный протокол TCP, который также является RESTful в своей коммуникационной модели, доступной с помощью [пакета SDK клиента .NET](https://msdn.microsoft.com/library/azure/dn781482.aspx).

![Иерархическая модель ресурсов DocumentDB][1] **Иерархическая модель ресурсов.**

Чтобы приступить к работе с ресурсами, необходимо [создать учетную запись базы данных DocumentDB](documentdb-create-account.md) с помощью подписки Azure. Учетная запись базы данных может состоять из набора **баз данных**, каждая из которых включает несколько **коллекций** с **хранимыми процедурами, триггерами, пользовательскими функциями, документами** и связанными **вложениями** (предварительная версия функции). С базой данных также связаны **пользователи**, каждый из которых обладает набором **разрешений** для доступа к коллекциям, хранимым процедурам, триггерам, пользовательским функциям, документам или вложениям. В то время как базы данных, пользователи, разрешения и коллекции являются определяемыми системой ресурсами с известными схемами, документы и вложения содержат произвольный, определяемый пользователем контент в формате JSON.

|Resource (Ресурс) |Описание
|-----------|-----------
|Учетная запись базы данных |Учетная запись базы данных связана с набором баз и определенным местом в хранилище больших двоичных объектов для хранения вложений (это предварительная версия функции). Вы можете создать одну или несколько учетных записей базы данных с помощью подписки Azure. Дополнительные сведения см. на нашей [странице цен](https://azure.microsoft.com/pricing/details/documentdb/).
|База данных |База данных представляет собой логический контейнер для хранения документов, разделенных между коллекциями. Она также является контейнером для пользователей.
|Пользователь |Логическое пространство имен для ограничений разрешений. 
|Разрешение |Маркер проверки подлинности, связанный с пользователем, предоставляет доступ к определенному ресурсу.
|Коллекция |Коллекция представляет собой контейнер документов JSON и связанной логики приложения на JavaScript. Коллекция представляет собой тарифицируемый объект, и его [стоимость](documentdb-performance-levels.md) определяется связанным с ним уровнем производительности. Коллекции могут охватывать один или несколько разделов либо серверов и масштабироваться до практически неограниченных объемов хранилища или пропускной способности.
|Хранимая процедура |Логика приложения, написанная на JavaScript, которая зарегистрирована в коллекции и выполняется в транзакции в ядре базы данных.
|Триггер |Логика приложения в виде кода JavaScript, автоматически исполняемого до или после операций вставки, замены и удаления.
|Определяемая пользователем функция |Логика приложения на языке JavaScript. Пользовательские функции позволяют моделировать операторы пользовательских запросов и тем самым расширить базовый язык запросов DocumentDB.
|Документ |Пользовательский (произвольный) контент JSON. По умолчанию, нет необходимости определения схемы или предоставления вторичных индексов для всех документов, добавляемых в коллекцию.
|Вложения (предварительная версия) |Вложение — это специальный документ, содержащий ссылки и связанные с ним метаданные ко внешним большим двоичным объектам и носителям. Разработчик может выбрать, управлять ли BLOB-объектами в DocumentDB или хранить их с помощью внешних поставщиков услуг хранения BLOB-объектов, таких как OneDrive, Dropbox и т. д. 


## Системные и пользовательские ресурсы
Ресурсы (такие как учетные записи баз данных, базы данных, коллекции, пользователи, разрешения, хранимые процедуры, триггеры и определяемые пользователем функции) имеют статическую схему и называются системными ресурсами. В отличие от таких ресурсов, как документы и вложения, не имеющих ограничений по схеме, которые являются примерами пользовательских ресурсов. В DocumentDB системные и пользовательские ресурсы представляются и управляются как стандартные, совместимые с JSON-объекты. Все ресурсы, системные и пользовательские, имеют перечисленные ниже общие свойства.

> [AZURE.NOTE] Обратите внимание, что все сгенерированные системой свойства в ресурсах начинаются с символа подчеркивания (\_) в представлении JSON.

<table>
    <tbody>
        <tr>
            <td valign="top"><p><strong>Свойство</strong></p></td>
            <td valign="top"><p><strong>Устанавливается пользователем или генерируется системой</strong></p></td>
            <td valign="top"><p><strong>Назначение</strong></p></td>
        </tr>
        <tr>
            <td valign="top"><p>_rid</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Генерируемый системой уникальный иерархический идентификатор ресурса</p></td>
        </tr>
        <tr>
            <td valign="top"><p>_etag</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>etag ресурса, необходимый для управления оптимистичным параллелизмом</p></td>
        </tr>
        <tr>
            <td valign="top"><p>_ts</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Метка времени последнего обновления ресурса</p></td>
        </tr>
        <tr>
            <td valign="top"><p>_self</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Уникальный адресуемый URI ресурса</p></td>
        </tr>
        <tr>
            <td valign="top"><p>id</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Определяемое пользователем уникальное имя ресурса (с тем же значением ключа секции). Если пользователь не укажет идентификатор, идентификатор будет создан системой.</p></td>
        </tr>
    </tbody>
</table>

### Сетевое представление ресурсов
DocumentDB не требует никаких собственных расширений помимо стандарта JSON или специальных кодировок; она работает со документами, совместимыми со стандартом JSON.
 
### Адресация ресурса
Все ресурсы можно адресовать по URI. Значение свойства **\_self** представляет относительный URI ресурса. Формат URI состоит из сегментов пути /<feed>/{\_rid}:

|Значение свойства \_self |Описание
|-------------------|-----------
|/dbs |Канал баз данных под учетной записью базы данных
|/dbs/{dbName} |Базы данных с идентификатором, соответствующим значению {dbName}
|/dbs/{dbName}/colls/ |Канал коллекций в базе данных
|/dbs/{dbName}/colls/{collName} |Коллекция с идентификатором, соответствующим значению {collName}
|/dbs/{dbName}/colls/{collName}/docs |Канал документов в коллекции
|/dbs/{dbName}/colls/{collName}/docs/{docId} |Документ с идентификатором, соответствующим значению {doc}
|/dbs/{dbName}/users/ |Канал пользователей в базе данных
|/dbs/{dbName}/users/{userId} |Пользователь с идентификатором, соответствующим значению {user}
|/dbs/{dbName}/users/{userId}/permissions |Канал разрешений для пользователя
|/dbs/{dbName}/users/{userId}/permissions/{permissionId} |Разрешение с идентификатором, соответствующим значению {permission}
  
Каждый ресурс имеет уникальное имя, которое определяется пользователем и используется в качестве идентификатора ресурса. Примечание. Если пользователь не укажет идентификатор документа, система автоматически создаст для этого документа уникальный идентификатор. Идентификатор является определяемой пользователем строкой длиной до 256 символов, которая уникальна в контексте конкретного родительского ресурса.

Каждый ресурс также имеет иерархический идентификатор ресурсов, генерируемый системой (также известный как RID), который доступен через свойство \_rid. RID кодирует всю иерархию данного ресурса, и это удобное внутреннее представление, которое используется для обеспечения ссылочной целостности распределенным способом. RID является уникальным в пределах учетной записи базы данных и используется службой DocumentDB для эффективной маршрутизации без перекрестного поиска по разделам. Значения свойств \_self и \_rid являются альтернативным и каноническим представлениями ресурса.

Интерфейсы REST API DocumentDB поддерживают адресацию ресурсов и маршрутизацию запросов по свойствам id и \_rid.

## Учетные записи базы данных
Вы можете подготовить одну или несколько учетных записей базы данных DocumentDB с помощью подписки Azure.

Вы можете [создавать учетные записи базы данных DocumentDB и управлять ими](documentdb-create-account.md) с помощью портала Azure на сайте [http://portal.azure.com/](https://portal.azure.com/). Создание и управление учетной записью базы данных требует наличия административного доступа и может быть выполнено только в рамках вашей подписки Azure.

### Свойства учетной записи базы данных
В рамках подготовки учетной записи базы данных и управления ею можно настроить следующие свойства и ознакомиться с ними:

<table border="0" cellspacing="0" cellpadding="0">
    <tbody>
        <tr>
            <td valign="top"><p><strong>Имя свойства</strong></p></td>
            <td valign="top"><p><strong>Описание</strong></p></td>
        </tr>
        <tr>
            <td valign="top"><p>Политика согласованности</p></td>
            <td valign="top"><p>Установите это свойство, чтобы настроить уровень согласованности по умолчанию для всех коллекций под вашей учетной записью базы данных. Вы можете переопределить уровень согласованности для каждого запроса, используя заголовок запроса x-ms-consistency-level. <p><p>Обратите внимание, что это свойство применяется только к <i>пользовательским ресурсам</i>. Все определяемые системой ресурсы настроены для поддержки чтения и запросов с сильной согласованностью.</p></td>
        </tr>
        <tr>
            <td valign="top"><p>Ключи авторизации</p></td>
            <td valign="top"><p>Существуют первичный и вторичный главные ключи, доступные только для чтения, которые обеспечивают административный доступ ко всем ресурсам учетной записи базы данных.</p></td>
        </tr>
    </tbody>
</table>

Обратите внимание, что наряду с подготовкой, настройкой учетной записи базы данных и управлением ею на портале Azure вы также можете программно создавать учетные записи базы данных DocumentDB и управлять ими через [интерфейсы REST API Azure DocumentDB](https://msdn.microsoft.com/library/azure/dn781481.aspx) или [клиентские пакеты SDK](https://msdn.microsoft.com/library/azure/dn781482.aspx).

## Базы данных
База данных DocumentDB является логическим контейнером из одного или нескольких коллекций и пользователей, как показано на следующей схеме. Вы можете создать любое количество баз данных под учетной записью базы данных DocumentDB с учетом предложенных ограничений.

![Учетная запись базы данных и иерархическая модель коллекций][2] **База данных представляет собой логический контейнер пользователей и коллекций**

База данных может содержать практически неограниченный объем для хранения документов, разделенный на коллекции, которые формируют домены транзакций для документов, содержащихся в них.

### Гибкое масштабирование базы данных DocumentDB
База данных DocumentDB по умолчанию обладает гибкостью, ее размер может меняться от нескольких гигабайт до потенциально петабайт хранилищ документов на базе SSD и подготовленной пропускной способности.

В отличие от традиционных реляционных СУБД базы данных в DocumentDB не ограничены одним узлом. DocumentDB позволяет создавать больше коллекций и баз данных по мере увеличения масштаба вашего приложения. Действительно, различные собственные приложения корпорации Майкрософт уже используют DocumentDB в потребительском масштабе путем создания чрезвычайно больших баз данных DocumentDB, каждая из которых содержит тысячи коллекций с терабайтами хранимых документов. Вы можете увеличить или уменьшить базу данных, добавляя или удаляя коллекции для удовлетворения требований масштабности вашего приложения.

Вы можете создать любое количество коллекций в пределах субъекта базы данных в рамках своего предложения. Для каждой коллекции выделяется хранилище на базе SSD-накопителей и пропускная способность с учетом выбранного уровня производительности.

База данных DocumentDB также является контейнером для пользователей. Пользователь, в свою очередь, является логическим пространством имен для набора разрешений, что обеспечивает детальный уровень авторизации и доступа к коллекции, документам и вложениям.
 
Как и другие ресурсы в модели DocumentDB, базы данных могут быть созданы, заменены, удалены, прочитаны или перечислены с помощью [интерфейса API REST Azure DocumentDB](https://msdn.microsoft.com/library/azure/dn781481.aspx) либо любого [клиентского пакета SDK](https://msdn.microsoft.com/library/azure/dn781482.aspx). DocumentDB гарантирует строгую согласованность для чтения или запроса метаданных ресурса базы данных. Удаление базы данных автоматически означает, что вы больше не сможете получить доступ к любой из коллекций или пользователям, содержащимся в ней.

## Коллекции
Коллекция DocumentDB — контейнер для документов JSON. Коллекция также является единицей масштабирования для транзакций и запросов.

### Гибкое хранилище документов на базе SSD
Коллекция является неразрывно гибкой, она автоматически увеличивается и уменьшается по мере добавления или удаления документов. Коллекции — это логические ресурсы, они могут включать в себя одну или несколько физических секций или серверов. Число секций в коллекции определяется DocumentDB по размеру хранилища и пропускной способности, выделенных для коллекции. С каждой секцией в DocumentDB связано фиксированное хранилище на основе SSD, которое реплицируются для обеспечения высокого уровня доступности. Управление секциями полностью осуществляется Azure DocumentDB, и нет необходимости создавать сложный код или управлять секциями. Коллекции DocumentDB **практически не ограничены** в объеме хранилища и пропускной способности.

### Автоматическое индексирование коллекций
DocumentDB — система баз данных без схемы. Она не подразумевает и не требует указания каких-либо схем для документов JSON. По мере добавления документов в коллекции DocumentDB автоматически индексирует их, и они становятся доступны для выполнения запросов. Автоматическая индексация документов, не требующая указания схемы или вторичных индексов, является ключевой возможностью DocumentDB и доступна благодаря оптимизации записи, безблокировочной и оптимизированной журнально-структурированной технологии обслуживания индексов. DocumentDB поддерживает устойчивый объем чрезвычайно быстрых операций записи и в то же время обслуживает согласованные запросы. Хранилище и документов и индекса используется для расчета объема хранения, потребляемого каждой коллекцией. Вы можете управлять компромиссом между объемом хранения и производительностью, связанным с индексацией по настройке политики индексирования для коллекции.

### Настройка политики индексирования коллекции
Политика индексирования каждой коллекции позволяет настраивать соотношения производительности и объема, связанные с индексацией. Для конфигурации индексирования доступны следующие параметры:

-	Выберите, будет ли коллекция автоматически индексировать все документы или нет. По умолчанию все документы индексируются автоматически. Можно отключать автоматическое индексирование и добавлять только выбранные документы в индекс. И наоборот, вы можете выборочно указать, какие документы необходимо исключить из индексирования. Вы можете добиться этого путем установки автоматического логического свойства indexingPolicyколлекции и с помощью заголовка запроса [x-ms-indexingdirective] при вставке, замене или удалении документа.
-	Укажите, следует ли включить или исключить определенные пути или шаблоны в документах из индекса. Вы можете добиться этого путем установки includedPaths и excludedPaths на indexingPolicy коллекции соответственно. Вы также можете настроить соотношения объема и производительности для интервала и хэш-запросов для конкретных шаблонов пути.
-	Выбор между синхронными обновлениями (согласованные) и асинхронными обновлениями (отложенные) индекса. По умолчанию, индекс обновляется синхронно при каждой операции вставки, заменить или удаления документа в коллекции. Это позволяет выполнять запросы с уровнем согласованности, как и в документе. В то время как DocumentDB оптимизирован для операций записи и поддерживает устойчивые объемы записей документов вместе с синхронным обслуживанием индекса и обслуживанием согласованных запросов, вы можете настроить определенные коллекции для отложенного обновления своих ​​индексов. Отложенное индексирование еще больше повышает производительность операций записи и идеально подходит для сценариев пакетной вставки, прежде всего для чтения больших коллекций.

Вы можете изменить политику индексирования, выполнив запрос PUT для коллекции. Это можно сделать с помощью [клиентского пакета SDK](https://msdn.microsoft.com/library/azure/dn781482.aspx), [портала Azure](https://portal.azure.com) или [интерфейсов API REST Azure DocumentDB](https://msdn.microsoft.com/library/azure/dn781481.aspx).

### Запросы к коллекции
Документы в коллекции могут иметь произвольные схемы, и вы можете запрашивать их без предварительного предоставления любой схемы или вторичных индексов. Вы можете создавать запросы к коллекции, используя [синтаксис SQL DocumentDB](https://msdn.microsoft.com/library/azure/dn782250.aspx). Он предоставляет богатый выбор иерархических, реляционных и пространственных операторов и расширяемость с использованием определяемых пользователем функций на основе JavaScript. Грамматика JSON позволяет моделировать документы JSON в форме деревьев с метками в качестве узлов. Этот подход используется для автоматического индексирования DocumentDB, а также лежит в основе диалекта SQL DocumentDB. Язык запросов DocumentDB построен на следующих трех основных принципах.

1.	Небольшой набор операций запросов, которые естественным образом отображаются в древовидной структуре в том числе иерархических запросов и проекций.
2.	Подмножество реляционных операций, включая композиции, фильтры, проекции, агрегатов и внутренние соединения.
3.	Пользовательские функции на основе чистого JavaScript, которые работают с (1) и (2)

Модель запросов DocumentDB пытается установить баланс между функциональностью, эффективностью и простотой. Ядро базы данных DocumentDB непосредственно компилирует и выполняет операторы SQL-запросов. Вы можете сформировать запрос к коллекции с помощью интерфейса [API REST Azure DocumentDB](https://msdn.microsoft.com/library/azure/dn781481.aspx) или любого из [клиентских пакетов SDK](https://msdn.microsoft.com/library/azure/dn781482.aspx). В комплект пакета .NET SDK входит поставщик LINQ.

> [AZURE.TIP] Вы можете испытать DocumentDB в действии и проверить запросы SQL к нашему образцу данных в среде [Query Playground](https://www.documentdb.com/sql/demo).

### Операции над несколькими документами
Транзакции в базах данных обеспечивают безопасную и предсказуемую модель программирования для работы с одновременными изменениями данных. В РСУБД традиционный способ написать бизнес-логику заключается в том, чтобы написать **хранимые процедуры** и/или **триггеры** и загрузить их на сервер базы данных для выполнения в транзакциях. В РСУБД, прикладному программисту приходится иметь дело с двумя разнородными языками программирования:

- Нетранзакционный язык прикладного программирования (JavaScript, Python, C#, Java и др.).
- Транзакционный язык T-SQL, который является "родным" для базы данных.

В силу своей глубокой приверженности JavaScript и JSON непосредственно внутри базы данных, DocumentDB обеспечивает интуитивную модель программирования для выполнения логики приложения на основе JavaScript непосредственно в коллекциях в виде хранимых процедур и триггеров. Это позволяет получить

- с одной стороны, эффективные механизмы восстановления, управления параллелизмом и автоматической индексации графов объектов JSON прямо в ядре СУБД;
- с другой стороны, естественное выражение потока управления, области видимости переменных, присвоения, а также интеграцию примитивов обработки исключений с транзакциями базы данных непосредственно на JavaScript.

Логика JavaScript, регистрируемая на уровне коллекции, может выполнять операции с базами данных на документах данной коллекции. DocumentDB неявно обертывает хранимые процедуры и триггеры на основе JavaScript с соблюдением ACID и изоляцией моментальных снимков документов в коллекции. В ходе его исполнения, если код JavaScript генерирует исключение, то вся транзакция прерывается. Полученная модель программирования является очень простой, но мощной. Разработчики JavaScript получают "надежную" модель программирования, при этом используя привычные языковые конструкции и библиотечные примитивы.

Возможность выполнить JavaScript непосредственно в ядре базы данных в том же адресном пространстве, что буферный пул, позволяет производительное и транзакционное выполнение операций с базами данных над документами коллекции. Кроме того, ядро СУБД DocumentDB оптимизировано для JSON и JavaScript, что устраняет несоответствия, возникающие при одновременном использовании объектной модели и реляционной базы данных.

После создания коллекции можно зарегистрировать хранимые процедуры, триггеры и определяемые пользователем функции с помощью [API REST DocumentDB Azure](https://msdn.microsoft.com/library/azure/dn781481.aspx) или любого [клиентского пакета SDK](https://msdn.microsoft.com/library/azure/dn781482.aspx). После регистрации вы можете использовать и выполнять их. Рассмотрим приведенный ниже код хранимой процедуры, написанный полностью на JavaScript. Процедура принимает два аргумента (имя книги и имя автора), создает новый документ, выполняет запрос документа и обновляет его. Все эти действия выполняются в ходе неявной транзакции ACID. Транзакция будет прервана в любой момент выполнения, если будет выдано исключение JavaScript.

	function businessLogic(name, author) {
	    var context = getContext();
	    var collectionManager = context.getCollection();        
	    var collectionLink = collectionManager.getSelfLink()
	        
	    // create a new document.
	    collectionManager.createDocument(collectionLink,
	        {id: name, author: author},
	        function(err, documentCreated) {
	            if(err) throw new Error(err.message);
	            
	            // filter documents by author
	            var filterQuery = "SELECT * from root r WHERE r.author = 'George R.'";
	            collectionManager.queryDocuments(collectionLink,
	                filterQuery,
	                function(err, matchingDocuments) {
	                    if(err) throw new Error(err.message);
	                    
	                    context.getResponse().setBody(matchingDocuments.length);
	                   
	                    // Replace the author name for all documents that satisfied the query.
	                    for (var i = 0; i < matchingDocuments.length; i++) {
	                        matchingDocuments[i].author = "George R. R. Martin";
	                        // we don’t need to execute a callback because they are in parallel
	                        collectionManager.replaceDocument(matchingDocuments[i]._self,
	                            matchingDocuments[i]);   
	                    }
	                })
	        })
	};

Клиент может "грузить" вышеуказанную JavaScript логику в базу данных для транзакционного исполнения через HTTP POST. Дополнительные сведения об использовании методов HTTP см. в разделе [Взаимодействия RESTful с ресурсами DocumentDB](https://msdn.microsoft.com/library/azure/mt622086.aspx).

	client.createStoredProcedureAsync(collection._self, {id: "CRUDProc", body: businessLogic})
	   .then(function(createdStoredProcedure) {
	        return client.executeStoredProcedureAsync(createdStoredProcedure.resource._self,
	            "NoSQL Distilled",
	            "Martin Fowler");
	    })
	    .then(function(result) {
	        console.log(result);
	    },
	    function(error) {
	        console.log(error);
	    });


Обратите внимание, что, поскольку база данных изначально понимает JSON и JavaScript, нет проблемы несоответствия типов, нет "отображения ИЛИ" или генерации "магического" кода.

Хранимые процедуры и триггеры взаимодействуют с коллекцией и документами в коллекции через четко определенную объектную модель, которая отражает текущий контекст коллекции.

Коллекции в DocumentDB можно создавать, удалять, читать и перечислять с помощью [интерфейса API REST Azure DocumentDB](https://msdn.microsoft.com/library/azure/dn781481.aspx) или любого [клиентского пакета SDK](https://msdn.microsoft.com/library/azure/dn781482.aspx). DocumentDB всегда обеспечивает сильную согласованность для чтения или запроса метаданных коллекции. Удаление коллекции автоматически гарантирует, что вы не сможете получить доступ к любому из документов, вложений, хранимых процедур, триггеров и пользовательских функций, содержащихся в ней.

## Хранимые процедуры, триггеры и определяемые пользователями функции (UDF)
Как описано в предыдущем разделе, вы можете реализовать логику приложения для непосредственного исполнения в рамках транзакции ядра СУБД. Логика приложения может быть полностью написана на JavaScript и смоделирована в виде хранимой процедуры, триггера или определяемой пользователем функции. Код JavaScript в хранимой процедуре или триггере может вставлять, заменять, удалять, читать или формировать запросы к документам коллекции. С другой стороны, код JavaScript в определяемой пользователем функции не может добавлять, заменять или удалять документы. Определяемые пользователем функции перечисляют документы из результата запроса и создают новый набор результатов. Для мультитенантности DocumentDB реализует управление ресурсами на основе строгого резервирования. Для каждой хранимой процедуры, триггера или пользовательской функции выделяется фиксированный квант ресурсов операционной системы, чтобы выполнить свою задачу. Кроме того, хранимые процедуры, триггеры и пользовательские функции не могут подключать внешние библиотеки JavaScript и попадают в черный список, если превышают установленные для них пределы ресурсов. Вы можете зарегистрировать или отменить регистрацию хранимых процедур, триггеров или пользовательских функций в коллекции через API REST. После регистрации хранимая процедура, триггер или пользовательская функция предварительно компилируются и хранятся в виде байт-кода, который позже запускается на выполнение. В следующем разделе показано, как можно использовать пакет SDK JavaScript DocumentDB для регистрации, выполнения, отмены регистрации хранимой процедуры, триггера и определяемой пользователем функции. Пакет SDK JavaScript является простой оболочкой [API REST DocumentDB](https://msdn.microsoft.com/library/azure/dn781481.aspx).

### Регистрация хранимой процедуры
Регистрация хранимой процедуры — это создание нового ресурса хранимой процедуры ресурса в коллекции с помощью HTTP POST.

	var storedProc = {
	    id: "validateAndCreate",
	    body: function (documentToCreate) {
	        documentToCreate.id = documentToCreate.id.toUpperCase();
	        
	        var collectionManager = getContext().getCollection();
	        collectionManager.createDocument(collectionManager.getSelfLink(),
	            documentToCreate,
	            function(err, documentCreated) {
	                if(err) throw new Error('Error while creating document: ' + err.message;
	                getContext().getResponse().setBody('success - created ' + 
	                        documentCreated.name);
	            });
	    }
	};
	
	client.createStoredProcedureAsync(collection._self, storedProc)
	    .then(function (createdStoredProcedure) {
	        console.log("Successfully created stored procedure");
	    }, function(error) {
	        console.log("Error");
	    });

### Выполнение хранимой процедуры
Выполнение хранимой процедуры осуществляется с помощью команды HTTP POST, запускаемой для существующего ресурса хранимой процедуры, с передачей параметров в теле запроса.

	var inputDocument = {id : "document1", author: "G. G. Marquez"};
	client.executeStoredProcedureAsync(createdStoredProcedure.resource._self, inputDocument)
	    .then(function(executionResult) {
	        assert.equal(executionResult, "success - created DOCUMENT1");
	    }, function(error) {
	        console.log("Error");
	    });

### Отмена регистрации хранимой процедуры
Отменить регистрацию хранимой процедуры можно с помощью команды HTTP DELETE, выполняемой для существующего ресурса хранимой процедуры.

	client.deleteStoredProcedureAsync(createdStoredProcedure.resource._self)
	    .then(function (response) {
	        return;
	    }, function(error) {
	        console.log("Error");
	    });


### Регистрация триггера со срабатыванием до наступления события
Регистрация триггера осуществляется путем создания ресурса триггера в коллекции с помощью команды HTTP POST. Вы можете указать тип срабатывания триггера и тип операции, с которой он может быть связан (например, создание, замена, удаление или все типы).

	var preTrigger = {
	    id: "upperCaseId",
	    body: function() {
	            var item = getContext().getRequest().getBody();
	            item.id = item.id.toUpperCase();
	            getContext().getRequest().setBody(item);
	    },
	    triggerType: TriggerType.Pre,
	    triggerOperation: TriggerOperation.All
	}
	
	client.createTriggerAsync(collection._self, preTrigger)
	    .then(function (createdPreTrigger) {
	        console.log("Successfully created trigger");
	    }, function(error) {
	        console.log("Error");
	    });

### Запуск триггера со срабатыванием до наступления события
Выполнение триггера производится путем указания в заголовке запроса имени существующего триггера в момент выдачи запроса POST/PUT/DELETE к ресурсу документа.
 
	client.createDocumentAsync(collection._self, { id: "doc1", key: "Love in the Time of Cholera" }, { preTriggerInclude: "upperCaseId" })
	    .then(function(createdDocument) {
	        assert.equal(createdDocument.resource.id, "DOC1");
	    }, function(error) {
	        console.log("Error");
	    });

### Отмена регистрации триггера со срабатыванием до наступления события
Отменить регистрацию триггера можно с помощью команды HTTP DELETE, выполняемой для существующего ресурса триггера.

	client.deleteTriggerAsync(createdPreTrigger._self);
	    .then(function(response) {
	        return;
	    }, function(error) {
	        console.log("Error");
	    });

### Регистрация определяемой пользователем функции
Регистрация определяемой пользователем функции осуществляется путем создания нового ресурса UDF в коллекции или через команду HTTP POST.

	var udf = { 
	    id: "mathSqrt",
	    body: function(number) {
	            return Math.sqrt(number);
	    },
	};
	client.createUserDefinedFunctionAsync(collection._self, udf)
	    .then(function (createdUdf) {
	        console.log("Successfully created stored procedure");
	    }, function(error) {
	        console.log("Error");
	    });

### Выполнение определяемой пользователем функции как части запроса
Пользовательские функции (UDF) указываются в SQL-запросах и позволяют расширить [язык запросов SQL DocumentDB](https://msdn.microsoft.com/library/azure/dn782250.aspx).

	var filterQuery = "SELECT udf.mathSqrt(r.Age) AS sqrtAge FROM root r WHERE r.FirstName='John'";
	client.queryDocuments(collection._self, filterQuery).toArrayAsync();
	    .then(function(queryResponse) {
	        var queryResponseDocuments = queryResponse.feed;
	    }, function(error) {
	        console.log("Error");
	    });

### Отмена регистрации определяемой пользователем функции 
Отменить регистрацию определяемой пользователем функции можно с помощью команды HTTP DELETE, выполняемой для существующего ресурса UDF.

	client.deleteUserDefinedFunctionAsync(createdUdf._self)
	    .then(function(response) {
	        return;
	    }, function(error) {
	        console.log("Error");
	    });

Хотя в примерах выше используются команды для регистрации (POST), отмены регистрации (PUT), чтения и получения списка (GET), а также выполнения (POST) с помощью пакета [JavaScript SDK для DocumentDB](https://github.com/Azure/azure-documentdb-js), также можно использовать интерфейсы [API REST](https://msdn.microsoft.com/library/azure/dn781481.aspx) или другие [клиентские пакеты SDK](https://msdn.microsoft.com/library/azure/dn781482.aspx).

## Документы
Вы можете вставлять, заменять, удалять, читать, перечислять и запрашивать произвольные документы JSON в коллекции. DocumentDB не требует указывать схему и не требует создавать вторичные индексы для поддержки запросов к документам в коллекции.

Будучи по-настоящему открытой службой базы данных, DocumentDB не изобретает какие-то специализированные типы данных (например, date time) или конкретные кодировки для документов JSON. Обратите внимание, что DocumentDB не требует никаких специальных соглашений JSON для обозначения связей между различными документами. Реализованный в DocumentDB синтаксис SQL предоставляет мощные иерархические и реляционные операторы для создания запросов и проекций документов. При этом вам не требуется использовать специальные примечания или выражать взаимосвязи между документами с помощью отличительных свойств.
 
Как и для всех других ресурсов, документы могут быть созданы, заменены, удалены, прочитаны, перечислены и запрошены с использованием API REST или любого [клиентского пакета SDK](https://msdn.microsoft.com/library/azure/dn781482.aspx). Удаление документа мгновенно освобождает квоту, соответствующую всем его вложениям. Уровень согласованности для чтения документов соответствует политике согласованности для учетной записи базы данных. Эта политика может быть переопределена для каждого запроса в зависимости от требований к согласованности данных для вашего приложения. При запросе документов согласованность чтения соответствует режиму индексирования, который задан в коллекции. Понятие "согласованность" следует политике согласованности для учетной записи базы данных.

## Вложения и мультимедиа
>[AZURE.NOTE] Ресурсы вложений и мультимедиа реализованы в режиме предварительной версии.
 
DocumentDB позволяет хранить двоичные BLOB-объекты/медиафайлы либо непосредственно в DocumentDB, либо в удаленном хранилище файлов. Она также позволяет представлять метаданные медиафайлов в виде особого документа под названием "вложение". Вложение в DocumentDB — это специальный (JSON) документ, который ссылается на медиафайлы/BLOB-объекты, хранящиеся в другом месте. Вложение представляет собой специальный документ, который фиксирует метаданные (например, расположение, автора и т. д.) медиафайлов, хранящихся в удаленном хранилище.

Рассмотрим социальное приложения для чтения, которое использует DocumentDB для хранения заметок и метаданных, включая комментарии, выделения, закладки, рейтинги, пометки "нравится/не нравится" и т. д., связанных с электронной книгой данного пользователя.

-	Содержание самой книги хранится в хранилище, доступном в виде части учетной записи базы данных DocumentDB или удаленного хранилища.
-	Приложение может хранить метаданные каждого пользователя в виде отдельного документа. Например, метаданные пользователя Джо для книги Book1 можно хранить в документе, имеющем ссылку /colls/joe/docs/book1.
-	Вложения, указывающие на страницы содержимого данной книги пользователя, хранятся в соответствующем документе, например, /colls/joe/docs/book1/chapter1, /colls/joe/docs/book1/chapter2 и т. д.

Обратите внимание, что в приведенных выше примерах используются мнемонические идентификаторы для передачи иерархии ресурсов. Ресурсы доступны через API REST с помощью уникальных идентификаторов ресурсов.

Для медиафайлов, которые управляется DocumentDB, свойство вложения \_media будет содержать ссылку на URI медиафайла. DocumentDB запустит уборку мусора, когда все находящиеся в коллекции ссылки на медиафайл будут удалены. DocumentDB автоматически генерирует вложение, когда вы загружаете новые медиафайлы, и заполняет \_media ссылками на вновь добавленные файлы. Если вы решите хранить медиафайлы в удаленном хранилище больших двоичных объектов, управляемом вами (например OneDrive, хранилище Azure, DropBox и т. д.), вы можете использовать вложения для хранения ссылок. В этом случае вам придется создавать вложение и заполнять его свойство \_media самостоятельно.

Как и все прочие ресурсы, вложения могут быть созданы, заменены, удалены, прочитаны или перечислены с помощью API REST либо любого клиентского пакета SDK. Как и для документов, уровень согласованности для чтения вложений соответствует политике согласованности для учетной записи базы данных. Эта политика может быть переопределена для каждого запроса в зависимости от требований к согласованности данных для вашего приложения. При запросе вложений согласованность чтения соответствует режиму индексирования, который задан в коллекции. Понятие "согласованность" следует политике согласованности для учетной записи базы данных.  
## Пользователи
Пользователь в DocumentDB представляет собой логическое пространство имен для группировки разрешений. Пользователю в DocumentDB может соответствовать пользователь в системе управления удостоверениями или предопределенной роли приложения. В рамках DocumentDB пользователь представляет собой абстракцию для группировки набора разрешений под базой данных.

Чтобы реализовать для приложения многопользовательскую среду, вы можете создавать пользователей в DocumentDB, которые будут соответствовать фактическим пользователям или клиентам вашего приложения. Затем можно создать разрешения для данного пользователя, которые соответствуют уровням доступа к различным коллекциям, документам, приложениям и т. д.

По мере расширения вашего приложения с ростом количества пользователей вы можете использовать различные способы для сегментирования данных. Вы можете смоделировать каждого из пользователей следующим образом:

-	каждый пользователь сопоставлен базе данных;
-	каждый пользователь сопоставлен коллекции; 
-	документы, соответствующие нескольким пользователям, отправляются в выделенную коллекцию; 
-	документы, соответствующие нескольким пользователям, отправляются в набор коллекций.   

Независимо от конкретной стратегии сегментирования, вы можете моделировать реальных пользователей в качестве пользователей в базе данных DocumentDB и присваивать точные разрешения каждому пользователю.

![Коллекции пользователей][3]
**Стратегии сегментирования и моделирования пользователей**

Как и все прочие ресурсы, пользователи в DocumentDB могут быть созданы, заменены, удалены, прочитаны или перечислены с помощью API REST либо любого клиентского пакета SDK. DocumentDB всегда обеспечивает сильную согласованность для чтения или запроса метаданных ресурса пользователя. Стоит отметить, что при удалении пользователя гарантируется, что вы не сможете получить доступ к любому из разрешений, входящих в его состав. Удаленные разрешения станут доступны сразу же для повторного использования, несмотря на то что DocumentDB восстанавливает квоту разрешений удаленного пользователя в фоновом режиме.

## Разрешения
В контексте контроля доступа такие ресурсы, как учетные записи баз данных, базы данных, пользователи и разрешения, считаются *административными* ресурсами, так как для обращения к ним требуются права администратора. С другой стороны, ресурсы, включая коллекции, документы, вложения, хранимые процедуры, триггеры и пользовательские функции, находятся в области видимости данной базы данных и рассматриваются как *ресурсы приложения*. В соответствии с двумя типами ресурсов и ролями, которые обращаются к ним (администратора и пользователей), модель авторизации определяет два типа *ключей доступа*: *мастер-ключ* и *ключ ресурса*. Мастер-ключ является частью учетной записи базы данных и предоставляется разработчику (или администратору), который подготавливает учетную запись базы данных. Этот мастер-ключ имеет семантику администратора, в том смысле, что он может быть использован для того, чтобы разрешить доступ как к административным, так и к прикладным ресурсам. В отличие от этого, ключ ресурса является разделенным ключом доступа, который позволяет получить доступ к *определенному* ресурсу приложения. Таким образом, он охватывает отношения между пользователем базы данных и разрешениями пользователя, которые он имеет для определенного ресурса (например, коллекции, документа, вложения, хранимой процедуры, триггера или пользовательской функции).

Единственным способом получить ключ ресурса является создание разрешения для ресурса под конкретного пользователя. Обратите внимание, что в для создания или получения разрешения, мастер-ключ должен быть представлен в заголовке авторизации. Разрешение ресурса связывает ресурс, доступ к нему и пользователя. После создания разрешения ресурса пользователю нужно только предоставить ключ, связанный с ресурсами, для того чтобы получить доступ к соответствующему ресурсу. Таким образом, ключ ресурса можно рассматривать как логическое и компактное представление разрешения ресурса.

Как и все прочие ресурсы, разрешения могут быть созданы, заменены, удалены, прочитаны или перечислены с помощью API REST либо любого клиентского пакета SDK. DocumentDB всегда обеспечивает сильную согласованность для чтения или запроса метаданных какого-либо разрешения.

## Дальнейшие действия
Дополнительные сведения о работе с ресурсами с помощью команд HTTP см. в разделе [RESTful-взаимодействия с ресурсами DocumentDB](https://msdn.microsoft.com/library/azure/mt622086.aspx).


[1]: media/documentdb-resources/resources1.png
[2]: media/documentdb-resources/resources2.png
[3]: media/documentdb-resources/resources3.png

<!---HONumber=AcomDC_0921_2016-->