<properties 
	pageTitle="Советы по улучшению производительности DocumentDB | Microsoft Azure" 
	description="Узнайте, как улучшить производительность базы данных Azure DocumentDB с помощью параметров конфигурации клиента"
	keywords="как улучшить производительность базы данных"
	services="documentdb" 
	authors="mimig1" 
	manager="jhubbard" 
	editor="" 
	documentationCenter=""/>

<tags 
	ms.service="documentdb" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="09/19/2016" 
	ms.author="mimig"/>

# Советы по улучшению производительности DocumentDB

Azure DocumentDB — быстрая и гибкая распределенная база данных, которая легко масштабируется с гарантированной задержкой и пропускной способностью. Для масштабирования базы данных с помощью DocumentDB не нужно вносить существенных изменений в архитектуру или писать сложный код. Для увеличения или уменьшения масштаба достаточно вызвать один метод интерфейса API или [пакета SDK](documentdb-performance-levels.md#changing-performance-levels-using-the-net-sdk). Но так как для доступа к DocumentDB выполняются сетевые вызовы, чтобы обеспечить максимальную производительность, можно выполнить некоторые оптимизации на стороне клиента.

Чтобы оптимизировать производительность базы данных, рассмотрите следующие варианты.

## Сеть
<a id="direct-connection"></a>

1. **Политика подключения: использование режима прямого подключения**
    
    Режим подключения к Azure DocumentDB оказывает серьезное влияние на производительность, в частности на задержку на стороне клиента. Для настройки политики подключения для клиента используются два основных параметра конфигурации — *режим* и *протокол* [подключения](#connection-protocol). DocumentDB предоставляет два режима подключения:

    1. режим шлюза (по умолчанию);
    2. режим прямого подключения.

    Так как DocumentDB — это распределенная система, ресурсы (например, коллекции) в ней разбиваются по многочисленным серверам, а каждый раздел реплицируется для обеспечения высокой доступности. Соответствие логического и физического адресов хранится в таблице маршрутизации, которая также внутренне доступна в качестве ресурса.

    В режиме шлюза маршрутизация выполняется на компьютерах со шлюзом DocumentDB, поэтому код клиента простой и компактный. Клиентское приложение отправляет запросы компьютерам со шлюзом DocumentDB, которые преобразовывают логический URI в запросе на физический адрес узла сервера и перенаправляют запрос на соответствующий сервер. И наоборот, при прямом подключении к узлам сервера DocumentDB необходимо сохранить в клиенте копию таблицы маршрутизации и периодически ее обновлять.

    Режим шлюза по умолчанию используется на всех платформах SDK. Так как в режиме шлюза используется стандартный порт HTTPS и одна конечная точка, его рекомендуется использовать для приложений, запущенных в корпоративных сетях со строгими ограничениями брандмауэра. Недостаток режима шлюза в плане производительности заключается в том, что каждый раз во время выполнения операции чтения или записи данных в DocumentDB добавляется дополнительный прыжок сети. Поэтому для обеспечения более высокой производительности рекомендуется использовать режим прямого подключения.

2. **Политика подключения: использование протокола TCP**

    При использовании режима прямого подключения доступно два варианта протоколов:

    - TCP
    - HTTPS

    DocumentDB предлагает простую и открытую модель программирования RESTful поверх HTTPS. Кроме того, предлагается эффективный протокол TCP, который также является RESTful в своей коммуникационной модели и доступен через клиентский пакет SDK для .NET. Чтобы добиться лучшей производительности, рекомендуется по возможности использовать протокол TCP.

    Режим подключения настраивается с помощью параметра ConnectionPolicy во время создания экземпляра DocumentClient. При использовании режима прямого подключения протокол также можно определить в параметре ConnectionPolicy.

        var serviceEndpoint = new Uri("https://contoso.documents.net");
        var authKey = new "your authKey from Azure Mngt Portal";
        DocumentClient client = new DocumentClient(serviceEndpoint, authKey, 
        new ConnectionPolicy
        {
            ConnectionMode = ConnectionMode.Direct,
            ConnectionProtocol = Protocol.Tcp
        });

    Протокол TCP поддерживается только в режиме прямого подключения. Если используется режим шлюза, взаимодействие со шлюзом происходит по протоколу HTTPS, а значение, заданное в параметре ConnectionPolicy, игнорируется.

    ![Изображение: политика подключения DocumentDB](./media/documentdb-performance-tips/azure-documentdb-connection-policy.png)

3. **Использование вызовов OpenAsync для избежания задержки при выполнении первого запроса**

    По умолчанию первый запрос характеризуется более длительной задержкой, так как используется для извлечения таблицы маршрутизации с адресами. Чтобы избежать возникновения этой задержки, во время инициализации необходимо один раз вызвать OpenAsync(), как показано ниже.

        await client.OpenAsync();
<a id="same-region"></a>
4. **Оптимизация производительности за счет размещения клиентов в одном регионе Azure**

    По возможности разверните приложения, выполняющие вызовы к DocumentDB, в том же регионе, в котором находится база данных DocumentDB. Для приблизительного сравнения: вызовы к DocumentDB в одном и том же регионе выполняются в течение 1–2 мс, но задержка между восточным и западным побережьем США превышает 50 мс. Значение задержки может отличаться в зависимости от выбранного маршрута при передаче запроса от клиента к границе центра обработки данных Azure. Минимальная возможная задержка достигается за счет размещения приложения, выполняющего вызовы к DocumentDB, в том же регионе Azure, в котором находится подготовленная конечная точка DocumentDB. Список доступных регионов см. на странице [Регионы Azure](https://azure.microsoft.com/regions/#services).

    ![Изображение: политика подключения DocumentDB](./media/documentdb-performance-tips/azure-documentdb-same-region.png) <a id="increase-threads"></a>
5. **Увеличение количества потоков или задач**

    Так как вызовы DocumentDB выполняются по сети, может потребоваться изменить степень параллелизма запросов, чтобы клиентское приложение тратило минимальное количество времени на ожидание между запросами. Например, если вы используете [библиотеку параллельных задач .NET](https://msdn.microsoft.com//library/dd460717.aspx), создайте несколько сотен задач для чтения или записи в DocumentDB.

## Использование пакета SDK

1. **Установка последней версии пакета SDK**

    Пакеты SDK для DocumentDB постоянно улучшаются для оптимизации производительности. Сведения о последней версии пакета SDK и заметки об улучшениях см. в статье [Пакет SDK для DocumentDB](documentdb-sdk-dotnet.md).

2. **Использование одного клиента DocumentDB в течение жизненного цикла приложения**
  
    Обратите внимание, что каждый экземпляр DocumentClient является потокобезопасным, а при использовании режима прямого подключения предоставляется возможность управления подключениями и кэширования адресов. Чтобы реализовать возможность управления подключениями и оптимизировать производительность, рекомендуется использовать один экземпляр DocumentClient для каждого домена в течение жизненного цикла приложения. <a id="max-connection"></a>
3. **Увеличение максимального количества подключений System.Net для каждого узла**

    По умолчанию запросы DocumentDB выполняются через HTTPS или REST, и на них распространяется ограничение на количество подключений по имени узла или по IP-адресу по умолчанию. Может потребоваться увеличить это значение (до 100–1000), чтобы клиентская библиотека могла использовать несколько одновременных подключений к DocumentDB. В пакете SDK для .NET версии 1.8.0 и выше для параметра [ServicePointManager.DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit.aspx) по умолчанию задано значение 50. Чтобы изменить это значение, установите для параметра [Documents.Client.ConnectionPolicy.MaxConnectionLimit](https://msdn.microsoft.com/ru-RU/library/azure/microsoft.azure.documents.client.connectionpolicy.maxconnectionlimit.aspx) более высокое значение.

4. **Настройка параллельных запросов для секционированных коллекций**

    В пакете SDK для DocumentDB .NET версии 1.9.0 и выше поддерживаются параллельные запросы, позволяющие выполнять запросы к секционированным коллекциям в параллельном режиме. (Дополнительные сведения см. в разделе о работе с пакетами SDK, а также в разделе со связанными примерами кода.) Они предназначены для сокращения задержки при обработке запросов и улучшения пропускной способности. Параллельные запросы содержат два параметра, которые пользователи могут настроить в соответствии со своими требованиями: а) MaxDegreeOfParallelism — управляет максимальным количеством секций, которые можно запросить в параллельном режиме; б) MaxBufferedItemCount — управляет количеством предварительно выбранных результатов.
    
    1\. ***Настройка MaxDegreeOfParallelism***. При параллельном запросе одновременно запрашиваются несколько секций. Однако данные из отдельной секционированной коллекции извлекаются последовательно в соответствии с запросом. Таким образом, настройка количества секций для параметра MaxDegreeOfParallelism позволит достичь высокой производительности запроса, если все другие состояния системы остаются неизменными. Если вы не знаете количество секций, для параметра MaxDegreeOfParallelism можно задать максимальное количество. При этом система выберет минимальное количество (число секций, входные данные, предоставленные пользователем).
    
    Следует отметить, что параллельные запросы обеспечивают больше преимуществ, если данные равномерно распределены во всех секциях по отношению к запросу. Если коллекция секционируется таким образом, что все или большинство данных, возвращаемых запросом, содержатся в нескольких секциях (в худшем случае в одной), это негативно скажется на производительности запроса.
    
    2\. ***Настройка MaxBufferedItemCount***. Параллельный запрос предназначен для предварительной выборки результатов, в то время как текущий пакет результатов обрабатывается клиентом. Предварительная выборка способствует общему уменьшению задержки при обработке запроса. Параметр MaxBufferedItemCount ограничивает количество предварительно выбранных результатов. Если настроить для параметра MaxBufferedItemCount ожидаемое (или максимальное) количество возвращаемых результатов, запрос получит максимальную выгоду от предварительной выборки.
    
    Обратите внимание, что предварительная выборка работает одинаково, независимо от значения параметра MaxDegreeOfParallelism. Для данных из всех секций применяется один буфер.

5. **Включение сбора мусора на сервере**
    
    В некоторых случаях для оптимизации производительности необходимо уменьшить частоту сбора мусора. В .NET установите для параметра [gcServer](https://msdn.microsoft.com/library/ms229357.aspx) значение true.

6. **Реализация интервала задержки для RetryAfter**
 
    Во время проверки производительности следует увеличивать нагрузку до тех пор, пока регулирование не будет выполняться при небольшой частоте запросов. При регулировании клиентское приложение должно реализовать интервал частоты повтора для частоты повтора сервера. Это гарантирует, что время ожидания между повторными попытками будет минимальным. В пакетах SDK для [.NET](documentdb-sdk-dotnet.md) и [Java](documentdb-sdk-java.md) версии 1.8.0 и выше, а также в пакетах SDK для [Node.js](documentdb-sdk-nodejs.md) и [Python](documentdb-sdk-python.md) версии 1.9.0 и выше включена поддержка политики повтора. Дополнительные сведения см. в разделе [Превышение лимита зарезервированной пропускной способности](documentdb-request-units.md#exceeding-reserved-throughput-limits) и в разделе [RetryAfter](https://msdn.microsoft.com/library/microsoft.azure.documents.documentclientexception.retryafter.aspx).

7. **Развертывание рабочей нагрузки клиента**

    При проверке с высокой пропускной способностью (более 50 000 единиц запроса в секунду) клиентское приложение может стать узким местом из-за того, что на компьютере будут достигнуты максимальные уровни использования ЦП и сети. Если вы достигли этой точки, вы можете распространить учетную запись DocumentDB на другие компьютеры, развернув свои клиентские приложения на нескольких серверах.

8. **Кэширование URI документов для снижения задержки чтения**

    Чтобы повысить производительность операций чтения, по возможности выполняйте кэширование URI документов. <a id="tune-page-size"></a>
9. **Оптимизация производительности посредством настройки размера страницы для запросов и каналов чтения**

    Если при выполнении массового чтения документов с помощью функции для чтения канала (например, ReadDocumentFeedAsync) или отправке запроса DocumentDB SQL набор результатов слишком большой, результаты возвращаются сегментами. По умолчанию результаты возвращаются в пакетах (не более 100 элементов и не более 1 МБ в каждом пакете).

    Чтобы снизить количество полных обходов сети, необходимых для получения всех соответствующих результатов, можно увеличить размер страницы до 1000 с помощью заголовка запроса x-ms-max-item-count. Чтобы отобразить только некоторые результаты, например, когда пользовательский интерфейс или приложение API возвращает только десять результатов за раз, размер страницы можно уменьшить до 10. Это позволит снизить пропускную способность, используемую на операции чтения и на выполнение запросов.

    Размер страницы также можно изменить с помощью доступных пакетов SDK для DocumentDB. Например:
    
        IQueryable<dynamic> authorResults = client.CreateDocumentQuery(documentCollection.SelfLink, "SELECT p.Author FROM Pages p WHERE p.Title = 'About Seattle'", new FeedOptions { MaxItemCount = 1000 });

10. **Увеличение количества потоков или задач**

	См. подраздел [Увеличение количества потоков или задач](increase-threads.md) раздела "Сеть".

## Политика индексации

1. **Использование отложенного индексирования для увеличения скорости приема документов во время пиковой нагрузки**

    DocumentDB позволяет указать политику индексации (на уровне коллекции). При необходимости эта политика используется для включения автоматический индексации документов в коллекции. Кроме того, можно выбрать синхронное (согласованное) или асинхронное (отложенное) обновления индекса. По умолчанию индекс обновляется синхронно при каждой операции вставки, замены или удаления документа в коллекции. Синхронный режим позволяет выполнять запросы, обеспечивая тот же [уровень согласованности](documentdb-consistency-levels.md), что и при чтении документа, без каких-либо задержек, чтобы индекс "успевал" обновиться.
    
    Отложенное индексирование можно использовать для сценариев, при которых происходит запись данных пачками, а вы хотите уменьшить нагрузку при выполнении работы, необходимой для индексирования содержания в течение более длительного периода времени. Это также позволяет эффективно использовать отведенную пропускную способность и обслуживать запросы на запись в часы пик с минимальной задержкой. Важно отметить, что при включенном отложенном индексировании результаты запросов будут в конечном итоге согласованы независимо от уровня согласованности, настроенного в учетной записи DocumentDB.

    Таким образом, при использовании режима согласованного индексирования (для параметра IndexingPolicy.IndexingMode задано значение Consistent) расходуется максимальное количество единиц запроса на каждую операцию записи, в то время как при использовании отложенного индексирования (для параметра IndexingPolicy.IndexingMode задано значение Lazy) и при отключенном индексировании (для параметра IndexingPolicy.Automatic задано значение False) во время выполнения операции записи плата за индексирование не взимается.

2. **Увеличение скорости выполнения операций записи посредством исключения неиспользуемых путей из индексирования**

    Политика индексирования DocumentDB также позволяет добавлять пути к документам или исключать их из индексирования. Для этого используется параметр Indexing Paths (IndexingPolicy.IncludedPaths и IndexingPolicy.ExcludedPaths). Возможность управления путями индексирования позволяет оптимизировать производительность записи и снизить затраты на хранение индекса для сценариев с заранее определенными шаблонами запросов. Это связано с тем, что затраты на индексирование непосредственно зависят от количества уникальных путей индексирования. Например, в следующем коде показано, как исключить из индексации раздел сущностей документов (так называемое поддерево) с помощью подстановочного знака "*".

        var collection = new DocumentCollection { Id = "excludedPathCollection" };
        collection.IndexingPolicy.IncludedPaths.Add(new IncludedPath { Path = "/*" });
        collection.IndexingPolicy.ExcludedPaths.Add(new ExcludedPath { Path = "/nonIndexedContent/*");
        collection = await client.CreateDocumentCollectionAsync(UriFactory.CreateDatabaseUri("db"), excluded);

    Дополнительные сведения см. в статье [Политики индексации DocumentDB](documentdb-indexing-policies.md).

## Пропускная способность
<a id="measure-rus"></a>

1. **Измерение и настройка расхода единиц запроса/повторного использования**

    DocumentDB предоставляет обширный набор операций базы данных, включая реляционные и иерархические запросы с использованием UDF, хранимых процедур и триггеров, для документов в коллекции базы данных. Затраты, связанные с каждой из этих операций, зависят от типа процессора, операций ввода-вывода и памяти, необходимой для завершения операции. Вместо того чтобы думать о закупке и управлении аппаратными ресурсами, вы можете думать о единице запроса (RU) как единой меры для ресурсов, необходимых для выполнения различных операций с базами данных и обслуживания запросов приложений.

    [Единицы запросов](documentdb-request-units.md) предоставляются для каждой учетной записи базы данных в зависимости от количества приобретенных единиц емкости. Удельный расход единиц запросов оценивается в расчете на одну секунду. Частота запросов для приложений, у которых она превышает подготовленные единицы запросов для учетной записи, будет ограничена, пока она не упадет ниже зарезервированного для учетной записи уровня. Если ваше приложение требует более высокого уровня пропускной способности, вы можете приобрести дополнительные единицы емкости.

    Сложность запроса влияет на количество потребляемых единиц запросов для операции. Количество предикатов и их характер, количество определяемых пользователем функций и размер набора исходных данных — все это влияет на плату за операции запроса.

    Для оценки расходов на каждую операцию (создание, обновление или удаление) выберите заголовок x-ms-request-charge (или эквивалентное свойство RequestCharge на вкладке ResourceResponse<T> или FeedResponse<T> в пакете SDK для .NET), чтобы измерить число единиц запроса, используемых такими операциями.

        // Measure the performance (request units) of writes
        ResourceResponse<Document> response = await client.CreateDocumentAsync(collectionSelfLink, myDocument);
        Console.WriteLine("Insert of document consumed {0} request units", response.RequestCharge);
        // Measure the performance (request units) of queries
        IDocumentQuery<dynamic> queryable = client.CreateDocumentQuery(collectionSelfLink, queryString).AsDocumentQuery();
        while (queryable.HasMoreResults)
             {
                  FeedResponse<dynamic> queryResponse = await queryable.ExecuteNextAsync<dynamic>();
                  Console.WriteLine("Query batch consumed {0} request units", queryResponse.RequestCharge);
             }
        
    Затраты на запрос, возвращенные в этом заголовке, — это часть подготовленной пропускной способности (например, 2000 единиц запроса в секунду). Например, если после выполнения приведенного выше запроса возвращается 1000 документов размером 1 КБ каждый, затраты на операцию составят 1000 единиц. Таким образом, перед регулированием последующих запросов сервер за одну секунду выполняет только два таких запроса. Дополнительные сведения см. в статье [Единицы запросов в DocumentDB](documentdb-request-units.md). Кроме того, для вычисления единиц запросов можно воспользоваться [калькулятором единиц запросов](https://www.documentdb.com/capacityplanner).

2. **Обработка ограничения скорости/ слишком высокая частота запросов**

    Выполнение запроса, который превышает лимит зарезервированной пропускной способности для учетной записи, не приводит к снижению производительности сервера, так как пользователь не сможет превысить это зарезервированное значение. Сервер заблаговременно завершит запрос с ошибкой RequestRateTooLarge (код состояния HTTP: 429) и вернет заголовок x-x-ms-retry-after-ms, указывая время (в миллисекундах), спустя которое можно повторно выполнить запрос.
 
        HTTP Status 429,
        Status Line: RequestRateTooLarge
        x-ms-retry-after-ms :100

    Пакеты SDK перехватят этот ответ, обработают заголовок retry-after, указанный сервером, и отправят запрос повторно. Если к вашей учетной записи параллельно имеет доступ только один клиент, следующая попытка будет успешной.

    По умолчанию количество повторных попыток отправки запроса составляет 9 (это значение задается клиентом). Если к вашей учетной записи имеют доступ несколько клиентов и они выполняют запросы одновременно, этого значения может быть недостаточно. В этом случае клиент выдаст для приложения исключение DocumentClientException с кодом состояния 429. Число повторных попыток по умолчанию можно переопределить в свойстве RetryOptions экземпляра ConnectionPolicy. По умолчанию в случае превышения заданного счетчика повторов исключение DocumentClientException с кодом состояния 429 возвращается через 30 секунд (совокупное время ожидания). Это происходит, даже если текущее значение количества повторных попыток (по умолчанию (9) или определенное пользователем) меньше максимального значения.

    Хотя автоматическая процедура отправки повторного запроса позволяет улучшить устойчивость приложений и повысить удобство работы с ними, она может снизить производительность, что, в свою очередь, станет причиной появления более длительных задержек. Если настройка производительности повлияла на регулирование сервера и стала причиной автоматической отправки запросов пакетом SDK, это может стать причиной появления пиков задержек на стороне клиента. Чтобы избежать пиков задержек во время настройки производительности, проверьте расход ресурсов на каждую операцию и убедитесь, что значение частоты запросов не превышено. Дополнительные сведения см. в статье [Единицы запросов в DocumentDB](documentdb-request-units.md).
   
3. **Использование меньших документов для более высокой пропускной способности**

    Плата за запрос (например, плата за обработку запроса) на выполнение определенной операции напрямую зависит от размера документа. За операции с большими документами взимается больше единиц запроса, чем за операции с мелкими документами.

## Уровни согласованности

1. **Сокращение времени задержки при чтении за счет использования более низких уровней согласованности**

    При настройке производительности приложений DocumentDB также следует учитывать уровень согласованности. Выбранный уровень согласованности влияет как на операции чтения, так и на операции записи. Вы можете настроить уровень согласованности по умолчанию для учетной записи базы данных, который будет распространяться на все коллекции (всех баз данных) в учетной записи DocumentDB. При изменении уровня согласованности операции записи выполняются с задержками. И чем строже уровень согласованности, тем выше задержки. С другой стороны, изменение уровня согласованности влияет на пропускную способность для операций записи. Чем ниже уровень согласованности, тем выше пропускная способность операций чтения для клиента.

    По умолчанию все операции чтения и запросов к определенным пользователем ресурсам будут использовать уровень согласованности по умолчанию, заданный в учетной записи базы данных. Однако вы можете понизить уровень согласованности для конкретного запроса чтения/запроса, указав заголовок запроса [x-ms-consistency-level]. Дополнительные сведения см. в статье [Уровни согласованности в DocumentDB](documentdb-consistency-levels.md).

## Дальнейшие действия

Пример приложения, используемого в сценариях оценки производительности DocumentDB на нескольких клиентских компьютерах, см. в статье [Проверка производительности и масштабирования с помощью Azure DocumentDB](documentdb-performance-testing.md).

Дополнительные сведения о создании собственного масштабируемого приложения с высокой производительностью см. в статье [Секционирование и масштабирование в Azure DocumentDB](documentdb-partition-data.md).

<!---HONumber=AcomDC_0921_2016-->