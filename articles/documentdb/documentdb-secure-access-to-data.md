<properties 
	pageTitle="Сведения о защите доступа к данным в DocumentDB | Microsoft Azure" 
	description="Узнайте об основных понятиях управления доступом в DocumentDB, включая главные ключи, ключи только для чтения, пользователей и разрешения." 
	services="documentdb" 
	authors="kiratp" 
	manager="jhubbard" 
	editor="monicar" 
	documentationCenter=""/>

<tags 
	ms.service="documentdb" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="09/19/2016" 
	ms.author="kipandya"/>

# Защита доступа к данным DocumentDB

В этой статье приведены общие сведения о защите доступа к данным, хранящимся в [Microsoft Azure DocumentDB](https://azure.microsoft.com/services/documentdb/).

Прочитав этот обзор, вы сможете ответить на следующие вопросы.

-	Что собой представляют главные ключи DocumentDB?
-	Что собой представляют ключи только для чтения DocumentDB?
-	Что такое маркеры ресурсов DocumentDB?
-	Как использовать пользователей и разрешения DocumentDB для защиты доступа к данным DocumentDB?

## Понятия управления доступом DocumentDB

DocumentDB содержит понятия первого класса, позволяющие контролировать доступ к ресурсам DocumentDB. В этой статье ресурсы DocumentDB сгруппированы в две категории:

- Административные ресурсы
	- Учетная запись
	- База данных
	- Пользователь
	- Разрешение
- Ресурсы приложения
	- Коллекция
	- ПРЕДЛОЖЕНИЕ
	- Документ
	- Вложение
	- Хранимая процедура
	- Триггер
	- Определяемая пользователем функция

Применительно к этим двум категориям DocumentDB поддерживает три типа лиц управления доступом: администратор учетной записи, администратора с доступом только для чтения и пользователь базы данных. Для каждого типа пользователя управления доступом существуют следующие права.
 
- Администратор учетной записи. Полный доступ ко всем ресурсам (административным ресурсам и ресурсам приложения) в рамках данной учетной записи DocumentDB.
- Администратор с доступом только для чтения. Доступ ко всем ресурсам (административным ресурсам и ресурсам приложения) в рамках данной учетной записи DocumentDB с правами только на чтение.
- Пользователь базы данных. Ресурс пользователя DocumentDB, связанный с определенным набором ресурсов базы данных DocumentDB (например, коллекциями, документами, скриптами). С указанной базой данных может быть связан один или несколько ресурсов пользователя, а у каждого ресурса пользователя может быть одно или несколько связанных разрешений.

С учетом упомянутых выше категорий и ресурсов в модели управления доступом использования DocumentDB определено три типа конструкций доступа.

- Главные ключи. При создании учетной записи DocumentDB формируются два главных ключа (первичный и вторичный). Эти ключи предоставляют полный административный доступ ко всем ресурсам в учетной записи DocumentDB.

![Иллюстрация главных ключей DocumentDB](./media/documentdb-secure-access-to-data/masterkeys.png)

- Ключи только для чтения. При создании учетной записи DocumentDB формируются два ключа только для чтения (первичный и вторичный). Эти ключи предоставляют доступ ко всем ресурсам в учетной записи DocumentDB с правами только на чтение.

![Иллюстрация ключей DocumentDB только для чтения](./media/documentdb-secure-access-to-data/readonlykeys.png)

- Маркеры ресурса. Маркер ресурса связан с разрешением DocumentDB и отражает отношение между пользователем базы данных и разрешением этого пользователя к конкретному ресурсу приложения DocumentDB (например, коллекции, документу).

![Иллюстрация маркеров ресурсов DocumentDB](./media/documentdb-secure-access-to-data/resourcekeys.png)

## Работа с главными ключами и ключами только для чтения DocumentDB

Как упоминалось ранее, главные ключи DocumentDB предоставляют полный административный доступ ко всем ресурсам в учетной записи DocumentDB, тогда как ключи только для чтения предоставляют доступ для чтения ко всем ресурсам в учетной записи. В следующем фрагменте кода показано, как использовать конечную точку учетной записи DocumentDB и главный ключ для создания DocumentClient и построения новой базы данных.

    //Read the DocumentDB endpointUrl and authorization keys from config.
    //These values are available from the Azure Classic Portal on the DocumentDB Account Blade under "Keys".
    //NB > Keep these values in a safe and secure location. Together they provide Administrative access to your DocDB account.
    
    private static readonly string endpointUrl = ConfigurationManager.AppSettings["EndPointUrl"];
    private static readonly SecureString authorizationKey = ToSecureString(ConfigurationManager.AppSettings["AuthorizationKey"]);
        
    client = new DocumentClient(new Uri(endpointUrl), authorizationKey);
    
    // Create Database
    Database database = await client.CreateDatabaseAsync(
        new Database
        {
            Id = databaseName
        });


## Общие сведения о маркерах ресурсов DocumentDB

Маркер ресурсов можно использовать(создавая пользователей и разрешения DocumentDB), если доступ к ресурсам в учетной записи DocumentDB требуется предоставить клиенту, которому нельзя доверять. Главные ключи DocumentDB включают в себя как первичный, так и вторичный ключ, и оба этих ключа предоставляют административный доступ к вашей учетной записи и всем ее ресурсам. Предоставление любого из главных ключей делает учетную запись уязвимой для вредоносного или небрежного использования.

Аналогичным образом, ключи только для чтения DocumentDB предоставляют доступ для чтения ко всем ресурсам (за исключением ресурсов разрешений) в учетной записи DocumentDB и не могут использоваться для предоставления более детального доступа к определенным ресурсам DocumentDB.

Маркеры ресурсов DocumentDB — это безопасное альтернативное решение, которое позволяет клиентам читать, записывать и удалять ресурсы в учетной записи DocumentDB согласно предоставленным разрешениям и без необходимости использовать главный ключ или ключ только для чтения.

Ниже приведена стандартная схема запроса, создания и отправки маркеров ресурсов клиентам.

1. Служба среднего уровня настроена для обслуживания мобильного приложения по обмену фотографиями.
2. Служба среднего уровня обрабатывает главный ключ учетной записи DocumentDB.
3. Приложение по обмену фотографиями устанавливается на мобильных устройствах конечных пользователей.
4. При входе в систему приложение для обмена фотографиями идентифицирует пользователя службы. Механизм установления личности пользователя реализуется исключительно в приложении.
5. После установления личности служба среднего уровня запрашивает разрешения на основе удостоверения.
6. Служба среднего уровня отправляет маркер ресурса обратно в приложение для телефона.
7. Приложение может по-прежнему использовать маркер ресурса для прямого доступа к ресурсам DocumentDB с разрешениями, определенными маркером, и в течение интервала времени, разрешенного этим маркером.
8. По истечении срок действия маркера ресурса последующие запросы будут получать исключение 401 — Не санкционировано. На этом этапе приложение для телефона повторно установит личность и запросит новый маркер ресурса.

![Рабочий процесс маркеров ресурсов DocumentDB](./media/documentdb-secure-access-to-data/resourcekeyworkflow.png)

## Работа с пользователями и разрешениями DocumentDB
Ресурс пользователя DocumentDB связан с базой данных DocumentDB. Каждая база данных может содержать несколько пользователей DocumentDB или не содержать ни одного. В следующем фрагменте кода показано, как создать ресурс пользователя DocumentDB.

    //Create a user.
    User docUser = new User
    {
        Id = "mobileuser"
    };

    docUser = await client.CreateUserAsync(UriFactory.CreateDatabaseUri("db"), docUser);

> [AZURE.NOTE] Каждый пользователь DocumentDB обладает свойством PermissionsLink, используемым для получения списка разрешений, связанных с этим пользователем.

Ресурс разрешения DocumentDB связан с пользователем DocumentDB. Каждый пользователь может иметь несколько разрешений DocumentDB или не иметь ни одного. Ресурс разрешения предоставляет доступ к маркеру безопасности, необходимому пользователю при попытке доступа к конкретному ресурсу приложения. Существует два уровня доступа, предоставляемых ресурсом разрешения.

- Все. Пользователь имеет полный набор разрешений для ресурса.
- Чтение. Пользователь может только считывать содержимое ресурса, но не может выполнять на ресурсе операции записи, обновления или удаления.


> [AZURE.NOTE] Для выполнения хранимых процедур DocumentDB пользователь должен иметь полные разрешения на использование коллекции, в которой будут выполняться хранимые процедуры.


В следующем фрагменте кода показано, как создать ресурс разрешения, прочесть его маркер и связать разрешения с созданным выше пользователем.

    // Create a permission.
    Permission docPermission = new Permission
    {
        PermissionMode = PermissionMode.Read,
        ResourceLink = documentCollection.SelfLink,
        Id = "readperm"
    };
            
  docPermission = await client.CreatePermissionAsync(UriFactory.CreateUserUri("db", "user"), docPermission); Console.WriteLine(docPermission.Id + "имеет токен:" + docPermission.Token);
  
Если вы указали ключ секции для коллекции, то разрешение для ресурсов коллекции, документа и вложения также должно включать ResourcePartitionKey наряду с ResourceLink.

Чтобы получить все ресурсы разрешений, связанные с конкретным пользователем, DocumentDB предоставляет каждому объекту пользователя доступ к каналу разрешений. В следующем фрагменте кода показано, как получить разрешение, связанное с созданным выше пользователем, сформировать список разрешений и создать новый DocumentClient от имени пользователя.

    //Read a permission feed.
    FeedResponse<Permission> permFeed = await client.ReadPermissionFeedAsync(
      UriFactory.CreateUserUri("db", "myUser"));

    List<Permission> permList = new List<Permission>();
      
    foreach (Permission perm in permFeed)
    {
        permList.Add(perm);
    }
            
    DocumentClient userClient = new DocumentClient(new Uri(endpointUrl), permList);

> [AZURE.TIP] Допустимый интервал времени по умолчанию для маркеров ресурсов составляет 1 час. Однако продолжительность действия маркера можно задать явным образом. Ее значение не должно превышать 5 часов.

## Дальнейшие действия

- Для получения дополнительных сведений о DocumentDB щелкните [здесь](http://azure.com/docdb).
- Дополнительные сведения об управлении главными ключами и ключами только для чтения можно узнать [здесь](documentdb-manage-account.md).
- Сведения о создании маркеров авторизации DocumentDB можно узнать [здесь](https://msdn.microsoft.com/library/azure/dn783368.aspx).
 

<!---HONumber=AcomDC_0921_2016-->