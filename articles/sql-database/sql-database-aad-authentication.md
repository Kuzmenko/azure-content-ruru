<properties
   pageTitle="Подключение к Базе данных SQL или хранилищу данных SQL c использованием проверки подлинности Azure Active Directory | Microsoft Azure"
   description="Сведения о подключении к базе данных SQL с использованием проверки подлинности Azure Active Directory."
   services="sql-database"
   documentationCenter=""
   authors="BYHAM"
   manager="jhubbard"
   editor=""
   tags=""/>

<tags
   ms.service="sql-database"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="data-management"
   ms.date="09/16/2016"
   ms.author="rick.byham@microsoft.com"/>

# Подключение к Базе данных SQL или хранилищу данных SQL c использованием проверки подлинности Azure Active Directory

Проверка подлинности Azure Active Directory — это механизм подключения к Базе данных SQL Microsoft Azure и [хранилищу данных SQL](../sql-data-warehouse/sql-data-warehouse-overview-what-is.md) с помощью удостоверений в Azure Active Directory (Azure AD). С помощью аутентификации Azure Active Directory можно централизованно управлять удостоверениями пользователей базы данных и другими службами Майкрософт. Централизованное управление удостоверениями позволяет использовать единое расположение для управления пользователями и упрощает управление разрешениями. Это дает такие преимущества:

- наличие альтернативного варианта проверки подлинности SQL Server;
- возможность остановить увеличение количества пользователей на серверах баз данных;
- изменение паролей в одном расположении;
- клиенты могут управлять разрешениями базы данных с помощью внешних групп (AAD);
- возможность исключить хранение паролей с помощью встроенной проверки подлинности Windows и других видов проверки подлинности, поддерживаемых Azure Active Directory;
- при проверке подлинности Azure Active Directory используются данные пользователей автономной базы данных для проверки подлинности удостоверений на уровне базы данных.
- Azure Active Directory поддерживает аутентификацию на основе маркеров для приложений, подключающихся к базе данных SQL.
- Azure Active Directory поддерживает проверку подлинности с использованием ADFS (федерация доменов) или собственную проверку подлинности с помощью имени пользователя и пароля для локального каталога Azure Active Directory без синхронизации домена.
- Azure Active Directory поддерживает подключения из SQL Server Management Studio, использующие универсальную аутентификацию Active Directory, в том числе Multi-Factor Authentication (MFA). MFA обеспечивает надежную аутентификацию с использованием ряда простых вариантов проверки посредством телефонного звонка, текстового сообщения, смарт-карты с ПИН-кодом или уведомления в мобильном приложении. Дополнительные сведения см. в разделе [Поддержка SSMS в Azure AD MFA для базы данных SQL и хранилища данных SQL](sql-database-ssms-mfa-authentication.md).

Для настройки и использования проверки подлинности Azure Active Directory выполните следующие действия.

1. Создайте и заполните каталог Azure Active Directory.
2. Разместите свою базу данных в Базе данных SQL Azure версии 12. (Необязательно для хранилища данных SQL.)
3. Свяжите или измените каталог Active Directory, который сейчас связан с вашей подпиской Azure (этот шаг можно пропустить).
4. Создание учетной записи администратора Azure Active Directory для сервера Azure SQL Server или [хранилища данных SQL Azure](https://azure.microsoft.com/services/sql-data-warehouse/).
5. Настройте клиентские компьютеры.
6. Создайте учетные записи пользователей автономной базы данных в базе данных, сопоставленной с удостоверениями Azure AD.
7. Подключитесь к базе данных с помощью удостоверений Azure AD.


## Архитектура доверия

На следующей общей схеме представлена архитектура решения, в котором используется аутентификация Azure AD для базы данных SQL Azure. Та же концепция применяется к хранилищу данных SQL. Для поддержки собственной проверки подлинности Azure Active Directory с использованием пароля пользователя учитывается только облачная часть, База данных SQL Azure и Azure AD. Для поддержки федеративной проверки подлинности (или имени пользователя и пароля в качестве учетных данных Windows) требуется взаимодействие с блоком ADFS. Стрелки обозначают пути обмена данными.

![схема проверки подлинности aad][1]

На следующей схеме показаны федерация, отношения доверия и отношения размещения. Все эти компоненты позволяют клиенту подключиться к базе данных, отправив маркер. Маркер проходит аутентификацию в Azure AD и становится доверенным для базы данных. Клиент 1 может представлять Azure Active Directory с собственными пользователями или федеративными пользователями. Клиент 2 представляет возможное решение, включая импортированных пользователей. В этом примере пользователи импортированы из федеративной службы Azure Active Directory, при этом службы ADFS синхронизированы с Azure Active Directory. Важно понимать, что для доступа к базе данных с использованием аутентификации Azure AD необходимо связать подписку размещения с Azure Active Directory. Эту же подписку нужно использовать для создания сервера SQL Server для размещения базы данных SQL Azure или хранилища данных SQL.

![отношение подписки][2]

## Структура администраторов

При использовании аутентификации Azure AD существуют две учетные записи администратора сервера базы данных SQL: учетная запись первоначального администратора сервера SQL Server и учетная запись администратора Azure AD. Та же концепция применяется к хранилищу данных SQL. Создать в пользовательской базе данных первого пользователя автономной базы данных Azure AD может только администратор с учетной записью Azure AD. Администратор Azure AD может использовать для входа имя пользователя Azure AD или имя группы Azure AD. Если учетная запись администратора является учетной записью группы, ее может использовать любой участник группы. По этой причине для одного экземпляра SQL Server может существовать несколько администраторов Azure AD. Использование учетной записи группы в качестве учетной записи администратора повышает управляемость. Это позволяет централизованно добавлять и удалять членов группы в Azure AD, не изменяя пользователей или разрешения в базе данных SQL. За один раз можно настроить только одного администратора Azure AD (пользователя или группу).

![структура администраторов][3]

## Разрешения

Чтобы создавать новых пользователей, у вас должно быть разрешение `ALTER ANY USER` в базе данных. Разрешение `ALTER ANY USER` можно предоставить любому пользователю базы данных. Разрешение `ALTER ANY USER` также предоставляется учетным записям администратора сервера и пользователям базы данных с разрешениями `CONTROL ON DATABASE` или `ALTER ON DATABASE` для этой базы данных, а также участникам роли `db_owner` в базе данных.

Чтобы создать учетную запись пользователя автономной базы данных в Базе данных SQL Azure или хранилище данных SQL, необходимо подключиться к базе данных с помощью удостоверения Azure AD. Чтобы создать учетную запись первого пользователя автономной базы данных, необходимо подключиться к ней с правами администратора Azure Active Directory (который является владельцем базы данных). См. шаги 4 и 5 ниже. Проверка подлинности Azure Active Directory любого типа возможна только в том случае, если для Базы данных SQL Azure или сервера хранилища данных SQL создана учетная запись администратора Azure Active Directory. Если учетная запись администратора Azure Active Directory удалена с сервера, то существующие пользователи Azure Active Directory, учетные записи которых были созданы ранее на сервере SQL Server, больше не смогут подключаться к базе данных, используя свои текущие учетные данные Azure Active Directory.

## Функции и ограничения Azure AD

На сервере Azure SQL Server или в хранилище данных SQL можно подготовить следующих членов Azure Active Directory.

- Собственные члены — члены, созданные в Azure AD в управляемом домене или в домене клиента. Дополнительные сведения см. в статье [Добавление имени личного домена в Azure Active Directory](../active-directory/active-directory-add-domain.md).

- Федеративные члены домена — члены, созданные в Azure AD с федеративным доменом. Дополнительные сведения см. в статье [Microsoft Azure now supports federation with Windows Server Active Directory](https://azure.microsoft.com/blog/2012/11/28/windows-azure-now-supports-federation-with-windows-server-active-directory/) (Microsoft Azure теперь поддерживает федерацию с Windows Server Active Directory).

- Импортированные члены из других служб Azure Active Directory, являющиеся собственными или федеративными членами домена.

- Группы Active Directory, созданные как группы безопасности.

Учетные записи Майкрософт (например, outlook.com, hotmail.com, live.com) и гостевые учетные записи (например, gmail.com, yahoo.com) не поддерживаются. Если вы можете войти на сайт [https://login.live.com](https://login.live.com) с помощью учетной записи и пароля, это означает, что ваша учетная запись Майкрософт не поддерживается для аутентификации Azure AD для базы данных SQL Azure или хранилища данных SQL Azure.

### Дополнительные замечания

- Для повышения управляемости рекомендуем подготовить специальную группу Azure Active Directory от имени администратора.
- За один раз можно настроить только одну учетную запись администратора Azure AD (пользователя или группу) для сервера Azure SQL Server или хранилища данных SQL Azure.
- Изначально только администратор Azure Active Directory для SQL Server может подключаться к серверу Azure SQL Server или хранилищу данных SQL Azure, используя учетную запись Azure Active Directory. Затем администратор Active Directory может настроить других пользователей базы данных Azure Active Directory.
- Мы рекомендуем установить время ожидания подключения в 30 секунд.
- Проверку подлинности Azure Active Directory поддерживают SQL Server 2016 Management Studio и SQL Server Data Tools для Visual Studio 2015 (версии 14.0.60311.1, выпущенной в апреле 2016 г., или более поздней). (Проверку подлинности Azure Active Directory поддерживает **поставщик данных .NET Framework для SQL Server**, требуется версия .NET Framework не ниже 4.6.) Поэтому для последних версий этих инструментов и приложений уровня данных (DAC и BACPAC) можно применять проверку подлинности Azure Active Directory.
- [ODBC версии 13.1](https://www.microsoft.com/download/details.aspx?id=53339) поддерживает аутентификацию Azure Active Directory, однако `bcp.exe` не может подключаться с использованием аутентификации Azure Active Directory, так как использует устаревший поставщик ODBC.
- `sqlcmd` поддерживает аутентификацию Azure Active Directory, начиная с версии 13.1, доступной в [Центре загрузки](http://go.microsoft.com/fwlink/?LinkID=825643).
- Для SQL Server Data Tools для Visual Studio 2015 требуется версия Data Tools, выпущенная в апреле 2016 г. (14.0.60311.1), или более поздняя. Сейчас пользователи Azure Active Directory не отображаются в обозревателе объектов SSDT. В качестве решения сведения о пользователях можно просмотреть в файле [sys.database\_principals](https://msdn.microsoft.com/library/ms187328.aspx).
- [Драйвер Microsoft JDBC 6.0 для SQL Server](https://www.microsoft.com/ru-RU/download/details.aspx?id=11774) поддерживает проверку подлинности Azure Active Directory. Вы можете также ознакомиться с [настройкой свойств подключения](https://msdn.microsoft.com/library/ms378988.aspx).
- PolyBase не может пройти проверку с помощью проверки подлинности Azure Active Directory.
- Некоторые средства, такие как бизнес-аналитика и Excel, не поддерживаются.
- База данных SQL поддерживает аутентификацию Azure Active Directory на портале Azure. Для этого используются колонки **Импорт базы данных** и **Экспорт базы данных**. Импорт и экспорт с использованием проверки подлинности Azure Active Directory также можно выполнить с помощью команды PowerShell.


## 1\. Создание и заполнение каталога Azure AD

Создайте каталог Azure Active Directory и заполните его пользователями и группами. Azure Active Directory может быть исходным доменом управляемого домена Azure AD. Azure Active Directory может также быть локальными доменными службами Active Directory, объединенными в федерацию с Azure Active Directory.

Дополнительные сведения см. в статьях [Интеграция локальных удостоверений с Azure Active Directory](../active-directory/active-directory-aadconnect.md), [Добавление имени личного домена в Azure Active Directory](../active-directory/active-directory-add-domain.md), [Microsoft Azure now supports federation with Windows Server Active Directory](https://azure.microsoft.com/blog/2012/11/28/windows-azure-now-supports-federation-with-windows-server-active-directory/) (Microsoft Azure теперь поддерживает федерацию с Windows Server Active Directory), [Управление каталогом Azure AD](https://msdn.microsoft.com/library/azure/hh967611.aspx) и [Управление службой Azure AD с помощью Windows PowerShell](https://msdn.microsoft.com/library/azure/jj151815.aspx).

## 2) Проверка того, что используется база данных SQL версии 12

Проверка подлинности Azure Active Directory поддерживается в последней версии базы данных SQL V12. Сведения о базе данных SQL V12 и о том, как определить, доступна ли она в вашем регионе, см. в статье [Новые возможности базы данных SQL V12](sql-database-v12-whats-new.md). Этот шаг необязателен для хранилища данных SQL Azure, так как хранилище данных SQL доступно только в версии 12.

Если база данных уже существует, убедитесь, что она размещена в базе данных SQL версии 12, подключившись к ней (например, с помощью SQL Server Management Studio) и выполнив команду `SELECT @@VERSION;`. Ожидаемый результат для базы данных в базе данных SQL версии 12 — по меньшей мере **Microsoft SQL Azure (RTM) — 12.0**. Если база данных размещена не в базе данных SQL V12, см. статью [Планирование и подготовка к обновлению до версии базы данных SQL Azure V12](sql-database-v12-plan-prepare-upgrade.md), а затем перейдите на классический портал Azure, чтобы перенести базу данных в базу данных SQL V12.

Также можно создать новую базу данных в базе данных SQL версии 12, выполнив действия, описанные в статье [Создание своей первой Базы данных SQL Azure](sql-database-get-started.md). **Совет**. Прочитайте следующий шаг полностью, прежде чем выбрать подписку для новой базы данных.

## 3\. Связывание каталога Active Directory с подпиской Azure или изменение каталога, который сейчас связан с этой подпиской (этот шаг можно пропустить)

Чтобы связать базу данных с каталогом Azure AD для вашей организации, сделайте каталог доверенным для подписки Azure, в которой размещена база данных. Дополнительные сведения см. в статье [Связь подписок Azure с Azure AD](https://msdn.microsoft.com/library/azure/dn629581.aspx).

**Дополнительные сведения.** Каждая подписка Azure связана отношением доверия с экземпляром Azure AD. Это означает, что она доверяет каталогу проверять подлинность пользователей, служб и устройств. Несколько подписок могут доверять одному и тому же каталогу, но одна конкретная подписка доверяет только одному каталогу. На вкладке **Параметры** на сайте [https://manage.windowsazure.com/](https://manage.windowsazure.com/) можно проверить, какой каталог является доверенным для вашей подписки. Данное отношение доверия, которое подписка имеет с каталогом, отличается от отношения, которую подписка имеет со всеми другими ресурсами в Azure (веб-сайтами, базами данных и т. д.), которые больше похожи на дочерние ресурсы подписки. Если срок действия подписки истекает, доступ к другим ресурсам, связанным с этой подпиской, также прекращается. Однако каталог останется в Azure, вы можете связать другую подписку с этим каталогом и продолжать управлять пользователями каталога. Дополнительные сведения о ресурсах см. в статье [Основные сведения о доступе к ресурсам в Azure](https://msdn.microsoft.com/library/azure/dn584083.aspx).

Ниже приведены пошаговые инструкции по изменению связанного каталога для заданной подписки.

1. Подключитесь к [классическому порталу Azure](https://manage.windowsazure.com/) с помощью учетной записи администратора подписки Azure.
2. В области слева выберите элемент **ПАРАМЕТРЫ**.
3. Ваши подписки отобразятся в окне параметров. Если нужная подписка не отображается, в верхней части окна щелкните **Подписки**, в раскрывающемся списке **ФИЛЬТРОВАТЬ ПО КАТАЛОГУ** выберите каталог, содержащий подписки, и щелкните **ПРИМЕНИТЬ**.

	![выбрать подписку][4]
4. В области **Параметры** выберите подписку и внизу страницы щелкните **ИЗМЕНИТЬ КАТАЛОГ**.

	![ad-settings-portal][5]
5. В окне **Изменить каталог** выберите службу Azure Active Directory, связанную с сервером SQL Server или хранилищем данных SQL, и нажмите кнопку со стрелкой, чтобы перейти к следующему шагу.

	![edit-directory-select][6]
6. В диалоговом окне **ПОДТВЕРЖДЕНИЕ сопоставления каталогов** убедитесь, что отображается текст **Все соадминистраторы будут удалены**.

	![edit-directory-confirm][7]
7. Нажмите на кнопку с галочкой, чтобы перезагрузить портал.

> [AZURE.NOTE] После изменения каталога доступ ко всем соадминистраторам, пользователям и группам Azure AD, а также пользователям ресурсов на основе каталогов будет запрещен. Указанные пользователи не смогут больше получить доступ к этой подписке или ее ресурсам. Доступ субъектов на основе нового каталога сможет настроить только администратор службы. Применение этих изменений ко всем ресурсам может занять значительное время. В случае изменения каталога также изменяется администратор Azure AD для Базы данных SQL и хранилища данных SQL, а доступ всех существующих пользователей Azure AD к Базе данных SQL запрещается. Необходимо будет повторно указать администратора Azure AD (как описано ниже) и создать новых пользователей Azure AD.

## 4\. Создание администратора Azure AD для сервера Azure SQL Server

Каждый сервер Azure SQL Server (на котором размещена база данных или SQL или хранилище данных SQL) сначала имеет одну учетную запись администратора сервера, который является администратором всего сервера Azure SQL Server. Необходимо создать второго администратора SQL Server, то есть учетную запись Azure AD. Этот участник создается как пользователь автономной базы данных в базе данных master. Администраторы с учетными записями администратора сервера являются членами роли **db\_owner** в каждой пользовательской базе данных. Они входят в каждую такую базу данных как пользователи **dbo**. Дополнительные сведения об учетных записях администраторов сервера см. в статье [Управление базами данных и учетными записями в базе данных SQL Azure](sql-database-manage-logins.md) и в разделе **Имена входа и пользователи** статьи [Безопасность в базе данных SQL Azure: рекомендации и ограничения](sql-database-security-guidelines.md).

При использовании Azure Active Directory с георепликацией необходимо настроить администратора Azure Active Directory сервера-источника и сервера-получателя. Если администратор Azure Active Directory для сервера отсутствует, то пользователи, входящие в Active Directory, будут получать сообщение о невозможности подключиться к серверу.

> [AZURE.NOTE] Пользователи без учетной записи Azure AD (включая учетную запись администратора Azure SQL Server) не могут создавать пользователей на основе Azure AD, так как у них нет разрешения на проверку предложенных пользователей базы данных с помощью Azure AD.

### Подготовка администратора Azure Active Directory для сервера Azure SQL Server с помощью портала Azure

1. В правом верхнем углу [портала Azure](https://portal.azure.com/) щелкните имя подключения, чтобы открыть список доступных каталогов Active Directory. Выберите нужный экземпляр Active Directory в качестве Azure AD по умолчанию. С помощью этого шага можно связать подписку Active Directory с Azure SQL Server, чтобы одна и та же подписка использовалась для Azure AD и SQL Server. (На сервере Azure SQL Server может размещаться база данных SQL Azure или хранилище данных SQL Azure.)

	![choose-ad][8]
2. В области слева выберите **Серверы SQL Server**, выберите нужное значение **SQL Server**, а затем в верхней части колонки **SQL Server** щелкните **Параметры**.

	![параметры ad][9]
3. В колонке **Параметры** щелкните "Администратор Active Directory".
4. В колонке **Администратор Active Directory** щелкните **Администратор Active Directory**, а затем щелкните **Задать администратора** вверху.
5. В колонке **Добавление администратора** найдите пользователя, выберите пользователя (или группу), чтобы назначить его администратором, и щелкните **Выбрать**. (В колонке "Администратор Active Directory" отобразятся все участники и группы Active Directory. Пользователей или группы, которые выделены серым цветом, нельзя выбрать; они не поддерживаются ролью администратора Azure AD. См. список поддерживаемых администраторов в разделе **Функции и ограничения Azure AD** выше.) Управление доступом на основе ролей (RBAC) применяется только к порталу и не распространяется на SQL Server.
6. В верхней части колонки **Администратор Active Directory** нажмите кнопку **Сохранить**. ![выбор администратора][10]

	Изменение администратора может занять несколько минут. После этого новый администратор появится в поле **Администратор Active Directory**.

> [AZURE.NOTE] При настройке администратора Azure AD новое имя администратора (пользователя или группы) не может уже присутствовать в виртуальной базе данных master как пользователь аутентификации SQL Server. Если оно присутствует, настройка администратора Azure AD завершится ошибкой. Будет выполнен откат его создания и появится сообщение, что такой администратор (имя) уже существует. Такой пользователь аутентификации SQL Server не входит в Azure AD, поэтому любая попытка подключиться к серверу с помощью аутентификации Azure AD завершится сбоем.

Чтобы потом удалить учетную запись администратора, в верхней части колонки **Администратор Active Directory** щелкните **Удалить администратора**, а затем нажмите кнопку **Сохранить**.

### Подготовка администратора Azure AD для сервера Azure SQL Server с помощью PowerShell

Чтобы выполнять командлеты PowerShell, необходимо установить и запустить Azure PowerShell. Дополнительные сведения можно узнать в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md).

Чтобы подготовить администратора Azure AD, выполните следующие команды Azure PowerShell.

- Add-AzureRmAccount
- Select-AzureRmSubscription


Командлеты, используемые для подготовки администратора Azure AD и управления им:

| Имя командлета | Описание |
|---------------------------------------------------|-----------------------------------------------------------------------------------------------------------------|
| [Set-AzureRmSqlServerActiveDirectoryAdministrator](https://msdn.microsoft.com/library/azure/mt603544.aspx) | Выполняет подготовку учетной записи администратора Azure Active Directory для сервера Azure SQL Server или хранилища данных SQL Azure. (должен входить в текущую подписку). |
| [Remove-AzureRmSqlServerActiveDirectoryAdministrator](https://msdn.microsoft.com/library/azure/mt619340.aspx) | Удаляет учетную запись администратора Azure Active Directory для сервера Azure SQL Server или хранилища данных SQL Azure. |
| [Get-AzureRmSqlServerActiveDirectoryAdministrator](https://msdn.microsoft.com/library/azure/mt603737.aspx) | Возвращает сведения о текущем администраторе Azure Active Directory, настроенном для сервера Azure SQL Server или хранилища данных SQL Azure. |

Чтобы получить дополнительные сведения о каждой из этих команд, используйте команду PowerShell get-help, например ``get-help Set-AzureRmSqlServerActiveDirectoryAdministrator``.

Приведенный ниже сценарий выполняет подготовку группы администраторов Azure AD с именем **DBA\_Group** (идентификатор объекта `40b79501-b343-44ed-9ce7-da4c8cc7353f`) для сервера **demo\_server** в группе ресурсов с именем **Group-23**.

```
Set-AzureRmSqlServerActiveDirectoryAdministrator –ResourceGroupName "Group-23"
–ServerName "demo_server" -DisplayName "DBA_Group"
```

Входной параметр **DisplayName** принимает отображаемое имя Azure AD или имя участника-пользователя. Например, ``DisplayName="John Smith"`` и ``DisplayName="johns@contoso.com"``. Для групп Azure AD поддерживается только отображаемое имя Azure AD.

> [AZURE.NOTE] Команда Azure PowerShell ```Set-AzureRmSqlServerActiveDirectoryAdministrator``` не запрещает подготовку администраторов Azure AD для неподдерживаемых пользователей. Неподдерживаемого пользователя можно подготовить, но он не сможет подключиться к базе данных (См. список поддерживаемых администраторов в разделе **Функции и ограничения Azure AD** выше.)

В следующем примере используется необязательный параметр **ObjectID**:

```
Set-AzureRmSqlServerActiveDirectoryAdministrator –ResourceGroupName "Group-23"
–ServerName "demo_server" -DisplayName "DBA_Group" -ObjectId "40b79501-b343-44ed-9ce7-da4c8cc7353f"
```

> [AZURE.NOTE] Параметр **ObjectID** Azure AD является обязательным, если параметр **DisplayName** не уникален. Чтобы получить значения **ObjectID** и **DisplayName**, используйте раздел Active Directory классического портала Azure. Там можно просмотреть свойства пользователя или группы.

Следующий пример возвращает сведения о текущем администраторе Azure AD для сервера Azure SQL Server:

```
Get-AzureRmSqlServerActiveDirectoryAdministrator –ResourceGroupName "Group-23" –ServerName "demo_server" | Format-List
```

В примере ниже выполняется удаление администратора Azure AD.
```
Remove-AzureRmSqlServerActiveDirectoryAdministrator -ResourceGroupName "Group-23" –ServerName "demo_server"
```

Кроме того, можно подготовить администратора Azure Active Directory с помощью интерфейсов REST API. Дополнительные сведения см. в справочнике по REST API управления службами и статье [Операции для баз данных SQL Azure](https://msdn.microsoft.com/library/azure/dn505719.aspx).

## 5\. Настройка клиентских компьютеров

Приложения или пользователи подключаются к Базе данных SQL Azure или хранилищу данных SQL, используя удостоверения Azure AD, с клиентских компьютеров. На эти компьютеры необходимо установить указанное ниже программное обеспечение.

- .NET Framework 4.6 или более поздней версии можно скачать на веб-странице [https://msdn.microsoft.com/library/5a4x27ek.aspx](https://msdn.microsoft.com/library/5a4x27ek.aspx).
- Библиотека аутентификации Azure Active Directory для SQL Server (**ADALSQL.DLL**) доступна на нескольких языках (версии x86 и amd64) в центре загрузки в [библиотеке аутентификации Microsoft Active Directory для Microsoft SQL Server](http://www.microsoft.com/download/details.aspx?id=48742).

### Средства

- Установка [SQL Server 2016 Management Studio](https://msdn.microsoft.com/library/mt238290.aspx) или [SQL Server Data Tools для Visual Studio 2015](https://msdn.microsoft.com/library/mt204009.aspx) соответствует требованиям .NET Framework 4.6.
- SSMS устанавливает **ADALSQL.DLL** версии x86.
- SSDT устанавливает **ADALSQL.DLL** версии amd64.
- Последняя версия Visual Studio со страницы [скачивания Visual Studio](https://www.visualstudio.com/downloads/download-visual-studio-vs) соответствует требованиям .NET Framework 4.6, но не устанавливает необходимую версию amd64 **ADALSQL.DLL**.

## 6\. Создание пользователей автономной базы данных в базе данных, сопоставленной с удостоверениями Azure AD

### Сведения о пользователях автономной базы данных

Для проверки подлинности Azure Active Directory необходимо, чтобы пользователи базы данных создавались как пользователи автономной базы данных. Пользователь автономной базы данных на основе удостоверения Azure AD —это пользователь, у которого нет имени для входа в базу данных master и который сопоставляется с удостоверением в каталоге Azure AD, связанном с базой данных. Удостоверение Azure AD может быть учетной записью отдельного пользователя или группы. Дополнительные сведения о пользователях автономной базы данных см. в статье [Пользователи автономной базы данных — создание переносимой базы данных](https://msdn.microsoft.com/library/ff929188.aspx).

> [AZURE.NOTE] Пользователей базы данных (за исключением администраторов) невозможно создавать с помощью портала. Роли RBAC не распространяются в SQL Server, Базу данных SQL или хранилище данных SQL. Роли Azure RBAC используются для управления ресурсами Azure и не относятся к разрешениям базы данных. Например, роль **Участник SQL Server** не предоставляет разрешение на подключение к Базе данных SQL или хранилищу данных SQL. Разрешение доступа должно быть предоставлено непосредственно в базе данных с помощью инструкций Transact-SQL.

### Подключение к базе данных пользователя или хранилищу данных с помощью SQL Server Management Studio или SQL Server Data Tools

Чтобы убедиться, что администратор Azure AD настроен правильно, подключитесь к базе данных **master** с помощью учетной записи администратора Azure AD. Вы можете подготовить пользователя автономной базы данных, использующей Azure AD (кроме администратора сервера, который является владельцем базы данных). Для этого подключитесь к базе данных с помощью удостоверения Azure AD, у которого есть доступ к базе данных.

> [AZURE.IMPORTANT] Проверку подлинности Azure Active Directory поддерживают [SQL Server 2016 Management Studio](https://msdn.microsoft.com/library/mt238290.aspx) и [SQL Server Data Tools](https://msdn.microsoft.com/library/mt204009.aspx) для Visual Studio 2015. Выпуск SSMS за август 2016 года также включает в себя поддержку универсальной аутентификации Active Directory, что позволяет администраторам требовать прохождения Multi-Factor Authentication с помощью телефонного звонка, текстового сообщения, смарт-карты с ПИН-кодом или уведомления в мобильном приложении.

#### Подключение с помощью встроенной проверки подлинности Active Directory

Этот метод следует использовать, если вы входите в систему Windows с помощью учетных данных Azure Active Directory из федеративного домена.

1. Запустите Management Studio или Data Tools и в диалоговом окне **Подключение к серверу** (или **Подключиться к ядру СУБД**) в поле **Проверка подлинности** выберите пункт **Встроенная проверка подлинности Active Directory**. Пароль не требуется (и его нельзя ввести), так как для подключения используются существующие учетные данные. ![Выбор встроенной аутентификации Active Directory][11]

2. Нажмите кнопку **Параметры**, и на странице **Свойства подключения** в поле **Подключение к базе данных** введите имя пользовательской базы данных для подключения. ![Выбор имени базы данных][13]


#### Подключение с помощью проверки пароля Active Directory

Используйте этот метод при подключении с помощью имени участника Azure AD, в котором используется управляемый домен Azure AD. Его также можно использовать для федеративной учетной записи без доступа к домену, например при удаленной работе.

Используйте этот метод, если вы вошли в Windows, используя учетные данные домена, для которого не настроена федерация с Azure. Или если используете аутентификацию Azure AD с помощью Azure AD на основе исходного домена или домена клиента.

1. Запустите Management Studio или Data Tools и в диалоговом окне **Подключение к серверу** (или **Подключиться к ядру СУБД**) в поле **Проверка подлинности** выберите пункт **Проверка пароля Active Directory**.
2. В поле **Имя пользователя** введите имя пользователя Azure Active Directory в формате **username@domain.com**. Это должна быть учетная запись из Azure Active Directory или учетная запись из федерации домена с Azure Active Directory.
3. В поле **Пароль** введите пароль пользователя для учетной записи Azure Active Directory или учетной записи федеративного домена. ![Выбор проверки пароля Active Directory][12]

4. Нажмите кнопку **Параметры**, и на странице **Свойства подключения** в поле **Подключение к базе данных** введите имя пользовательской базы данных для подключения. (См. рисунок в предыдущем варианте.)


### Создание пользователя автономной базы данных Azure AD в пользовательской базе данных

Вы можете создать пользователя автономной базы данных на основе Azure AD (кроме администратора сервера, который является владельцем базы данных). Для этого подключитесь к базе данных с помощью удостоверения Azure AD от имени пользователя с уровнем разрешений не ниже, чем **ИЗМЕНЕНИЕ ЛЮБОГО ПОЛЬЗОВАТЕЛЯ**. Затем используйте следующий синтаксис Transact-SQL:

	CREATE USER <Azure_AD_principal_name>
	FROM EXTERNAL PROVIDER;


Значением параметра *Azure\_AD\_principal\_name* может быть имя участника-пользователя Azure AD или отображаемое имя группы Azure AD.

**Примеры.** Создание пользователя автономной базы данных, представляющего собой пользователя федеративного или управляемого домена Azure AD:

	CREATE USER [bob@contoso.com] FROM EXTERNAL PROVIDER;
	CREATE USER [alice@fabrikam.onmicrosoft.com] FROM EXTERNAL PROVIDER;

Чтобы создать пользователя автономной базы данных, представляющего собой группу Azure AD или группу федеративного домена, укажите отображаемое имя группы безопасности.

	CREATE USER [ICU Nurses] FROM EXTERNAL PROVIDER;

Чтобы создать пользователя автономной базы данных, который представляет приложение и будет подключаться с помощью маркера Azure AD, выполните следующее.

	CREATE USER [appName] FROM EXTERNAL PROVIDER;

Подробнее о создании пользователей автономной базы данных на основе удостоверений Azure Active Directory см. в статье [СОЗДАНИЕ ПОЛЬЗОВАТЕЛЯ (Transact-SQL)](http://msdn.microsoft.com/library/ms173463.aspx).


> [AZURE.NOTE] Если удалить учетную запись администратора Azure Active Directory на сервере SQL Azure, все прошедшие проверку подлинности пользователи Azure AD не смогут подключиться к серверу. При необходимости администратор Базы данных SQL может вручную удалить неиспользуемых пользователей Azure AD.

При создании пользователя базы данных пользователь получает разрешение **ПОДКЛЮЧЕНИЕ** и может подключаться к этой базе данных как участник роли **PUBLIC**. Изначально пользователю доступны только разрешения, предоставленные для роли **PUBLIC**, или любые разрешения, предоставленные любой группе Windows, в которую входит пользователь. Подготовив пользователя автономной базы данных, использующей Azure AD, можно предоставить ему дополнительные разрешения — так же, как разрешения для любого другого типа пользователя. Обычно разрешения предоставляются ролям базы данных, а затем эти роли назначаются пользователям. Подробнее об этом см. в статье [Основные сведения о разрешениях ядра СУБД](http://social.technet.microsoft.com/wiki/contents/articles/4433.database-engine-permission-basics.aspx). Дополнительные сведения о специальных ролях базы данных SQL см. в статье [Управление базами данных и учетными записями в базе данных SQL Azure](sql-database-manage-logins.md). Пользователь федеративного домена, импортируемый в управляемый домен, должен использовать идентификатор управляемого домена.

> [AZURE.NOTE] Пользователи Azure AD помечаются в метаданных базы данных как тип E (EXTERNAL\_USER), а группы — как тип X (EXTERNAL\_GROUPS). Дополнительные сведения см. в статье [sys.database\_principals](https://msdn.microsoft.com/library/ms187328.aspx).


## 7\. Подключение с использованием удостоверений Azure AD

Проверка подлинности Azure Active Directory поддерживает следующие способы подключения к базе данных с помощью удостоверений Azure AD:

- с использованием встроенной проверки подлинности Windows;
- Использование имени субъекта-пользователя и пароля Azure AD
- Использование маркера проверки подлинности приложения

### 7\.1. Подключение с использованием встроенной проверки подлинности (Windows)

Для использования встроенной проверки подлинности Windows необходимо включить в федерацию Active Directory вашего домена и Azure Active Directory. Клиентское приложение (или служба), подключающееся к базе данных, должно быть запущено на компьютере, присоединенном к домену, с учетными данными пользователя домена.

Чтобы подключиться к базе данных с помощью встроенной проверки подлинности и удостоверения Azure AD, ключевое слово проверки подлинности в строке подключения к базе данных должно иметь значение «Active Directory Integrated». В следующем примере кода C# используется ADO .NET.

	string ConnectionString =
	@"Data Source=n9lxnyuzhv.database.windows.net; Authentication=Active Directory Integrated; Initial Catalog=testdb;";
	SqlConnection conn = new SqlConnection(ConnectionString);
	conn.Open();

Обратите внимание, что ключевое слово ``Integrated Security=True`` строки подключения не используется для подключения к базе данных SQL Azure. Обратите внимание, что при создании подключения ODBC потребуется удалить пробелы и задать для параметра Authentication значение ActiveDirectoryIntegrated.

### 7\.2. Подключение с использованием имени участника-пользователя и пароля Azure AD
Чтобы подключиться к базе данных с помощью встроенной аутентификации и удостоверения Azure AD, ключевому слову аутентификации нужно присвоить пароль Active Directory. Строка подключения должна содержать ключевые слова для идентификатора пользователя (UID) и пароля (PWD), а также их значения. В следующем примере кода C# используется ADO .NET.

	string ConnectionString =
	  @"Data Source=n9lxnyuzhv.database.windows.net; Authentication=Active Directory Password; Initial Catalog=testdb;  UID=bob@contoso.onmicrosoft.com; PWD=MyPassWord!";
	SqlConnection conn = new SqlConnection(ConnectionString);
	conn.Open();

Дополнительные сведения о методах проверки подлинности Azure AD и примеры кода вы найдете в [демонстрации проверки подлинности Azure AD на GitHub](https://github.com/Microsoft/sql-server-samples/tree/master/samples/features/security/azure-active-directory-auth).


### 7\.3. Подключение с помощью маркера Azure AD
Этот метод проверки подлинности позволяет службам среднего уровня подключаться к базе данных SQL Azure или хранилищу данных SQL Azure путем получения маркера из Azure Active Directory (AAD). Он используется для реализации сложных сценариев, включая проверку подлинности на основе сертификатов. Для работы с проверкой подлинности маркера Azure AD необходимо выполнить четыре основных шага.

1. Зарегистрируйте приложение в Azure Active Directory и получите идентификатор клиента для кода.
2. Создайте пользователя базы данных, представляющего приложение. (Выполнено ранее на шаге 6.)
3. Создайте сертификат на клиентском компьютере, на котором выполняется приложение.
4. Добавьте сертификат в качестве ключа для вашего приложения.

Пример строки подключения.

```
string ConnectionString =@"Data Source=n9lxnyuzhv.database.windows.net; Initial Catalog=testdb;"
SqlConnection conn = new SqlConnection(ConnectionString);
connection.AccessToken = "Your JWT token"
conn.Open();
```

Дополнительные сведения см. в [блоге о безопасности SQL Server](https://blogs.msdn.microsoft.com/sqlsecurity/2016/02/09/token-based-authentication-support-for-azure-sql-db-using-azure-ad-auth/).

### Подключение с помощью sqlcmd  
Ниже приведены инструкции для подключения с помощью sqlcmd версии 13.1, доступной в [Центре загрузки](http://go.microsoft.com/fwlink/?LinkID=825643).

```
sqlcmd -S Target_DB_or_DW.testsrv.database.windows.net  -G  
sqlcmd -S Target_DB_or_DW.testsrv.database.windows.net -U bob@contoso.com -P MyAADPassword -G -l 30
```

## Дополнительные материалы

[Управление базами данных и учетными записями в базе данных SQL Azure](sql-database-manage-logins.md)

[Пользователи автономной базы данных](https://msdn.microsoft.com/library/ff929071.aspx)

[СОЗДАНИЕ ПОЛЬЗОВАТЕЛЯ (Transact-SQL)](http://msdn.microsoft.com/library/ms173463.aspx)


<!--Image references-->

[1]: ./media/sql-database-aad-authentication/1aad-auth-diagram.png
[2]: ./media/sql-database-aad-authentication/2subscription-relationship.png
[3]: ./media/sql-database-aad-authentication/3admin-structure.png
[4]: ./media/sql-database-aad-authentication/4select-subscription.png
[5]: ./media/sql-database-aad-authentication/5ad-settings-portal.png
[6]: ./media/sql-database-aad-authentication/6edit-directory-select.png
[7]: ./media/sql-database-aad-authentication/7edit-directory-confirm.png
[8]: ./media/sql-database-aad-authentication/8choose-ad.png
[9]: ./media/sql-database-aad-authentication/9ad-settings.png
[10]: ./media/sql-database-aad-authentication/10choose-admin.png
[11]: ./media/sql-database-aad-authentication/11connect-using-int-auth.png
[12]: ./media/sql-database-aad-authentication/12connect-using-pw-auth.png
[13]: ./media/sql-database-aad-authentication/13connect-to-db.png

<!---HONumber=AcomDC_0921_2016-->