<properties
 pageTitle="Метаданные сведений об устройстве в решении для удаленного мониторинга | Microsoft Azure"
 description="Описание предварительно настроенного решения удаленного мониторинга Azure IoT и его архитектура."
 services=""
 suite="iot-suite"
 documentationCenter=""
 authors="dominicbetts"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-suite"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="09/12/2016"
 ms.author="dobett"/>

# Метаданные сведений об устройстве в предварительно настроенном решении для удаленного мониторинга

В предварительно настроенном решении для удаленного мониторинга Azure IoT Suite демонстрируется, как управлять метаданными устройства. В этой статье описан подход, применяемый в этом решении. Он позволяет понять следующее:

- какие метаданные устройства хранятся в решении;
- как решение управляет метаданными устройства.

## Context

Предварительно настроенное решение для удаленного мониторинга использует [центр IoT Azure][lnk-iot-hub], чтобы позволить устройствам отправлять данные в облако. Центр IoT включает [реестр удостоверений устройств][lnk-identity-registry] для управления доступом к центру IoT. Этот реестр не связан с *реестром устройств* решения для удаленного мониторинга, в котором хранятся метаданные сведений об устройстве. Чтобы внедрить свой реестр устройств для хранения метаданных сведений об устройстве, решение для удаленного мониторинга использует базу данных [DocumentDB][lnk-docdb]. В документе [Microsoft Azure IoT Reference Architecture][lnk-ref-arch] \(Эталонная архитектура Microsoft Azure IoT) описывается роль реестра устройств в стандартном решении IoT.

> [AZURE.NOTE] Предварительно настроенное решение для удаленного мониторинга обеспечивает синхронизацию реестра удостоверений устройств и реестра устройства. И в том, и в другом используется один и тот же идентификатор устройства для уникальной идентификации каждого устройства, подключенного к центру IoT.

В [предварительной версии управления устройствами центра IoT][lnk-dm-preview] в центр IoT добавляются функции, похожие на функции управления сведениями об устройствах, описанные в этой статье. В настоящее время решение для удаленного мониторинга использует только общедоступные функции в центре IoT.

## Метаданные сведений об устройстве

Ниже представлена структура документа JSON с метаданными сведений об устройстве, хранящегося в базе данных DocumentDB в реестре устройств:

```
{
  "DeviceProperties": {
    "DeviceID": "deviceid1",
    "HubEnabledState": null,
    "CreatedTime": "2016-04-25T23:54:01.313802Z",
    "DeviceState": "normal",
    "UpdatedTime": null
    },
  "SystemProperties": {
    "ICCID": null
  },
  "Commands": [],
  "CommandHistory": [],
  "IsSimulatedDevice": false,
  "id": "fe81a81c-bcbc-4970-81f4-7f12f2d8bda8"
}
```

- **DeviceProperties** — устройство записывает эти свойства и оно же является источником этих данных. К другим свойствам устройства относятся производитель, номер модели и серийный номер.
- **DeviceID** — уникальный идентификатор устройства. Это значение соответствует значению в реестре удостоверений устройств в центре IoT.
- **HubEnabledState** — состояние устройства в центре IoT. До первого подключения устройства для этого параметра задано значение **NULL**. На портале решения значение **NULL** интерпретируется так: устройство зарегистрировано, но отсутствует.
- **CreatedTime** — время создания устройства.
- **DeviceState** — состояние, сообщаемое устройством.
- **UpdatedTime** — время последнего обновления устройства на портале решения.
- **SystemProperties** — портал решения записывает системные свойства, о которых устройство не имеет сведений. В качестве примера системного свойства можно привести **ICCID**, если решение авторизовано в службе, управляющей устройствами с поддержкой SIM-карт, и подключено к ней.
- **Commands** — список команд, поддерживаемых устройством. Устройство отправляет эти сведения решению.
- **CommandHistory** — список команд, которые решение для удаленного мониторинга отправило устройству, и их состояние.
- **IsSimulatedDevice** — флаг, определяющий, что устройство является имитацией устройства.
- **id** — уникальный идентификатор DocumentDB для этого документа устройства.

> [AZURE.NOTE] Сведения об устройстве могут также включать метаданные, описывающие данные телеметрии, которые устройство отправляет в центр IoT. Решение для удаленного мониторинга использует эти метаданные телеметрии, чтобы настроить отображение [динамической телеметрии][lnk-dynamic-telemetry] на панели мониторинга.

## Жизненный цикл

При создании устройства на портале впервые решение создает запись в реестре устройств, как показано ранее. Изначально для большей части сведений создаются заглушки, а для параметра **HubEnabledState** задается значение **NULL**. На этом этапе решение также формирует запись для устройства в реестре удостоверений устройств, которая создает ключи. Устройство использует их для аутентификации в центре IoT.

При первом подключении к решению устройство отправляет сообщение с соответствующими сведениями. В этом сообщении содержатся свойства устройства, например производитель, номер модели и серийный номер. Кроме того, в нем содержится список команд, которые поддерживает устройство, а также сведения о всех параметрах этих команд. При получении этого сообщения в реестре устройств решения обновляются метаданные сведений об устройстве.

### Просмотр и изменение сведений об устройстве на портале решения

В списке устройств на портале решения отображаются следующие свойства устройства в виде столбцов: **Состояние**, **Идентификатор устройства**, **Производитель**, **Номер модели**, **Серийный номер**, **Встроенное ПО**, **Платформа**, **Процессор** и **Установлено ОЗУ**. Такие свойства устройства, как **Широта** и **Долгота**, управляют расположением на карте Bing на панели мониторинга.

![Список устройств][img-device-list]

Если щелкнуть **Изменить** в области **Сведения об устройстве** на портале решения, можно изменить все перечисленные выше свойства. Изменение этих свойств приведет к обновлению записи устройства в базе данных DocumentDB. Тем не менее, если устройство отправляет сообщение с обновленными сведениями об устройстве, оно перезаписывает любые изменения, внесенные на портале решения. На портале решения нельзя изменить свойства **Идентификатор устройства**, **Имя узла**, **HubEnabledState**, **CreatedTime**, **DeviceState** и **UpdatedTime**, так как только устройство может изменять их.

![Изменение устройств][img-device-edit]

На портале решения можно удалить устройство из решения. При этом решение удаляет метаданные сведений об устройстве из реестра устройств решения, а также запись устройства из реестра удостоверений устройств в центре IoT. Перед удалением устройства его необходимо отключить.

![Удаление устройств][img-device-remove]

## Обработка сообщений со сведениями об устройстве

Сообщения со сведениями об устройстве, отправляемые устройством, отличаются от сообщений телеметрии. Сообщения со сведениями об устройстве содержат информацию о свойствах устройства, командах, на которые может реагировать устройство, и журнал команд. В центре IoT отсутствуют сведения о метаданных в сообщении со сведениями об устройстве. Он обрабатывает такое сообщение так же, как и все сообщения, отправляемые с устройства в облако. В решении для удаленного мониторинга задание [Azure Stream Analytics][lnk-stream-analytics] \(ASA) считывает сообщения из центра IoT. Задание **DeviceInfo** Stream Analytics отфильтровывает сообщения, содержащие фрагмент кода **"ObjectType": "DeviceInfo"**, и пересылает их экземпляру узла **EventProcessorHost**, выполняющемуся в веб-задании. Логика в экземпляре **EventProcessorHost** использует идентификатор устройства, чтобы найти запись DocumentDB для конкретного устройства и обновить ее. Теперь в записи реестра устройства есть сведения о свойствах и командах устройства, а также журнал команд.

> [AZURE.NOTE] Сообщение со сведениями об устройстве — это стандартное сообщение, отправляемое с устройства в облако. Решение различает сообщения со сведениями об устройстве и сообщения с телеметрией с помощью запросов ASA.

## Пример записей со сведениями об устройстве

Предварительно настроенное решение для удаленного мониторинга использует два типа записей со сведениями об устройстве: записи для виртуальных устройств, развертываемых в решении, и записи для пользовательских устройств, подключаемых к решению.

### Виртуальное устройство

В следующем примере показана запись со сведениями об устройстве в формате JSON для виртуального устройства. В ней содержится параметр **UpdatedTime** с заданным значением, которое указывает, что устройство отправило сообщение **DeviceInfo** в центр IoT. Запись содержит несколько общих свойств устройства и определяет шесть команд, поддерживаемых виртуальным устройством. Кроме того, для флага **IsSimulatedDevice** в этой записи задано значение **1**.

```
{
  "DeviceProperties": {
    "DeviceID": "SampleDevice001_455",
    "HubEnabledState": true,
    "CreatedTime": "2016-01-26T19:02:01.4550695Z",
    "DeviceState": "normal",
    "UpdatedTime": "2016-06-01T15:28:41.8105157Z",
    "Manufacturer": "Contoso Inc.",
    "ModelNumber": "MD-369",
    "SerialNumber": "SER9009",
    "FirmwareVersion": "1.39",
    "Platform": "Plat-34",
    "Processor": "i3-2191",
    "InstalledRAM": "3 MB",
    "Latitude": 47.583582,
    "Longitude": -122.130622
  },
  "Commands": [
    {
      "Name": "PingDevice",
      "Parameters": null
    },
    {
      "Name": "StartTelemetry",
      "Parameters": null
    },
    {
      "Name": "StopTelemetry",
      "Parameters": null
    },
    {
      "Name": "ChangeSetPointTemp",
      "Parameters": [
        {
          "Name": "SetPointTemp",
          "Type": "double"
        }
      ]
    },
    {
      "Name": "DiagnosticTelemetry",
      "Parameters": [
        {
          "Name": "Active",
          "Type": "boolean"
        }
      ]
    },
    {
      "Name": "ChangeDeviceState",
      "Parameters": [
        {
          "Name": "DeviceState",
          "Type": "string"
        }
      ]
    }
  ],
  "CommandHistory": [],
  "IsSimulatedDevice": 1,
  "Version": "1.0",
  "ObjectType": "DeviceInfo",
  "IoTHub": {
    "MessageId": null,
    "CorrelationId": null,
    "ConnectionDeviceId": "SampleDevice001_455",
    "ConnectionDeviceGenerationId": "635894317219942540",
    "EnqueuedTime": "0001-01-01T00:00:00",
    "StreamId": null
  },
  "SystemProperties": {
    "ICCID": null
  },
  "id": "7101c002-085f-4954-b9aa-7466980a2aaf"
}
```

### Пользовательское устройство

В следующем примере показана запись со сведениями об устройстве в формате JSON для пользовательского устройства. Для флага **IsSimulatedDevice** установлено значение **0**. Как видите, это пользовательское устройство поддерживает две команды, а устройству отправлена команда **SetTemperature** с портала решения.

```
{
  "DeviceProperties": {
    "DeviceID": "mydevice01",
    "HubEnabledState": true,
    "CreatedTime": "2016-03-28T21:05:06.6061104Z",
    "DeviceState": "normal",
    "UpdatedTime": "2016-06-07T22:05:34.2802549Z"
  },
  "SystemProperties": {
    "ICCID": null
  },
  "Commands": [
    {
      "Name": "SetHumidity",
      "Parameters": [
        {
          "Name": "humidity",
          "Type": "int"
        }
      ]
    },
    {
      "Name": "SetTemperature",
      "Parameters": [
        {
          "Name": "temperature",
          "Type": "int"
        }
      ]
    }
  ],
  "CommandHistory": [
    {
      "Name": "SetTemperature",
      "MessageId": "2a0cec61-5eca-4de7-92dc-9c0bc4211c46",
      "CreatedTime": "2016-06-07T21:05:18.140796Z",
      "Parameters": {
        "temperature": 20
      },
      "UpdatedTime": "2016-06-07T21:05:18.716076Z",
      "Result": "Expired"
    }
  ],
  "IsSimulatedDevice": 0,
  "id": "6184ae0f-2d94-4fbd-91cd-4b193aecc9d1",
  "ObjectType": "DeviceInfo",
  "Version": "1.0",
  "IoTHub": {
    "MessageId": null,
    "CorrelationId": null,
    "ConnectionDeviceId": "SampleCustom",
    "ConnectionDeviceGenerationId": "635947959068246845",
    "EnqueuedTime": "0001-01-01T00:00:00",
    "StreamId": null
  }
}
```

Ниже приведено сообщение **DeviceInfo** JSON, отправленное устройством для обновления метаданных сведений об устройстве.

```
{ "ObjectType":"DeviceInfo",
  "Version":"1.0",
  "IsSimulatedDevice":false,
  "DeviceProperties": { "DeviceID":"mydevice01", "HubEnabledState":true },
  "Commands": [
    {"Name":"SetHumidity", "Parameters":[{"Name":"humidity","Type":"double"}]},
    {"Name":"SetTemperature", "Parameters":[{"Name":"temperature","Type":"double"}]}
  ]
}
```

## Дальнейшие действия

Теперь когда вы знаете, как менять параметры предварительно настроенных решений IoT Suite, можете ознакомиться с другими функциями и возможностями таких решений:

- [Обзор предварительно настроенного решения прогнозного обслуживания][lnk-predictive-overview]
- [Часто задаваемые вопросы об IoT Suite][lnk-faq]
- [Все аспекты безопасности IoT][lnk-security-groundup]



<!-- Images and links -->
[img-device-list]: media/iot-suite-remote-monitoring-device-info/image1.png
[img-device-edit]: media/iot-suite-remote-monitoring-device-info/image2.png
[img-device-remove]: media/iot-suite-remote-monitoring-device-info/image3.png

[lnk-iot-hub]: https://azure.microsoft.com/documentation/services/iot-hub/
[lnk-identity-registry]: ../iot-hub/iot-hub-devguide.md#device-identity-registry
[lnk-docdb]: https://azure.microsoft.com/documentation/services/documentdb/
[lnk-ref-arch]: http://download.microsoft.com/download/A/4/D/A4DAD253-BC21-41D3-B9D9-87D2AE6F0719/Microsoft_Azure_IoT_Reference_Architecture.pdf
[lnk-stream-analytics]: https://azure.microsoft.com/documentation/services/stream-analytics/
[lnk-dm-preview]: ../iot-hub/iot-hub-device-management-overview.md
[lnk-dynamic-telemetry]: iot-suite-dynamic-telemetry.md

[lnk-predictive-overview]: iot-suite-predictive-overview.md
[lnk-faq]: iot-suite-faq.md
[lnk-security-groundup]: securing-iot-ground-up.md

<!---HONumber=AcomDC_0914_2016-->