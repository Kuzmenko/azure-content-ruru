<properties
	pageTitle="Использование динамической телеметрии | Microsoft Azure"
	description="Ознакомьтесь с этим учебником, чтобы узнать, как использовать динамическую телеметрию с предварительно настроенным решением для удаленного мониторинга."
	services=""
    suite="iot-suite"
	documentationCenter=""
	authors="dominicbetts"
	manager="timlt"
	editor=""/>

<tags
     ms.service="iot-suite"
     ms.devlang="na"
     ms.topic="article"
     ms.tgt_pltfrm="na"
     ms.workload="na"
     ms.date="08/25/2016"
     ms.author="dobett"/>

# Использование динамической телеметрии с предварительно настроенным решением для удаленного мониторинга

## Введение

Динамическая телеметрия позволяют визуализировать любые данные телеметрии, отправленные в предварительно настроенное решение для удаленного мониторинга. Имитации устройств, развертываемые вместе с предварительно настроенным решением, отправляют данные телеметрии температуры и влажности, которые можно отобразить на панели мониторинга. Если настроить существующие имитации устройств, создать новые имитации устройств или подключить физические устройства к предварительно настроенному решению, то это позволит отправлять другие значения телеметрии, такие как внешняя температура, число оборотов в минуту или скорость ветра. Затем эти дополнительные данные телеметрии можно будет визуализировать на панели мониторинга.

В этом учебнике используется простая имитация устройства Node.js, которую можно легко изменить для экспериментов с динамической телеметрией.

Чтобы завершить этот учебник, потребуется следующее.

- Активная подписка Azure. Если ее нет, можно создать бесплатную пробную учетную запись всего за несколько минут. Дополнительные сведения см. в разделе [Бесплатная пробная версия Azure][lnk_free_trial].
- [Node.js][lnk-node] 0.12.x или более поздней версии.

Этот учебник подходит для любой операционной системы, например Windows или Linux, в которой можно установить Node.js.

[AZURE.INCLUDE [iot-suite-provision-remote-monitoring](../../includes/iot-suite-provision-remote-monitoring.md)]

## Настройка имитации устройства Node.js

1. На панели удаленного мониторинга щелкните **+ Add a device** (+ Добавить устройство), затем добавьте пользовательское устройство. Запишите имя узла центра IoT, идентификатор устройства и ключ устройства. Они потребуются позже, при подготовке клиентского приложения устройства remote\_monitoring.js.

2. Убедитесь, что на компьютере разработки установлен компонент Node.js 0.12.x или более поздняя версия. Выполните команду `node --version` в командной строке или оболочке, чтобы проверить версию. Сведения об использовании диспетчера пакетов для установки Node.js в Linux см. в разделе [Installing Node.js via package manage][node-linux] \(Установка Node.js с помощью диспетчера пакетов).

3. После установки Node.js клонируйте последнюю версию репозитория [azure-iot-sdks][lnk-github-repo] на свой компьютер разработки. Всегда используйте ветвь **master**, чтобы получать последние версии библиотек и примеров.

4. Из папки node/device/samples в локальной копии репозитория [azure-iot-sdks][lnk-github-repo] скопируйте в пустую папку на компьютере разработки следующие два файла.

  - packages.json
  - remote\_monitoring.js

5. Откройте файл remote\_monitoring.js и найдите следующее определение переменной.

    ```
    var connectionString = "[IoT Hub device connection string]";
    ```

6. Замените **[IoT Hub device connection string]** строкой подключения устройства. Используйте значения имени узла центра IoT, идентификатора устройства и ключа устройства, которые вы записали на шаге 1. Строка подключения имеет следующий формат:

    ```
    HostName={your IoT Hub hostname};DeviceId={your device id};SharedAccessKey={your device key}
    ```

    Если имя узла центра IoT — **contoso**, а идентификатор устройства — **mydevice**, то строка подключения будет выглядеть следующим образом.

    ```
    var connectionString = "HostName=contoso.azure-devices.net;DeviceId=mydevice;SharedAccessKey=2s ... =="
    ```

7. Сохраните файл. Выполните следующие команды в оболочке или командной строке в папке, содержащей эти файлы, для установки необходимых пакетов, а затем запустите пример приложения.

    ```
    npm install
    node remote_monitoring.js
    ```

## Наблюдение динамической телеметрии в действии

На панели мониторинга отображаются данные телеметрии температуры и влажности из существующих имитаций устройств.

![Панель мониторинга по умолчанию][image1]

Если выбрать имитацию устройства Node.js, которая запускалась в предыдущем разделе, отобразятся данные телеметрии температуры, влажности и внешней температуры.

![Добавление значения внешней температуры на панель мониторинга][image2]

Решение для удаленного мониторинга автоматически определяет тип дополнительных данных телеметрии внешней температуры и добавляет их на диаграмму на панели мониторинга.

## Добавление типа данных телеметрии

Следующий шаг — заменить данные телеметрии, созданные имитацией устройства Node.js, новым набором значений.

1. Остановите имитацию устройства Node.js, нажав клавиши **Ctrl+C** в командной строке или оболочке.

2. В файле remote\_monitoring.js можно увидеть базовые значения для существующих данных телеметрии температуры, влажности и внешней температуры. Добавьте базовое значение данных для **rpm** следующим образом.

    ```
    // Sensors data
    var temperature = 50;
    var humidity = 50;
    var externalTemperature = 55;
    var rpm = 200;
    ```

3. Имитация устройства Node.js добавляет случайное приращение базовых значений данных с помощью функции **generateRandomIncrement**, определенной в файле remote\_monitoring.js. Рандомизируйте значение **rpm**, добавив строку кода после существующего кода рандомизации следующим образом.

    ```
    temperature += generateRandomIncrement();
    externalTemperature += generateRandomIncrement();
    humidity += generateRandomIncrement();
    rpm += generateRandomIncrement();
    ```

4. Добавьте новое значение rpm в полезные данные JSON, которые устройство отправляет в центр IoT.

    ```
    var data = JSON.stringify({
      'DeviceID': deviceId,
      'Temperature': temperature,
      'Humidity': humidity,
      'ExternalTemperature': externalTemperature,
      'RPM': rpm
    });
    ```

5. Запустите имитацию устройства Node.js с помощью следующей команды.

    ```
    node remote_monitoring.js
    ```

6. Вы увидите новый тип данных телеметрии RPM на диаграмме на панели мониторинга.

![Добавление значения оборотов в секунду на панель мониторинга][image3]

> [AZURE.NOTE] Может потребоваться отключить и снова включить устройство Node.js на странице **Устройства** на панели мониторинга, чтобы немедленно отобразить изменения.

## Настройка отображения панели мониторинга

Сообщение **Device-Info** может содержать метаданные о данных телеметрии, которые устройство может отправлять в центр IoT. В этих метаданных могут быть указаны типы данных телеметрии, отправляемых устройством. Измените значение **deviceMetaData** в файле remote\_monitoring.js, чтобы добавить определение **Telemetry** после определения **Commands**. Определение **Commands** показано в следующем фрагменте кода (не забудьте добавить `,` после определения **Commands**.

```
'Commands': [{
  'Name': 'SetTemperature',
  'Parameters': [{
    'Name': 'Temperature',
    'Type': 'double'
  }]
},
{
  'Name': 'SetHumidity',
  'Parameters': [{
    'Name': 'Humidity',
    'Type': 'double'
  }]
}],
'Telemetry': [{
  'Name': 'Temperature',
  'Type': 'double'
},
{
  'Name': 'Humidity',
  'Type': 'double'
},
{
  'Name': 'ExternalTemperature',
  'Type': 'double'
}]
```

> [AZURE.NOTE] Решение для удаленного мониторинга проверяет соответствие регистра при сравнении определения метаданных с информацией в потоке данных телеметрии.

Добавление определения **Telemetry**, показанное в предыдущем фрагменте кода, не изменяет поведение панели мониторинга. Тем не менее метаданные также могут содержать атрибут **DisplayName** для настройки отображения на панели мониторинга. Измените определение метаданных **Telemetry**, как показано во фрагменте кода ниже.

```
'Telemetry': [
{
  'Name': 'Temperature',
  'Type': 'double',
  'DisplayName': 'Temperature (C*)'
},
{
  'Name': 'Humidity',
  'Type': 'double',
  'DisplayName': 'Humidity (relative)'
},
{
  'Name': 'ExternalTemperature',
  'Type': 'double',
  'DisplayName': 'Outdoor Temperature (C*)'
}
]
```

На следующем снимке экрана показано, как это изменение меняет легенду диаграммы на панели мониторинга.

![Настройка легенды диаграммы][image4]

> [AZURE.NOTE] Может потребоваться отключить и снова включить устройство Node.js на странице **Устройства** на панели мониторинга, чтобы немедленно отобразить изменения.

## Фильтрация типов данных телеметрии

По умолчанию диаграмма на панели мониторинга отображает каждый ряд данных в потоке данных телеметрии. Можно использовать метаданные **Device-Info**, чтобы подавить вывод определенных типов данных телеметрии на диаграмме.

Чтобы на диаграмме отображались только данные телеметрии температуры и влажности, опустите **ExternalTemperature** в метаданных **Telemetry** для **Device-Info**, как показано ниже.

```
'Telemetry': [
{
  'Name': 'Temperature',
  'Type': 'double',
  'DisplayName': 'Temperature (C*)'
},
{
  'Name': 'Humidity',
  'Type': 'double',
  'DisplayName': 'Humidity (relative)'
},
//{
//  'Name': 'ExternalTemperature',
//  'Type': 'double',
//  'DisplayName': 'Outdoor Temperature (C*)'
//}
]
```

**Outdoor Temperature** (Наружная температура) больше не отображается на диаграмме.

![Фильтрация данных телеметрии на панели мониторинга][image5]

Это изменение влияет только на отображение диаграммы. Значения данных **ExternalTemperature** по-прежнему сохраняются и остаются доступными для внутренней обработки.

> [AZURE.NOTE] Может потребоваться отключить и снова включить устройство Node.js на странице **Устройства** на панели мониторинга, чтобы немедленно отобразить изменения.

## Обработка ошибок

Чтобы поток данных можно было отобразить на диаграмме, его значение **Type** в метаданных **Device-Info** должно соответствовать типу данных значений телеметрии. Например, если в метаданных указано, что **Type** данных влажности — **int**, а в потоке данных телеметрии обнаружен тип **double**, то данные телеметрии влажности не отображаются на диаграмме. Тем не менее значения **Humidity** по-прежнему сохраняются и остаются доступными для внутренней обработки.

## Дальнейшие действия

Теперь, когда вы узнали, как использовать динамическую телеметрию, ознакомьтесь также с информацией о том, как с помощью предварительно настроенных решений применять сведения об устройстве: [Метаданные сведений об устройстве в предварительно настроенном решении для удаленного мониторинга][lnk-devinfo].

[lnk-devinfo]: iot-suite-remote-monitoring-device-info.md

[image1]: media/iot-suite-dynamic-telemetry/image1.png
[image2]: media/iot-suite-dynamic-telemetry/image2.png
[image3]: media/iot-suite-dynamic-telemetry/image3.png
[image4]: media/iot-suite-dynamic-telemetry/image4.png
[image5]: media/iot-suite-dynamic-telemetry/image5.png

[lnk_free_trial]: http://azure.microsoft.com/pricing/free-trial/
[lnk-node]: http://nodejs.org
[node-linux]: https://github.com/nodejs/node-v0.x-archive/wiki/Installing-Node.js-via-package-manager
[lnk-github-repo]: https://github.com/Azure/azure-iot-sdks

<!---HONumber=AcomDC_0831_2016-->