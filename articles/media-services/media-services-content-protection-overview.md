<properties 
	pageTitle="Общие сведения о защите содержимого | Microsoft Azure" 
	description="В этой статье представлен обзор защиты содержимого с помощью служб мультимедиа." 
	services="media-services" 
	documentationCenter="" 
	authors="Juliako" 
	manager="erikre" 
	editor=""/>

<tags 
	ms.service="media-services" 
	ms.workload="media" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="09/19/2016" 
	ms.author="juliako"/>

#Общие сведения о защите содержимого


Службы мультимедиа Microsoft Azure позволяют защитить данные мультимедиа, покидающие ваш компьютер, на этапах их хранения, обработки и доставки. Службы мультимедиа позволяют доставлять содержимое, зашифрованное динамически с помощью AES (с использованием 128-битных ключей шифрования) и общим шифрованием (CENC), используя PlayReady и (или) Widevine DRM. Они также обеспечивают службы доставки ключей AES и лицензий PlayReady авторизованным клиентам. Для доставки лицензий Widevine можно использовать следующих партнеров AMS: [Axinom](http://www.axinom.com/press/ibc-axinom-drm-6/), [EZDRM](http://ezdrm.com/) и [castLabs](http://castlabs.com/company/partners/azure/).

- На следующем изображении показан рабочий процесс общего динамического шифрования PlayReady и (или) Widevine DRM. Дополнительные сведения см. в статье [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-drm.md).

![Защита с помощью PlayReady](./media/media-services-content-protection-overview/media-services-content-protection-with-drm.png)


- На следующем изображении показан рабочий процесс динамического шифрования AES-128. Дополнительные сведения см. в статье [Использование динамического шифрования AES-128 и службы доставки ключей](media-services-protect-with-aes128.md).

![Защита с помощью AES-128](./media/media-services-content-protection-overview/media-services-content-protection-with-aes.png)

>[AZURE.NOTE]Чтобы использовать динамическое шифрование, необходимо сначала получить как минимум одну зарезервированную единицу потоковой передачи на конечной точке потоковой передачи, с которой необходимо выполнять потоковую передачу содержимого.

##Параметры шифрования ресурсов

В зависимости от типа содержимого, которое вы хотите выкладывать, хранить и доставлять, службы мультимедиа предлагают различные параметры шифрования.

###None

Шифрование не используется. Это значение по умолчанию. При использовании этого параметра содержимое не защищено при передаче и хранении.

Используйте этот параметр при добавлении содержимого, если MP4-файл планируется доставлять с помощью поэтапного скачивания.

###StorageEncrypted

Параметр **StorageEncrypted** используется для локального шифрования незашифрованного содержимого с помощью AES 256 и его добавления в хранилище Azure, где оно хранится в зашифрованном виде. Ресурсы, защищенные с помощью шифрования хранилища, автоматически расшифровываются и помещаются в зашифрованную файловую систему до кодирования, а затем при необходимости повторно кодируются перед добавлением в виде нового выходного актива. Основная причина использования шифрования хранилища — для защиты входных файлов мультимедиа высокого качества с помощью стойкого шифрования при хранении на диске.

Для доставки ресурса из зашифрованного хранилища необходимо настроить политику доставки ресурсов, чтобы службы мультимедиа могли определить, как вы хотите доставлять содержимое. Перед выполнением потоковой передачи ресурса-контейнера сервер потоковой передачи удаляет шифрование хранилища и осуществляет потоковую передачу содержимого с помощью указанной политики доставки (например, AES, общее шифрование или без шифрования).

####Сведения о реализации

Шифрование хранилища AMS применяет режим шифрования **AES-CTR** ко всему файлу. AES-CTR — это блочный шифр, который может шифровать данные произвольной длины и не требует заполнения. Он шифрует блок счетчика, используя алгоритм AES, а затем применяет XOR к выходным данным AES, содержащим данные для шифрования или расшифровки. Используемый блок счетчика формируется путем копирования значения InitializationVector в байты 0–7 значения счетчика и присвоения байтам 8–15 нулевого значения. Байты 8–15 в 16-байтовом блоке счетчика (т. е. наименее значимые) используются как простое 64-разрядное целое число без знака, увеличивающееся на единицу с каждым последующим блоком данных, которые обрабатываются и хранятся в соответствии с порядком байтов в сети. Если это число достигает максимального значения (0xFFFFFFFFFFFFFFFF), при следующем приращении счетчик блока сбрасывается до нуля (байты 8–15) и не влияет на другие 64 разряда в счетчика (байты 0–7). Для обеспечения безопасности шифрования в режиме AES значение InitializationVector для соответствующего KID должно быть уникальным для каждого файла, а длина файлов должна быть меньше 2^64 блоков. Это гарантирует, что значение счетчика не будет использоваться с данным ключом повторно. Дополнительные сведения о режиме CTR см. на [этой вики-странице](https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#CTR) (в вики-статье вместо InitializationVector используется термин Nonce).

Если вы хотите узнать, как работает основной алгоритм, просмотрите реализацию AMS .NET для следующих методов:

- [ApplyEncryptionTransform](https://github.com/Azure/azure-sdk-for-media-services/blob/dev/src/net/Client/Common/Common.BlobTransfer/BlobTransferBase.cs)
- [AesCtr](https://github.com/Azure/azure-sdk-for-media-services/blob/dev/src/net/Client/Common/Common.FileEncryption/FileEncryptionTransform.cs)


###CommonEncryptionProtected

Параметр **CommonEncryptionProtected** позволяет зашифровать содержимое с помощью стандартного шифрования либо выложить уже зашифрованное содержимое. PlayReady и Widewine шифруются согласно спецификации общего шифрования (CENC) и поддерживаются AMS.

###EnvelopeEncryptionProtected

Параметр **EnvelopeEncryptionProtected** позволяет защитить потоковую передачу HTTP (HLS), зашифрованную с помощью AES, или же добавить уже защищенную передачу. Обратите внимание на то, что если HLS уже зашифрована с помощью AES, ее можно выложить только в том случае, если для шифрования использовался Transform Manager.

##Динамическое шифрование

Службы мультимедиа Microsoft Azure позволяют доставлять содержимое, динамически зашифрованное с помощью AES (с использованием 128-разрядных ключей шифрования), а также PlayReady и (или) Widevine DRM.

В настоящее время поддерживается шифрование для следующих форматов потоковой передачи: HLS, MPEG DASH и Smooth Streaming. Шифрование формата потоковой передачи HDS и последовательных скачиваний не поддерживается.

Если требуется, чтобы службы мультимедиа зашифровали ресурс, необходимо связать ключ шифрования (CommonEncryption или EnvelopeEncryption) с ресурсом, а также настроить политики авторизации для ключа.

Потребуется также настроить политику доставки ресурсов. Если вы хотите выполнять потоковую передачу ресурса из зашифрованного хранилища, задайте способ его доставки, настроив политику доставки ресурсов.

Когда поток запрашивается проигрывателем, службы мультимедиа используют указанный ключ для динамического шифрования содержимого с помощью AES или общего шифрования. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценивает политики авторизации, заданные для ключа.

>[AZURE.NOTE]Для использования динамического шифрования вам потребуется получить по крайней мере одну единицу потоковой передачи по запросу для конечной точки потоковой передачи, из которой планируется передавать зашифрованное содержимое. Дополнительную информацию см. в статье [Масштабирование служб мультимедиа](media-services-portal-manage-streaming-endpoints.md).

##Служба доставки лицензий и ключей

Службы мультимедиа предоставляют службу доставки лицензий DRM (PlayReady и Widevine) и незащищенных ключей AES авторизованным клиентам. Чтобы настроить политики авторизации и проверки подлинности для лицензий и ключей, можно использовать классический портал Azure, API REST или пакет SDK служб мультимедиа для .NET.

Обратите внимание на то, что при использовании портала можно настроить одну политику AES (которая будет применяться ко всему содержимому, зашифрованному с помощью AES) и одну политику PlayReady (которая будут применяться ко всему содержимому, зашифрованному с помощью PlayReady). Используйте пакет SDK служб мультимедиа для .NET, если вам требуется больший контроль над конфигурациями.

##Лицензии DRM

###Лицензия PlayReady

Службы мультимедиа обеспечивают доставку лицензий PlayReady. Когда проигрыватель конечного пользователя (например, Silverlight) пытается воспроизвести содержимое, защищенное с помощью PlayReady, в службу доставки лицензий отправляется запрос на получение лицензии. Если служба лицензий утверждает запрос, она выдает лицензию, которая отправляется клиенту и может использоваться для расшифровки и воспроизведения указанного содержимого.

Лицензии определяют права и ограничения, которые должны применяться в среде выполнения PlayReady DRM при попытке пользователя воспроизвести защищенное содержимое. Службы мультимедиа предоставляют интерфейсы API, которые позволяют настраивать лицензии PlayReady. Дополнительную информацию см. в разделе [Обзор шаблона лицензий PlayReady для служб мультимедиа](media-services-playready-license-template-overview.md).

###Лицензия Widevine

AMS позволяет также передавать MPEG DASH с шифрованием, выполненным с помощью Widevine DRM. PlayReady и Widewine шифруются согласно спецификации общего шифрования (CENC). Чтобы настроить AssetDeliveryConfiguration для использования Widevine, можно воспользоваться пакетом [SDK для AMS .NET](https://www.nuget.org/packages/windowsazure.mediaservices/) (начиная с версии 3.5.1) или REST API.

Начиная с версии 3.5.2 пакета SDK служб мультимедиа для .NET, службы мультимедиа позволяют настраивать [шаблоны лицензии Widevine](media-services-widevine-license-template-overview.md) и получать лицензии Widevine. Для доставки лицензий Widevine можно использовать следующих партнеров AMS: [Axinom](http://www.axinom.com/press/ibc-axinom-drm-6/), [EZDRM](http://ezdrm.com/) и [castLabs](http://castlabs.com/company/partners/azure/).

##Ограничение по маркеру

Для политики авторизации ключа содержимого можно задать одно или несколько из ограничений авторизации: открытая авторизация или с ограничением по маркеру. При ограничении по маркеру к политике должен прилагаться маркер, выданный службой маркеров безопасности (STS). Службы мультимедиа поддерживают маркеры в формате простого веб-маркера (SWT) и формате веб-маркера JSON (JWT). Службы мультимедиа не предоставляют службы маркеров безопасности. Для выдачи маркеров можно создать пользовательскую службу STS или использовать службу Microsoft Azure ACS. Чтобы создать маркер, подписанный указанным ключом, и получить утверждения, указанные в конфигурации ограничения по маркерам, должна быть настроена служба маркеров безопасности. Служба доставки ключей служб мультимедиа возвращает клиенту запрошенный ключ (или лицензию), если маркер является допустимым, а его утверждения соответствуют утверждениям, настроенным для ключа (или лицензии).

При настройке политики ограничения по маркеру необходимо задать такие параметры, как основной ключ проверки, издатель и аудитория. Основной ключ проверки содержит ключ, которым подписан маркер, а издатель — это служба маркеров безопасности, которая выдает маркер. Аудитория (иногда называется областью) описывает назначение маркера или ресурс, доступ к которому обеспечивает маркер. Служба доставки ключей служб мультимедиа проверяет, соответствуют ли эти значения в маркере значениям в шаблоне.

##Распространенные сценарии

###Защита содержимого в хранилище, доставка потокового мультимедиа с динамическим шифрованием, использование службы доставки ключей/лицензий AMS

1. Получение мезонинного файла в высоком качестве в ресурсе. Примените шифрование хранилища к ресурсу.
2. Настройка конечных точек потоковой передачи данных.
1. Закодируйте содержимое в набор MP4-файлов с адаптивной скоростью. Примените шифрование хранилища к выходному ресурсу.
1. Создайте ключ шифрования содержимого для ресурса, который вы хотите динамически шифровать во время воспроизведения.
2. Настройте политику авторизации ключа содержимого.
1. Настройте политику доставки ресурсов (она используется средствами динамической упаковки и шифрования).
1. Опубликуйте ресурс, создав указатель OnDemand.
1. Потоковая передача содержимого.

Дополнительные сведения см. в статьях [Защита с помощью AES](media-services-protect-with-aes128.md) и [Защита с помощью PlayReady и Widevine](media-services-protect-with-drm.md).


###Использование службы доставки ключа и лицензии служб мультимедиа с собственными службами шифрования и потоковой передачи

Дополнительные сведения см. в статье [Как интегрировать службу лицензий PlayReady Azure с собственным механизмом шифрования или сервером потоковой передачи](http://mingfeiy.com/integrate-azure-playready-license-service-encryptorstreaming-server).

###Интеграция с партнерами

[Использование castLabs для доставки лицензий DRM для служб мультимедиа Azure](media-services-castlabs-integration.md)

##Схемы обучения работе со службами мультимедиа

[AZURE.INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

##Отзывы

[AZURE.INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]


##Связанные ссылки

[Представляем новые возможности служб мультимедиа Azure: функцию динамического шифрования AES и PlayReady как службу](http://mingfeiy.com/playready)

[Разъяснение ценовой политики для доставки лицензий PlayReady служб мультимедиа Azure](http://mingfeiy.com/playready-pricing-explained-in-azure-media-services)

[Способы отладки потока, зашифрованного с использованием AES, в службах мультимедиа Azure](http://mingfeiy.com/debug-aes-encrypted-stream-azure-media-services)

[Аутентификация по токенам JWT](http://www.gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/)

[Интегрируйте приложение на основе OWIN MVC служб мультимедиа Azure с Azure Active Directory и ограничьте доставку ключей содержимого на основе утверждений JWT](http://www.gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).

[Используйте Azure ACS для выдачи токенов](http://mingfeiy.com/acs-with-key-services).

[content-protection]: ./media/media-services-content-protection-overview/media-services-content-protection.png

<!---HONumber=AcomDC_0921_2016-->