<properties
	pageTitle="Доставка содержимого клиентам | Microsoft Azure"
	description="В этой статье представлен обзор доставки содержимого с помощью служб мультимедиа Azure."
	services="media-services"
	documentationCenter=""
	authors="Juliako"
	manager="erikre"
	editor=""/>

<tags
	ms.service="media-services"
	ms.workload="media"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/19/2016"
	ms.author="juliako"/>


# Доставка содержимого клиентам
При доставке содержимого клиентам в виде потоковой трансляции или видео по запросу ваша задача — доставлять видео высокого качества для различных устройств в разных сетевых условиях.

Для достижения этой цели можно сделать следующее.

- Можно кодировать поток в видеопоток с разными скоростями (с переменной скоростью). Это позволит соблюдать различные уровни качества и условия сети.
- Можно также использовать [динамическую упаковку](media-services-dynamic-packaging-overview.md) служб мультимедиа Microsoft Azure для динамической перепаковки потока в разные протоколы. Это позволит транслировать поток на разных устройствах. Службы мультимедиа поддерживают доставку следующих потоковых технологий с переменное скоростью: HTTP Live Streaming (HLS), Smooth Streaming, MPEG DASH и HDS (только для обладателей лицензий Adobe PrimeTime/Access).

В этой статье приводится обзор важных понятий, связанных с доставкой содержимого.

Информацию об известных проблемах см. в разделе [Известные проблемы](media-services-deliver-content-overview.md#known-issues).

## Динамическая упаковка

Применение динамической упаковки служб мультимедиа позволяет доставлять закодированное содержимое MP4-файлов с переменной скоростью или содержимое Smooth Streaming в форматах потоковой передачи с поддержкой служб мультимедиа (MPEG DASH, HLS, Smooth Streaming, HDS) без необходимости перепаковки в эти форматы. Мы рекомендуем доставлять содержимое с помощью динамической упаковки.

Чтобы воспользоваться преимуществом динамической упаковки, необходимо выполнить следующие действия:

- Закодируйте мезонинный (исходный) файл в набор MP4-файлов с переменной скоростью или в набор файлов Smooth Streaming.
- Получите по крайней мере одну единицу потоковой передачи по запросу для конечной точки потоковой передачи, из которой планируется доставлять содержимое. Дополнительные сведения см. в статье [Управление конечными точками потоковой передачи с помощью портала Azure](media-services-portal-manage-streaming-endpoints.md).

Используя динамическую упаковку, можно хранить и оплачивать файлы в одном формате хранения. Службы мультимедиа будут создавать и обрабатывать соответствующий ответ с учетом ваших запросов.

Кроме возможности использовать динамическую упаковку, зарезервированные единицы потокового воспроизведения по запросу обеспечивают выделенный объем исходящего трафика, который можно приобрести с шагом 200 Мбит/с. По умолчанию потоковое воспроизведение по запросу настроено в модели общего экземпляра, для которой серверные ресурсы (например, вычислительная мощность или объем исходящего трафика) используются совместно с другими пользователями. Вы можете повысить пропускную способность потоковой передачи по запросу, приобретая зарезервированные единицы потоковой передачи по запросу.

Дополнительные сведения см. в разделе [Динамическая упаковка](media-services-dynamic-packaging-overview.md).

## Фильтры и динамические манифесты

Службы мультимедиа позволяют определять фильтры для ресурсов-контейнеров. Эти фильтры представляют собой правила на стороне сервера, помогающие пользователям выполнять такие действия, как воспроизведение определенной части видео или указание подмножества представлений аудио и видео, которые может обрабатывать устройство клиента (вместо всех представлений, связанных с ресурсом-контейнером). Такая фильтрация осуществляется с помощью *динамических манифестов*, которые создаются, когда клиент запрашивает потоковую передачу видео на основе одного или нескольких указанных фильтров.

Дополнительные сведения см. в разделе [Фильтры и динамические манифесты](media-services-dynamic-manifest-overview.md).

## Локаторы

Чтобы предоставить пользователю URL-адрес, который можно использовать для потоковой передачи или скачивания содержимого, сначала необходимо опубликовать ресурс-контейнер, создав указатель. Указатель предоставляет точку входа для доступа к файлам в ресурсе-контейнере. Службы мультимедиа поддерживают два типа указателей:

- Указатели OnDemandOrigin. Они используются для потоковой передачи мультимедиа (например, в формате MPEG DASH, HLS или Smooth Streaming) или поэтапной загрузки файлов.
-  Указатели подписанного URL-адреса (SAS). Они используются для скачивания файлов мультимедиа на локальный компьютер.

*Политика доступа* используется для определения разрешений (например, для чтения, записи и перечисления) и длительности доступа клиента к определенному ресурсу-контейнеру. Обратите внимание, что разрешение перечисления (AccessPermissions.List) не следует использовать при создании указателя OrDemandOrigin.

Указатели имеют срок действия. Портал Azure задает для указателей срок действия в 100 лет.

>[AZURE.NOTE] Если вы создавали указатели на портале Azure до марта 2015 года, то их срок действия составлял два года.

Чтобы обновить срок действия указателя, используйте [REST API](http://msdn.microsoft.com/library/azure/hh974308.aspx#update_a_locator) или [API .NET](http://go.microsoft.com/fwlink/?LinkID=533259). Обратите внимание, что при обновлении срока действия указателя SAS изменяется URL-адрес.

Указатели не предназначены для управления доступом на уровне пользователей. Вы можете предоставлять различные права доступа отдельным пользователям, используя решения для управления цифровыми правами. Дополнительные сведения см. в разделе [Защита мультимедиа](http://msdn.microsoft.com/library/azure/dn282272.aspx).

При создании указателя может возникать 30-секундная задержка из-за необходимых процессов сохранения и распространения в службе хранилища Azure.


## Адаптивная потоковая передача

Технологии передачи с переменной скоростью позволяют видеопроигрывателю определить условия работы сети и выбрать одну из нескольких скоростей. Если условия передачи в сети ухудшаются, клиент может выбрать более низкую скорость, позволяя видеопроигрывателю продолжать воспроизводить видео в более низком качестве. Если состояние сети улучшается, то клиент может переключиться на более высокую скорость с более высоким качеством видео. Службы мультимедиа Azure поддерживают следующие технологии передачи с переменной скоростью: HTTP Live Streaming (HLS), Smooth Streaming, MPEG-DASH и HDS.

Чтобы предоставить пользователям URL-адреса потоковой передачи, сначала необходимо создать указатель OnDemandOrigin. При создании указателя вы получите базовый путь к ресурсу-контейнеру, в котором находится содержимое для потоковой передачи. Тем не менее, чтобы получить возможность потоковой передачи содержимого, необходимо изменить этот путь. Чтобы сформировать полный URL-адрес к файлу манифеста потоковой передачи, необходимо сцепить значение пути указателя и имя файла манифеста (filename.ism). Затем добавьте **/Manifest** и соответствующий формат (если нужно) в путь указателя.

>[AZURE.NOTE]Также по SSL-подключению можно выполнять потоковую передачу содержимого. Для этого убедитесь, что URL-адреса потоковой передачи начинаются с HTTPS.

Потоковая передача через подключение SSL возможна только в том случае, если конечная точка потоковой передачи, из которой доставляется содержимое, была создана после 10 сентября 2014 года. Если URL-адреса потоковой передачи основаны на конечных точках потоковой передачи, созданных после 10 сентября 2014 года, то они содержат "streaming.mediaservices.windows.net". URL-адреса потоковой передачи, который содержат "origin.mediaservices.windows.net" (старый формат), не поддерживают SSL. Если URL-адрес имеет старый формат и необходимо организовать передачу через SSL, нужно создать новую конечную точку. Используйте URL-адреса на основе новой конечной точки потоковой передачи для потоковой передачи содержимого через подключение SSL.


## Форматы URL-адресов потоковой передачи

### Формат MPEG-DASH

{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest(format=mpd-time-csf)

http://testendpoint-testaccount.streaming.mediaservices.windows.net/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ism/Manifest(format=mpd-time-csf)



### Формат Apple HTTP Live Streaming (HLS) V4

{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest(format=m3u8-aapl)

http://testendpoint-testaccount.streaming.mediaservices.windows.net/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ism/Manifest(format=m3u8-aapl)

### Формат Apple HTTP Live Streaming (HLS) V3

{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest(format=m3u8-aapl-v3)

http://testendpoint-testaccount.streaming.mediaservices.windows.net/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ism/Manifest(format=m3u8-aapl-v3)

### Формат Apple HTTP Live Streaming (HLS) с фильтром "только аудио"

По умолчанию дорожки, содержащие только аудио, включены в манифест HLS. Это требуется для сертификации магазина Apple для сетей мобильной связи. В этом случае, если клиент не имеет достаточную пропускную способность или подключен через сеть 2G, то он переключается на воспроизведение только аудио дорожки. Это позволяет осуществлять потоковую передачу содержимого без необходимости буферизации, но и видео при этом не отображается. В некоторых сценариях буферизация проигрывателя может быть предпочтительнее воспроизведения лишь аудио дорожки. Для удаления дорожки, содержащей только аудио, добавьте к URL-адресу **audio-only=false**.

http://testendpoint-testaccount.streaming.mediaservices.windows.net/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ism/Manifest(format=m3u8-aapl-v3,audio-only=false)

Дополнительные сведения см. в блоге [Azure Media Services – Dynamic Manifest Composition support and HLS output additional features](https://azure.microsoft.com/blog/azure-media-services-release-dynamic-manifest-composition-remove-hls-audio-only-track-and-hls-i-frame-track-support/) (Службы мультимедиа Azure — поддержка динамического создания манифестов и дополнительные функции вывода HLS).


### Формат Smooth Streaming

{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest

Пример:

http://testendpoint-testaccount.streaming.mediaservices.windows.net/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ism/Manifest

### <a id="fmp4_v20"></a>Манифест Smooth Streaming 2.0 (манифест прежних версий)

По умолчанию формат манифеста Smooth Streaming содержит тег повтора (r-tag). Однако некоторые проигрыватели не поддерживают r-tag. Клиенты с этими проигрывателями могут использовать формат, который отключает r-tag.

{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest(format=fmp4-v20)

	http://testendpoint-testaccount.streaming.mediaservices.windows.net/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ism/Manifest(format=fmp4-v20)

### HDS (только для лицензиатов Adobe PrimeTime/Access)

{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest(format=f4m-f4f)

	http://testendpoint-testaccount.streaming.mediaservices.windows.net/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ism/Manifest(format=f4m-f4f)

## Прогрессивное скачивание

Поэтапная загрузка позволяет начать воспроизведение мультимедиа до окончания скачивания всего файла. ISMV-, ISMA-, ISMT- и ISMC-файлы не могут быть загружены поэтапно.

Для последовательной загрузки содержимого используйте тип указателя OnDemandOrigin. В следующем примере показан URL-адрес, основанный на типе указателя OnDemandOrigin.

	http://amstest1.streaming.mediaservices.windows.net/3c5fe676-199c-4620-9b03-ba014900f214/BigBuckBunny_H264_650kbps_AAC_und_ch2_96kbps.mp4

Необходимо расшифровать все зашифрованные в хранилище ресурсы-контейнеры, которые требуется передать из исходной службы для поэтапной загрузки.

## Загрузить

Для скачивания содержимого на клиентское устройство необходимо создать указатель SAS. Он предоставляет доступ к контейнеру службы хранилища Azure, в котором расположен ваш файл. Чтобы создать URL-адрес загрузки, необходимо вставить имя файла между узлом и подписью SAS.

В следующем примере показан URL-адрес, основанный на типе указателя SAS.

	https://test001.blob.core.windows.net/asset-ca7a4c3f-9eb5-4fd8-a898-459cb17761bd/BigBuckBunny.mp4?sv=2012-02-12&se=2014-05-03T01%3A23%3A50Z&sr=c&si=7c093e7c-7dab-45b4-beb4-2bfdff764bb5&sig=msEHP90c6JHXEOtTyIWqD7xio91GtVg0UIzjdpFscHk%3D

Действительны следующие условия.

- Необходимо расшифровать все зашифрованные в хранилище ресурсы-контейнеры, которые требуется передать из исходной службы для поэтапной загрузки.
- Процесс скачивания, не завершенный в течение 12 часов, завершается ошибкой.

## Конечные точки потоковой передачи

Конечная точка потоковой передачи — это служба потоковой передачи, которая может доставить содержимое непосредственно в клиентское приложение проигрывателя или в сеть доставки содержимого (CDN) для дальнейшего распространения. Исходящим потоком службы конечной точки потоковой передачи может быть динамический поток или ресурс-контейнер видео по запросу в учетной записи служб мультимедиа. Кроме того, чтобы справиться с растущими потребностями в пропускной способности, можно контролировать емкость службы конечной точки потоковой передачи, регулируя число зарезервированных единиц потоковой передачи. Необходимо выделить хотя бы одну зарезервированную единицу для приложений в рабочей среде. Дополнительные сведения см. в статье [Управление конечными точками потоковой передачи с помощью портала Azure](media-services-portal-manage-streaming-endpoints.md).

## Известные проблемы

### Изменения в версии манифеста Smooth Streaming

До выпуска набора исправлений в июле 2016 года дело обстояло так. Когда ресурсы-контейнеры, генерируемые стандартным кодировщиком мультимедиа, расширенным рабочим процессом кодировщика мультимедиа или устаревшим кодировщиком мультимедиа Azure, передавались в потоке с помощью динамической упаковки, выдавался манифест Smooth Streaming версии 2.0. В нем для длительностей фрагментов не использовались так называемые теги повтора (r-tag). Например:

<?xml version="1.0" encoding="UTF-8"?> <SmoothStreamingMedia MajorVersion="2" MinorVersion="0" Duration="8000" TimeScale="1000"> <StreamIndex Chunks="4" Type="video" Url="QualityLevels({bitrate})/Fragments(video={start time})" QualityLevels="3" Subtype="" Name="video" TimeScale="1000"> <QualityLevel Index="0" Bitrate="1000000" FourCC="AVC1" MaxWidth="640" MaxHeight="360" CodecPrivateData="00000001674D4029965201405FF2E02A100000030010000003032E0A000F42400040167F18E3050007A12000200B3F8C70ED0B16890000000168EB7352" /> <c t="0" d="2000" n="0" /> <c d="2000" /> <c d="2000" /> <c d="2000" /> </StreamIndex> </SmoothStreamingMedia>

После выпуска набора исправлений в июле 2016 года создаваемый манифест Smooth Streaming соответствует версии 2.2, в которой для длительностей фрагментов используются теги повтора. Например:

	<?xml version="1.0" encoding="UTF-8"?>
	<SmoothStreamingMedia MajorVersion="2" MinorVersion="2" Duration="8000" TimeScale="1000">
		<StreamIndex Chunks="4" Type="video" Url="QualityLevels({bitrate})/Fragments(video={start time})" QualityLevels="3" Subtype="" Name="video" TimeScale="1000">
			<QualityLevel Index="0" Bitrate="1000000" FourCC="AVC1" MaxWidth="640" MaxHeight="360" CodecPrivateData="00000001674D4029965201405FF2E02A100000030010000003032E0A000F42400040167F18E3050007A12000200B3F8C70ED0B16890000000168EB7352" />
			<c t="0" d="2000" r="4" />
		</StreamIndex>
	</SmoothStreamingMedia>

Некоторые устаревшие клиенты Smooth Streaming могут не поддерживать теги повтора и поэтому не загружать манифест. Чтобы устранить эту проблему, воспользуйтесь параметром формата манифеста прежних версий **(format=fmp4-v20)** или обновите свой клиент до последней версии, поддерживающей теги повтора. Чтобы узнать больше, ознакомьтесь со [Smooth Streaming 2.0](media-services-deliver-content-overview.md#fmp4_v20).

## Схемы обучения работе со службами мультимедиа

[AZURE.INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## Отзывы

[AZURE.INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]

## Связанные разделы

[Обновление указателей служб мультимедиа после отката ключей хранилища](media-services-roll-storage-access-keys.md)

<!---HONumber=AcomDC_0921_2016-->