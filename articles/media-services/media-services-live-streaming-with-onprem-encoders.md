<properties 
	pageTitle="Потоковая трансляция с помощью локальных кодировщиков, создающих потоки с разными скоростями | Microsoft Azure" 
	description="В этой статье описывается настройка канала, который получает динамический поток с поддержкой нескольких скоростей от локального кодировщика. Далее этот поток можно доставлять в клиентские приложения для воспроизведения через одну или несколько конечных точек потоковой передачи по одному из следующих протоколов адаптивной потоковой передачи: HLS, Smooth Stream, MPEG DASH или HDS." 
	services="media-services" 
	documentationCenter="" 
	authors="Juliako" 
	manager="erikre" 
	editor=""/>

<tags 
	ms.service="media-services" 
	ms.workload="media" 
	ms.tgt_pltfrm="na" 
	ms.devlang="ne" 
	ms.topic="article" 
	ms.date="09/19/2016" 
	ms.author="cenkdin;juliako"/>

#Потоковая трансляция с помощью локальных кодировщиков, создающих потоки с разными скоростями

##Обзор

В службах мультимедиа Azure **канал** представляет собой конвейер для обработки контента, передаваемого в потоковом режиме. **Канал** получает входные потоки одним из двух способов.


- Локальный динамический кодировщик передает содержимое во многоскоростном формате **RTMP** или формате **Smooth Streaming** (фрагментированный MP4) в канал, для которого не задана поддержка кодирования в реальном времени с помощью AMS. Полученные потоки передаются через **каналы** без дальнейшей обработки. Этот способ называется **сквозной передачей**. Вы можете использовать следующие динамические кодировщики, выдающие контент в многоскоростном формате Smooth Streaming: Elemental, Envivio, Cisco. Следующие динамические кодировщики выдают контент в формате RTMP: Adobe Flash Live, Telestream Wirecast и транскодеры Tricaster. Динамический кодировщик может также передавать односкоростной поток в канал, для которого не включено кодирование в реальном времени, но это не рекомендуется. При получении запроса службы мультимедиа предоставляют потоки клиентам.

	>[AZURE.NOTE] Использование сквозной передачи является наиболее экономичным способом потоковой передачи в реальном времени.
	
- Локальный динамический кодировщик передает односкоростной поток в канал, который может осуществлять кодирование в реальном времени с помощью служб мультимедиа, в одном из следующих форматов: RTP (MPEG-TS), RTMP или Smooth Streaming (Fragmented MP4) . Затем канал кодирует входящий односкоростной поток в реальном времени в многоскоростной (адаптивный) видеопоток. При получении запроса службы мультимедиа предоставляют потоки клиентам.

Начиная с выпуска 2.10 служб мультимедиа, при создании канала можно указать, как он должен принимать входной поток и должен ли он выполнять его кодирование в реальном времени. Существует два варианта.

- **Нет** — задайте это значение, если вы собираетесь использовать локальный динамический кодировщик, который будет выдавать многоскоростной (сквозной) поток. В этом случае входящий поток передается на выход без кодирования. Таким образом каналы работали до выпуска 2.10. В этой статье приведены подробные сведения о работе с каналами такого типа.

- **Стандартный** — выберите это значение, если собираетесь использовать службы мультимедиа для кодирования односкоростного потока во многоскоростной. Помните о том, что за кодирование в реальном времени взимается плата, поэтому, если вы оставите канал кодирования в реальном времени в состоянии "Работает", вам будут выставлены соответствующие счета. Рекомендуется сразу же прекращать работу канала после завершения потоковой передачи в реальном времени во избежание оплаты дополнительных часов. При получении запроса службы мультимедиа предоставляют потоки клиентам.

>[AZURE.NOTE]В этой статье рассматриваются атрибуты каналов, которые не поддерживают кодирование в реальном времени (тип кодирования **Нет**). Информацию о работе с каналами, которые поддерживают кодирование в реальном времени, см. в разделе [Потоковая трансляция с использованием служб мультимедиа Azure для создания потоков с разными скоростями](media-services-manage-live-encoder-enabled-channels.md).

На следующей диаграмме показан рабочий процесс динамической потоковой передачи, использующий локальный динамический кодировщик для вывода потоков с разными скоростями RTMP или Fragmented MP4 (Smooth Streaming).

![Динамический рабочий процесс][live-overview]

В этой статье рассматриваются следующие вопросы:

- [Стандартный сценарий потоковой передачи в режиме реального времени](media-services-live-streaming-with-onprem-encoders.md#scenario)
- [Описание канала и связанных с ним компонентов](media-services-live-streaming-with-onprem-encoders.md#channel)
- [Рекомендации](media-services-live-streaming-with-onprem-encoders.md#considerations)

##<a id="scenario"></a>Стандартный сценарий потоковой передачи в режиме реального времени
Далее описываются задачи, связанные с созданием распространенных приложений динамической потоковой передачи.

1. Подключите видеокамеру к компьютеру. Запустите и настройте локальный динамический кодировщик, который выводит поток с разными скоростями RTMP или поток Fragmented MP4 (Smooth Streaming). Дополнительные сведения см. в статье [Поддержка протокола RTMP службами мультимедиа Azure и динамические кодировщики](http://go.microsoft.com/fwlink/?LinkId=532824).
	
	Это действие также можно выполнить после создания канала.

1. Создайте и запустите канал.
1. Получите URL-адрес приема канала.

	URL-адрес приема используется динамическим кодировщиком для отправки потока в канал.
1. Получите URL-адрес предварительного просмотра канала.

	С его помощью можно убедиться в том, что канал надлежащим образом получает поток.

3. Создайте программу.

	Если вы используете классический портал Azure, при создании программы также создается ресурс.

	Если вы используете пакет .NET SDK или REST, необходимо создать ресурс и указать его при создании программы.
1. Опубликуйте ресурс, связанный с программой.

	Убедитесь, что есть как минимум одна зарезервированная единица потоковой передачи на конечной точке потоковой передачи, с которой необходимо выполнять потоковую передачу содержимого.
1. Когда вы будете готовы начать потоковую передачу и архивацию, запустите программу.
2. При необходимости динамическому кодировщику можно дать сигнал начать показ рекламы. Реклама вставляется в выходной поток.
1. Чтобы остановить потоковую передачу и архивацию содержимого мероприятия, завершите работу программы.
1. Удалите программу (и при необходимости ресурс).

##<a id="channel"></a>Описание канала и связанных с ним компонентов

###<a id="channel_input"></a>Конфигурации входа (приема) канала

####<a id="ingest_protocols"></a>Протокол входного потока

Службы мультимедиа поддерживают прием динамических каналов с использованием следующих протоколов потоковой передачи:

- **фрагментированный MP4 с поддержкой разных скоростей;**
 
- **RTMP с поддержкой разных скоростей.**

	Если выбран протокол потоковой передачи **RTMP**, для канала создаются две конечные точки приема (ввода):
	
	**Основной URL-адрес** задает полный URL-адрес основной конечной точки приема RTMP канала.

	**Дополнительный URL-адрес** (необязательно) задает полный URL-адрес дополнительной конечной точки приема RTMP канала.


	Используйте дополнительный URL-адрес, чтобы повысить надежность и отказоустойчивость потока приема, а также отказоустойчивость кодировщика, особенно в следующих сценариях.

	- Двойная передача одного кодировщика как по основному, так и по дополнительному URL-адресам.
	
		Основная цель такого приема — повысить устойчивость к колебаниям сети и ухудшению качества сигнала. Некоторые кодировщики RTMP не очень хорошо справляются с сетевыми отключениями. При отключении от сети кодировщик может прекратить кодирование, не отправляя буферизованные данные при возобновлении подключения. Это ведет к перебоям в работе и потере данных. Отключение сети может происходить из-за ее неисправности или во время технического обслуживания со стороны Azure. Основной и дополнительный URL-адреса минимизируют проблемы с сетью, а также обеспечивают управляемый процесс обновления. При каждом плановом отключении сети службы мультимедиа управляют первичным и вторичным отключением, обеспечивая отложенное отключение между двумя адресами. Это дает время кодировщикам поддерживать отправку данных и возобновлять подключение. Порядок отключений может быть случайным, но задержка между отключением основного и дополнительного или дополнительного и основного адресов будет присутствовать всегда. В этом сценарии кодировщик по-прежнему является единственной точкой отказа.
	 
	- Несколько кодировщиков, каждый из которых осуществляет передачу в выделенную точку.
		
		Этот сценарий обеспечивает избыточность как кодировщиков, так и приема. В этом сценарии кодировщик1 передает сигнал на основной URL-адрес, а кодировщик2 — на дополнительный URL-адрес. При сбое одного из кодировщиков другой может по-прежнему отправлять данные. Избыточность данных при этом все равно поддерживается, так как службы мультимедиа не отключают основной и дополнительный адреса одновременно. В этом сценарии предполагается, что кодировщики синхронизированы по времени и предоставляют абсолютно одинаковые данные.
 
	- Несколько кодировщиков, осуществляющих двойную передачу как по основному, так и по дополнительному URL-адресам.
	
		В этом сценарии оба кодировщика передают данные по основному и дополнительному URL-адресам. Это обеспечивает самую высокую надежность и отказоустойчивость, а также избыточность данных. Такая конфигурация может выдержать отключения и сбои обоих кодировщиков, даже если один из кодировщиков перестанет работать. В этом сценарии предполагается, что кодировщики синхронизированы по времени и предоставляют абсолютно одинаковые данные.

Сведения о динамических кодировщиках RTMP см. в разделе [Поддержка RTMP в службах мультимедиа Azure и динамические кодировщики](http://go.microsoft.com/fwlink/?LinkId=532824).

Действительны следующие условия.

- Убедитесь, что имеется достаточно свободных возможностей подключения к Интернету для отправки данных точкам приема.
- Для использования дополнительного URL-адреса приема требуется дополнительная пропускная способность.
- Входящий поток с разными скоростями может предоставлять не более 10 уровней качества видео (слоев) и не более 5 звуковых дорожек.
- Наибольшая средняя скорость передачи для любого из уровней качества видео не должна превышать 10 Мбит/с.
- Общее значение средних скоростей для всех видео- и аудиопотоков всегда должно быть меньше 25 Мбит/с.
- Во время работы канала или связанных с ним программ входной протокол изменить невозможно. Если вам нужны другие протоколы, создайте отдельный канал для каждого из них.
- Канал может принимать поток с одной скоростью передачи, но из-за того, что поток не обрабатывается каналом, клиентские приложения также будут получать поток с одной скоростью (этот вариант не рекомендуется).

####URL-адреса приема (конечные точки) 

Канал предоставляет входную конечную точку (URL-адрес приема), которая определяется в динамическом кодировщике, чтобы кодировщик мог передать потоки в каналы.

URL-адреса приема можно получить при создании канала. Для этого каналу не обязательно находиться в состоянии **Выполняется**. Чтобы начать передавать данные каналу, его нужно перевести в состояние **Выполняется**. После того как канал начинает принимать данные, можно просмотреть поток через URL-адрес предварительного просмотра потока.

Предусмотрена возможность приема динамического потока Fragmented MP4 (Smooth Streaming) по SSL-подключению. Для приема по протоколу SSL измените URL-адрес приема на HTTPS. В настоящее время прием RTMP по протоколу SSL не поддерживается.

####<a id="keyframe_interval"></a>Интервал опорного кадра

При использовании локального динамического кодировщика для формирования потока с поддержкой нескольких скоростей интервал опорного кадра определяет длительность GOP (которая используется внешним кодировщиком). После того, как канал получит входящий поток, вы можете предоставить динамический поток клиентским приложениям для воспроизведения в любом из следующих форматов: Smooth Streaming, DASH и HLS. При динамической потоковой передаче HLS всегда упаковывается динамически. По умолчанию службы мультимедиа автоматически вычисляют соотношение упаковки сегмента HLS (число фрагментов на сегмент) на основе интервала опорного кадра, который также называется "группа кадров", полученного из динамического кодировщика.

В следующей таблице показано вычисление длительности сегментов.

Интервал опорного кадра|Соотношение упаковки сегмента HLS (FragmentsPerSegment)|Пример
---|---|---
меньше или равно 3 секундам|3:1|Если значение KeyFrameInterval (или GOP) равно 2 секундам, соотношение упаковки сегмента HLS по умолчанию будет равно 3 к 1, что приведет к созданию сегмента HLS длительностью 6 секунд.
3–5 секунд|2:1|Если значение KeyFrameInterval (или GOP) равно 4 секундам, соотношение упаковки сегмента HLS по умолчанию будет равно 2 к 1, что приведет к созданию сегмента HLS длительностью 8 секунд.
более 5 секунд|1:1|Если значение KeyFrameInterval (или GOP) равно 6 секундам, соотношение упаковки сегмента HLS по умолчанию будет равно 1 к 1, что приведет к созданию сегмента HLS длительностью 6 секунд.


Можно изменить соотношение фрагментов на сегмент, настроив вывод канала и установив параметр FragmentsPerSegment в ChannelOutputHls.

Также можно изменить значение интервала опорного кадра, установив свойство KeyFrameInterval в ChanneInput.

Если явно задать значение KeyFrameInterval, соотношение упаковки сегмента HLS, FragmentsPerSegment, вычисляется с помощью правил, описанных выше.

Если явно задать свойства KeyFrameInterval и FragmentsPerSegment, службы мультимедиа будут использовать значения, указанные пользователем.


####Разрешенные IP-адреса

Вы можете определить IP-адреса, с которых разрешено публиковать видео в этом канале. Разрешенные IP-адреса можно указать в виде одного IP-адреса (например, 10.0.0.1), диапазона IP-адресов, заданного с помощью IP-адреса и маски подсети CIDR (например, 10.0.0.1/22), или диапазона IP-адресов, заданного с помощью IP-адреса и маски подсети в десятичной записи (например, 10.0.0.1(255.255.252.0)).

Если IP-адреса не указаны и правила не заданы, ни один IP-адрес не разрешен. Чтобы разрешить все IP-адреса, создайте правило и задайте адрес 0.0.0.0/0.

###Предварительный просмотр канала 

####URL-адреса предварительного просмотра

Канал предоставляет конечную точку (URL-адрес) предварительного просмотра, с помощью которой можно проверить поток перед дальнейшей обработкой и доставкой.

Получить URL-адрес предварительного просмотра можно при создании канала. Для этого каналу не обязательно находиться в состоянии **Выполняется**.

После запуска канала можно выполнить предварительный просмотр потока.

Обратите внимание, что в настоящее время поток предварительного просмотра может предоставляться только в формате Fragmented MP4 (Smooth Streaming), независимо от указанного типа входных данных. Для проверки потока Smooth Streaming можно использовать проигрыватель [http://smf.cloudapp.net/healthmonitor](http://smf.cloudapp.net/healthmonitor). Также для просмотра потока можно воспользоваться проигрывателем, размещенным на классическом портале Azure.


####Разрешенные IP-адреса

Вы можете определить IP-адреса, которым разрешено подключаться к конечной точке предварительного просмотра. Если этого не сделать, будут разрешены все IP-адреса. Разрешенные IP-адреса можно указать в виде одного IP-адреса (например, 10.0.0.1), диапазона IP-адресов, заданного с помощью IP-адреса и маски подсети CIDR (например, 10.0.0.1/22), или диапазона IP-адресов, заданного с помощью IP-адреса и маски подсети в десятичной записи (например, 10.0.0.1(255.255.252.0)).

###Вывод канала

Дополнительные сведения см. в разделе [Настройка интервала опорного кадра](#keyframe_interval).


###Программы канала

Канал связан с программами, с помощью которых вы можете управлять публикацией и хранением сегментов динамического потока. Каналы управляют программами. Связь между каналом и программой очень похожа на аналогичную взаимосвязь в традиционной мультимедийной отрасли, где по определенному каналу транслируется постоянный поток информации, а программа связана с определенным временным промежутком — мероприятием на этом канале.

Задать количество часов, в течение которых следует хранить записанное содержимое программы, можно с помощью параметра длины **окна архивирования**. Для него можно задать значение от 5 минут до 25 часов. Длина окна архивирования также определяет максимальный период, в пределах которого клиенты могут перемещаться назад во времени относительно текущей позиции в передаваемом потоке данных. Программы могут длиться в течение определенного времени, однако содержимое, выходящее за пределы окна указанной длины, теряется. Значение этого свойства также определяет максимальный размер манифестов клиентов.

Каждая программа связана с ресурсом, в котором хранится передаваемый в потоковом режиме контент. Ресурс сопоставляется с контейнером BLOB-объектов в учетной записи хранения Azure. Файлы ресурса хранятся в этом контейнере как BLOB-объекты. Чтобы опубликовать программу для просмотра потока клиентами, необходимо создать указатель OnDemand для соответствующего ресурса. С помощью этого указателя можно сформировать URL-адрес потоковой передачи данных, который предоставляется клиентам.

Канал поддерживает одновременную потоковую трансляцию до трех программ, поэтому можно создавать по несколько архивов одного и того же входящего потока. Благодаря этому можно публиковать и архивировать разные части транслируемого мероприятия. Например ваш бизнес-требование — архивировать 6 часов программы, но для передачи только оставить последние 10 минут. Для этого необходимо создать две одновременно работающие программы. Для одной из них настроено архивирование 6 часов транслируемого мероприятия, но без публикации. Для второй программы настроено архивирование 10 минут с публикацией.

Не используйте существующие программы повторно для новых мероприятий. Вместо этого создавайте и запускайте новую программу для каждого мероприятия, как описано в разделе "Программирование приложений потоковой трансляции".

Когда вы будете готовы начать потоковую передачу и архивацию, запустите программу. Чтобы остановить потоковую передачу и архивацию содержимого мероприятия, завершите работу программы.

Чтобы удалить архивированное содержимое, остановите и удалите программу, а затем удалите связанный с ней ресурс. Ресурс невозможно удалить, пока он используется какой-либо программой: сначала нужно удалить ее.

Даже после остановки и удаления программы пользователи смогут запрашивать потоковую передачу архивированного видеосодержимого, пока не удален соответствующий ресурс.

Если вы хотите сохранить архивированное содержимое, но при этом заблокировать возможность его потоковой передачи, удалите указатель.

##<a id="states"></a>Состояния канала и их сопоставление с режимом выставления счетов 

Текущее состояние канала. Ниже перечислены возможные значения.

- **Остановлен**. Это начальное состояние канала после его создания. В этом состоянии можно изменять свойства канала, но потоковая передача запрещена.
- **Запуск**. Канал запускается. В этом состоянии обновление и потоковая передача запрещены. Если возникает ошибка, канал возвращается в состояние "Остановлен".
- **Выполняется**. Канал может обрабатывать динамические потоки.
- **Остановка**. Канал останавливается. В этом состоянии обновление и потоковая передача запрещены.
- **Удаление**. Канал удаляется. В этом состоянии обновление и потоковая передача запрещены.

В таблице ниже показано, как состояния канала соотносятся с режимом выставления счетов.
 
Состояние канала|Индикаторы в пользовательском интерфейсе портала|Выставление счетов
---|---|---|---
Starting|Starting|Нет (переходное состояние)
Выполнение|Готово (нет запущенных программ)<p> или <p>Потоковая передача (запущена по крайней мере одна программа)|Да
Остановка|Остановка|Нет (переходное состояние)
Остановлена|Остановлено|Нет

##<a id="cc_and_ads"></a>Вставка субтитров и рекламы 

В следующей таблице показаны поддерживаемые стандарты субтитров и рекламы.

Стандартная|Примечания
---|---
CEA-708 и EIA-608 (708/608)|CEA-708 и EIA-608 — это стандарты субтитров для США и Канады. <p><p>В настоящее время субтитры поддерживаются, только если они передаются в закодированном входном потоке. Необходимо использовать динамический кодировщик мультимедиа, который может вставлять субтитры стандарта 608 или 708 в закодированный поток, передаваемый службам мультимедиа. Службы мультимедиа доставляют зрителям контент с субтитрами.
TTML в ismt (текстовые дорожки Smooth Streaming)|Динамическая упаковка служб мультимедиа позволяет клиентам выполнять потоковую передачу контента в любом из следующих форматов: MPEG DASH, HLS или Smooth Streaming. Однако, если вы принимаете фрагментированный поток MP4 (Smooth Streaming) с субтитрами внутри ISMT (текстовых дорожек Smooth Streaming), вы сможете доставлять контент только клиентам Smooth Streaming.
SCTE-35|Цифровая система передачи сигналов, которая используется для вставки рекламы. Получатели используют сигнал для вставки рекламы в поток на отведенное время. Данные SCTE-35 следует передавать в виде отдельной дорожки во входном потоке.<p><p>Обратите внимание, что в настоящее время поддерживается только один формат входного потока, который переносит рекламные сигналы, — фрагментированный MP4 (Smooth Streaming). Единственным поддерживаемый выходной формат — это также Smooth Streaming.


##<a id="Considerations"></a>Рекомендации

При использовании локального динамического кодировщика для отправки потока с разными скоростями в канал действуют следующие ограничения.

- Убедитесь, что имеется достаточно свободных возможностей подключения к Интернету для отправки данных точкам приема.
- Входящий поток с разными скоростями может предоставлять не более 10 уровней качества видео (10 слоев) и не более 5 звуковых дорожек.
- Наибольшая средняя скорость передачи для любого из уровней качества видео не должна превышать 10 Мбит/с.
- Общее значение средних скоростей для всех видео- и аудиопотоков всегда должно быть меньше 25 Мбит/с.
- Во время работы канала или связанных с ним программ входной протокол изменить нельзя. Если вам нужны другие протоколы, создайте отдельный канал для каждого из них.


Другие вопросы по работе с каналами и связанными компонентами:

- Каждый раз при повторной настройке динамического кодировщика вызывайте для канала метод **Reset**. Перед сбросом канала нужно остановить программу. После сброса канала перезапустите программу.
- Канал можно остановить, только если он находится в состоянии "Выполняется" и все передаваемые по нему программы остановлены.
- По умолчанию в учетную запись служб мультимедиа можно добавить только 5 каналов. Подробнее см. в разделе [Квоты и ограничения](media-services-quotas-and-limitations.md).
- Во время работы канала или связанных с ним программ входной протокол изменить нельзя. Если вам нужны другие протоколы, создайте отдельный канал для каждого из них.
- Счета выставляются, только когда канал находится в состоянии **Выполняется**. Подробнее см. в [этом разделе](media-services-live-streaming-with-onprem-encoders.md#states).

##Создание каналов, получающих динамические многоскоростные потоки данных от локальных кодировщиков

Дополнительные сведения о локальных динамических кодировщиках см. в [разделе, посвященном использованию сторонних динамических кодировщиков со службами мультимедиа Azure](https://azure.microsoft.com/blog/azure-media-services-rtmp-support-and-live-encoders/).

Выберите **Портал**, **.NET**, **REST API**, чтобы увидеть, как создавать каналы и программы, а также управлять ими.

[AZURE.INCLUDE [media-services-selector-manage-channels](../../includes/media-services-selector-manage-channels.md)]



##Схемы обучения работе со службами мультимедиа

[AZURE.INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

##Отзывы

[AZURE.INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]



##Связанные разделы

[Спецификация приема фрагментированного потока MP4 в режиме реального времени в службах мультимедиа Azure](media-services-fmp4-live-ingest-overview.md)

[Трансляция мероприятий путем динамической потоковой передачи с помощью служб мультимедиа Azure](media-services-overview.md)

[Основные понятия служб мультимедиа](media-services-concepts.md)

[live-overview]: ./media/media-services-manage-channels-overview/media-services-live-streaming-current.png

<!---HONumber=AcomDC_0921_2016-->