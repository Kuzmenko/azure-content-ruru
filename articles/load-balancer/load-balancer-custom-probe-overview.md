<properties
  pageTitle="Пользовательские проверки балансировщика нагрузки и мониторинг состояния работоспособности | Microsoft Azure"
  description="Узнайте, как выполнять мониторинг экземпляров за балансировщиком нагрузки с помощью пользовательских проверок для балансировщика нагрузки Azure"
  services="load-balancer"
  documentationCenter="na"
  authors="sdwheeler"
  manager="carmonm"
  editor=""
  tags="azure-resource-manager"
/>
<tags
  ms.service="load-balancer"
  ms.devlang="na"
  ms.topic="article"
  ms.tgt_pltfrm="na"
  ms.workload="infrastructure-services"
  ms.date="08/25/2016"
  ms.author="sewhee" />

# Проверки балансировщика нагрузки

Балансировщик нагрузки Azure позволяет отслеживать работоспособность различных экземпляров сервера с помощью проверок. Если проверка не отвечает, балансировщик нагрузки Azure прекращает отправлять новое подключение неработоспособным экземплярам. Существующие подключения не затрагиваются, а новые подключения отправляются в работоспособные экземпляры.

Роли облачной службы (рабочие роли и веб-роли) используют гостевой агент для мониторинга проб. При использовании виртуальных машин за балансировщиком нагрузки необходимо настроить пользовательские проверки TCP или HTTP.

## Общие сведения о количестве проверок и времени ожидания

Поведение проверки зависит от следующих параметров:

- Количество успешных проверок, достаточное для того, чтобы пометить экземпляр как работоспособный.
- Количество неудачных проверок, достаточное для того, чтобы пометить экземпляр как неработоспособный.

Время ожидания, деленное на значение частоты выборки, равно значению SuccessFailCount, которое определяет, считается ли экземпляр считается работоспособным. На портале Azure в качестве значения времени ожидания задается удвоенное значение частоты.

Все экземпляры с балансировкой нагрузки для конечной точки (набор с балансировкой нагрузки) должны иметь одинаковую конфигурацию проверки. Это значит, что нельзя иметь различную конфигурацию проверок для каждого экземпляра роли или виртуальной машины в одной и той же размещенной службе для конкретного сочетания конечных точек. Например, каждый экземпляр должен иметь два одинаковых локальных порта и времени ожидания.


>[AZURE.IMPORTANT] Проверка балансировщика нагрузки использует IP-адрес 168.63.129.16. Этот общедоступный IP-адрес упрощает взаимодействие с ресурсами внутренней платформы при использовании виртуальной сети Azure с собственным IP-адресом. Общедоступный виртуальный IP-адрес 168.63.129.16 действует во всех регионах и не изменяется. Рекомендуется разрешить этот IP-адрес во всех политиках локального брандмауэра. Этот адрес не должен считаться угрозой для безопасности, так как источником сообщений с него может быть только внутренняя платформа Azure. Если этого не сделать, возникнет непредвиденное поведение в различных сценариях, например, настройка того же диапазона IP-адресов 168.63.129.16 и наличие повторяющихся IP-адресов.

## Сведения о типах проверки

### Проверка гостевого агента

Эта проверка доступна только для облачных служб Azure. Подсистема балансировки нагрузки использует гостевой агент в виртуальной машине и затем выполняет прослушивание и отправляет ответ HTTP с кодом 200 (OK), только когда экземпляр находится в состоянии "Готов" (т. е. экземпляр не находится в другом состоянии, таком как "Занят", "Перезапуск" или "Остановка").

Дополнительные сведения см. в статьях [Настройка файла определения службы (CSDEF-файла) для проверки работоспособности](https://msdn.microsoft.com/library/azure/jj151530.asp) или [Приступая к созданию балансировщика нагрузки для облачных служб, доступного в Интернете](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).

### В каком случае проверка гостевого агента отметит экземпляр как неработоспособный?

Если гостевой агент не отправляет ответ HTTP с кодом 200 (OK), балансировщик нагрузки отмечает экземпляр как неработоспособный и перестает отправлять ему трафик. Балансировщик нагрузки продолжит проверять связь с экземпляром. Если гостевой агент отправляет ответ HTTP с кодом 200 (OK), балансировщик нагрузки снова начинает отправлять трафик к этому экземпляру.

При использовании веб-роли код веб-сайта обычно выполняется в процессе w3wp.exe, который не отслеживается структурой Azure или гостевым агентом. Это означает, что ошибки в процессе w3wp.exe (например ответы HTTP с кодом 500) не будут передаваться гостевому агенту и балансировщик нагрузки не узнает о том, что экземпляр перестал использоваться.

### Пользовательская проверка HTTP

Пользовательская проверка балансировщика нагрузки HTTP переопределяет проверку гостевого агента по умолчанию и позволяет создать собственную пользовательскую логику для определения работоспособности экземпляра роли. Балансировщик нагрузки по умолчанию проверяет конечную точку каждые 15 секунд. Экземпляр считается используемым балансировщиком нагрузки, если дает ответ HTTP с кодом 200 в течение времени ожидания (по умолчанию 31 секунда).

Это может быть полезно для реализации собственной логики для удаления используемых экземпляров балансировщика нагрузки. Например, можно удалить экземпляр, если он использует более 90 % ресурсов ЦП и возвращает состояние, отличное от кода 200. Для веб-ролей, использующих w3wp.exe, также предоставляется автоматический мониторинг веб-сайта, так как при возникновении ошибок в коде веб-сайта проверке балансировщика нагрузки будет возвращено состояние, отличное от 200.

>[AZURE.NOTE] Пользовательская проверка HTTP поддерживает относительные пути и только HTTP-протокол. HTTPS не поддерживается.

### В каком случае пользовательская проверка HTTP отметит экземпляр как неработоспособный?

- Приложение HTTP возвращает код ответа HTTP, отличный от 200 (например 403, 404 или 500). Это означает, что экземпляр приложения необходимо вывести из использования прямо сейчас.

. HTTP-сервер вообще не отвечает по истечении времени ожидания. В зависимости от установленного времени ожидания это может означать, что множество запросов на проверку остаются без ответа, перед тем как проверка отмечает экземпляр как неработоспособный (то есть перед отправкой количества проверок, равного SuccessFailCount).
- 	Сервер закрывает подключение путем сброса TCP-соединения.

### Пользовательская проверка TCP

Проверки TCP инициализируют подключение, выполняя трехстороннее подтверждение на определенном порту.

### В каком случае пользовательская проверка TCP отметит экземпляр как неработоспособный?

- TCP-сервер вообще не отвечает по истечении времени ожидания. Когда проверка отмечена как неработоспособная в зависимости от количества неудачных запросов на проверку, достаточного для того, чтобы проверка была помечена как неработоспособная.
- Проверка получает сброс TCP-соединения от экземпляра роли.

Дополнительные сведения о настройке проверки работоспособности HTTP и проверки TCP см. в разделе [Приступая к созданию доступного через Интернет балансировщика нагрузки в Resource Manager с помощью PowerShell](load-balancer-get-started-internet-arm-ps.md#create-lb-rules-nat-rules-a-probe-and-a-load-balancer).

## Добавление работоспособных экземпляров в подсистему балансировки нагрузки

Проверки TCP и HTTP считаются допустимыми и отмечают экземпляр роли как работоспособный в следующих случаях:

- Балансировщик нагрузки получает положительный результат проверки при первой загрузке виртуальной машины.
- Количество успешных проверок, необходимых для отметки экземпляра роли как работоспособного, определяется параметром SuccessFailCount (см. выше). Если экземпляр роли был удален, то для пометки экземпляра роли как неработоспособного количество последующих успешных проверок должно быть не меньше значения SuccessFailCount.

>[AZURE.NOTE] Если состояние работоспособности экземпляра роли постоянно меняется, балансировщик нагрузки ожидает более длительное время перед переводом экземпляра роли обратно в работоспособное состояние. Для этого используется политика, позволяющая защитить пользователей и инфраструктуру.

## Использование службы анализа журналов для балансировщика нагрузки

Для проверки состояния работоспособности проверок и количества проверок можно использовать [службу анализа журналов для балансировщика нагрузки](load-balancer-monitor-log.md). Функция ведения журналов в Power BI или Azure Operational Insights позволяет получать статистические данные о работоспособности балансировщика нагрузки.

<!---HONumber=AcomDC_0921_2016-->