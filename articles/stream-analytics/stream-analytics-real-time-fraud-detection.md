<properties
	pageTitle="Stream Analytics: выявление мошенничества в режиме реального времени | Microsoft Azure"
	description="Информация о том, как с помощью службы Stream Analytics создать решение для выявления мошенничества в режиме реального времени. Используйте концентратор событий для обработки событий в реальном времени."
	keywords="обнаружение аномалий, обнаружение мошенничества, обнаружение аномалий в реальном времени"
	services="stream-analytics"
	documentationCenter=""
	authors="jeffstokes72"
	manager="jhubbard"
	editor="cgronlun" />

<tags
	ms.service="stream-analytics"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="data-services"
	ms.date="08/11/2016"
	ms.author="jeffstok" />



# Приступая к работе с Azure Stream Analytics: выявление мошенничества в режиме реального времени

Узнайте, как с помощью службы Azure Stream Analytics создать комплексное решение для выявления мошенничества в режиме реального времени. Переносите события в концентраторы событий Azure, составляйте запросы Stream Analytics для агрегирования данных или отправки предупреждений, а также отправляйте результаты в приемник выходных данных для анализа данных с помощью обработки в режиме реального времени. В статье рассматривается вопрос обнаружения аномалий в реальном времени для телекоммуникационной отрасли, но приведенная в примере методика одинаково подходит и для обнаружения других видов мошенничества (например, кража кредитных карт или персональных данных).

Stream Analytics — это полностью управляемая служба, обеспечивающая масштабируемую обработку сложных событий с низкой задержкой и высоким уровнем доступности посредством потоковой передачи данных в облако. Дополнительные сведения см. в статье [Введение в Azure Stream Analytics](stream-analytics-introduction.md).


## Сценарий. Выявление мошенничества в отношении телекоммуникаций и SIM-карт в режиме реального времени

У поставщика телекоммуникационных услуг есть большой объем данных для входящих вызовов. Организации необходимо:
* Сократить объем этих данных и тем самым облегчить управление ими, а также проанализировать сведения об использовании клиентом услуг по времени и географическим регионам.
* Обнаруживать мошенничества в отношении SIM-карт (когда один пользователь одновременно выполняет несколько вызовов из разных географических расположений) в режиме реального времени, чтобы с легкостью реагировать на угрозы путем уведомления клиентов или завершения работы службы.

В традиционных сценариях использования «Интернета вещей» (IoT) при наличии множества создаваемых данных телеметрии или датчиков клиенты желают агрегировать эти данные или получать оповещения о проблемах в реальном времени.

## Предварительные требования

- Скачайте файл [TelcoGenerator.zip](http://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB83-3354B69C8A7E/TelcoGenerator.zip) из Центра загрузки Майкрософт.
- Дополнительно: исходный код генератора событий с сайта [GitHub](https://aka.ms/azure-stream-analytics-telcogenerator).

## Создание входных данных концентраторов событий и группы потребителей Azure

В этом примере создаются события, которые принудительно отправляются в экземпляр концентратора событий для обработки в режиме реального времени. Концентраторы событий служебной шины являются предпочтительным способом приема событий для службы Stream Analytics. Дополнительные сведения о концентраторах событий в приведены в [документации по служебной шине Azure](/documentation/services/service-bus/).

Создание концентратора событий

1.	На [портале Azure](https://manage.windowsazure.com/) последовательно щелкните **Создать** > **Службы приложений** > **Служебная шина** > **Концентратор событий** > **Быстрое создание**. Укажите имя, регион и новое или существующее пространство имен, чтобы создать концентратор событий.
2.	Рекомендуем, чтобы каждое задание Stream Analytics считывалось из отдельной группы получателей концентратора событий. Следуя нашим указаниям, вы сможете создать указанную ниже группу получателей и [узнать о них много нового](https://msdn.microsoft.com/library/azure/dn836025.aspx). Чтобы создать группу получателей, перейдите к только что созданному концентратору событий, щелкните вкладку **Группы получателей**, нажмите кнопку **Создать** в нижней части страницы и укажите имя группы получателей.
3.	Чтобы предоставить доступ к концентратору событий, необходимо создать политику общего доступа. Перейдите на вкладку **Настройка** в окне концентратора событий.
4.	В разделе **Политики общего доступа** создайте политику с разрешениями на уровне **Управление**.

	![Политики общего доступа, в которых можно создать политику с разрешениями на управление.](./media/stream-analytics-real-time-fraud-detection/stream-ananlytics-shared-access-policies.png)

5.	В нижней части страницы нажмите кнопку **Сохранить**.
6.	Перейдите на **панель мониторинга** и нажмите внизу страницы кнопку **Сведения о подключении**. Затем скопируйте и сохраните сведения о подключении.

## Настройка и запуск приложения генератора событий

Мы создали клиентское приложение, с помощью которого создается пример метаданных входящих вызовов, которые отправляются в концентратор событий. Выполните следующие действия, чтобы настроить это приложение.

1.	Скачайте [файл TelcoGenerator.zip](http://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB83-3354B69C8A7E/TelcoGenerator.zip). Распакуйте его в папку.

    **Примечание**. Windows может заблокировать скачанный ZIP-файл. Щелкните его правой кнопкой мыши и выберите свойства. Если появляется сообщение "Этот файл получен с другого компьютера и, возможно, был заблокирован с целью защиты компьютера", установите флажок "Разблокировать" и нажмите кнопку применения ZIP-файла.

2.	Замените значения Microsoft.ServiceBus.ConnectionString и EventHubName в файле **telcodatagen.exe.config** своей строкой подключения и именем концентратора событий.

    **Примечание**. К строке подключения, скопированной из портала Azure, добавляется имя подключения. Не забудьте удалить ";EntityPath=<значение>" из поля add key=.

3.	Запустите приложение. Оно используется следующим образом.

   telcodatagen.exe [#NumCDRsPerHour] [вероятность мошенничества с SIM-картами] [#DurationHours]

В следующем примере будет создано 1000 событий с вероятностью мошенничества 20 % в течение 2 часов:

    telcodatagen.exe 1000 .2 2

Отобразятся записи, отправляемые в концентратор событий. Ниже определены некоторые ключевые поля, которые будут использоваться в этом приложении для выявления мошенничества в реальном времени:

| Record | Определение |
| ------------- | ------------- |
| CallrecTime | Метка времени начала вызова. |
| SwitchNum | Телефонный переключатель, используемый для совершения вызова. |
| CallingNum | Номер телефона звонящего. |
| CallingIMSI | Идентификатор IMSI. Уникальный идентификатор звонящего. |
| CalledNum | Номер телефона получателя звонка. |
| CalledIMSI | Идентификатор IMSI. Уникальный идентификатор получателя звонка. |


## Создание задания Stream Analytics
Теперь, когда у нас есть поток телекоммуникационных событий, можно настроить задание Stream Analytics, чтобы анализировать эти события в режиме реального времени.

### Подготовка задания Stream Analytics

1.	На портале Azure выберите пункты **Создать > Службы данных > Stream Analytics > Быстрое создание**.
2.	Укажите следующие значения и щелкните **Создать задание Stream Analytics**:

	* **Имя задания**: введите имя задания.

	* **Регион**: выберите регион, в котором должно выполняться задание. Рекомендуем поместить задание в концентратор событий в том же регионе, чтобы улучшить производительность и избежать лишних затрат на передачу данных между регионами.

	* **Учетная запись хранения**: выберите учетную запись хранения Azure, которую вы хотите использовать для хранения данных отслеживания всех заданий Stream Analytics, запущенных в этом регионе. Можно создать учетную запись хранения или выбрать уже существующую.

3.	Щелкните **Stream Analytics** в области слева, чтобы открыть список заданий Stream Analytics.

	![Значок службы Stream Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-service-icon.png)

4.	Новое задание будет отображаться с состоянием **Создано**. Обратите внимание, что кнопка **Пуск** в нижней части страницы отключена. Прежде чем запустить задание, необходимо настроить для него запрос, входные и выходные данные.

### Укажите вход данных для задания
1.	В задании Stream Analytics щелкните **Входные данные** в верхней части страницы, а затем выполните команду **Добавить входные данные**. В открывшемся диалоговом окне вы сможете выполнить ряд действий по настройке входных данных.
2.	Выберите пункт **Поток данных** и нажмите расположенную справа кнопку.
3.	Выберите пункт **Концентратор событий** и нажмите расположенную справа кнопку.
4.	На третьей странице введите или выберите следующие значения:

	* **Псевдоним входных данных**: введите понятное имя для входных данных этого задания, например *CallStream*. В дальнейшем это имя будет использоваться в запросе.
	* **Концентратор событий** — если созданный концентратор событий находится в той же подписке, что и задание Stream Analytics, выберите пространство имен, которому принадлежит концентратор.

	Если концентратор событий находится в другой подписке, выберите **Использовать концентратор событий из другой подписки** и введите вручную информацию в полях **Пространство имен Service Bus**, **Имя концентратора событий**, **Имя политики концентратора событий**, **Ключ политики концентратора событий** и **Event Hub Partition Count** (Количество секций концентратора событий).

	* **Имя концентратора событий**: выберите имя концентратора событий

	* **Имя политики концентратора событий**: выберите политику для концентратора событий, созданную ранее в этом учебнике.

	* **Группа пользователей концентратора событий**: введите группу пользователей, созданную ранее в соответствии с инструкциями этого руководства.
5.	Щелкните стрелку вправо.
6.	Укажите следующие значения:

	* **Формат сериализатора событий**: JSON;
	* **Кодировка**: UTF8.
7.	Нажмите кнопку "Проверить", чтобы добавить этот источник и убедиться, что служба Stream Analytics может успешно подключаться к концентратору событий.

### Укажите запрос задания

Stream Analytics поддерживает простую декларативную модель запроса для описания преобразований для обработки в режиме реального времени. Дополнительные сведения о языке см. в [справочнике по языку запросов Azure Stream Analytics](https://msdn.microsoft.com/library/dn834998.aspx). Этот учебник поможет создать и проверить несколько запросов потока данных вызова в режиме реального времени.

#### Необязательно: пример входных данных
Чтобы проверить запрос на соответствие фактическим данным задания, можно использовать функцию **Демонстрационные данные** для извлечения событий из потока и создания JSON-файла событий для тестирования. Ниже показано, как это сделать. Кроме того, мы предоставили для тестирования пример файла [Telco.json](https://github.com/Azure/azure-stream-analytics/blob/master/Sample%20Data/telco.json).

1.	Выберите входные данные концентратора событий и нажмите кнопку **Демонстрационные данные** в нижней части страницы.
2.	В появившемся окне укажите **Время начала** сбора данных и **Продолжительность** получения дополнительных данных.
3.	Нажмите кнопку "Проверить", чтобы запустить данные выборки из входных данных. Создание файла может занять пару минут. По завершении процесса щелкните **Сведения**, а затем скачайте и сохраните созданный JSON-файл.

	![Скачивание и сохранение обработанных данных в JSON-файле](./media/stream-analytics-real-time-fraud-detection/stream-analytics-download-save-json-file.png)

#### Запрос к серверу

Чтобы архивировать все события, вы можете отправить запрос к серверу для считывания всех полей в полезных данных события или сообщения. Для начала создайте простой запрос к серверу, чтобы заполнить все поля события.

1.	Щелкните **Запрос** в верхней части страницы задания Stream Analytics.
2.	Добавьте в редакторе следующий код:

		SELECT * FROM CallStream

	> Убедитесь, что имя входного источника соответствует имени входных данных, указанному вами ранее.

3.	В редакторе запросов щелкните **Тест**.
4.	Укажите тестовый файл, созданный с помощью этой процедуры, или используйте файл [telco.json](https://github.com/Azure/azure-stream-analytics/blob/master/Samples/SampleDataFiles/Telco.json).
5.	Нажмите кнопку проверки и просмотрите результаты, которые отображаются под определением запроса.

	![Результаты определения запроса](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sim-fraud-output.png)


### Заполнение столбцов

Теперь мы сократим набор возвращаемых полей.

1.	Измените запрос в редакторе кода на:

		SELECT CallRecTime, SwitchNum, CallingIMSI, CallingNum, CalledNum
		FROM CallStream

2.	Щелкните **Повтор** в редакторе запросов, чтобы просмотреть результаты запроса.

	![Выходные данные в редакторе запросов.](./media/stream-analytics-real-time-fraud-detection/stream-analytics-query-editor-output.png)

### Количество входящих вызовов по региону: "переворачивающееся" окно с агрегированием

Для сравнения количества входящих вызовов на регион мы используем [TumblingWindow](https://msdn.microsoft.com/library/azure/dn835055.aspx). Это позволит получить данные о числе входящих вызовов, которые каждые 5 секунд группируются по параметру SwitchNum.

1.	Измените запрос в редакторе кода на:

		SELECT System.Timestamp as WindowEnd, SwitchNum, COUNT(*) as CallCount
		FROM CallStream TIMESTAMP BY CallRecTime
		GROUP BY TUMBLINGWINDOW(s, 5), SwitchNum

	В этом запросе используется ключевое слово **Timestamp By**, позволяющее задать поле метки времени в полезных данных, используемых при вычислении временных распределений. Если это поле не указано, операции с окнами будут выполняться каждый раз при поступлении события в концентратор событий. См. раздел ["Время прибытия и время приложения" в справочнике по языку запросов Stream Analytics](https://msdn.microsoft.com/library/azure/dn834998.aspx).

	Обратите внимание, что вы можете получить доступ к метке времени конца каждого окна с помощью свойства **System.Timestamp**.

2.	Щелкните **Повтор** в редакторе запросов, чтобы просмотреть результаты запроса.

	![Результаты запроса по Timestand By](./media/stream-analytics-real-time-fraud-detection/stream-ananlytics-query-editor-rerun.png)

### Выявление мошенничества в отношении SIM-карт с помощью самосоединения

Чтобы определить потенциально мошеннические действия, мы выполним поиск вызовов, которые в течение менее 5 секунд совершает один пользователь из нескольких мест. Для проверки таких случаев поток событий вызовов необходимо [объединить](https://msdn.microsoft.com/library/azure/dn835026.aspx) с самим собой.

1.	Измените запрос в редакторе кода на:

		SELECT System.Timestamp as Time, CS1.CallingIMSI, CS1.CallingNum as CallingNum1,
		CS2.CallingNum as CallingNum2, CS1.SwitchNum as Switch1, CS2.SwitchNum as Switch2
		FROM CallStream CS1 TIMESTAMP BY CallRecTime
		JOIN CallStream CS2 TIMESTAMP BY CallRecTime
		ON CS1.CallingIMSI = CS2.CallingIMSI
		AND DATEDIFF(ss, CS1, CS2) BETWEEN 1 AND 5
		WHERE CS1.SwitchNum != CS2.SwitchNum

2.	Щелкните **Повтор** в редакторе запросов, чтобы просмотреть результаты запроса.

	![Результаты запроса соединения](./media/stream-analytics-real-time-fraud-detection/stream-ananlytics-query-editor-join.png)

### Создание приемника выходных данных

Теперь, когда мы определили поток событий, входные данные концентратора событий для приема событий и запрос для выполнения преобразования потока, остался последний этап — определить приемник выходных данных задания. Мы запишем события, связанные с мошенническими действиями, в хранилище BLOB-объектов.

Выполните следующие действия, чтобы создать контейнер для хранения больших двоичных объектов, если он еще не создан.

1.	Используйте существующую учетную запись хранения или создайте новую. Для этого щелкните **Создать > Службы данных > Служба хранилища > Быстрое создание** и следуйте указаниям на экране.
2.	Выберите учетную запись хранения, щелкните **Контейнеры** в верхней части страницы, а затем нажмите кнопку **Добавить**.
3.	В поле **ИМЯ** укажите имя контейнера, а в поле **ДОСТУП** задайте разрешение на доступ к общедоступному большому двоичному объекту.

## Укажите выходные данные задания

1.	В задании Stream Analytics щелкните **ВЫХОДНЫЕ ДАННЫЕ** в верхней части страницы, а затем выберите пункт **ДОБАВИТЬ ВЫХОДНЫЕ ДАННЫЕ**. В открывшемся диалоговом окне вы сможете выполнить ряд действий по настройке выходных данных.
2.	Выберите пункт **ХРАНИЛИЩЕ БОЛЬШИХ ДВОИЧНЫХ ОБЪЕКТОВ**, а затем нажмите расположенную справа кнопку.
3.	На третьей странице введите или выберите следующие значения:

	* **Выходной псевдоним**: введите понятное имя для этих выходных данных задания.
	* **Подписка**: если хранилище BLOB-объектов создано в той же подписке, что и задание Stream Analytics, выберите параметр **Использовать учетную запись хранения из текущей подписки**. Если хранилище связано с другой подпиской, выберите **Использовать учетную запись хранения из другой подписки** и вручную заполните поля **УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ**, **КЛЮЧ УЧЕТНОЙ ЗАПИСИ ХРАНЕНИЯ** и **КОНТЕЙНЕР**.
	* **УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ**: выберите имя учетной записи хранения.
	* **КОНТЕЙНЕР**: выберите имя контейнера.
	* **ПРЕФИКС ИМЕНИ ФАЙЛА**: введите префикс файла, который следует использовать при записи выходных данных большого двоичного объекта.

4.	Щелкните стрелку вправо.
5.	Укажите следующие значения:

	* **ФОРМАТ СЕРИАЛИЗАТОРА СОБЫТИЙ**: JSON;
	* **КОДИРОВКА**: UTF8.

6.	Нажмите кнопку "Проверить", чтобы добавить этот источник и убедиться, что служба Stream Analytics может успешно подключаться к учетной записи хранения.

## Запуск задания для обработки в режиме реального времени

Входные данные, запрос и выходные данные заданы, так что теперь можно запустить задание Stream Analytics для выявления мошенничества в режиме реального времени.

1.	На **ПАНЕЛИ МОНИТОРИНГА** задания щелкните **НАЧАЛО** в нижней части страницы.
2.	В открывшемся диалоговом окне выберите **Время начала задания**, а затем нажмите в нижней части диалогового окна кнопку с галочкой. Состояние задания изменится на **Запуск**, а затем — на **Выполняется**.

## Просмотр выходных данных при выявлении мошенничества

Чтобы просматривать события, связанные с мошенническими действиями, во время их записи в выходные данные в режиме реального времени, воспользуйтесь такими инструментами, как [обозреватель хранилищ Azure](http://storageexplorer.com/) или [обозреватель Azure](http://www.cerebrata.com/products/azure-explorer/introduction).

![Выявление мошенничества. Связанные с мошенническими действиями события, просмотренные в режиме реального времени](./media/stream-analytics-real-time-fraud-detection/stream-ananlytics-view-real-time-fraudent-events.png)

## Получение поддержки
За дополнительной помощью обращайтесь на наш [форум Azure Stream Analytics](https://social.msdn.microsoft.com/Forums/ru-RU/home?forum=AzureStreamAnalytics).


## Дальнейшие действия

- [Введение в Azure Stream Analytics](stream-analytics-introduction.md)
- [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
- [Справочник по языку запросов Azure Stream Analytics](https://msdn.microsoft.com/library/azure/dn834998.aspx)
- [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)

<!---HONumber=AcomDC_0921_2016-->