<properties
	pageTitle="Общие сведения о репликации Hyper-V с помощью Azure Site Recovery | Microsoft Azure" 
	description="Эта статья поможет изучить технические концепции, которые помогут успешно устанавливать и настраивать службу Azure Site Recovery, а также управлять ею." 
	services="site-recovery" 
	documentationCenter="" 
	authors="anbacker" 
	manager="mkjain" 
	editor=""/>

<tags 
	ms.service="site-recovery" 
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery" 
	ms.date="09/12/2016" 
	ms.author="anbacker"/>
 

# Общие сведения о репликации Hyper-V с помощью Azure Site Recovery

Эта статья описывает технические концепции, которые помогут вам успешно настраивать и контролировать защиту между сайтом Hyper-V или сайтом VMM и Azure с помощью Azure Site Recovery.

## Общие сведения о компонентах

### Развертывание сайта Hyper-V или VMM для репликации между локальной средой и Azure.
 
В ходе настройки аварийного восстановления между локальными средами и Azure необходимо загрузить поставщика Azure Site Recovery и установить на сервере VMM вместе с агентом служб восстановления Azure, который должен быть установлен на каждом узле Hyper-V.

![Развертывание с использованием VMM для репликации между локальными средами и Azure](media/site-recovery-understanding-site-to-azure-protection/image00.png)

Развертывание узла Hyper-V выполняется так же, как и развертывание VMM, только поставщик и агент устанавливаются на самом узле Hyper-V.

## Общие сведения о рабочих процессах

### Включение защиты
После активации защиты виртуальной машины, которая выполняется на портале или локально, создается задание ASR с именем *Включение защиты*, которое можно отслеживать на вкладке «ЗАДАНИЯ».

![Устранение неполадок локальной среды Hyper-V](media/site-recovery-understanding-site-to-azure-protection/image001.PNG)

Задание *Включение защиты* проверяет выполнение обязательных условий. Затем оно вызывает метод [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx), который создает репликацию в Azure с использованием входных данных, указанных при активации защиты. Задание *Включение защиты* запускает начальную репликацию из локальной среды, вызывая задание [StartReplication](https://msdn.microsoft.com/library/hh850303.aspx). Последнее отправляет в Azure содержимое виртуальных дисков виртуальной машины.

![Устранение неполадок локальной среды Hyper-V](media/site-recovery-understanding-site-to-azure-protection/IMAGE002.PNG)

### Завершение подготовки защиты
При запуске начальной репликации создается [моментальный снимок виртуальной машины Hyper-V](https://technet.microsoft.com/library/dd560637.aspx). Виртуальные жесткие диски будут обрабатываться по очереди, пока не будут отправлены в Azure. Этот процесс занимает некоторое время в зависимости от размеров дисков и пропускной способности. Ознакомьтесь с методами оптимизации использования сети в статье [Управление использованием пропускной способности сети для защиты между локальной средой и Azure](https://support.microsoft.com/kb/3056159). После завершения начальной репликации выполняется задача *Завершение подготовки защиты на виртуальной машине*, которая выполняет настройку сети и настройку после репликации. Во время начальной репликации отслеживаются все изменения данных на дисках, как описано далее в разделе, посвященном разностной репликации. Во время начальной репликации будет использоваться дополнительное дисковое пространство для хранения моментального снимка и HRL-файлов. После завершения начальной репликации моментальный снимок виртуальной машины Hyper-V удаляется. В результате этого изменения данных, выполненные после запуска начальной репликации, переносятся на родительский диск.

![Устранение неполадок локальной среды Hyper-V](media/site-recovery-understanding-site-to-azure-protection/image03.png)

### Разностная репликация данных
Модуль отслеживания репликации реплики Hyper-V, который является частью системы репликации реплики Hyper-V, регистрирует в журналах репликации Hyper-V (*.hrl) изменения, произошедшие на виртуальном жестком диске. HRL-файлы размещаются в одном каталоге с дисками, к которым они относятся. Для каждого диска, предназначенного для репликации, будет создан связанный HRL-файл. Эти журналы передаются в пользовательскую учетную запись хранения после завершения начальной репликации. Во время передачи журнала в Azure изменения основного диска отслеживаются в дополнительном журнале, расположенного в том же каталоге.

Работоспособность репликации виртуальной машины в ходе начальной или разностной репликации можно отслеживать в представлении виртуальной машины, как описано в разделе [Мониторинг работоспособности репликации виртуальной машины](./site-recovery-monitoring-and-troubleshooting.md#monitor-replication-health-for-virtual-machine).

### Повторная синхронизация 
Виртуальная машина отмечается для повторной синхронизации, если произошел сбой в ходе разностной репликации, а полная начальная репликация чрезмерно затратна с точки зрения пропускной способности сети или времени выполнения. Например, если размер HRL-файла увеличивается на 50 % от общего размера диска, виртуальная машина отмечается для выполнения повторной синхронизации. Повторная синхронизация минимизирует объем данных, передаваемых по сети. Для этого вычисляются контрольные суммы исходного и целевого дисков виртуальной машины, а затем отправляется только полученная разница.

После завершения повторной синхронизации возобновляется обычный режим разностной репликации. Повторная синхронизация может возобновляться в случае сбоев (например, после отключения питания, сбоя VMMS и т. д.).

*Автоматическое выполнение повторной синхронизации* по умолчанию выполняется в нерабочее время. Если вы желаете выполнить повторную синхронизацию виртуальной машины вручную, выберите виртуальную машину на портале и щелкните "ПОВТОРНАЯ СИНХРОНИЗАЦИЯ".

![Устранение неполадок локальной среды Hyper-V](media/site-recovery-understanding-site-to-azure-protection/image04.png)

Повторная синхронизация использует алгоритм фрагментации на фиксированные блоки. Этот алгоритм разделяет исходные и целевые файлы на фрагменты фиксированной длины, а затем вычисляет контрольную сумму каждого фрагмента. Сравнение этих сумм позволяет определить блоки, которые нужно передать с исходного диска на целевой.

### Логика повторных попыток
При возникновении ошибок репликации используется встроенный алгоритм повторных попыток. Ошибки делятся на две представленные ниже категории.

| Категория | Сценарии |
|---------------------------|----------------------------------------------|
| Неустранимая ошибка | Повторная попытка не выполняется. Состояние репликации виртуальной машины отображается как критическое; требуется вмешательство администратора. Примеры таких ошибок: <ul><li>нарушение цепочки виртуальных жестких дисков;</li><li>недопустимое состояние реплики виртуальной машины;</li><li>ошибка определения подлинности сети;</li><li>ошибка авторизации;</li><li>ошибка поиска виртуальной машины для изолированного сервера Hyper-V.</li></ul>|
| Устранимая ошибка | Повторные попытки выполняются в рамках каждого интервала репликации с использованием экспоненциального алгоритма отсрочки. При этом каждая следующая попытка выполняется с большей задержкой (1, 2, 4, 8, 10 минут). Если проблема не устранена, повторные попытки выполняются каждые 30 минут. Примеры таких ошибок: <ul><li>сетевая ошибка;</li><li>недостаточно места на диске;</li><li>недостаточно памяти.</li></ul>|

## Основные сведения о жизненном цикле защиты и восстановления виртуальных машин Hyper-V

![Основные сведения о жизненном цикле защиты и восстановления виртуальных машин Hyper-V](media/site-recovery-understanding-site-to-azure-protection/image05.png)

## Прочие ссылки

- [Отслеживание и устранение неполадок защиты для VMware, VMM, Hyper-V и физических расположений](./site-recovery-monitoring-and-troubleshooting.md)
- [Служба технической поддержки Майкрософт](./site-recovery-monitoring-and-troubleshooting.md#reaching-out-for-microsoft-support)
- [Распространенные ошибки ASR и способы их устранения](./site-recovery-monitoring-and-troubleshooting.md#common-asr-errors-and-their-resolutions)

<!---HONumber=AcomDC_0921_2016-->