<properties
	pageTitle="Репликация виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery на портале Azure | Microsoft Azure"
	description="В этой статье описывается, как развернуть Azure Site Recovery, чтобы координировать репликацию, отработку отказа и восстановление локальных виртуальных машин VMware и физических серверов Windows и Linux в Azure с использованием портала Azure."
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/12/2016"
	ms.author="raynew"/>

# Репликация виртуальных машин VMware и физических компьютеров в Azure с помощью службы Azure Site Recovery и портала Azure

> [AZURE.SELECTOR]
- [Портал Azure](site-recovery-vmware-to-azure.md)
- [Классическая модель Azure](site-recovery-vmware-to-azure-classic.md)
- [Классический портал Azure (предыдущая версия)](site-recovery-vmware-to-azure-classic-legacy.md)

Вас приветствует служба Azure Site Recovery! Эта статья поможет вам выполнить репликацию локальных виртуальных машин VMware или физических серверов Windows или Linux в Azure с использованием службы Azure Site Recovery на портале Azure.

> [AZURE.NOTE] В Azure предлагаются две [модели развертывания](../resource-manager-deployment-model.md) для создания ресурсов и работы с ними: модель Azure Resource Manager (ARM) и классическая модель. Кроме того, Azure предоставляет два портала — классический портал Azure, поддерживающий классическую модель развертывания, и портал Azure, поддерживающий обе модели развертывания.

Site Recovery на портале Azure обеспечивает множество новых возможностей:

- Служба архивации Azure и службы Azure Site Recovery объединены в одном хранилище служб восстановления. Таким образом, вы можете настроить непрерывность бизнес-процессов и аварийное восстановление и управлять этими функциями из одного места. На единой панели мониторинга можно отслеживать операции между локальными сайтами и общедоступным облаком Azure и управлять ими.
- Теперь у пользователей с подписками Azure, которые подготовлены к работе в рамках программы для поставщиков облачных решений, появилась возможность управлять операциями Site Recovery на портале Azure.
- Используя службу Site Recovery на портале Azure, можно реплицировать компьютеры в учетные записи хранения ARM. При отработке отказа Site Recovery создает виртуальные машины на основе ARM в Azure.
- Site Recovery по-прежнему поддерживает репликацию в классические учетные записи хранения. При отработке отказа Site Recovery создает виртуальные машины с использованием классической модели.

Если после прочтения этой статьи у вас появятся комментарии, вы можете оставить их внизу в разделе обсуждений. Вы можете задать любые вопросы технического характера на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## Обзор

Организациям нужна стратегия обеспечения непрерывности бизнес-процессов и аварийного восстановления, которая определяет, как приложения, рабочие нагрузки и данные будут оставаться доступными при запланированных и незапланированных простоях, а также как можно максимально быстро восстановить нормальный режим работы. Эта стратегия должна обеспечивать защиту и восстановление бизнес-данных, а также постоянную доступность рабочих нагрузок в случае сбоя.

Служба Azure Site Recovery помогает реализовать стратегию BCDR. Она управляет процессами репликации локальных физических серверов и виртуальных машин в облако (Azure) или дополнительные центры обработки данных. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода в дополнительное расположение. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него. Дополнительные сведения см. в статье [Что такое Site Recovery?](site-recovery-overview.md)

Эта статья содержит все сведения, необходимые для репликации локальных виртуальных машин VMware и физических серверов Windows/Linux в среду Azure. Здесь приведены обзор архитектуры и сведения о планировании, а также рассмотрены этапы развертывания для настройки среды Azure, локальных серверов, параметров репликации и планирования ресурсов. После настройки инфраструктуры можно включить репликацию на компьютерах, которые требуется защитить, и проверить работоспособность отработки отказа.

## Преимущества для предприятий

- Site Recovery обеспечивает удаленную защиту корпоративных рабочих нагрузок и приложений, запущенных на виртуальных машинах VMware и физических серверах.
- Портал служб восстановления предоставляет единое расположение для настройки, мониторинга и контроля репликации, отработки отказа и восстановления.
- Служба Site Recovery способна автоматически обнаружить виртуальные машины VMware, добавление в узлы vSphere.
- Azure Site Recovery позволяет выполнять простую отработку отказа из локальной инфраструктуры в Azure и восстановление размещения (восстановление) с переносом из Azure на серверы виртуальных машин VMware на локальном сайте.
- Можно включить развертывание нескольких виртуальных машин и создать группы репликации, чтобы рабочие нагрузки приложений, распределенные между несколькими компьютерами, реплицировались одновременно. Все компьютеры в группе репликации имеют отказоустойчивые и согласованные точки восстановления после отработки отказа. Для отработки отказа можно объединить в планах восстановления сразу несколько компьютеров, чтобы отработка отказа выполнялась для всей распределенной рабочей нагрузки.

## Поддерживаемые операционные системы

### Windows (только 64-разрядная версия)
- Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздняя версия.
- Windows Server 2012
- Windows Server 2012 R2

### Linux (только 64-разрядная версия)
- Red Hat Enterprise Linux 6.7, 7.1, 7.2.
- CentOS 6.5, 6.6, 6.7, 7.0, 7.1, 7.2.
- Oracle Enterprise Linux 6.4, 6.5 с ядром, совместимым с Red Hat, или с ядром Unbreakable Enterprise Kernel Release 3 (UEK3).
- SUSE Linux Enterprise Server 11 SP3

## Архитектура сценария

Ниже приведены компоненты, участвующие в сценарии:

- **Сервер конфигурации** — локальный компьютер, который координирует обмен данными и управляет процессами репликации и восстановления данных. На этом компьютере запускается отдельный файл установки, который устанавливает сервер конфигурации, а также следующие дополнительные компоненты:
	- **Сервер обработки** — выступает в качестве шлюза репликации. Он получает данные репликации с защищенных исходных компьютеров, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure. Он также обеспечивает принудительную установку службы Mobility Service на защищенные компьютеры и выполняет автоматическое обнаружение виртуальных машин VMware. Сервер обработки по умолчанию устанавливается на сервере конфигурации. Для масштабирования среды можно развернуть дополнительные автономные серверы обработки.
	- **Главный целевой сервер** — обрабатывает данные репликации при восстановлении размещения с переносом из Azure.

- **Служба Mobility**. Этот компонент развертывается на каждом компьютере (виртуальной машине VMware или физическом сервере), для которого требуется выполнить репликацию в Azure. Она фиксирует операции записи данных на компьютере и перенаправляет их на сервер обработки.
- **Azure**. Для выполнения репликации и отработки отказа в Azure не нужно создавать виртуальные машины Azure. Требуется подписка Azure, учетная запись хранения Azure для хранения реплицированных данных и виртуальная сеть Azure для подключения виртуальных машин Azure к сети после отработки отказа. Учетная запись хранения и сеть должны располагаться в том же регионе, что и хранилище служб восстановления.
- **Восстановления размещения**. Когда вы будете готовы к восстановлению размещения из Azure на локальный сайт после отработки отказа, необходимо будет создать виртуальную машину Azure, исполняющую роль временного сервера обработки. После восстановления размещения ее можно будет удалить. Для восстановления размещения также потребуется VPN-подключение (или Azure ExpressRoute) между локальным узлом и сетью Azure, в которой размещаются виртуальные машины Azure. Если трафик восстановления размещения слишком велик, может потребоваться локальная установка специального главного целевого сервера. При небольшом трафике можно использовать главный целевой сервер, который выполняется на сервере конфигурации.


На рисунке показано взаимодействие этих компонентов.

![архитектура](./media/site-recovery-vmware-to-azure/v2a-architecture-henry.png)

**Рисунок 1. Виртуальные машины VMware или физические компьютеры в Azure**

## Предварительные требования Azure

Для развертывания этого сценария вам потребуются следующие компоненты среды Azure.

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Учетная запись Azure**| Вам потребуется учетная запись [Microsoft Azure](http://azure.microsoft.com/). Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). Ознакомьтесь с [дополнительными сведениями](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery.
**Служба хранилища Azure** | Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure создаются при отработке отказа. <br/><br/> Для хранения данных потребуется учетная запись хранения уровня "Стандартный" или "Премиум", размещенная в том же регионе, что и хранилище служб восстановления. <br/><br/> Подойдет учетная запись хранения LRS или GRS. Рекомендуется использовать учетную запись хранения GRS, чтобы обеспечить устойчивость данных в случае отключения электричества в регионе или при отсутствии возможности восстановления основного региона. [Узнайте больше об этом](../storage/storage-redundancy.md). <br/><br/> [Хранилище уровня "Премиум"](../storage/storage-premium-storage.md) обычно используется для виртуальных машин, которым требуется постоянная высокая производительность ввода-вывода и малая задержка для размещения интенсивных рабочих нагрузок ввода-вывода.<br/><br/> Если для хранения реплицированных данных необходимо использовать учетную запись хранения уровня "Премиум", потребуется дополнительная учетная запись хранения уровня "Стандартный" для хранения журналов репликации, в которые записываются текущие изменения локальных данных.<br/><br/> Обратите внимание, что учетные записи хранения, созданные на портале Azure, нельзя перемещать из одной группы ресурсов в другую. Кроме того, защита для учетных записей хранения уровня "Премиум" в центральной и южной Индии в настоящее время не поддерживается.<br/><br/> Прочтите [статью](../storage/storage-introduction.md) о службе хранилища Azure.
**Сеть Azure** | Потребуется виртуальная сеть Azure, к которой будут подключаться виртуальные машины Azure при отработке отказа. Виртуальная сеть Azure должна располагаться в том же регионе, что и хранилище служб восстановления.
**Восстановление размещения с выполнением переноса из Azure** | Вам потребуется временный сервер обработки, настроенный как виртуальная машина Azure. Его можно создать, когда вы будете готовы к восстановлению размещения, и удалить после его завершения. <br/><br/> Для восстановления размещения необходимо будет настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным узлом.

## Предварительные требования для сервера конфигурации

В качестве сервера конфигурации используется локальный компьютер.

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Сервер конфигурации**| Вам потребуется локальная физическая или виртуальная машина под управлением Windows Server 2012 R2. На эту машину устанавливаются все локальные компоненты Site Recovery. <br/><br/> Для репликации виртуальных узлов VMware рекомендуется развернуть сервер в виде высокодоступной виртуальной машины VMware. Если реплицируются физические компьютеры, то это может быть физический сервер.<br/><br/> Восстановление размещения на локальном сайте с переносом из Azure всегда будет выполняться на виртуальные машины VMware независимо от того, для чего выполняется отработка отказа — для виртуальных машин или физических серверов. Если сервер конфигурации не развертывается как виртуальная машина VMware, необходимо настроить отдельный главный целевой сервер как виртуальную машину VMware для приема трафика, используемого для восстановления размещения. <br/><br/> Если сервер является виртуальной машиной VMware, то следует использовать сетевой адаптер типа VMXNET3. Если вы используете сетевой адаптер другого типа, следует установить [обновление VMware](https://kb.vmware.com/selfservice/microsites/search.do?cmd=displayKC&docType=kc&externalId=2110245&sliceId=1&docTypeID=DT_KB_1_1&dialogID=26228401&stateId=1) для сервера vSphere 5.5.<br/><br/>Этот сервер должен иметь статический IP-адрес.<br/><br/>Этот сервер не должен быть контроллером домена.<br/><br/>Имя узла сервера не может содержать больше 15 символов.<br/><br/>Операционная система обязательно должна быть англоязычной.<br/><br/> На сервер конфигурации необходимо установить VMware vSphere PowerCLI 6.0.<br/><br/>Серверу конфигурации требуется доступ к Интернету. Требуется исходящий доступ: <br/><br/>Временный доступ к порту HTTP 80 на период настройки компонентов службы Site Recovery (для скачивания MySQL). <br/><br/>Постоянный исходящий доступ к порту HTTPS 443 для управления репликацией. <br/><br/>Постоянный исходящий доступ к порту HTTPS 9443 для трафика репликации (этот порт можно изменить). <br/><br/>Для подключения к Azure серверу также нужен доступ к следующим URL-адресам: *.hypervrecoverymanager.windowsazure.com; *.accesscontrol.windows.net; *.backup.windowsazure.com; *.blob.core.windows.net; *.store.core.windows.net. <br/><br/>Если на сервере используется брандмауэр с правилами на основе IP-адресов, убедитесь, что правила разрешают обмен данными с Azure. Необходимо разрешить использовать [диапазоны IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и протокол HTTPS (порт 443). <br/><br/>Внесите в список разрешенных диапазоны IP-адресов для региона Azure, который соответствует вашей подписке, и для западной части США. <br/><br/>Для скачивания MySQL разрешите следующий URL-адрес: http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.37-win32.msi


## Предварительные требования узлов VMware vCenter и vSphere

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**vSphere**| Вам потребуется один или несколько гипервизоров VMware vSphere. <br/><br/>Они должны работать под управлением vSphere версии 6.0, 5.5 или 5.1 с последними обновлениями. <br/><br/>Мы рекомендуем размещать узлы vSphere и серверы vCenter в той же сети, в которой находится сервер обработки (или в сети, в которой находится сервер конфигурации, если вы не настроили выделенный сервер обработки).
**vCenter** | Для управления узлами vSphere рекомендуется развернуть сервер VMware vCenter. На нем нужно установить vCenter версии 6.0 или 5.5 с последними обновлениями. <br/><br/>Обратите внимание, что Site Recovery не поддерживает новые возможности vCenter и vSphere 6.0, например Cross vCenter vMotion, виртуальные тома и DRS хранилища. Поддержка Site Recovery предоставляется только для компонентов, доступных в версии 5.5.


## Предварительные требования для защищенных компьютеров

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Локальные виртуальные машины VMware** | На виртуальных машинах VMware, которые нужно защитить, должны быть установлены и запущены средства VMware.<br/><br/> Виртуальные машины, которые нужно защитить, должны соответствовать [предварительным требованиям](site-recovery-best-practices.md#azure-virtual-machine-requirements) для создания виртуальных машин Azure. <br/><br/>Емкость одного диска на защищенных компьютерах не должна превышать 1023 ГБ. Для виртуальной машины можно настроить до 64 дисков (то есть до 64 ТБ). <br/><br/>Защита виртуальных машин с помощью зашифрованных дисков (root и дисков данных) не поддерживается.

Гостевые кластеры общих дисков не поддерживаются.<br/><br/>**Порт 20004** должен оставаться открытым на защищенных виртуальных машинах, если вы хотите включить **согласованность приложений**.

Загрузка с использованием интерфейса UEFI или EFI не поддерживается. <br/><br/>Имена компьютеров должны содержать от 1 до 63 знаков (можно использовать буквы, цифры и дефисы). Имя должно начинаться с буквы или цифры и заканчиваться буквой или цифрой. Включив репликацию для виртуальной машины, можно изменить имя в Azure. <br/><br/>Если на исходной виртуальной машине настроено объединение сетевых карт, то после отработки отказа в Azure такое объединение преобразуется в один сетевой адаптер. <br/><br/>Если у защищенной виртуальной машины есть диск iSCSI, то при отработке отказа в Azure служба Site Recovery преобразует защищенный диск iSCSI виртуальной машины в VHD-файл. Если виртуальная машина Azure может получить доступ к целевому объекту iSCSI, она подключится к нему и обнаружит два диска — VHD на виртуальной машине Azure и исходный диск iSCSI. В этом случае необходимо отключить целевой объект iSCSI, который отображается на виртуальной машине Azure. **Компьютеры или виртуальные машины VMware на основе Windows** | Компьютер должен работать под управлением поддерживаемой 64-разрядной операционной системы: Windows Server 2012 R2, Windows Server 2012 или Windows Server 2008 R2 с пакетом обновления 1 (SP1) (как минимум).<br/><br/> Операционная система должна устанавливаться на диске C:\\. Диск операционной системы должен представлять собой базовый, а не динамический диск Windows. Диск данных может быть динамическим. <br/><br/>Служба Site Recovery поддерживает виртуальные машины с дисками RDM. При восстановлении размещения Site Recovery повторно использует диск RDM, если исходная виртуальная машина и диск RDM доступны. Если они недоступны, при восстановлении размещения служба Site Recovery создаст для каждого диска новый файл VMDK. **Компьютеры Linux** | Необходима одна из поддерживаемых 64-разрядных операционных систем: Red Hat Enterprise Linux 6.7,7.1,7.2; Centos 6.5, 6.6,6.7,7.0,7.1,7.2; Oracle Enterprise Linux 6.4, 6.5 с ядром, совместимым с Red Hat, или Unbreakable Enterprise Kernel Release 3 (UEK3), SUSE Linux Enterprise Server 11 с пакетом обновления 3 (SP3). <br/><br/>Файлы /etc/hosts на защищаемых компьютерах должны содержать записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров. <br/><br/>Если вы хотите подключаться к виртуальной машине Azure под управлением Linux с использованием клиента Secure Shell (SSH) после отработки отказа, для службы Secure Shell на защищенном компьютере следует настроить автоматический запуск при загрузке системы, а правила брандмауэра должны разрешать подключение SSH к компьютеру. <br/><br/>Имена узлов, точки подключения, имена устройств, системные пути и имена файлов Linux (/etc, /usr и т. п.) должны содержать только знаки латинского алфавита. <br/><br/>Защиту можно включить для компьютеров Linux со следующими характеристиками хранилища: файловая система EXT3, ETX4, ReiserFS или XFS; многомаршрутное подключение устройств (multipath); диспетчер томов LVM2. Физические серверы с хранилищем контроллера HP CCISS не поддерживаются. Файловая система ReiserFS поддерживается только в SUSE Linux Enterprise Server 11 с пакетом обновления 3 (SP3). <br/><br/>Служба Site Recovery поддерживает виртуальные машины с дисками RDM. При восстановлении размещения для компьютеров Linux служба Site Recovery не использует диск RDM повторно. Вместо этого она создает новый VMDK-файл для каждого соответствующего диска RDM. <br/><br/>Убедитесь, что в конфигурации виртуальной машины в VMware параметр disk.enableUUID имеет значение Тrue. Создайте запись, если она не существует. Это необходимо для обеспечения согласованного UUID для правильного подключения VMDK. Добавление этого параметра также гарантирует, что во время восстановления размещения на локальный компьютер будут переноситься только разностные изменения без полной репликации. **Mobility Service** | **Windows**. Для автоматической установки службы Mobility Service на виртуальные машины под управлением Windows необходимо указать учетную запись администратора (локального администратора на компьютере Windows), чтобы сервер обработки мог выполнить принудительную установку.<br/><br/> **Linux**: для автоматической установки службы Mobility Service на виртуальные машины под управлением Linux необходимо создать учетную запись администратора, которую сервер обработки сможет использовать для выполнения принудительной установки.<br/><br/> По умолчанию реплицируются все диски на компьютере. Чтобы [исключить диск из репликации](#exclude-disks-from-replication), службу Mobility Service необходимо установить на компьютер вручную до включения репликации.

## Подготовка к развертыванию

Чтобы подготовиться к развертыванию, потребуется следующее:

1. [Настроить сеть Azure](#set-up-an-azure-network), в которой будут размещаться виртуальные машины Azure, развернутые после отработки отказа. Кроме того, для восстановления размещения вам потребуется настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным сайтом.
2. [Настроить учетную запись хранения Azure](#set-up-an-azure-storage-account) для реплицированных данных.
3. [Подготовить учетную запись](#prepare-an-account-for-automatic-discovery) на сервере vCenter или узлах vSphere, чтобы служба Site Recovery могла автоматически обнаруживать добавленные виртуальные машины VMware.
4. [Подготовить сервер конфигурации](#prepare-the-configuration-server), чтобы он мог получить доступ к необходимым URL-адресам и установить vSphere PowerCLI 6.0.


### Настройка сети Azure

- Сеть должна располагаться в том же регионе Azure, в котором будет развернуто хранилище служб восстановления.
- В зависимости от модели ресурсов, которую нужно использовать для отработавших отказ виртуальных машин Azure, для сети Azure необходимо настроить [режим ARM](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) или [классический режим](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).
- Для восстановления размещения из Azure на локальный узел VMware потребуется VPN-подключение (или подключение Azure ExpressRoute) между сетью Azure, в которой размещены реплицированные виртуальные машины Azure, и локальной сетью, в которой находится сервер конфигурации.
- [Узнайте больше](../vpn-gateway/vpn-gateway-site-to-site-create.md) о моделях развертывания, поддерживаемых для VPN-подключений типа "сеть — сеть", а также узнайте, [как установить подключение](../vpn-gateway/vpn-gateway-site-to-site-create.md#create-your-virtual-network).
- Вы можете также настроить подключение [Azure ExpressRoute](../expressroute/expressroute-introduction.md). [Узнайте больше](../expressroute/expressroute-howto-vnet-portal-classic.md) о настройке сети Azure с подключением ExpressRoute.

> [AZURE.NOTE] [Migration of networks](../resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для сетей, используемых для развертывания Site Recovery.

### Настройка учетной записи хранения Azure

- Для хранения данных, реплицированных в Azure, понадобится учетная запись хранения Azure класса Standard или Premium. Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления. В зависимости от модели ресурсов, которую нужно использовать для отработавших отказ виртуальных машин Azure, для учетной записи необходимо настроить [режим ARM](../storage/storage-create-storage-account.md) или [классический режим](../storage/storage-create-storage-account-classic-portal.md).
- Если для реплицированных данных используется учетная запись класса Premium, понадобится настроить дополнительную стандартную учетную запись для хранения журналов репликации, в которых фиксируются текущие изменения локальных данных.

> [AZURE.NOTE] [Migration of storage accounts](../resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для учетных записей хранения, используемых для развертывания Site Recovery.

### Подготовка учетной записи для автоматического обнаружения

Сервер обработки Site Recovery может автоматически обнаруживать виртуальные машины WMware на узлах vSphere или на сервере vCenter, который управляет узлами. Для этого службе Site Recovery требуются учетные данные Site Recovery, обеспечивающие доступ к серверу VMware. Они не нужны при репликации только физических компьютеров.

1. Чтобы использовать выделенную учетную запись для автоматического обнаружения, создайте роль (например, Azure\_Site\_Recovery) на уровне vCenter с [необходимыми разрешениями](#vmware-account-permissions).
2. Создайте нового пользователя на узле vSphere или на сервере vCenter и назначьте роль пользователю. Затем сообщите эти учетные данные службе Site Recovery, чтобы она могла выполнить автоматическое обнаружение.

	>[AZURE.NOTE] Учетная запись vCenter с ролью только для чтения позволяет выполнять отработку отказа только без выключения исходных защищенных компьютеров. Если их работу следует завершить, то потребуется роль [Azure\_Site\_Recovery](#vmware-account-permissions). Если нужно только перенести виртуальные машины из VMware в Azure и не нужно выполнять восстановление размещения, роли только для чтения достаточно.

### Подготовка сервера конфигурации

1.	Убедитесь, что компьютер, который используется в качестве сервера конфигурации, соответствует [предварительным требованиям](#configuration-server-prerequisites). В частности, проверьте, подключен ли компьютер к Интернету, используя следующие параметры:

	- Разрешите доступ к следующим URL-адресам: *.hypervrecoverymanager.windowsazure.com*; .accesscontrol.windows.net; *.backup.windowsazure.com*; .blob.core.windows.net; .store.core.windows.net.
	- Разрешите доступ к URL-адресу [http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.37-win32.msi](http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.37-win32.msi) для скачивания MySQL.
	- В настройках брандмауэра разрешите подключение к Azure по адресам из [диапазона IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и протоколу HTTPS (443).

2.	Скачайте и установите [VMware vSphere PowerCLI 6.0](https://developercenter.vmware.com/tool/vsphere_powercli/6.0) на сервер конфигурации. (В настоящее время другие версии PowerCLI не поддерживаются, включая выпуски R версии 6.0.)


## Создание хранилища служб восстановления

1. Выполните вход на [портал Azure](https://portal.azure.com).
2. Щелкните **Создать** > **Управление** > **Backup and Site Recovery (OMS)** (Служба архивации и Site Recovery (OMS)). В качестве альтернативы можно щелкнуть **Обзор** > **Хранилище служб восстановления** > **Добавить**.

	![Новое хранилище](./media/site-recovery-vmware-to-azure/new-vault3.png)

3. В поле **Имя** укажите понятное имя для идентификации хранилища. Если у вас имеется несколько подписок, выберите одну из них.
4. [Создайте новую группу ресурсов](../resource-group-template-deploy-portal.md) или выберите существующую. Укажите регион Azure. В него будут реплицированы данные компьютеров. Обратите внимание, что хранилище и сети Azure, используемые для службы Site Recovery, находятся в том же регионе. Чтобы проверить поддерживаемые регионы, см. географическую доступность в разделе [Azure Site Recovery Pricing Details](https://azure.microsoft.com/pricing/details/site-recovery/) (Информация о ценах на Azure Site Recovery).
4. Если вам нужна возможность быстрого доступа к хранилищу из панели мониторинга, установите флажок **Закрепить на панели мониторинга** и щелкните **Создать**.

	![Новое хранилище](./media/site-recovery-vmware-to-azure/new-vault-settings.png)

Новое хранилище появится в колонке **Панель мониторинга** > **Все ресурсы** и в основной колонке **Хранилища служб восстановления**.

## Приступая к работе

В Site Recovery предусмотрен механизм для начала работы, который позволяет выполнить развертывание максимально быстро. Он проверяет соответствие предварительным требованиям и помогает выполнить действия, необходимые для развертывания Site Recovery.

Необходимо выбрать тип компьютеров, которые требуется реплицировать, и место для репликации. Затем нужно настроить инфраструктуру, включая локальные серверы, параметры Azure, политики репликации и планирование емкости. Когда инфраструктура будет готова, следует включить репликацию для виртуальных машин и физических серверов. Затем можно выполнить отработку отказа для конкретных компьютеров или создать план восстановления для отработки отказа на нескольких компьютерах.

Сначала выберите способ развертывания Site Recovery. Начальные процедуры немного изменяются в зависимости от требований к репликации.


## Шаг 1. Выбор целевых объектов для защиты

Выберите целевые объекты и место для репликации.

1. В колонке **Хранилища служб восстановления** выберите хранилище и щелкните **Параметры**.
2. Выбрав **Параметры** > **Приступая к работе**, щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Цель защиты**.

	![Выбор цели](./media/site-recovery-vmware-to-azure/choose-goals.png)

3. На странице **Цель защиты** выберите **To Azure** (В Azure) и **Yes, with VMware vSphere Hypervisor** (Да, с использованием гипервизора VMware vSphere). Нажмите кнопку **ОК**.

	![Выбор цели](./media/site-recovery-vmware-to-azure/choose-goals2.png)


## Шаг 2. Настройка исходной среды

Настройте конфигурацию сервера и зарегистрируйте его в хранилище службы восстановления. При репликации виртуальных машин VMware укажите учетную запись VMware, которая используется для автоматической доставки.

1. Щелкните **Шаг 1. Подготовка инфраструктуры** > **Источник**. Если у вас нет сервера конфигурации, в окне **Подготовка источника** щелкните **+Configuration server** (+Сервер конфигурации), чтобы его добавить.

	![Настройка источника](./media/site-recovery-vmware-to-azure/set-source1.png)

2. В колонке **Добавление сервера** в поле **Тип конфигурации** должно быть указано **Сервер конфигурации**.
3. Перед настройкой сервера конфигурации проверьте, выполнены ли [предварительные требования](#configuration-server-prerequisites). В частности, убедитесь в том, что компьютер имеет доступ к необходимым URL-адресам.
4.	Скачайте файл единой установки Site Recovery.
5.	Скачайте ключ регистрации хранилища. Он потребуется при запуске программы единой установки. Ключ действителен в течение 5 дней после создания.

	![Настройка источника](./media/site-recovery-vmware-to-azure/set-source2.png)

6.	На компьютере, который используется в качестве сервера конфигурации, запустите программу единой установки, чтобы установить сервер конфигурации, сервер обработки и главный целевой сервер.


### Выполнение единой установки Site Recovery

1.	Запустите файл единой установки.
2.	На странице **Перед началом работы** выберите **Install the configuration server and process server** (Установить сервер конфигурации и сервер обработки).

	![Перед началом работы](./media/site-recovery-vmware-to-azure/combined-wiz1.png)

3. В окне **Third-Party Software License** (Лицензия на программное обеспечение стороннего поставщика) щелкните **I Accept** (Принимаю), чтобы скачать и установить MySQL.

	![Стороннее программное обеспечение](./media/site-recovery-vmware-to-azure/combined-wiz105.PNG)

4. На странице **Регистрация** нажмите кнопку "Обзор" и выберите регистрационный ключ, скачанный из хранилища.

	![Регистрация](./media/site-recovery-vmware-to-azure/combined-wiz3.png)

5. На странице **Параметры Интернета** укажите параметры для подключения поставщика, который будет выполняться на сервере конфигурации, к Azure Site Recovery через Интернет.

	- Чтобы подключаться с помощью прокси-сервера, который уже настроен на компьютере, выберите **Connect with existing proxy settings** (Подключение с параметрами существующего прокси-сервера).
	- Чтобы поставщик подключался напрямую, выберите **Connect directly without a proxy** (Прямое подключение без прокси-сервера).
	- Если для существующего прокси-сервера требуется аутентификация или для подключения поставщика нужно использовать пользовательский прокси-сервер, установите переключатель **Connect with custom proxy settings** (Подключение с параметрами пользовательского прокси-сервера).
		- При использовании пользовательского прокси-сервера необходимо указать адрес, порт и учетные данные.
		- Если используется прокси-сервер, скорее всего, вы уже разрешили использовать URL-адреса, описанные в разделе о [предварительных требованиях](#configuration-server-prerequisites).

	![Брандмауэр](./media/site-recovery-vmware-to-azure/combined-wiz4.png)

6. В окне **Проверка необходимых компонентов** программа установки проверяет возможность установки. Если появится предупреждение о **проверке глобальной синхронизации времени**, убедитесь, что время системных часов (параметры **даты и времени**) соответствует часовому поясу.

	![Предварительные требования](./media/site-recovery-vmware-to-azure/combined-wiz5.png)

7. На странице **MySQL Configuration** (Конфигурация MySQL) создайте учетные данные для входа в экземпляр сервера MySQL, который будет установлен.

	![MySQL](./media/site-recovery-vmware-to-azure/combined-wiz6.png)

8. На странице **Сведения о среде** укажите, нужно ли выполнять репликацию виртуальных машин VMware. Если нужно, программа установки проверяет, установлен ли компонент PowerCLI 6.0.

	![MySQL](./media/site-recovery-vmware-to-azure/combined-wiz7.png)

9. На странице **Расположение установки** выберите место для установки двоичных файлов и хранения кэша. Можно выбрать диск кэша с объемом доступной памяти от 5 ГБ. Однако рекомендуемый объем — не менее 600 ГБ.

	![Расположение установки](./media/site-recovery-vmware-to-azure/combined-wiz8.png)

10. На странице **Выбор сети** укажите прослушиватель (сетевой адаптер и порт SSL), через который сервер конфигурации будет отправлять и получать данные репликации. Можно изменить порт по умолчанию (9443). Помимо этого порта веб-сервером, который координирует операции репликации, будет использоваться порт 443. Не следует использовать порт 443 для приема данных репликации.


	![Выбор сети](./media/site-recovery-vmware-to-azure/combined-wiz9.png)



11.  Просмотрите информацию на странице **Сводка** и нажмите кнопку **Установить**. После завершения установки создается парольная фраза. Они потребуются при включении репликации, поэтому ее необходимо скопировать и сохранить в безопасном месте.

	![Сводка](./media/site-recovery-vmware-to-azure/combined-wiz10.png)

12.  После завершения регистрации сервер появится в колонке хранилища **Параметры** > **Серверы**.



#### Запуск установки из командной строки

Сервер конфигурации можно настроить из командной строки:

    UnifiedSetup.exe [/ServerMode <CS/PS>] [/InstallDrive <DriveLetter>] [/MySQLCredsFilePath <MySQL credentials file path>] [/VaultCredsFilePath <Vault credentials file path>] [/EnvType <VMWare/NonVMWare>] [/PSIP <IP address to be used for data transfer] [/CSIP <IP address of CS to be registered with>] [/PassphraseFilePath <Passphrase file path>]

После завершения установки пройдите регистрацию, выполнив указанные ниже действия.

1. Запустите приложение с именем "Оболочка служб восстановления Microsoft Azure" из меню "Пуск" Windows.
2. В открывшемся командном окне выполните следующий набор команд, чтобы настроить параметры прокси-сервера.

		PS C:\Windows\System32> $pwd = ConvertTo-SecureString -String ProxyUserPassword
		PS C:\Windows\System32> Set-OBMachineSetting -ProxyServer http://myproxyserver.domain.com -ProxyPort PortNumb – ProxyUserName domain\username -ProxyPassword $pwd
		PS C:\Windows\System32> net stop obengine.exe

Параметры

- /ServerMode. (Обязательный параметр.) Указывает, нужно ли установить и сервер конфигурации, и сервер обработки или только север обработки. Входные значения: CS, PS.
- InstallLocation. (Обязательный параметр.) Папка для установки компонентов.
- /MySQLCredsFilePath. (Обязательный параметр.) Путь к файлу, в котором хранятся учетные данные сервера MySQL. Файл должен быть в следующем формате:
	- [MySQLCredentials]
	- MySQLRootPassword = "<пароль>"
	- MySQLUserPassword = "<пароль>"
- /VaultCredsFilePath. (Обязательный параметр.) Расположение файла с учетными данными хранилища.
- /EnvType. (Обязательный параметр.) Тип установки. Значения: VMware, NonVMware.
- /PSIP и /CSIP. (Обязательный параметр.) IP-адрес сервера обработки и сервера конфигурации.
- /PassphraseFilePath. (Обязательный параметр.) Расположение файла с парольной фразой.
- /BypassProxy. необязательный параметр. Указывает, что сервер конфигурации подключается к Azure без использования прокси-сервера.
- /ProxySettingsFilePath. необязательный параметр. Параметры прокси-сервера (по умолчанию прокси-серверу требуется проверка подлинности или пользовательский прокси-сервер). Файл должен быть в следующем формате:
	- [ProxySettings]
	- ProxyAuthentication = "Да/Нет"
	- Proxy IP = "IP-адрес>"
	- ProxyPort = "<порт>"
	- ProxyUserName="<имя\_пользователя>"
	- ProxyPassword="<пароль>"
- DataTransferSecurePort. необязательный параметр. Номер порта для данных репликации.
- SkipSpaceCheck. необязательный параметр. Пропуск проверки пространства для кэша.
- AcceptThirdpartyEULA. (Обязательный параметр.) Флажок означает принятие лицензионного соглашения между пользователем и сторонним разработчиком.
- ShowThirdpartyEULA. (Обязательный параметр.) Отображает лицензионное соглашение со сторонним разработчиком. Если оно задано как источник данных, все остальные параметры игнорируются.

### Добавление учетной записи VMware, используемой для автоматического обнаружения

 При подготовке к развертыванию вы [создали учетную запись VMware](#prepare-an-account-for-automatic-discovery), которую Site Recovery сможет использовать для автоматического обнаружения. Добавьте эту учетную запись, выполнив указанные ниже действия.

1. Запустите файл **CSPSConfigtool.exe**. Он доступен в качестве ярлыка на рабочем столе и расположен в папке \\[РАСПОЛОЖЕНИЕ УСТАНОВКИ]\\home\\svsystems\\bin.
2. Последовательно выберите **Управление учетными записями** > **Добавить учетную запись**.

	![Добавление учетной записи](./media/site-recovery-vmware-to-azure/credentials1.png)

3. В разделе **Сведения об учетной записи** добавьте учетную запись, которая будет использоваться для автоматического обнаружения. Обратите внимание на то, что имя учетной записи может отобразиться на портале через 15 или больше минут. Чтобы выполнить обновление немедленно, последовательно выберите **Серверы конфигурации** > имя сервера > **Сервер обновления**.

	![Сведения](./media/site-recovery-vmware-to-azure/credentials2.png)

### Подключение к узлам vSphere и серверам vCenter

Если вы выполняете репликацию виртуальных машин VMware, подключитесь к узлам vSphere и серверам vCenter.

1. Убедитесь, что сервер конфигурации имеет сетевой доступ к узлам vSphere и серверам vCenter.
2. Выберите **Подготовка инфраструктуры** > **Источник**. В окне **Подготовка источника** выберите сервер конфигурации и щелкните **+vCenter**, чтобы добавить узел vSphere или сервер vCenter.
3. В окне **Add vCenter** (Добавление vCenter) укажите понятное имя для узла vSphere или сервера vCenter, а также IP-адрес или полное доменное имя сервера. Если серверы VMware настроены на прослушивание запросов через другой порт, оставьте порт 443. Выберите учетную запись, которая будет использоваться для подключения к серверу VMware. Нажмите кнопку **ОК**.

	![VMware](./media/site-recovery-vmware-to-azure/vmware-server.png)

	>[AZURE.NOTE] При добавлении сервера vCenter или узла vSphere с учетной записью без прав администратора на сервере vCenter или сервере узла убедитесь, что для учетной записи активированы права центра обработки данных, хранилища данных, папки, узла, сети, ресурса, виртуальной машины и распределенного коммутатора vSphere. Кроме того, для сервера vCenter должны быть активированы права представлений хранилища.

Site Recovery подключается к серверам VMware, используя указанные вами параметры, и обнаруживает виртуальные машины.

## Шаг 3. Настройка целевой среды

Убедитесь, что у вас есть учетная запись хранения для репликации и сеть Azure, к которой виртуальные машины Azure будут подключаться после отработки отказа.

1.	Щелкните **Подготовка инфраструктуры** > **Цель** и выберите требуемую подписку Azure.
2.	Укажите модель развертывания, которая будет использоваться для виртуальных машин после отработки отказа.
3.	Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

	![Цель](./media/site-recovery-vmware-to-azure/gs-target.png)

4.	Если учетная запись хранения еще не создана и ее нужно создать с помощью ARM, щелкните **+Storage account** (+Учетная запись хранения). В колонке **Создание учетной записи хранения** укажите имя, тип, подписку и расположение учетной записи. Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.

	![Хранилище](./media/site-recovery-vmware-to-azure/gs-createstorage.png)

	Обратите внимание на следующее.

	- Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать на портале Azure. [Подробнее](../storage/storage-create-storage-account-classic-portal.md)
	- Если для реплицированных данных используется учетная запись хранения класса Premium, понадобится настроить дополнительную стандартную учетную запись хранения для хранения журналов репликации, в которых фиксируются текущие изменения локальных данных.
	
	> [AZURE.NOTE] Защита для учетных записей хранения уровня "Премиум" в центральной и южной Индии в настоящее время не поддерживается.

4.	Выберите сеть Azure. Если сеть еще не создана и ее нужно создать с помощью ARM, щелкните **+Network** (+ Сеть), чтобы сделать это при настройке. В колонке **Создание виртуальной сети** укажите имя, диапазон адресов, сведения о подсетях, подписку и расположение сети. Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.

	![Сеть](./media/site-recovery-vmware-to-azure/gs-createnetwork.png)

	Если нужно создать сеть, используя классическую модель, это можно сделать на портале Azure. [Подробнее](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).

## Этап 4. Настройка параметров репликации

1. Чтобы создать политику репликации, последовательно выберите **Подготовка инфраструктуры** > **Параметры репликации** > **+Create and associate** (+ Создание и сопоставление).
2. На странице **Создать и связать политику** укажите имя политики.
3. В поле **Пороговое значение RPO** укажите предельное значение целевой точки восстановления (RPO). Если непрерывная репликация превышает это значение, выдаются оповещения.
5. В поле **Хранение точки восстановления** укажите продолжительность периода хранения для каждой точки восстановления (в часах). Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода. Для компьютеров, реплицируемых в хранилище класса Premium, поддерживается период удержания до 24 часов.
6. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, с какой периодичностью (в минутах) будут создаваться точки восстановления, содержащие моментальные снимки, согласованные на уровне приложений.
7. При создании политики репликации для восстановления размещения по умолчанию автоматически создается соответствующая политика. Например, если политика репликации называется **rep-policy**, то политика восстановления размещения будет называться **rep-policy-failback**. Эта политика не используется, пока не будет запущено восстановление размещения.
8. Нажмите кнопку **ОК**, чтобы создать политику.

	![Политика репликации](./media/site-recovery-vmware-to-azure/gs-replication2.png)

9. Созданная политика автоматически сопоставляется с облаком сервером конфигурации. Нажмите кнопку **ОК**.

	![Политика репликации](./media/site-recovery-vmware-to-azure/gs-replication3.png)


## Шаг 5. Планирование ресурсов

Теперь после настройки базовой инфраструктуры можно начать планирование ресурсов и выяснить, нужны ли дополнительные ресурсы.

Site Recovery предоставляет планировщик ресурсов, который поможет выделить нужные ресурсы для исходной среды, компонентов Site Recovery, сети и хранилища. Планировщик можно запустить в быстром режиме, чтобы получить оценку на основе среднего числа виртуальных машин и дисков, а также среднего объема хранилища, или в подробном режиме, в котором необходимо вводить показатели на уровне рабочей нагрузки. Прежде всего необходимо сделать следующее:

- Соберите сведения о среде репликации, включая информацию о виртуальных машинах, количестве дисков на виртуальную машину и объеме хранилища на диск.
- Определите частоту ежедневных изменений (обновлений) реплицированных данных. Для этого можно воспользоваться [устройством планирования загрузки vSphere](https://labs.vmware.com/flings/vsphere-replication-capacity-planning-appliance).

1.	Щелкните ссылку **Скачать**, чтобы скачать этот инструмент, и запустите его. Сведения об этом инструменте см. в [этой статье](site-recovery-capacity-planner.md).
2.	После этого выберите **Да** в поле **Вы выполнили планирование ресурсов?**.

	![Планирование загрузки](./media/site-recovery-vmware-to-azure/gs-capacity-planning.png)

В следующей таблице представлено несколько моментов, которые помогут вам спланировать емкость для этого сценария.


**Компонент** | **Дополнительные сведения**
--- | --- | ---
**Репликация** | **Максимальный объем ежедневно изменяемых данных**. Защищенный компьютер может использовать только один сервер обработки, а объем ежедневно изменяемых данных на одном сервере обработки может составлять не более 2 ТБ. В связи с этим 2 ТБ — максимальный объем ежедневно изменяемых данных, поддерживаемый защищенным компьютером.<br/><br/> **Максимальная пропускная способность**. Реплицированный компьютер может принадлежать одной учетной записи хранения в Azure. Стандартная учетная запись хранения может обрабатывать не более 20 000 запросов в секунду. Рекомендуется не превышать количество в 20 000 операций ввода-вывода в секунду на исходном компьютере. Например, если есть исходный компьютер с 5 дисками, на каждом из которых выполняется по 120 операций ввода-вывода в секунду (размером 8 КБ), этот показатель не будет превышать ограничение в 500 операций ввода-вывода в секунду на диск в Azure. Число необходимых учетных записей хранения определяется путем деления общего числа операций ввода-вывода для источника на 20 000.
**Сервер конфигурации** | Сервер конфигурации должен поддерживать суммарный объем ежедневно изменяемых данных для всех рабочих нагрузок, которые выполняются на защищенных компьютерах. Также он должен обладать достаточной пропускной способностью для непрерывной репликации данных в службу хранилища Azure.<br/><br/> Рекомендуется разместить сервер конфигурации в той же сети и в том же сегменте локальной сети, что и компьютеры, которые необходимо защитить. Его можно разместить и в другой сети при наличии у компьютеров, которые нужно защитить, доступа к этой сети третьего уровня.<br/><br/> В следующей таблице приведены рекомендации по размерам для сервера конфигурации.
**Сервер обработки** | Первый сервер обработки по умолчанию устанавливается на сервере конфигурации. Для масштабирования среды можно развернуть дополнительные серверы обработки. Обратите внимание на следующее. <br/><br/>Сервер обработки получает данные репликации от защищенных компьютеров и оптимизирует их перед отправкой в Azure, применяя кэширование, сжатие и шифрование. Сервер обработки должен располагать достаточными ресурсами для выполнения этих задач.<br/><br/> Сервер обработки использует дисковый кэш. Чтобы обеспечить обработку хранящихся изменений данных в случае возникновения узкого места в сети или сбоя, рекомендуется установить отдельный диск кэша объемом 600 ГБ и более.

### Рекомендации по размеру сервера конфигурации

**ЦП** | **Память** | **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры**
--- | --- | --- | --- | ---
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц) | 16 ГБ | 300 ГБ | 500 ГБ или менее | Репликация не более 100 компьютеров
12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц) | 18 ГБ | 600 ГБ | От 500 ГБ до 1 ТБ | Репликация от 100 до 150 компьютеров
16 виртуальных ЦП (2 сокета * 8 ядер с частотой 2,5 ГГц) | 32 ГБ | 1 TБ | От 1 ТБ до 2 ТБ | Репликация от 150 до 200 компьютеров
Разверните другой сервер обработки | | | Более 2 ТБ | Разверните дополнительные серверы обработки при репликации более 200 компьютеров или объеме ежедневно изменяемых данных более 2 ТБ.

Описание

- Для каждого исходного компьютера настраивается 3 диска объемом по 100 ГБ каждый.
- Чтобы измерить показатели диска кэша, мы использовали хранилище для тестирования производительности с 8 дисками SAS с частотой вращения шпинделя 10 000 об/мин в конфигурации RAID 10.

### Рекомендации по размеру сервера обработки

Если необходимо защитить более 200 компьютеров или объем ежедневно изменяемых данных составляет более 2 ТБ, для обработки такой нагрузки репликации можно добавить дополнительные серверы обработки. Для масштабирования можно выполнить следующее.

- Увеличить количество серверов конфигурации. Например, с помощью двух серверов конфигурации можно защитить до 400 компьютеров.
- Добавить дополнительные серверы обработки и использовать их для обработки трафика вместо сервера конфигурации (или вместе с ним).

В этой таблице описан следующий сценарий.

- Вы не планируете использовать сервер конфигурации в качестве сервера обработки.
- Вы настроили дополнительный сервер обработки.
- Вы настроили защищенные виртуальные машины для использования дополнительного сервера обработки.
- Для каждого защищенного исходного компьютера настраивается три диска объемом 100 ГБ каждый.

**Сервер конфигурации** | **Дополнительный сервер обработки**| **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры**
--- | --- | --- | --- | ---
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), память объемом 16 ГБ | 4 виртуальных ЦП (2 сокета * 2 ядра с частотой 2,5 ГГц), память объемом 8 ГБ | 300 ГБ | 250 ГБ или менее | Репликация до 85 компьютеров
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), память объемом 16 ГБ | 8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), память объемом 12 ГБ | 600 ГБ | От 250 ГБ до 1 ТБ | Репликация от 85 до 150 компьютеров
12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц), память объемом 18 ГБ | 12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц), память объемом 24 ГБ | 1 TБ | От 1 ТБ до 2 ТБ | Репликация от 150 до 225 компьютеров


Способ масштабирования серверов будет зависеть от параметров модели увеличения масштаба и развертывания. Вы можете увеличить масштаб, развернув несколько современных серверов конфигурации и обработки, или выполнить развертывание, развернув несколько серверов с меньшим объемом ресурсов. Например, чтобы защитить 220 компьютеров, можно выполнить одно из следующих указаний:

- Настроить сервер конфигурации с 12 виртуальными ЦП и памятью объемом 18 ГБ, дополнительный сервер обработки с 12 виртуальными ЦП и памятью объемом 24 ГБ и защищенные компьютеры для использования только дополнительного сервера обработки.
- Кроме того, можно настроить два сервера конфигурации (8 виртуальных ЦП, 16 ГБ ОЗУ в каждом), два дополнительных сервера обработки (8 виртуальных ЦП в одном и 4 виртуальных ЦП в другом для обработки 220 (135 + 85) компьютеров) и защищенные компьютеры для использования только дополнительных серверов обработки.

[Выполните эти инструкции](#deploy-additional-process-servers), чтобы настроить дополнительный сервер обработки.

### Рекомендации по пропускной способности сети

С помощью планировщика ресурсов можно рассчитать пропускную способность, необходимую для репликации (начальная и разностная репликации данных). Существует несколько вариантов управления объемом пропускной способности, используемой для репликации:

- **Регулирование пропускной способности**. Трафик VMware, который реплицируется в Azure, проходит через определенный сервер обработки. Пропускную способность можно регулировать на компьютерах, которые служат серверами обработки.
- **Изменение пропускной способности**. Пропускную способность, используемую для репликации, можно изменить с помощью нескольких разделов реестра.
	- Значение реестра **HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows Azure Backup\\UploadThreadsPerVM** задает количество потоков, используемых для передачи данных диска (для начальной или разностной репликации данных). Если задать высокое значение, пропускная способность сети, используемая для репликации, увеличивается.
	- Значение **HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows Azure Backup\\DownloadThreadsPerVM** задает количество потоков, используемых для передачи данных при восстановлении размещения.

#### Регулирование пропускной способности

1. Откройте оснастку MMC в службе архивации Microsoft Azure на компьютере, который выступает в качестве сервера обработки. По умолчанию ярлык для службы архивации Microsoft Azure доступен на рабочем столе или в папке C:\\Program Files\\Microsoft Azure Recovery Services Agent\\bin\\wabadmin.
2. В оснастке щелкните **Изменить свойства**.

	![Регулирование пропускной способности](./media/site-recovery-vmware-to-azure/throttle1.png)

3. На вкладке **Регулирование** установите флажок **Разрешить регулирование уровня использования пропускной способности интернет-канала для операций архивации** и задайте ограничения для рабочего и нерабочего времени. Допустимы значения в диапазоне от 512 Кбит/с до 102 Мбит/с.

	![Регулирование пропускной способности](./media/site-recovery-vmware-to-azure/throttle2.png)

Чтобы настроить регулирование, можно также использовать командлет [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409.aspx). Рассмотрим пример:

    $mon = [System.DayOfWeek]::Monday
    $tue = [System.DayOfWeek]::Tuesday
    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth  (512*1024) -NonWorkHourBandwidth (2048*1024)

**Set-OBMachineSetting -NoThrottle** указывает, что регулирование не требуется.


#### Изменение пропускной способности сети

1. В реестре перейдите в раздел **HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows Azure Backup\\Replication**.
	- Чтобы изменить скорость передачи данных при репликации диска, задайте новое значение для раздела **UploadThreadsPerVM** или создайте его, если он еще не существует.
	- Чтобы изменить скорость передачи данных при восстановлении размещения из Azure, задайте новое значение для раздела **DownloadThreadsPerVM**.
2. Значение по умолчанию — 4. В сети со значительным избыточным резервом для этих разделов реестра необходимо изменить значения по умолчанию. Максимальное значение — 32. Следите за трафиком для оптимизации значения.

## Шаг 6. Репликация приложений

Убедитесь, что компьютеры, которые нужно реплицировать, подготовлены для установки службы Mobility и включите репликацию.

### Установка службы Mobility

При включении защиты для виртуальных машин и физических серверов нужно прежде всего установить службу Mobility Service. Это можно сделать несколькими способами.

- **Принудительная установка с сервера обработки**. Если вы включаете репликацию для компьютера, выполните принудительную установку компонента службы Mobility Service с сервера обработки. Обратите внимание, что принудительная установка не выполняется, если на компьютере уже выполняется актуальная версия компонента.
- **Принудительная установка корпоративными средствами**. Автоматическая установка компонента с помощью корпоративных средств принудительной установки, таких как WSUS или System Center Configuration Manager. Перед этим настройте сервер конфигурации.
- **Установка вручную**. Установите компонент вручную на каждом компьютере, который нужно реплицировать. Перед этим настройте сервер конфигурации.


#### Подготовка к принудительной установке на компьютерах Windows

Ниже описан процесс подготовки компьютеров Windows для автоматической установки службы Mobility Service сервером обработки.

1.  Создайте учетную запись, используемую сервером обработки для доступа к компьютеру. Учетная запись должна иметь права администратора (локального или администратора домена) и использоваться только для принудительной установки.

	>[AZURE.NOTE] Если учетная запись домена не используется, на локальном компьютере потребуется отключить контроль удаленного доступа пользователей. Для этого в разделе реестра HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System добавьте запись LocalAccountTokenFilterPolicy DWORD и задайте для нее значение 1. Чтобы добавить в реестр запись из интерфейса командной строки, введите **`REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1`**.

2.  В брандмауэре Windows на компьютере, который нужно защитить, выберите **Разрешить запуск программы или компонента через брандмауэр Windows**. Установите флажки **Общий доступ к файлам и принтерам** и **Инструментарий управления Windows**. Для компьютеров, принадлежащих домену, можно настроить параметры брандмауэра с помощью объекта групповой политики.

	![Параметры брандмауэра](./media/site-recovery-vmware-to-azure/mobility1.png)

2. Добавьте созданную учетную запись:

	- Откройте **cspsconfigtool**. Он доступен в качестве ярлыка на рабочем столе и расположен в папке \\[РАСПОЛОЖЕНИЕ УСТАНОВКИ]\\home\\svsystems\\bin.
	- На вкладке **Управление учетными записями** нажмите кнопку **Добавить учетную запись**.
	- Добавьте созданную учетную запись. После этого понадобится указать учетные данные при добавлении репликации для компьютера.


#### Подготовка к принудительной установке на серверах Linux

1.	Убедитесь, что компьютер Linux, который необходимо защитить, соответствует всем [предварительным требованиям для защищаемого компьютера](#protected-machine-prerequisites). Убедитесь, что между компьютером Linux и сервером обработки установлено сетевое подключение.

2.	Создайте учетную запись, используемую сервером обработки для доступа к компьютеру. Учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux и использоваться только для принудительной установки.

	- Откройте **cspsconfigtool**. Он доступен в качестве ярлыка на рабочем столе и расположен в папке \\[РАСПОЛОЖЕНИЕ УСТАНОВКИ]\\home\\svsystems\\bin.
	- На вкладке **Управление учетными записями** нажмите кнопку **Добавить учетную запись**.
	- Добавьте созданную учетную запись. После этого понадобится указать учетные данные при добавлении репликации для компьютера.

3.	Убедитесь, что файл /etc/hosts на исходном сервере Linux содержит записи, которые связывают имя локального узла с IP-адресами всех сетевых адаптеров.
4.	Установите последние пакеты openssh, openssh-server, openssl на компьютере, который нужно реплицировать.
5.	Убедитесь, что служба SSH включена и работает через порт 22.
6.	Включите подсистему SFTP и проверку подлинности с помощью пароля в файле sshd\_config следующим образом:

	- Выполните вход в качестве привилегированного пользователя.
	- В файле /etc/ssh/sshd\_config найдите строку, которая начинается с **PasswordAuthentication**.
	- Раскомментируйте ее и измените значение с **no** на **yes**.
	- Найдите строку, которая начинается с **Subsystem**, и раскомментируйте ее.

		![Linux](./media/site-recovery-vmware-to-azure/mobility2.png)


#### Установка службы Mobility Service вручную

Установщики находятся на сервере обработки в каталоге **C:\\Program Files (x86)\\Microsoft Azure Site Recovery\\home\\svsystems\\pushinstallsvc\\repository**.

Исходная операционная система | Файл установки службы Mobility Service
--- | ---
Windows Server (только 64-разрядная версия) | Microsoft-ASR_UA_9.*.0.0_Windows_* release.exe
CentOS 6.4, 6.5, 6.6 (только 64-разрядная версия) | Microsoft-ASR_UA_9.*.0.0_RHEL6-64_*release.tar.gz
SUSE Linux Enterprise Server 11 SP3 (только 64-разрядная версия) | Microsoft-ASR_UA_9.*.0.0_SLES11-SP3-64_*release.tar.gz
Oracle Enterprise Linux 6.4, 6.5 (только 64-разрядная версия) | Microsoft-ASR_UA_9.*.0.0_OL6-64_*release.tar.gz


#### Установка вручную на сервер Windows


1. Скачайте и запустите соответствующий установщик.
2. На странице **Перед началом работы** выберите **Служба мобильности**.

	![Служба Mobility Service](./media/site-recovery-vmware-to-azure/mobility3.png)

3. На странице **Configuration Server Details** (Сведения о сервере конфигурации) укажите IP-адрес сервера конфигурации и парольную фразу, созданную при выполнении единой установки. Ее можно получить, выполнив на сервере конфигурации команду **<папка\_установки\_Site\_Recovery>\\home\\sysystems\\bin\\genpassphrase.exe –v**.

	![Служба Mobility Service](./media/site-recovery-vmware-to-azure/mobility6.png)

4. На странице **Расположение установки** оставьте значение по умолчанию и нажмите кнопку **Далее**, чтобы начать установку.
5. На странице **Ход установки** следите за ходом установки и при появлении соответствующего запроса перезапустите компьютер. После установки службы ее состояние обновится на портале в течение 15 минут.

Кроме того, установку можно выполнить из командной строки:

UnifiedAgent.exe [/Role <агент или главный целевой сервер>] [/InstallLocation <каталог установки>] [/CSIP <IP-адрес сервера конфигурации для регистрации>] [/PassphraseFilePath <путь к файлу с парольной фразой>] [/LogFilePath <путь к файлу журнала>]

Описание

- /Role. (Обязательный параметр.) Указывает, следует ли устанавливать службу Mobility Service.
- /InstallLocation. (Обязательный параметр.) Указывает место установки службы.
- /PassphraseFilePath. (Обязательный параметр.) Парольная фраза сервера конфигурации.
- /LogFilePath. (Обязательный параметр.) Расположение файлов установки журнала.

#### Удаление службы Mobility Service вручную

Службу Mobility Service можно удалить с помощью элемента "Установка и удаление программ" на панели управления или с помощью командной строки.

Чтобы удалить службу Mobility Service, выполните приведенную ниже команду в командной строке.

	MsiExec.exe /qn /x {275197FC-14FD-4560-A5EB-38217F80CBD1}


#### Установка вручную на сервер Linux

1. Скопируйте соответствующий TAR-архив согласно приведенной выше таблице на компьютер Linux, который нужно реплицировать.
2. Откройте программу оболочки и извлеките содержимое сжатого TAR-файла архива в формате ZIP по локальному пути, выполнив команду `tar -xvzf Microsoft-ASR_UA_8.5.0.0*`.
3. Создайте файл passphrase.txt в локальном каталоге, в который извлечено содержимое TAR-архива. Для этого скопируйте парольную фразу из файла C:\\ProgramData\\Microsoft Azure Site Recovery\\private\\connection.passphrase на сервере конфигурации и сохраните ее в файле passphrase.txt, выполнив в оболочке команду *`echo <passphrase> >passphrase.txt`*.
4. Установите службу Mobility Service, выполнив команду *`sudo ./install -t both -a host -R Agent -d /usr/local/ASR -i <IP address> -p <port> -s y -c https -P passphrase.txt`*.
5. Укажите внутренний IP-адрес сервера конфигурации и убедитесь, что выбран порт 443. После установки службы ее состояние обновится на портале в течение 15 минут.

**Кроме того, установку можно выполнить из командной строки**.

1. Скопируйте парольную фразу из файла C:\\Program Files (x86)\\InMage Systems\\private\\connection на сервере конфигурации и сохраните ее там же как файл passphrase.txt. Затем выполните следующие команды. В нашем примере используется IP-адрес сервера конфигурации 104.40.75.37 и порт HTTPS 443:

Установка на рабочем сервере

    ./install -t both -a host -R Agent -d /usr/local/ASR -i 104.40.75.37 -p 443 -s y -c https -P passphrase.txt

Установка на главном целевом сервере:


    ./install -t both -a host -R MasterTarget -d /usr/local/ASR -i 104.40.75.37 -p 443 -s y -c https -P passphrase.txt


### Включение репликации

#### Перед началом работы

При репликации виртуальных машин VMware обратите внимание на следующее:

- Виртуальные машины VMware обнаруживаются каждые 15 минут, и для их отображения на портале Site Recovery после обнаружения может потребоваться более 15 минут. Обнаружение может также занять 15 минут или более при добавлении нового сервера vCenter или узла vSphere.
- Изменения среды на виртуальной машине (например, установка средств VMware) также могут отобразиться на портале через 15 и более минут.
- Время последнего обнаружения для виртуальных машин VMware можно узнать в колонке **Серверы конфигурации** в поле **Последний контакт в** свойств сервера vCenter или узла vSphere.
- Чтобы добавить компьютеры для репликации, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не щелкая его) и нажмите кнопку **Обновить**.
- Если при включении репликации компьютер подготовлен, сервер обработки автоматически устанавливает на него службу Mobility.

#### Исключение дисков из репликации

При включении репликации по умолчанию реплицируются все диски на компьютере. Диски можно исключить из репликации. Например, репликация может не требоваться для дисков с временными данными или данными, которые обновляются при каждом перезапуске компьютера или приложения (например, pagefile.sys или базы данных tempdb SQL Server). Если вы хотите исключить диски, обратите внимание на следующее:

- Исключать можно только те диски, которые уже установлены в службе Mobility. [Службу Mobility Service необходимо установить вручную](#install-the-mobility-service-manually), так как она устанавливается только с помощью механизма принудительной установки при включении репликации.
- Из репликации можно исключать только базовые диски. Диски операционной системы и динамический диск исключать нельзя.
- После включения репликации добавить или удалить диски для репликации нельзя. Если вы хотите добавить или исключить диск, отключите защиту компьютера, а затем включите ее повторно.
- Если вы исключили диск, необходимый для работы приложения, для выполнения реплицируемого приложения после отработки отказа в Azure вам необходимо будет создать его в Azure вручную. Кроме того, для создания диска во время отработки отказа компьютера вы можете интегрировать службу автоматизации Azure в план восстановления.
- Диски, создаваемые в Azure вручную, будут восстановлены в исходном расположении. Например, при отработке отказа трех дисков и создании двух дисков непосредственно в Azure все пять дисков будут восстановлены в исходном расположении. Диски, созданные вручную при восстановлении расположения, исключать нельзя.

**Включите репликацию следующим образом**.

1. Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**. Включив репликацию впервые, щелкните **+Replicate** (+ Реплицировать) в хранилище, чтобы включить репликацию для дополнительных компьютеров.
2. В колонке **Источник** найдите поле **Источник** и выберите сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Виртуальные машины** или **Физические компьютеры**.
4. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, управляющий узлом vSphere, или сам узел. Этот параметр не учитывается при репликации физических компьютеров.
5. Выберите сервер обработки. Если ни один дополнительный сервер обработки еще не создан, это будет имя сервера конфигурации. Нажмите кнопку **ОК**.

	![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication2.png)

6. В поле **Целевой объект** выберите подписку хранилища, а в поле **Модель развертывания после отработки отказа** — модель для использования после отработки отказа в Azure (классическую или с управлением ресурсами).
7. Выберите учетную запись хранения Azure, используемую для репликации данных. Обратите внимание на следующее.

	- Можно выбрать учетную запись хранения класса Standard или Premium. При выборе учетной записи класса Premium необходимо указать дополнительную учетную запись хранения класса Standard для журналов текущей репликации. Учетные записи должны находиться в том же регионе, что и хранилище служб восстановления.
	- Если вам нужна другая учетная запись хранения, [создайте ее](#set-up-an-azure-storage-account). Чтобы создать учетную запись хранения с использованием модели ARM, щелкните **Создать**. Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать [на портале Azure](../storage/storage-create-storage-account-classic-portal.md).

8. Выберите сеть и подсеть Azure, к которой будут подключаться развернутые виртуальные машины Azure после отработки отказа. Сеть должна располагаться в том же регионе, что и хранилище служб восстановления. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети для всех защищаемых компьютеров. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера. Если у вас нет сети, ее необходимо [создать](#set-up-an-azure-network). Чтобы создать сеть, используя модель ARM, щелкните **Создать**. Если нужно создать сеть, используя классическую модель, это можно сделать [на портале Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md). Выберите подсеть (если это применимо). Нажмите кнопку **ОК**.

	![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication3.png)

9. Щелкнув **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждый компьютер, который нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.

	![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication5.png)

10. В разделе **Свойства** щелкните **Настройка свойств** и выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютер. По умолчанию будут реплицироваться все диски. Щелкните **Все диски**, а затем снимите флажки напротив дисков, которые не нужно реплицировать. Нажмите кнопку **ОК**. Позже можно задать дополнительные свойства.

	![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication6.png)

11. В разделе **Параметры репликации** выберите **Настройка параметров репликации** и убедитесь, что выбрана правильная политика репликации. Параметры политики репликации можно изменить, последовательно выбрав **Параметры** > **Политики репликации** > имя политики > **Изменить параметры**. Изменения, примененные к политике, будут применены к репликации и новым компьютерам.

12. Включите параметр **Согласование с несколькими виртуальными машинами**, если хотите объединить компьютеры в группу репликации, и укажите имя этой группы. Нажмите кнопку **ОК**. Обратите внимание на следующее.

	- Компьютеры в группе репликации реплицируются вместе и имеют отказоустойчивые и согласованные точки восстановления после отработки отказа.
	- Виртуальные машины и физические серверы рекомендуется объединять для того, чтобы они могли зеркалировать рабочие нагрузки. Включение согласованности нескольких виртуальных машин может повлиять на производительность рабочей нагрузки, поэтому ее необходимо использовать, только если компьютеры выполняют одну и ту же рабочую нагрузку и должны действовать согласованно.

	![Включение репликации](./media/site-recovery-vmware-to-azure/enable-replication7.png)

13. Щелкните **Включить репликацию**. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Site Recovery jobs** (Задания Site Recovery). После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

> [AZURE.NOTE] Если компьютер готов для принудительной установки, компонент службы Mobility будет установлен при включении защиты. После того как компонент будет установлен на компьютере, задание защиты будет запущено и завершится ошибкой. После сбоя каждый компьютер необходимо будет перезапустить вручную. После перезапуска задание защиты будет запущено снова и будет выполнена начальная репликация.

### Просмотр свойств виртуальной машины и управление ими

Рекомендуется проверить свойства исходного компьютера. Помните, что имя виртуальной машины Azure должно соответствовать [требованиям к виртуальным машинам Azure](site-recovery-best-practices.md#azure-virtual-machine-requirements).

1. Щелкните **Параметры** > **Реплицированные элементы** и выберите компьютер. В колонке **Основные компоненты** отображается информация о параметрах и состоянии компьютеров.

2. На странице **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.

	![Включение репликации](./media/site-recovery-vmware-to-azure/test-failover2.png)

3. Выбрав **Вычисления и сеть** > **Свойства вычислений**, можно указать имя и целевой размер виртуальной машины Azure. При необходимости измените имя в соответствии с требованиями Azure. Кроме того, можно просмотреть и добавить сведения о целевой сети, подсети и целевом IP-адресе, который будет назначен виртуальной машине Azure. Обратите внимание на следующее.

	- Вы можете задать целевой IP-адрес. Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP. Если задать адрес, недоступный при отработке отказа, произойдет сбой. Этот же целевой IP-адрес можно использовать для тестовой отработки отказа, если он доступен в сети тестовой отработки отказа.
	- Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины:

		- Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
		- Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использовать максимальный размер целевой машины.
		- Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, то на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.
	- Если для виртуальной машины настроено несколько сетевых адаптеров, они будут подключены к одной сети.

	![Включение репликации](./media/site-recovery-vmware-to-azure/test-failover4.png)

4. На странице **Диски** отображаются сведения о дисках ОС и дисках данных на виртуальной машине, для которой будет выполняться репликация.


## Шаг 7. Тестирование развертывания

Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины или создать план восстановления для одной или нескольких виртуальных машин.


### Подготовка к отработке отказа

- Для запуска тестовой отработки отказа рекомендуется создать сеть Azure, изолированную от рабочей среды Azure (обычная практика при создании сети в Azure). [Узнайте больше](site-recovery-failover.md#run-a-test-failover) о выполнении тестовой отработки отказа.
- Для оптимальной производительности при отработке отказа в Azure установите агент Azure на защищенном компьютере. Это ускоряет загрузку и помогает устранять неполадки. Установите агент [Linux](https://github.com/Azure/WALinuxAgent) или [Windows](http://go.microsoft.com/fwlink/?LinkID=394789).
- Для полного тестирования развертывания требуется, чтобы инфраструктура для реплицируемого компьютера работала должным образом. Если нужно протестировать Active Directory и DNS, можно создать виртуальную машину в качестве контроллера домена с помощью DNS и реплицировать ее в Azure с помощью службы Azure Site Recovery. Узнайте больше о [рекомендациях по тестированию отработки отказа для Active Directory](site-recovery-active-directory.md#considerations-for-test-failover).
- Убедитесь, что сервер конфигурации запущен. В противном случае произойдет сбой отработки отказа.
- Если вы исключили диски из репликации, после отработки отказа их нужно будет создать вручную, чтобы приложение работало должны образом.
- Если нужно выполнить внеплановую отработку отказа вместо тестовой, обратите внимание на следующее:

	- По возможности перед выполнением внеплановой отработки отказа следует выключить основные компьютеры. В этом случае исходные и реплицированные компьютеры не будут работать одновременно. При репликации виртуальных машин VMware можно указать, что служба Site Recovery должна использовать все доступные способы для выключения исходных компьютеров. В зависимости от состояния основного сайта это может сработать или не сработать. При репликации физических серверов в службе Site Recovery такая возможность отсутствует.
	- При выполнении внеплановой отработки отказа репликация данных с основных компьютеров прекращается. Поэтому после начала внеплановой отработки отказа все изменения в данных не будут передаваться. Кроме того, при выполнении внеплановой отработки отказа в рамках плана восстановления она завершится даже в случае ошибки.

### Подготовка к подключению виртуальных машин Azure после отработки отказа

Если после отработки отказа нужно подключиться к виртуальным машинам Azure по протоколу удаленного рабочего стола, обязательно сделайте следующее:

**На локальном компьютере до отработки отказа**.

- Чтобы получить доступ через Интернет, включите протокол RDP. Убедитесь, что правила TCP и UDP добавлены в разделе **Общее** и что RDP разрешен в разделе **Брандмауэр Windows** > **Разрешенные программы и компоненты** для всех профилей.
- Чтобы получить доступ через подключение типа "сеть — сеть", включите протокол RDP на компьютере. Убедитесь, что RDP разрешен в разделе **Брандмауэр Windows** > **Разрешенные программы и компоненты** для сетей **домена** и **частных** сетей.
- Установите [агент виртуальной машины Azure](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) на локальном компьютере.
- [Установите службу Mobility Service вручную](#install-the-mobility-service-manually), не используя принудительную автоматическую установку службы через сервер обработки. Это связано с тем, что принудительная установка возможна только после того, как компьютер будет включен для репликации.
- Задайте для политики сети SAN операционной системы значение OnlineAll. [Подробнее](https://support.microsoft.com/kb/3031135)
- Отключите службу IPSec перед выполнением отработки отказа.

**На виртуальной машине Azure после отработки отказа**.

- Добавьте общедоступную конечную точку для протокола RDP (порт 3389) и укажите учетные данные для входа.
- Убедитесь в отсутствии политик домена, которые не допускают подключение к виртуальной машине с использованием общедоступного адреса.
- Попытайтесь подключиться. Если вам не удалось это сделать, убедитесь, что виртуальная машина запущена. Дополнительные советы по устранению неполадок см. в этой [статье](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).


Если после отработки отказа нужно получить доступ к виртуальной машине Azure под управлением Linux с помощью клиента SSH, выполните следующее:

**На локальном компьютере до отработки отказа**.

- Настройте автоматический запуск службы SSH на виртуальной машине Azure при загрузке системы (если он еще не настроен).
- Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.

**На виртуальной машине Azure после отработки отказа**.

- Правила группы сетевой безопасности на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения на порт SSH.
- Чтобы разрешить входящие подключения на порт SSH (TCP-порт 22 по умолчанию), необходимо создать общедоступную конечную точку.
- Если доступ к виртуальной машине осуществляется через VPN-подключение (Express Route или VPN типа "сеть — сеть"), можно использовать клиент для прямого подключения к виртуальной машине по протоколу SSH.

**После отработки отказа на виртуальных машинах Windows или Linux в Azure**.

При наличии группы безопасности сети, связанной с виртуальной машиной, или подсети, к которой принадлежит компьютер, проследите, чтобы группа безопасности сети имела правило, разрешающее исходящий трафик HTTP или HTTPS. Также убедитесь, что служба DNS сети, в которую выполняется отработка отказа виртуальной машины, настроена правильно. В противном случае отработка отказа может завершиться ошибкой "PreFailoverWorkflow task WaitForScriptExecutionTask timed out" (Истекло время ожидания выполнения задания WaitForScriptExecutionTask PreFailoverWorkflow). Дополнительную информацию об этой ошибке см. в разделе, посвященном восстановлению, статьи [Мониторинг и устранение неполадок защиты виртуальных машин и физических серверов](site-recovery-monitoring-and-troubleshooting.md#recovery).

## Запуск тестовой отработки отказа

1. Чтобы выполнить отработку отказа для одного компьютера, в разделе **Параметры** > **Реплицированные элементы** щелкните виртуальную машину, а затем значок **+Test Failover** (+ Тестовая отработка отказа).

	![Тестовая отработка отказа](./media/site-recovery-vmware-to-azure/test-failover1.png)

2. Чтобы выполнить отработку отказа по плану восстановления, в разделе **Параметры** > **Планы восстановления** щелкните план правой кнопкой мыши и выберите **Тестовая отработка отказа**. Чтобы создать план восстановления, [выполните эти инструкции](site-recovery-create-recovery-plans.md).

3. На странице **Тестовая отработка отказа** выберите сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.
4. Нажмите кнопку **ОК**, чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину, или в задании **тестовой отработки отказа**, выбрав имя хранилища > **Параметры** > **Задания** > **Site Recovery jobs** (Задания Site Recovery).
5. Когда отработка отказа дойдет до этапа **Завершение тестирования**, выполните следующие действия.

	1. Просмотрите реплику виртуальной машины на портале Azure. Проверьте, успешно ли выполнен запуск виртуальной машины.
	2. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине.
	3. Щелкните **Завершить тестирование**.

		![Тестовая отработка отказа](./media/site-recovery-vmware-to-azure/test-failover6.png)


	4. Щелкните элемент **Примечания** для регистрации и сохранения любых наблюдений, связанных с тестовой отработкой отказа.
	5. Выберите пункт **Тестовая отработка отказа завершена**, чтобы автоматически очистить тестовую среду. После этого для операции тестовой отработки отказа отобразится состояние **Завершено**.
	6.  На этом этапе элементы или виртуальные машины, автоматически созданные Site Recovery во время тестовой отработки отказа, удаляются. Дополнительные элементы, созданные для тестовой отработки отказа, не удаляются.

	> [AZURE.NOTE] Если отработка отказа выполняется более двух недель, она завершается принудительно.


6. После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в области **Виртуальные машины**. Следует убедиться, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
7. Если вы заранее [подготовились к подключению после отработки отказа](#prepare-to-connect-to-azure-vms-after-failover), то сможете подключиться к виртуальной машине Azure.

## Мониторинг развертывания

Вот как можно отслеживать параметры конфигурации, состояние и работоспособность развертывания Site Recovery:

1. Щелкните имя хранилища, чтобы открыть панель мониторинга **Основные компоненты**. На этой панели мониторинга можно просмотреть сведения о заданиях Site Recovery, состоянии репликации, планах восстановления, работоспособности сервера и событиях. Эту панель можно настроить таким образом, чтобы на ней отображались самые необходимые элементы и макеты, а также сведения о состоянии других хранилищ Site Recovery и службы архивации.<br> ![Основные компоненты](./media/site-recovery-vmware-to-azure/essentials.png)

2. На элементе **Работоспособность** можно следить за серверами сайта (серверами VMM или серверами конфигурации), на которых возникают ошибки, а также за событиями, о которых сообщила служба Site Recovery за последние 24 часа.
3. Мониторинг репликации и управление ею можно осуществлять в элементах **Реплицированные элементы**, **Планы восстановления** и **Site Recovery Jobs** (Задания Site Recovery). Подробные сведения о заданиях можно отобразить, выбрав **Параметры** > **Задания** > **Site Recovery Jobs** (Задания Site Recovery).


## Развертывание дополнительных серверов обработки

Если нужно выполнить масштабирование развертывания до более чем 200 исходных компьютеров или объем ежедневно изменяемых данных превышает 2 ТБ, для обработки объема трафика потребуются дополнительные серверы обработки.

Ознакомьтесь с [рекомендациями по выбору размера серверов обработки](#size-recommendations-for-the-process-server) и выполните приведенные ниже инструкции по настройке сервера обработки. После настройки сервера необходимо перенести исходные компьютеры для его использования.

### Установка дополнительного сервера обработки

1. Выберите **Параметры** > **Site Recovery servers** (Серверы Site Recovery), выберите сервер конфигурации и щелкните **Сервер обработки**.

	![Добавление сервера обработки](./media/site-recovery-vmware-to-azure/migrate-ps1.png)

2. В поле **Тип сервера** выберите **Process server (on-premises)** (Сервер обработки (локальный)).

	![Добавление сервера обработки](./media/site-recovery-vmware-to-azure/migrate-ps2.png)

3. Загрузите файл единой установки Site Recovery и запустите его, чтобы установить сервер обработки и зарегистрировать его в хранилище.
4. На странице **Перед началом работы** установите переключатель **Add additional process servers to scale out deployment** (Добавить дополнительные серверы обработки для масштабирования развертывания).
5. Завершите работу мастера так же, как и при [настройке](#step-2-set-up-the-source-environment) сервера конфигурации.

	![Добавление сервера обработки](./media/site-recovery-vmware-to-azure/add-ps1.png)

6. На странице **Configuration Server Details** (Сведения о сервере конфигурации) укажите IP-адрес сервера конфигурации и парольную фразу. Чтобы получить парольную фразу, выполните на сервере конфигурации команду **<папка\_установки\_Site\_Recovery>\\home\\sysystems\\bin\\genpassphrase.exe –n**.

	![Добавление сервера обработки](./media/site-recovery-vmware-to-azure/add-ps2.png)

### Перенос компьютеров для использования нового сервера обработки

1. В окне **Параметры** выберите **Site Recovery servers** (Серверы Site Recovery), щелкните сервер конфигурации и разверните список **Серверы обработки**.

	![Обновление сервера обработки](./media/site-recovery-vmware-to-azure/migrate-ps2.png)

2. Щелкните используемый сервер обработки правой кнопкой мыши и выберите **Переключить**.

	![Обновление сервера обработки](./media/site-recovery-vmware-to-azure/migrate-ps3.png)

3. В поле **Выбор целевого сервера обработки** выберите новый сервер обработки, который нужно использовать, а затем виртуальные машины, с которыми он будет работать. Щелкните значок сведений, чтобы получить сведения о сервере. Чтобы помочь принять решение о скачивании, отображается средний объем свободного места, требуемый для репликации каждой выбранной виртуальной машины на новом сервере обработки. Щелкните значок галочки, чтобы начать репликацию на новом сервере обработки.

## Разрешения учетной записи VMware

Сервер обработки может автоматически обнаруживать виртуальные машины на сервере vCenter. Для автоматического обнаружения необходимо [определить роль (Azure\_Site\_Recovery)](#prepare-an-account-for-automatic-discovery), чтобы предоставить службе Site Recovery доступ к серверу VMware. Обратите внимание, что если нужно лишь перенести компьютеры VMware в Azure и не нужно выполнять восстановление размещения с переносом из Azure, роли только для чтения достаточно. В следующей таблице представлены общие сведения о необходимых разрешениях ролей.

**Роль** | **Дополнительные сведения** | **Разрешения**
--- | --- | ---
Роль Azure\_Site\_Recovery | Обнаружение виртуальной машины VMware |Назначьте серверу vCenter такие права:<br/><br/>хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины;<br/><br/>сеть -> назначение сети;<br/><br/>ресурсы -> назначение виртуальной машины пулу ресурсов, перенос отключенной виртуальной машины, перенос включенной виртуальной машины;<br/><br/>задачи -> создание задачи, обновление задачи;<br/><br/>виртуальная машина -> конфигурация;<br/><br/>виртуальная машина -> взаимодействие -> ответ на вопрос, подключение к устройству, настройка компакт-диска, настройка гибкого диска, выключение, включение, установка средств VMware;<br/><br/>виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации;<br/><br/>виртуальная машина -> подготовка -> разрешение скачивания на виртуальной машине, разрешение отправки файлов с виртуальной машины;<br/><br/>виртуальная машина -> моментальные снимки -> удаление моментальных снимков.
Роль пользователя vCenter | Обнаружение виртуальной машины VMware, отработка отказа без выключения исходной виртуальной машины | Назначьте серверу vCenter такие права:<br/><br/>объект центра обработки данных -> распространение на дочерний объект, роль только для чтения. <br/><br/>Пользователь назначается на уровне центра обработки данных и поэтому получает доступ ко всем объектам в центре обработки данных. Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).
Роль пользователя vCenter | Отработка отказа и восстановление размещения | Назначьте серверу vCenter такие права:<br/><br/>объект центра обработки данных -> распространение на дочерний объект, роль Azure\_Site\_Recovery. <br/><br/>Пользователь назначается на уровне центра обработки данных и поэтому получает доступ ко всем объектам в центре обработки данных. Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).  
## Дальнейшие действия

- [Узнайте больше](site-recovery-failover.md) о разных типах отработки отказа.
- [Узнайте больше о восстановлении размещения](site-recovery-failback-azure-to-vmware.md) и о том, как перенести работающие в Azure компьютеры, для которых выполнена отработка отказа, обратно в локальную среду.

## Уведомления и сведения о стороннем программном обеспечении

Do Not Translate or Localize

The software and firmware running in the Microsoft product or service is based on or incorporates material from the projects listed below (collectively, “Third Party Code”). Microsoft is the not original author of the Third Party Code. The original copyright notice and license, under which Microsoft received such Third Party Code, are set forth below.

The information in Section A is regarding Third Party Code components from the projects listed below. Such licenses and information are provided for informational purposes only. This Third Party Code is being relicensed to you by Microsoft under Microsoft's software licensing terms for the Microsoft product or service.

The information in Section B is regarding Third Party Code components that are being made available to you by Microsoft under the original licensing terms.

The complete file may be found on the [Microsoft Download Center](http://go.microsoft.com/fwlink/?LinkId=529428). Microsoft reserves all rights not expressly granted herein, whether by implication, estoppel or otherwise.

<!---HONumber=AcomDC_0921_2016-->