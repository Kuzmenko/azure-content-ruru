<properties
	pageTitle="Репликация между локальными виртуальными машинами Hyper-V и Azure (без VMM) с помощью службы Site Recovery | Microsoft Azure"
	description="В этой статье описывается репликация виртуальных машин Hyper-V в Azure с помощью Azure Site Recovery, когда виртуальные машины не управляются в облаках VMM."
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery"
	ms.date="09/19/2016"
	ms.author="raynew"/>


# Репликация между локальными виртуальными машинами Hyper-V и Azure (без VMM) с помощью службы Azure Site Recovery

> [AZURE.SELECTOR]
- [Портал Azure](site-recovery-hyper-v-site-to-azure.md)
- [PowerShell в режиме ARM](site-recovery-deploy-with-powershell-resource-manager.md)
- [Классический портал](site-recovery-hyper-v-site-to-azure-classic.md)

В этой статье описывается развертывание Site Recovery для репликации виртуальных машин Hyper-V в Azure, когда узлы Hyper-V не управляются в облачных средах System Center Virtual Machine Manager (VMM).

Эта статья содержит необходимые условия развертывания, а также поможет вам настроить параметры репликации и включить защиту виртуальных машин. В заключение приводится процедура тестирования отработки отказа для подтверждения правильной работы всех компонентов.

После прочтения этой статьи любые комментарии или вопросы можно добавить в ее конце или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## Обзор

Организациям нужна стратегия обеспечения непрерывности бизнес-процессов и аварийного восстановления (BCDR), которая определяет, как приложения, рабочие нагрузки и данные будут оставаться доступными при запланированных и незапланированных простоях, а также как организация сможет максимально быстро восстановить нормальный режим работы. Стратегия BCDR сосредоточена на решениях, обеспечивающих защиту и восстановление бизнес-данных, а также постоянную доступность рабочих нагрузок в случае сбоя.

Служба Azure Site Recovery помогает реализовать стратегию BCDR. Она управляет процессами репликации локальных физических серверов и виртуальных машин в облако (Azure) или дополнительные центры обработки данных. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода на дополнительный сайт. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него.

Службу Site Recovery можно использовать в ряде сценариев. Она обеспечивает защиту нескольких рабочих нагрузок. Дополнительные сведения см. в статье [Что такое Azure Site Recovery?](site-recovery-overview.md).


## Предварительные требования Azure

- Вам потребуется учетная запись [Microsoft Azure](https://azure.microsoft.com/). Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/).
- Для хранения реплицируемых данных потребуется учетная запись хранения Azure. На учетной записи необходимо включить георепликацию. Она должна находиться в том же регионе, что и хранилище Azure Site Recovery, и быть связана с той же подпиской. См. [дополнительные сведения о службе хранилища Azure](../storage/storage-introduction.md). Учтите, что мы не поддерживаем перемещение учетных записей хранения, созданных с помощью [нового портала Azure](../storage/storage-create-storage-account.md), между группами ресурсов.
- Виртуальные машины Azure должны быть подключены к сети при отработке отказа с перемещением из основного сайта. Поэтому вам потребуется виртуальная сеть Azure.

## Предварительные требования Hyper-V

- На исходном локальном сайте вам понадобится один или несколько серверов с Windows Server 2012 R2 и установленной ролью Hyper-V. Ниже приведены требования к этому серверу.
- Он должен содержать одну или несколько виртуальных машин.
- Он должен быть подключенным к Интернету напрямую или через прокси-сервер.
- Он должен содержать исправления, описанные в KB [2961977](https://support.microsoft.com/ru-RU/kb/2961977 "KB2961977").

## Предварительные требования к виртуальным машинам

Виртуальные машины, которые требуется защитить, должны отвечать [требованиям к виртуальным машинам Azure](site-recovery-best-practices.md#azure-virtual-machine-requirements).

## Предварительные требования к поставщикам и агентам

При развертывании Azure Site Recovery мы установим поставщик этой службы и агент служб восстановления Azure на каждом сервере Hyper-V. Обратите внимание на следующее.

- Рекомендуется запускать последние версии поставщика и агента. Они доступны на портале Site Recovery.
- На всех серверах Hyper-V в хранилище должны быть одинаковые версии поставщика и агента.
- Поставщик, запущенный на сервере, подключается к службе Site Recovery через Интернет. Это можно сделать без прокси-сервера с помощью параметров прокси-сервера, настроенных на сервере Hyper-V, или с помощью пользовательских параметров прокси-сервера, настраиваемых во время установки поставщика. Необходимо убедиться в том, что желаемый прокси-сервер может получить доступ к этим URL-адресам для подключения к Azure:
	- *.hypervrecoverymanager.windowsazure.com
	- *.accesscontrol.windows.net
	- *.backup.windowsazure.com
	- *.blob.core.windows.net
	- *.store.core.windows.net
	
- Кроме того, разрешите подключение к IP-адресам, перечисленным в статье [Диапазоны IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653), и по протоколу HTTPS (443). Необходимо разрешить диапазоны IP-адресов региона Azure, который вы планируете использовать, и Запада США.


На рисунке показаны различные каналы связи и порты, используемые службой Site Recovery для управления и репликации

![Топология B2A](./media/site-recovery-hyper-v-site-to-azure-classic/b2a-topology.png)


## Шаг 1. Создание хранилища

1. Выполните вход на [Портал управления](https://portal.azure.com).


2. Разверните **Службы данных** > **Службы восстановления** и щелкните **Хранилище Site Recovery**.


3. Выберите **Создать** > **Быстрое создание**.

4. В поле **Имя** введите понятное имя для идентификации хранилища.

5. В поле **Область** выберите географический регион для хранилища архивации. Сведения о поддерживаемых регионах см. в разделе "Регионы" страницы [Расценки на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).

6. Щелкните элемент **Создать хранилище**.

	![Новое хранилище](./media/site-recovery-hyper-v-site-to-azure-classic/vault.png)

Проверьте строку состояния, чтобы убедиться, что хранилище успешно создано. На главной странице служб восстановления это хранилище будет указано с состоянием **Активно**.


## Шаг 2. Создание узла Hyper-V

1. На странице Службы восстановления щелкните хранилище, чтобы открыть страницу быстрого запуска. Страницу быстрого запуска можно открыть и в любой другой момент, щелкнув этот значок.

	![Быстрый запуск](./media/site-recovery-hyper-v-site-to-azure-classic/quick-start-icon.png)

2. В раскрывающемся списке выберите элемент **Между локальным узлом Hyper-V и Microsoft Azure**.

	![Сценарий узла Hyper-V](./media/site-recovery-hyper-v-site-to-azure-classic/select-scenario.png)

3. В разделе **Создание узла Hyper-V** щелкните **Создать узел Hyper-V**. Укажите имя узла и сохраните.

	![Узел Hyper-V](./media/site-recovery-hyper-v-site-to-azure-classic/create-site.png)


## Шаг 3. Установка поставщика и агента
Установите поставщик и агент на каждом сервере Hyper-V, содержащем виртуальные машины, которые необходимо защитить.

При установке в кластере Hyper-V выполните шаги с 5-11 на каждом узле отказоустойчивого кластера. После регистрации всех узлов и включения защиты виртуальные машины будут защищены даже при перемещении между узлами кластера.

1. В разделе **Подготовка серверов Hyper-V** нажмите пункт **Загрузить регистрационный ключ**.
2. На странице **Загрузить регистрационный ключ** щелкните пункт **Загрузка** рядом с узлом. Скачайте ключ в безопасное расположение, легко доступное для сервера Hyper-V. Ключ действителен в течение пяти дней после создания.

	![Регистрационный ключ](./media/site-recovery-hyper-v-site-to-azure-classic/download-key.png)

4. Щелкните **Скачать поставщик** для получения последней версии.
5. Запустите файл на каждом сервере Hyper-V, который нужно зарегистрировать в хранилище. Файл устанавливает два компонента:
	- **Поставщик Azure Site Recovery** — обеспечивает возможность связи и оркестрации между сервером Hyper-V и порталом Azure Site Recovery.
	- **Агент служб восстановления Azure** — обрабатывает передачу данных между виртуальными машинами, работающими на исходном сервере Hyper-V и в хранилище Azure.
6. В **Центре обновления Майкрософт** вы можете настроить обновления. Если этот параметр включен, то обновления поставщика и агента будут устанавливаться в соответствии с вашей политикой Центра обновления Майкрософт.

	![Центр обновления Майкрософт](./media/site-recovery-hyper-v-site-to-azure-classic/provider1.png)

7. В поле **Установка** укажите место на сервере Hyper-V для установки поставщика и агента.

	![Расположение установки](./media/site-recovery-hyper-v-site-to-azure-classic/provider2.png)

8. После завершения установки продолжите настройку, чтобы зарегистрировать сервер в хранилище.

9. На странице **Параметры хранилища** нажмите кнопку **Обзор**, чтобы выбрать файл ключа. Укажите подписку Azure Site Recovery, имя хранилища и узла Hyper-V, к которому относится сервер Hyper-V.

	![Регистрация сервера](./media/site-recovery-hyper-v-site-to-azure-classic/provider8.PNG)

10. На странице **Подключение к Интернету** укажите способ подключения поставщика к Azure Site Recovery. Выберите пункт **Use default system proxy settings** (Использовать настройки прокси-сервера по умолчанию), чтобы использовать настройки подключения к Интернету, по умолчанию заданные на сервере. Если значение не указано, будут использоваться параметры по умолчанию.

	![Параметры Интернета](./media/site-recovery-hyper-v-site-to-azure-classic/provider7.PNG)

11. Начнется процесс регистрации сервера в хранилище.

	![Регистрация сервера](./media/site-recovery-hyper-v-site-to-azure-classic/provider15.PNG)

11. После завершения регистрации Azure Site Recovery извлекает метаданные из сервера Hyper-V, а сам сервер отображается на вкладке **Узлы Hyper-V** страницы **Серверы** в хранилище.


### Установка поставщика из командной строки

В качестве альтернативы можно установить поставщик Azure Site Recovery из командной строки. Этот метод следует использовать, если требуется установить поставщик на компьютере, работающем под управлением Windows Server Core 2012 R2. Выполните запуск из командной строки следующим образом:

1. Скачайте файл установки поставщика и ключ регистрации в папку. Например, C:\\ASR.
2. Запустите командную строку от имени администратора и введите следующее:

    	C:\Windows\System32> CD C:\ASR
    	C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q

3. Установите поставщик, выполнив следующую команду:

		C:\ASR> setupdr.exe /i

4. Для завершения регистрации выполните следующую команду:

    	CD C:\Program Files\Microsoft Azure Site Recovery Provider
    	C:\Program Files\Microsoft Azure Site Recovery Provider> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>         

Параметры:

- **/Credentials**. Укажите расположение скачанного ключа регистрации.
- **/FriendlyName**. Укажите имя для определения сервера узла Hyper-V. Это имя отобразится на портале.
- **/EncryptionEnabled**. (Необязательно.) Укажите, следует ли шифровать виртуальные машины реплик в Azure (неактивное шифрование).
- **/ProxyAddress**, **/proxyport**, **/proxyusername**, **/proxypassword**. (Необязательно.) Укажите параметры прокси-сервера, если необходимо использовать пользовательский прокси-сервер или выполнить проверку подлинности для существующего прокси-сервера.


## Шаг 4. Создание учетной записи хранения Azure 

1. В разделе **Подготовка ресурсов** выберите **Создать учетную запись хранения** для создания учетной записи хранения Azure, если таковой нет. Для учетной записи необходимо включить георепликацию. Она должна находиться в том же регионе, что и хранилище Azure Site Recovery, и быть связана с той же подпиской.

	![Создание учетной записи хранения](./media/site-recovery-hyper-v-site-to-azure-classic/create-resources.png)

>[AZURE.NOTE] 1. Мы не поддерживаем перемещение учетных записей хранения, созданных с помощью [нового портала Azure](../storage/storage-create-storage-account.md), между группами ресурсов. 2) [Перенос учетных записей хранения](../resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для учетных записей хранения, используемых для развертывания Site Recovery.

## Шаг 5. Создание и настройка групп защиты

Группы защиты — это логические группы виртуальных машин, которые требуется защитить, используя те же параметры защиты. Параметры, установленные для группы защиты, будут применяться ко всем виртуальным машинам, добавленным в группу.

1. В поле **Создание и настройка групп защиты** щелкните **Создать группу защиты**. Если выполнены не все предварительные требования, выдается сообщение об этом. Чтобы получить подробную информацию, щелкните пункт сообщения **Просмотр сведений**.

2. На вкладке **Группы защиты** добавьте группу защиты. Укажите имя, исходный узел Hyper-V, целевой ресурс **Azure**, имя подписки Azure Site Recovery и учетную запись хранения Azure.

	![Группа защиты](./media/site-recovery-hyper-v-site-to-azure-classic/protection-group.png)


2. В разделе **Параметры репликации** задайте параметр **Частота копирования**, чтобы указать, как часто дельта данных должна быть синхронизирована между источником и целью. Можно выбрать значение 30 секунд, 5 минут или 15 минут.
3. В поле **Сохранять точки восстановления** укажите, сколько часов журнала восстановления следует сохранять.
4. В поле **Частота моментальных снимков, соответствующих приложению** можно указать, создавать ли снимки, использующие службу теневого копирования томов (VSS), чтобы гарантировать согласованное состояние приложений на момент создания снимка. По умолчанию они не создаются. Это значение должно быть меньше количества дополнительных точек восстановления, которое было настроено. Это поддерживается только в том случае, если виртуальная машина работает под управлением операционной системы Windows.
5. В поле **Время запуска начальной репликации** укажите, когда начальная репликация виртуальных машин в группе защиты должна отправляться в Azure.

	![Группа защиты](./media/site-recovery-hyper-v-site-to-azure-classic/protection-group2.png)


## Шаг 6. Включение защиты виртуальной машины


Добавьте виртуальные машины в группу защиты, чтобы включить для них защиту.

>[AZURE.NOTE] Защита виртуальных машин под управлением Linux со статическим IP-адресом не поддерживается.

1. На вкладке **Компьютеры** для группы защиты щелкните **Add virtual machines to protection groups to enable protection** (Добавить виртуальные машины в группы защиты для обеспечения защиты).
2. На странице **Включение защиты виртуальной машины** выберите виртуальные машины, которые следует защитить.

	![Включение защиты виртуальной машины](./media/site-recovery-hyper-v-site-to-azure-classic/add-vm.png)

	Запускается задание включения защиты. Ход выполнения операции можно отслеживать на вкладке **Задания**. После запуска задачи финализации защиты виртуальная машина готова к отработке отказа.
3. После настройки защиты вы можете:

	- просмотреть виртуальные машины, выбрав элементы **Защищенные элементы** > **Группы защиты** > *имя\_группы* > **Виртуальные машины**. Вы можете просмотреть подробные сведения о машинах на вкладке **Свойства**;
	- настраивать свойства отработки отказа для виртуальных машин в разделе **Защищенные элементы** > **Группы защиты** > *имя\_группы* > **Виртуальные машины** *имя\_виртуальной\_машины* > **Настройка**. Вы можете настроить:
		- **Имя**: имя виртуальной машины в Azure.
		- **Размер**: целевой размер виртуальной машины, отрабатывающей отказ.

		![Настройка свойств виртуальной машины](./media/site-recovery-hyper-v-site-to-azure-classic/vm-properties.png)
	- В разделе *Защищенные элементы** > **Группы защиты** > *имя\_группы\_защиты* > **Виртуальные машины* имя\_виртуальной\_машины* > **Настройка** настройте дополнительные параметры виртуальных машин, в том числе следующие.

		- **Сетевые адаптеры**: количество сетевых адаптеров диктуется размером, указанным для целевой виртуальной машины. Ознакомьтесь со [спецификациями размеров виртуальных машин](../virtual-machines/virtual-machines-linux-sizes.md#size-tables), чтобы узнать количество сетевых адаптеров в соответствии с размером виртуальной машины.


			После изменения размера виртуальной машины и сохранения параметров при следующем открытии страницы **Настройка** количество сетевых адаптеров изменится. Количество сетевых адаптеров целевой виртуальной машины равно меньшему из числа сетевых адаптеров исходной виртуальной машины и максимального числа сетевых адаптеров, поддерживаемых размером выбранной виртуальной машины. Пояснения приведены ниже.


			- Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
			- Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использовать максимальный размер целевой машины.
			- Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, то на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.
		- **Сеть Azure**: укажите сеть, в которую должна переходить виртуальная машина. Если у виртуальной машины несколько сетевых адаптеров, то все адаптеры должны быть подключены к одной сети Azure.
		- **Подсеть**: выберите для каждого сетевого адаптера на виртуальной машине подсеть в сети Azure, к которой машина должна подключаться после отработки отказа.
		- **Целевой IP-адрес**. Если сетевой адаптер исходной виртуальной машины настроен для использования статического IP-адреса, можно указать IP-адрес для целевой виртуальной машины, чтобы предотвратить изменение IP-адреса виртуальной машины после отработки отказа. Если IP-адрес не указан, то во время отработки отказа будет назначен любой доступный адрес. Если указать адрес, который уже используется, при отработке отказа произойдет сбой.
		
        > [AZURE.NOTE] [Migration of networks](../resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для сетей, используемых для развертывания Site Recovery.

		![Настройка свойств виртуальной машины](./media/site-recovery-hyper-v-site-to-azure-classic/multiple-nic.png)




## Шаг 7. Создание плана восстановления

Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины или создать план восстановления для одной или нескольких виртуальных машин. См. [дополнительные сведения](site-recovery-create-recovery-plans.md) о создании плана восстановления.

## Шаг 8. Тестирование развертывания

Существует два способа запуска тестовой отработки отказа в Azure.

- **Тестовая отработка отказа без использования сети Azure**. Этот тип тестовой отработки отказа проверяет, правильно ли работает виртуальная машина в Azure. Виртуальная машина не подключается к сети Azure после отработки отказа.
- **Тестовая отработка отказа с использованием сети Azure**. Этот тип отработки отказа проверяет, работает ли вся среда репликации должным образом и подключаются ли виртуальные машины, для которых выполнена отработка отказа, к указанной целевой сети Azure. Обратите внимание, что для тестовой отработки отказа подсеть тестовой виртуальной машины определяется в зависимости от подсети виртуальной машины реплики. Этот режим отличается от обычной репликации, когда подсеть реплики виртуальной машины основывается на подсети исходной виртуальной машины.

Если необходимо выполнить тестовую отработку отказа без указания сети Azure, никакая подготовка не требуется.

Для запуска тестовой отработки отказа с целевой сетью Azure потребуется создать новую сеть Azure, изолированную от рабочей среды Azure (обычная практика при создании новой сети в Azure). Дополнительные сведения см. в разделе [Запуск тестовой отработки отказа](site-recovery-failover.md#run-a-test-failover).


Чтобы полностью протестировать развертывание репликации и сети, необходимо настроить инфраструктуру так, чтобы реплицируемая виртуальная машина работала должным образом. Один из способов сделать это — настроить виртуальную машину как контроллер домена с помощью DNS и реплицировать ее в Azure с помощью службы Site Recovery, чтобы создать ее в тестовой сети, выполнив тестовую отработку отказа. [Узнайте больше](site-recovery-active-directory.md#considerations-for-test-failover) о рекомендациях по тестированию отработки отказа для Active Directory.

Запустите тестовую отработку отказа следующим образом:

>[AZURE.NOTE] Для оптимальной производительности при отработке отказа в Azure необходимо, чтобы агент Azure был установлен на защищенном компьютере. Это ускоряет загрузку и помогает диагностировать неполадки. Агент Linux можно скачать [отсюда](https://github.com/Azure/WALinuxAgent), а агент Windows — [отсюда](http://go.microsoft.com/fwlink/?LinkID=394789).

1. На вкладке **Планы восстановления** выберите план и щелкните **Тестовая отработка отказа**.
2. На **странице подтверждения тестовой отработки отказа** выберите **Нет** или конкретную сеть Azure. Учтите, что при выборе варианта **Нет** в ходе тестовой отработки отказа будет проверяться правильность репликации виртуальной машины в Azure, но не конфигурация сети репликации.

	![Тестовая отработка отказа](./media/site-recovery-hyper-v-site-to-azure-classic/test-nonetwork.png)

3. На вкладке **Задания** можно отследить ход выполнения отработки отказа. Кроме того, вы можете просмотреть тестовую реплику виртуальной машины на портале Azure. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине.
4. После того как отработка отказа достигнет фазы **Полное тестирование**, нажмите **Завершить тестирование**, чтобы закончить действие. Вы можете перейти на вкладку **Задания**, чтобы отслеживать ход выполнения отработки отказа и изменение ее состояния, а также выполнять прочие необходимые действия.
5. После отработки отказа тестовая реплика виртуальной машины будет отображаться на портале Azure. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине.

	1. Проверьте, успешно ли выполнен запуск виртуальных машин.
    2. При необходимости подключиться к виртуальной машине в Azure с использованием удаленного рабочего стола после отработки отказа, включите подключение удаленного рабочего стола на виртуальной машине до запуска тестирования отработки отказа. Кроме того, на виртуальной машине потребуется добавить конечную точку RDP. Для этого можно использовать модуль [Runbook службы автоматизации Azure](site-recovery-runbook-automation.md).
    3. После отработки отказа, если вы используете общедоступный IP-адрес для подключения к виртуальной машине в Azure с помощью удаленного рабочего стола, убедитесь, что у вас нет политик доменов, которые препятствуют подключению к виртуальной машине с помощью общедоступного адреса.

6. После завершения тестирования выполните следующие действия:

	- Щелкните пункт **Тестовая отработка отказа завершена**. Проведите очистку тестовой среды, чтобы автоматически отключить питание и удалить тестовые виртуальные машины.
	- Щелкните элемент **Примечания** для регистрации и сохранения любых наблюдений, связанных с тестовой отработкой отказа.
7. После того как отработка отказа достигнет фазы **Полное тестирование**, выполните следующую проверку:
	1. Просмотрите реплику виртуальной машины на портале Azure. Проверьте, успешно ли выполнен запуск виртуальной машины.
	2. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине.
	3. Щелкните **Завершить проверку** для завершения действия.
	4. Щелкните элемент **Примечания** для регистрации и сохранения любых наблюдений, связанных с тестовой отработкой отказа.
	5.  Щелкните пункт **Тестовая отработка отказа завершена**. Проведите очистку тестовой среды, чтобы автоматически отключить питание и удалить тестовую виртуальную машину.

## Дальнейшие действия

Настроив и запустив развертывание, см. [дополнительные сведения](site-recovery-failover.md) об обработке отказов.

<!---HONumber=AcomDC_0921_2016-->