<properties
	pageTitle="Репликация виртуальных машин Hyper-V (без VMM) в Azure с помощью Azure Site Recovery на портале Azure | Microsoft Azure"
	description="Здесь содержится описание того, как развернуть Azure Site Recovery, чтобы управлять репликацией, отработкой отказа и восстановлением локальных виртуальных машин Hyper-V, не управляемых VMM, в Azure с помощью портала Azure"
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery"
	ms.date="09/19/2016"
	ms.author="raynew"/>


# Репликация виртуальных машин Hyper-V (без VMM) в Azure с помощью Azure Site Recovery на портале Azure | Microsoft Azure

> [AZURE.SELECTOR]
- [Портал Azure](site-recovery-hyper-v-site-to-azure.md)
- [Классическая модель Azure](site-recovery-hyper-v-site-to-azure-classic.md)
- [PowerShell в режиме ARM](site-recovery-deploy-with-powershell-resource-manager.md)



Вас приветствует служба Azure Site Recovery! Эта статья поможет вам выполнить репликацию локальных виртуальных машин Hyper-V, управление которыми осуществляется **не** в облаках System Center Virtual Machine Manager (VMM), в Azure. В этой статье описывается, как настроить репликацию с помощью Azure Site Recovery на портале Azure.

> [AZURE.NOTE] В Azure предлагаются две [модели развертывания](../resource-manager-deployment-model.md) для создания ресурсов и работы с ними: модель Azure Resource Manager (ARM) и классическая модель. Кроме того, Azure предоставляет два портала — классический портал Azure, поддерживающий классическую модель развертывания, и портал Azure, поддерживающий обе модели развертывания.


Azure Site Recovery на портале Azure обеспечивает множество новых возможностей:

- На портале Azure служба архивации Azure и службы Azure Site Recovery объединены в одном хранилище служб восстановления. Таким образом, вы можете настроить непрерывность бизнес-процессов и аварийное восстановление и управлять этими функциями из одного места. Единая панель мониторинга позволяет отслеживать операции между локальными сайтами и общедоступным облаком Azure и управлять ими.
- Теперь у пользователей с подписками Azure, которые подготовлены к работе в рамках программы для поставщиков облачных решений, появилась возможность управлять операциями Site Recovery на портале Azure.
- Используя службу Site Recovery на портале Azure, можно реплицировать компьютеры в учетные записи хранения ARM. При отработке отказа Site Recovery создает виртуальные машины на основе ARM в Azure.
- Site Recovery по-прежнему поддерживает репликацию в классические учетные записи хранения и отработку отказа с использованием виртуальных машин по классической модели развертывания.


Если после прочтения этой статьи у вас появятся комментарии, вы можете оставить их внизу в разделе обсуждений. Вы можете задать любые вопросы технического характера на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## Обзор


Организациям нужна стратегия обеспечения непрерывности бизнес-процессов и аварийного восстановления, которая определяет, как приложения, рабочие нагрузки и данные будут оставаться доступными при запланированных и незапланированных простоях, а также как можно максимально быстро восстановить нормальный режим работы. Эта стратегия должна обеспечивать защиту и восстановление бизнес-данных, а также постоянную доступность рабочих нагрузок в случае сбоя.

Служба Azure Site Recovery помогает реализовать стратегию BCDR. Она управляет процессами репликации локальных физических серверов и виртуальных машин в облако (Azure) или дополнительные центры обработки данных. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода в дополнительное расположение. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него. Дополнительные сведения см. в статье [Что такое Site Recovery?](site-recovery-overview.md)

Эта статья содержит все сведения, необходимые для репликации виртуальных машин Hyper-V, управление которыми не осуществляется в облаках VMM для Azure. Здесь приведены обзор архитектуры и сведения о планировании, а также рассмотрены этапы развертывания для настройки локальных серверов, среды Azure, политики репликации и планирования ресурсов. После настройки инфраструктуры можно включить репликацию на компьютерах, которые требуется защитить, и проверить отработку отказа.

## Преимущества для предприятий

- Обеспечивает удаленную отработку отказа (через Azure) для корпоративных рабочих нагрузок и приложений, выполняемых на виртуальных машинах Hyper-V.
- Реплицирует виртуальные машины Hyper-V, используя Azure Site Recovery, без необходимости сервера VMM.
- Предоставляет отдельную консоль служб восстановления для простой настройки процессов репликации, отработки отказа и восстановления и управления этими процессами.
- Позволяет легко выполнять отработку отказа из локальной инфраструктуры в Azure и восстановление размещения (восстановление) с переносом из Azure на локальный сайт.
- Можно настроить планы восстановления для нескольких компьютеров, чтобы обеспечить отработку отказа рабочих нагрузок многоуровневого приложения.

## Архитектура сценария

Ниже приведены компоненты, участвующие в сценарии:

- **Узел или кластер Hyper-V**. Локальные серверы узлов или кластеры Hyper-V. При развертывании службы Site Recovery узлы Hyper-V, где запущены виртуальные машины, которые нужно защитить, будут собраны в логические узлы Hyper-V.
- **Агент служб восстановления и поставщик Azure Site Recovery**. Во время развертывания необходимо установить поставщик Azure Site Recovery, а на узле Hyper-V — агент служб восстановления Microsoft Azure. Поставщик обменивается данными со службой Azure Site Recovery через порт HTTPS 443 для репликации оркестрации. По умолчанию агент на сервере узла Hyper-V реплицирует данные в службу хранилища Azure через порт HTTPS 443.
- **Azure**. Требуется подписка Azure, учетная запись хранения Azure для хранения реплицированных данных и виртуальная сеть Azure для подключения виртуальных машин Azure к сети после отработки отказа.

![Архитектура узла Hyper-V](./media/site-recovery-hyper-v-site-to-azure/architecture.png)
 


## Предварительные требования Azure

Для развертывания этого сценария вам потребуются следующие компоненты среды Azure.

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Учетная запись Azure**| Вам потребуется учетная запись [Microsoft Azure](http://azure.microsoft.com/). Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). Ознакомьтесь с [дополнительными сведениями](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery. 
**Служба хранилища Azure** | Вам потребуется стандартная учетная запись хранения. Подойдет учетная запись хранения LRS или GRS. Рекомендуется использовать учетную запись хранения GRS, чтобы обеспечить устойчивость данных в случае отключения электричества в регионе или при отсутствии возможности восстановления основного региона. [Подробнее](../storage/storage-redundancy.md). Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления. <br/><br/> Хранилище класса Premium не поддерживается. <br/><br/> Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure создаются при отработке отказа. <br/><br/> [Прочтите статью](../storage/storage-introduction.md) о службе хранилища Azure.
**Сеть Azure** | Потребуется виртуальная сеть Azure, к которой будут подключаться виртуальные машины Azure при отработке отказа. Виртуальная сеть Azure должна располагаться в том же регионе, что и хранилище служб восстановления. 

## Предварительные требования для локальной среды

Вам потребуется следующее (локальная среда).

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Hyper-V**| Один или несколько локальный серверов должны работать под управлением Windows Server 2012 R2 с ролью Hyper-V и установленными последними обновлениями. <br/><br/> Сервер Hyper-V должен содержать одну или несколько виртуальных машин. <br/><br/> Серверы Hyper-V должны быть подключены к Интернету напрямую или через прокси-сервер. <br/><br/> На серверах Hyper-V должны быть установлены исправления, упомянутые в статье базы знаний [KB2961977](https://support.microsoft.com/ru-RU/kb/2961977 "KB2961977").
**Поставщик и агент** | Во время развертывания Azure Site Recovery устанавливается поставщик Azure Site Recovery. На каждом сервере Hyper-V, где запущены виртуальные машины, которые необходимо защитить, при установке поставщика также устанавливается агент служб восстановления Azure. На всех серверах Hyper-V в хранилище должны быть одинаковые версии поставщика и агента. <br/><br/> Поставщику потребуется подключиться к Azure Site Recovery через Интернет. Трафик может передаваться напрямую или через прокси-сервер. Обратите внимание, что прокси-сервер на основе HTTPS не поддерживается. Прокси-сервер должен обеспечивать доступ к следующим адресам: <br/><br/> *.hypervrecoverymanager.windowsazure.com <br/><br/> *.accesscontrol.windows.net <br/><br/> *.backup.windowsazure.com <br/><br/> *.blog.core.windows.net <br/><br/> *store.core.windows.net<br/><br/> https://www.msftncsi.com/ncsi.txt<br/><br/> При наличии правил брандмауэра на основе IP-адресов на сервере VMM убедитесь, что они разрешают обмен данными с Azure. Необходимо разрешить использовать [диапазоны IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и протокол HTTPS (433). <br/><br/>Внесите диапазоны IP-адресов для региона Azure своей подписки и для западной части США в список разрешенных.

## Предварительные требования для защищенных компьютеров


**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Защищенные виртуальные машины** | Перед отработкой отказа на виртуальной машине убедитесь, что имя, которое будет назначено виртуальной машине Azure, соответствует [предварительным требованиям Azure](site-recovery-best-practices.md#azure-virtual-machine-requirements). После включения репликации для виртуальной машины это имя можно будет изменить.<br/><br/> Емкость одного диска на защищенных компьютерах не должна превышать 1023 ГБ. Для виртуальной машины можно настроить до 64 дисков (то есть до 64 ТБ).<br/><br/> Гостевые кластеры общих дисков не поддерживаются.<br/><br/> Если на исходной виртуальной машине настроено объединение сетевых карт, то после отработки отказа в Azure оно преобразуется в одну сетевую карту.<br/><br/> Защита виртуальных машин под управлением Linux со статическими IP-адресами не поддерживается.

## Подготовка к развертыванию

Чтобы подготовиться к развертыванию, потребуется следующее:

1. [Настроить сеть](#set-up-an-azure-network), в которой будут размещаться виртуальные машины Azure, созданные в результате отработки отказа.
2. [Настроить учетную запись хранения Azure](#set-up-an-azure-storage-account) для реплицированных данных.
3. [Подготовить узлы Hyper-V](#prepare-the-hyper-v-hosts), чтобы они могли обращаться к необходимым URL-адресам.

### Настройка сети Azure

Настройка сети Azure. К этой сети должны будут подключиться виртуальные машины Azure, созданные после отработки отказа.

- Сеть должна располагаться в том же регионе, в котором будет развернуто хранилище служб восстановления.
- В зависимости от модели ресурсов, которую нужно использовать для отработавших отказ виртуальных машин Azure, для сети Azure необходимо настроить [режим ARM](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) или [классический режим](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).
- Рекомендуется настроить сеть перед началом работы. В противном случае это нужно будет сделать во время развертывания службы Site Recovery.

> [AZURE.NOTE] [Migration of networks](../resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для сетей, используемых для развертывания Site Recovery.

### Настройка учетной записи хранения Azure

- Для хранения данных, реплицированных в Azure, понадобится стандартная учетная запись хранения Azure.
- В зависимости от модели ресурсов, которую нужно использовать для отработавших отказ виртуальных машин Azure, для учетной записи необходимо настроить [режим ARM](../storage/storage-create-storage-account.md) или [классический режим](../storage/storage-create-storage-account-classic-portal.md).
- Рекомендуется настроить учетную запись хранения до начала работы. В противном случае это нужно будет сделать во время развертывания службы Site Recovery. Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.

> [AZURE.NOTE] [Migration of storage accounts](../resource-group-move-resources.md) между группами ресурсов в рамках одной или нескольких подписок не поддерживается для учетных записей хранения, используемых для развертывания Site Recovery.

### Подготовка узлов Hyper-V

- Убедитесь, что узлы VMM соответствуют [предварительным требованиям](#on-premises-prerequisites).

### Создание хранилища служб восстановления

1. Выполните вход на [портал Azure](https://portal.azure.com).
2. Щелкните **Создать** > **Управление** > **Backup and Site Recovery (OMS)** (Служба архивации и Site Recovery (OMS)). Кроме того, можно щелкнуть **Обзор** > **Хранилища служб восстановления** > **Добавить**.

	![Новое хранилище](./media/site-recovery-hyper-v-site-to-azure/new-vault3.png)

3. В поле **Имя** укажите понятное имя для идентификации хранилища. Если у вас имеется несколько подписок, выберите одну из них.
4. [Создайте группу ресурсов](../resource-group-template-deploy-portal.md) или выберите уже имеющуюся и укажите регион Azure. В него будут реплицированы данные компьютеров. Чтобы проверить поддерживаемые регионы, см. географическую доступность в разделе [Azure Site Recovery Pricing Details](https://azure.microsoft.com/pricing/details/site-recovery/) (Информация о ценах на Azure Site Recovery).
4. Если нужно быстро получить доступ к хранилищу с панели мониторинга, установите флажок **Закрепить на панели мониторинга** и щелкните **Создать хранилище**.

	![Новое хранилище](./media/site-recovery-hyper-v-site-to-azure/new-vault-settings.png)

Новое хранилище появится в колонке **Панель мониторинга** > **Все ресурсы** и в основной колонке **Хранилища служб восстановления**.

## Приступая к работе

В Site Recovery предусмотрен механизм для начала работы, который позволяет выполнить развертывание как можно быстрее. Перед развертыванием проверяется соответствие предварительным требованиям. Кроме того, вы получаете указания для выполнения этапов развертывания в правильной последовательности.

Приступая к работе, необходимо выбрать тип компьютеров, которые требуется реплицировать, и место для репликации. Затем нужно настроить локальные серверы, учетные записи хранения Azure и сети. Кроме того, требуется создать политики репликации и выполнить планирование ресурсов. После настройки инфраструктуры включается репликация виртуальных машин. Можно выполнить отработку отказа для конкретных компьютеров или создать план восстановления для отработки отказа на нескольких компьютерах.

Сначала выберите способ развертывания Site Recovery. Начальные процедуры немного изменяются в зависимости от требований к репликации.



## Шаг 1. Выбор целевых объектов для защиты

Выберите целевые объекты и место для репликации.

1. В колонке **Хранилища служб восстановления** выберите хранилище и щелкните **Параметры**.
2. Выбрав **Параметры** > **Приступая к работе**, щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Цель защиты**.

	![Выбор цели](./media/site-recovery-hyper-v-site-to-azure/choose-goals.png)

3. На странице **Protection goal** (Цель защиты) выберите **To Azure** (В Azure) и **Yes, with Hyper-V** (Да, с помощью Hyper-V). Выберите **Нет**, чтобы подтвердить, что VMM не используется. Нажмите кнопку **ОК**.

	![Выбор цели](./media/site-recovery-hyper-v-site-to-azure/choose-goals2.png)


## Шаг 2. Настройка исходной среды

Настройте узел Hyper-V, установите поставщика Azure Site Recovery и агента служб восстановления Azure на узлах Hyper-V и зарегистрируйте узлы в хранилище.


1. Щелкните **Шаг 2. Подготовка инфраструктуры** > **Источник**. Чтобы добавить новый узел Hyper-V в качестве контейнера для узлов или кластеров Hyper-V, щелкните **+Hyper-V Site** (+ Сайт Hyper-V).

	![Настройка источника](./media/site-recovery-hyper-v-site-to-azure/set-source1.png)

2. В колонке **Создание сайта Hyper-V** укажите имя для сайта. Нажмите кнопку **ОК**. Выберите только что созданный сайт.

	![Настройка источника](./media/site-recovery-hyper-v-site-to-azure/set-source2.png)

3. Щелкните **+Hyper-V Server** (+ Hyper-V Server), чтобы добавить сервер на сайт.
4. Выбрав **Добавить сервер** > **Тип сервера**, убедитесь, что **Hyper-V Server** отображается. Убедитесь, что сервер Hyper-V Server, который вы хотите добавить, соответствует [предварительным требованиям](#on-premises-prerequisites) и имеет доступ к указанным URL-адресам.
4. Скачайте файл установки поставщика Azure Site Recovery. Запустите этот файл, чтобы установить поставщик и агент служб восстановления на каждый узел Hyper-V.
5. Скачайте ключ регистрации. Он потребуется при запуске программы установки. Ключ действителен в течение 5 дней после создания.

	![Настройка источника](./media/site-recovery-hyper-v-site-to-azure/set-source3.png)

6. Запустите файл установки поставщика на каждом узле, добавленном в узел Hyper-V. Если установка выполняется в кластер Hyper-V, программу установки необходимо запустить на каждом узле кластера. Установка и регистрация всех узлов кластера Hyper-V гарантирует, что виртуальные машины останутся защищенными даже в случае переноса между узлами.

### Установка поставщика и агента

1. Запустите файл установки поставщика.
2. На странице **Центр обновления Майкрософт** можно включить обновления, чтобы обновления поставщика устанавливались в соответствии с политикой Центра обновления Майкрософт.
3. На странице **Установка** примите или измените расположение установки поставщика по умолчанию и нажмите кнопку **Установить**.
4. На странице **Параметры хранилища** нажмите кнопку **Обзор**, чтобы выбрать скачанный файл ключа хранилища. Укажите подписку Azure Site Recovery, имя хранилища и узла Hyper-V, к которому относится сервер Hyper-V.

	![Регистрация сервера](./media/site-recovery-hyper-v-site-to-azure/provider3.png)

5\. На странице **Параметры прокси-сервера** укажите параметры Интернета для подключения к Azure Site Recovery поставщика, который будет установлен на сервере.

- Чтобы поставщик подключался напрямую, выберите **Connect directly without a proxy** (Прямое подключение без прокси-сервера).
- Чтобы подключаться с помощью прокси-сервера, который уже настроен на сервере, выберите **Connect with existing proxy settings** (Подключение с параметрами существующего прокси-сервера).
- Если для имеющегося прокси-сервера требуется аутентификация или для подключения поставщика нужно использовать пользовательский прокси-сервер, выберите **Connect with custom proxy settings** (Подключение с параметрами пользовательского прокси-сервера).
- При использовании пользовательского прокси-сервера необходимо указать адрес, порт и учетные данные.
- Если используется прокси-сервер, убедитесь, что он не блокирует URL-адреса, описанные в [предварительных требованиях](#on-premises-prerequisites).

	![Интернет](./media/site-recovery-hyper-v-site-to-azure/provider7.PNG)

6\. После завершения установки нажмите кнопку **Зарегистрировать**, чтобы зарегистрировать сервер в хранилище. ![Расположение установки](./media/site-recovery-hyper-v-site-to-azure/provider2.png)

7\. После завершения регистрации Azure Site Recovery извлекает метаданные с сервера Hyper-V Server, а сам сервер отображается в разделе **Параметры** > **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > колонка **Hyper-V Hosts** (Узлы Hyper-V).


### Установка из командной строки

Поставщик и агент Azure Site Recovery также можно установить с помощью приведенной ниже командной строки. Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.

1. Скачайте файл установки поставщика и ключ регистрации в папку. Например, C:\\ASR.
2. В командной строке с повышенными правами запустите следующие команды, чтобы извлечь установщик поставщика:

	    	C:\Windows\System32> CD C:\ASR
	    	C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q
3. Выполните следующую команду для установки компонентов:

			C:\ASR> setupdr.exe /i

4. Зарегистрируйте сервер в хранилище, выполнив следующие команды: CD C:\\Program Files\\Microsoft Azure Site Recovery Provider\\ C:\\Program Files\\Microsoft Azure Site Recovery Provider> DRConfigurator.exe /r /Friendlyname <понятное\_имя\_сервера> /Credentials <путь\_к\_файлу\_учетных\_данных>, где:

- **/Credentials**: обязательный параметр, который задает расположение ключа регистрации.
- **/FriendlyName**: обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.
- **/proxyAddress**: необязательный параметр, указывающий адрес прокси-сервера.
- **/proxyport**: необязательный параметр, указывающий порт прокси-сервера.
- **/proxyusername**: необязательный параметр, указывающий имя пользователя прокси-сервера (если прокси-сервер требует выполнения проверки подлинности).
- **/proxypassword**: необязательный параметр, который указывает пароль для проверки подлинности на прокси-сервере (если прокси-сервер требует выполнения проверки подлинности).


## Шаг 3. Настройка целевой среды

Укажите учетную запись хранения Azure для репликации и сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.

1.	Щелкните **Подготовка инфраструктуры** > **Цель** и выберите требуемую подписку Azure.
2.	Укажите модель развертывания, которая будет использоваться для виртуальных машин после отработки отказа.
3.	Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

	![Хранилище](./media/site-recovery-hyper-v-site-to-azure/select-target.png)

4.	Если учетная запись хранения еще не создана и ее нужно создать с помощью ARM, щелкните **+Storage account** (+ Учетная запись хранения). В колонке **Создание учетной записи хранения** укажите имя, тип, подписку и расположение учетной записи. Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.

	![Хранилище](./media/site-recovery-hyper-v-site-to-azure/gs-createstorage.png)

	Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать [на портале Azure](../storage/storage-create-storage-account-classic-portal.md).
	
5.	Если сеть Azure еще не создана и ее нужно создать с помощью ARM, щелкните **+Network** (+ Сеть), чтобы сделать это в процессе настройки. В колонке **Создание виртуальной сети** укажите имя, диапазон адресов, сведения о подсетях, подписку и расположение сети. Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.

	![Сеть](./media/site-recovery-hyper-v-site-to-azure/gs-createnetwork.png)

	Если нужно создать сеть, используя классическую модель, это можно сделать [на портале Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).
	

## Этап 4. Настройка параметров репликации

1. Чтобы создать политику репликации, последовательно выберите **Подготовка инфраструктуры** > **Параметры репликации** > **+Create and associate** (+Создание и сопоставление).

	![Сеть](./media/site-recovery-hyper-v-site-to-azure/gs-replication.png)

2. На странице **Создать и связать политику** укажите имя политики.
3. В раскрывающемся списке **Частота копирования** выберите периодичность репликации изменений данных после начальной репликации (каждые 30 секунд, 5 или 15 минут).
4. В поле **Хранение точки восстановления** укажите продолжительность периода хранения для каждой точки восстановления (в часах). Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
6. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, как часто будут создаваться точки восстановления, содержащие моментальные снимки, согласованные с приложениями (от 1 до 12 часов). Hyper-V использует два типа резервного копирования: стандартное резервное копирование, обеспечивающее создание добавочных резервных копий всей виртуальной машины, и соответствующие приложению моментальные снимки, обеспечивающие создание моментального снимка данных приложений в виртуальной машине на момент времени. Функция моментальных снимков, соответствующих приложению, использует службу теневого копирования томов (VSS), чтобы гарантировать согласованное состояние приложений на момент создания снимка. Примечание. Включение моментальных снимков, соответствующих приложению, влияет на производительность приложений, выполняющихся на исходных виртуальных машинах. Заданное значение должно быть меньше числа настроенных дополнительных точек восстановления.
3. В поле **Время запуска начальной репликации** укажите, когда должна запускаться начальная репликация. При репликации используется полоса пропускания Интернета. Поэтому проведение репликации нужно запланировать на свободное от работы время. Нажмите кнопку **ОК**.

	![Политика репликации](./media/site-recovery-hyper-v-site-to-azure/gs-replication2.png)

При создании политики она автоматически сопоставляется с сайтом Hyper-V. Нажмите кнопку **ОК**. Узел Hyper-V (и входящие в него виртуальные машины) можно связать с несколькими политиками репликации, последовательно выбрав пункты **Параметры** > **Репликация** > имя политики > **Связать узел Hyper-V**.

## Шаг 5. Планирование ресурсов

Теперь после настройки базовой инфраструктуры можно начать планирование ресурсов и выяснить, нужны ли дополнительные ресурсы.

Site Recovery предоставляет планировщик ресурсов, который поможет выделить нужные ресурсы для исходной среды, компонентов Site Recovery, сети и хранилища. Планировщик можно запустить в быстром режиме, чтобы получить оценку на основе среднего числа виртуальных машин и дисков, а также среднего объема хранилища, или в подробном режиме, в котором необходимо вводить показатели на уровне рабочей нагрузки. Прежде всего необходимо сделать следующее:

- Соберите сведения о среде репликации, включая информацию о виртуальных машинах, количестве дисков на виртуальную машину и объеме хранилища на диск.
- Определите частоту ежедневных изменений (обновлений) реплицированных данных. Для этого можно воспользоваться [планировщиком ресурсов для реплики Hyper-V](https://www.microsoft.com/download/details.aspx?id=39057).

1.	Щелкните ссылку **Скачать**, чтобы скачать этот инструмент, и запустите его. Сведения о планировщике ресурсов см. в [этой статье](site-recovery-capacity-planner.md).
2.	После этого выберите **Да** в поле **Have you run the Capacity Planner?** (Вы запустили планировщик ресурсов?).

	![Планирование загрузки](./media/site-recovery-hyper-v-site-to-azure/gs-capacity-planning.png)

### Рекомендации по пропускной способности сети

С помощью планировщика ресурсов можно рассчитать пропускную способность, необходимую для репликации (начальная и разностная репликации данных). Существует несколько вариантов управления объемом пропускной способности, используемой для репликации:

- **Регулирование пропускной способности**. Трафик Hyper-V, который реплицируется в Azure, проходит через определенный узел Hyper-V. Пропускную способность можно регулировать на сервере этого узла.
- **Настройка пропускной способности**. Пропускную способность, используемую для репликации, можно изменить с помощью нескольких разделов реестра.

#### Регулирование пропускной способности

1. Откройте на сервере узла Hyper-V оснастку MMC в службе архивации Microsoft Azure. По умолчанию ярлык для службы архивации Microsoft Azure доступен на рабочем столе или в папке C:\\Program Files\\Microsoft Azure Recovery Services Agent\\bin\\wabadmin.
2. В оснастке щелкните **Изменить свойства**.
3. На вкладке **Регулирование** установите флажок **Разрешить регулирование уровня использования пропускной способности интернет-канала для операций архивации** и задайте ограничения для рабочего и нерабочего времени. Допустимы значения в диапазоне от 512 Кбит/с до 102 Мбит/с.

	![Регулирование пропускной способности](./media/site-recovery-hyper-v-site-to-azure/throttle2.png)

Чтобы настроить регулирование, можно также использовать командлет [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409.aspx). Рассмотрим пример:

    $mon = [System.DayOfWeek]::Monday 
    $tue = [System.DayOfWeek]::Tuesday
    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth  (512*1024) -NonWorkHourBandwidth (2048*1024)

**Set-OBMachineSetting -NoThrottle** указывает, что регулирование не требуется.


#### Изменение пропускной способности сети

1. В реестре перейдите в раздел **HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows Azure Backup\\Replication**.
	- Чтобы изменить скорость передачи данных при репликации диска, задайте новое значение для раздела **UploadThreadsPerVM** или создайте его, если он еще не существует.
	- Чтобы изменить скорость передачи данных при восстановлении размещения из Azure, задайте новое значение для раздела **DownloadThreadsPerVM**.
2. Значение по умолчанию — 4. В сети со значительным избыточным резервом для этих разделов реестра необходимо изменить значения по умолчанию. Максимальное значение — 32. Следите за трафиком для оптимизации значения.

## Шаг 6. Включение репликации

Включите репликацию следующим образом:

1. Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**. Включив репликацию впервые, щелкните **+Replicate** (+ Реплицировать) в хранилище, чтобы включить репликацию для дополнительных компьютеров.

	![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication.png)

2. В колонке **Источник** выберите сайт Hyper-V. Нажмите кнопку **ОК**.
3. В поле **Целевой объект** выберите подписку хранилища и модель отработки отказа (классическую или с управлением ресурсами), которую следует использовать в Azure после отработки отказа.
4. Выберите учетную запись хранения, которую нужно использовать. Если вам нужна другая учетная запись хранения, [создайте ее](#set-up-an-azure-storage-account). Чтобы создать учетную запись хранения с использованием модели ARM, щелкните **Создать**. Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать [на портале Azure](../storage/storage-create-storage-account-classic-portal.md). Нажмите кнопку **ОК**.
5.  Выберите сеть и подсеть Azure, к которой будут подключаться развернутые виртуальные машины Azure после отработки отказа. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети для всех защищаемых компьютеров. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера. Если требуется использовать другую сеть, [создайте ее](#set-up-an-azure-network). Чтобы создать сеть, используя модель ARM, щелкните **Создать**. Если нужно создать сеть, используя классическую модель, это можно сделать [на портале Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md). Выберите подсеть (если это применимо). Нажмите кнопку **ОК**.

	![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication11.png)

6. Щелкнув **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждый компьютер, который нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.

	![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication5.png)

11. Щелкнув **Свойства** > **Настройка свойств**, выберите операционную систему для выбранных виртуальных машин и диск операционной системы. Убедитесь, что имя виртуальной машины Azure (имя целевого объекта) соответствует [требованиям к виртуальной машине Azure](site-recovery-best-practices.md#azure-virtual-machine-requirements), и измените его, если нужно. Нажмите кнопку **ОК**. Позже можно задать дополнительные свойства.

	![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication6.png)

12. Щелкнув **Параметры репликации** > **Настройка параметров репликации**, выберите политику репликации, которую необходимо применить к защищенным виртуальным машинам. Нажмите кнопку **ОК**. Политику репликации можно изменить, последовательно выбрав **Параметры** > **Политики репликации** > имя политики > **Изменить параметры**. Изменения будут применяться к компьютерам, для которых уже выполняется репликация, и к новым компьютерам.

	![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication7.png)

Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Site Recovery jobs** (Задания Site Recovery). После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

### Просмотр свойств виртуальной машины и управление ими

Рекомендуется проверить свойства исходного компьютера.

1. Щелкните **Параметры** > **Защищенные элементы** > **Реплицированные элементы** и выберите компьютер.

	![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/test-failover1.png)

2. На странице **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.

	![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/test-failover2.png)

3. Выбрав **Вычисления и сеть** > **Свойства вычислений**, можно указать имя и целевой размер виртуальной машины Azure. При необходимости измените имя в соответствии с требованиями Azure. Кроме того, можно просмотреть и изменить сведения о целевой сети, подсети и целевом IP-адресе, который будет назначен виртуальной машине Azure. Обратите внимание на следующее.

	- Вы можете задать целевой IP-адрес. Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP. Если задать адрес, недоступный при отработке отказа, произойдет сбой. Этот же целевой IP-адрес можно использовать для тестовой отработки отказа, если он доступен в сети тестовой отработки отказа.
	- Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины:

		- Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
		- Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использовать максимальный размер целевой машины.
		- Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, то на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.
		- Если для виртуальной машины настроено несколько сетевых адаптеров, они будут подключены к одной сети.

	![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/test-failover4.png)

5.	На странице **Диски** отображаются сведения о дисках ОС и дисках данных на виртуальной машине, для которой будет выполняться репликация.


## Шаг 7. Тестирование развертывания

Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины или создать план восстановления для одной или нескольких виртуальных машин.


### Подготовка к тестовой отработке отказа

- Для запуска тестовой отработки отказа рекомендуется создать сеть Azure, изолированную от рабочей среды Azure (обычная практика при создании сети в Azure). [Узнайте больше](site-recovery-failover.md#run-a-test-failover) о выполнении тестовой отработки отказа.
- Для оптимальной производительности при отработке отказа в Azure установите агент Azure на защищенном компьютере. Это ускоряет загрузку и помогает устранять неполадки. Установите агент [Linux](https://github.com/Azure/WALinuxAgent) или [Windows](http://go.microsoft.com/fwlink/?LinkID=394789).
- Для полного тестирования развертывания требуется, чтобы инфраструктура для реплицируемого компьютера работала должным образом. Если нужно протестировать Active Directory и DNS, можно создать виртуальную машину в качестве контроллера домена с помощью DNS и реплицировать ее в Azure с помощью службы Azure Site Recovery. Узнайте больше о [рекомендациях по тестированию отработки отказа для Active Directory](site-recovery-active-directory.md#considerations-for-test-failover).
- Если нужно выполнить внеплановую отработку отказа вместо тестовой, обратите внимание на следующее:

	- По возможности перед выполнением внеплановой отработки отказа следует выключить основные компьютеры. В этом случае исходные и реплицированные компьютеры не будут работать одновременно.
	- При выполнении внеплановой отработки отказа репликация данных с основных компьютеров прекращается. Поэтому после начала внеплановой отработки отказа все изменения в данных не будут передаваться. Кроме того, при выполнении внеплановой отработки отказа в рамках плана восстановления она завершится даже в случае ошибки.
	
### Подготовка к подключению виртуальных машин Azure после отработки отказа

Если после отработки отказа нужно подключиться к виртуальным машинам Azure по протоколу удаленного рабочего стола, обязательно сделайте следующее:

**На локальном компьютере до отработки отказа**.

- Чтобы получить доступ через Интернет, включите протокол RDP. Убедитесь, что правила TCP и UDP добавлены в разделе **Общее** и что RDP разрешен в разделе **Брандмауэр Windows** > **Разрешенные программы и компоненты** для всех профилей.
- Чтобы получить доступ через подключение типа "сеть — сеть", включите протокол RDP на компьютере. Убедитесь, что RDP разрешен в разделе **Брандмауэр Windows** > **Разрешенные программы и компоненты** для сетей **домена** и **частных** сетей.
- Установите [агент виртуальной машины Azure](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) на локальном компьютере.
- Задайте для политики сети SAN операционной системы значение OnlineAll. [Подробнее](https://support.microsoft.com/kb/3031135)
- Отключите службу IPSec перед выполнением отработки отказа.

**На виртуальной машине Azure после отработки отказа**.

- Добавьте общедоступный IP-адрес для сетевой карты, связанной с виртуальной машиной Azure, чтобы разрешить использование RDP.
- Убедитесь в отсутствии политик домена, которые не допускают подключение к виртуальной машине с использованием общедоступного адреса.
- Попытайтесь подключиться. Если вам не удалось это сделать, убедитесь, что виртуальная машина запущена. Дополнительные советы по устранению неполадок см. в этой [статье](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

Если после отработки отказа нужно получить доступ к виртуальной машине Azure под управлением Linux с помощью клиента SSH, выполните следующее:

**На локальном компьютере до отработки отказа**.

- Настройте автоматический запуск службы SSH на виртуальной машине Azure при загрузке системы (если он еще не настроен).
- Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.

**На виртуальной машине Azure после отработки отказа**.

- Правила группы сетевой безопасности на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения на порт SSH.
- Чтобы разрешить входящие подключения на порт SSH (TCP-порт 22 по умолчанию), необходимо создать общедоступную конечную точку.
- Если доступ к виртуальной машине осуществляется через VPN-подключение (Express Route или VPN типа "сеть — сеть"), можно использовать клиент для прямого подключения к виртуальной машине по протоколу SSH.

### Запуск тестовой отработки отказа

Для запуска тестовой отработки отказа сделайте вот что:

1. Чтобы выполнить отработку отказа для одной виртуальной машины, в разделе **Параметры** > **Реплицированные элементы** щелкните виртуальную машину и **+Test Failover** (+Тестовая отработка отказа).

	![Тестовая отработка отказа](./media/site-recovery-hyper-v-site-to-azure/run-failover1.png)

2. Чтобы выполнить отработку отказа по плану восстановления, в разделе **Параметры** > **Планы восстановления** щелкните план правой кнопкой мыши и выберите **Тестовая отработка отказа**. Чтобы создать план восстановления, [выполните эти инструкции](site-recovery-create-recovery-plans.md).

3. На странице **Тестовая отработка отказа** выберите сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.

	![Тестовая отработка отказа](./media/site-recovery-hyper-v-site-to-azure/run-failover2.png)

4. Нажмите кнопку **ОК**, чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину, или в задании **тестовой отработки отказа**, выбрав **Параметры** > **Site Recovery jobs** (Задания Site Recovery).
5. Когда отработка отказа достигнет этапа **Полное тестирование**, выполните следующие действия.
	1. Просмотрите реплику виртуальной машины на портале Azure. Проверьте, успешно ли выполнен запуск виртуальной машины.
	2. Если настройки предусматривают доступ к виртуальным машинам из локальной сети, можно инициировать подключение протокола удаленного рабочего стола к виртуальной машине.
	3. Щелкните **Завершить проверку** для завершения действия.
	4. Щелкните элемент **Примечания** для регистрации и сохранения любых наблюдений, связанных с тестовой отработкой отказа.
	5. Щелкните пункт **Тестовая отработка отказа завершена**. Проведите очистку тестовой среды, чтобы автоматически отключить питание и удалить тестовую виртуальную машину.
	6. На этом этапе элементы или виртуальные машины, автоматически созданные Site Recovery во время тестовой отработки отказа, удаляются. Дополнительные элементы, созданные для тестовой отработки отказа, не удаляются.
	
	> [AZURE.NOTE] Если отработка отказа выполняется более двух недель, она завершается принудительно.

6. После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в области **Виртуальные машины**. Следует убедиться, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
7. Если вы заранее [подготовились к подключению после отработки отказа](#prepare-to-connect-to-Azure-VMs-after-failover), то сможете подключиться к виртуальной машине Azure.


## Мониторинг развертывания

Вот как можно отслеживать параметры конфигурации, состояние и работоспособность развертывания Site Recovery:

1. Щелкните имя хранилища, чтобы открыть панель мониторинга **Основные компоненты**. На этой панели мониторинга можно просмотреть сведения о заданиях Site Recovery, состоянии репликации, планах восстановления, работоспособности сервера и событиях. Эту панель можно настроить таким образом, чтобы на ней отображались самые необходимые элементы и макеты, а также сведения о состоянии других хранилищ Site Recovery и службы архивации.

	![Основные компоненты](./media/site-recovery-hyper-v-site-to-azure/essentials.png)

2. В элементе **Работоспособность** можно следить за серверами сайта, в которых возникают ошибки, а также за событиями, которые произошли в Site Recovery за последние 24 часа.
3. Мониторинг репликации и управление ею можно осуществлять в элементах **Реплицированные элементы**, **Планы восстановления** и **Site Recovery Jobs** (Задания Site Recovery). Подробные сведения о заданиях можно просмотреть, выбрав **Параметры** > **Задания** > **Site Recovery Jobs** (Задания Site Recovery).





## Дальнейшие действия

Настроив и запустив развертывание, вы можете ознакомиться с [дополнительными сведениями](site-recovery-failover.md) о различных типах обработки отказа.

<!---HONumber=AcomDC_0921_2016-->