<properties
   pageTitle="Дисковое шифрование Azure для виртуальных машин IaaS под управлением Windows и Linux | Microsoft Azure"
   description="В этом документе описано дисковое шифрование Microsoft Azure для виртуальных машин IaaS под управлением Windows и Linux."
   services="security"
   documentationCenter="na"
   authors="YuriDio"
   manager="swadhwa"
   editor="TomSh"/>

<tags
   ms.service="security"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="09/20/2016"
   ms.author="devtiw"/>


#Дисковое шифрование Azure для виртуальных машин IaaS под управлением Windows и Linux

Microsoft Azure обеспечивает конфиденциальность и независимость ваших данных всеми возможными способами. К данным, размещенным в Azure, можно применять целый ряд современных технологий для шифрования данных, контроля ключей шифрования и управления ими, а также контроля и аудита доступа к данным. Благодаря этому клиенты Azure получают гибкость в выборе решения, которое лучше всего соответствует потребностям их компании. В этом документе описывается новое технологическое решение «Дисковое шифрование Azure для виртуальных машин IaaS под управлением Windows и Linux», которое защитит ваши данные в соответствии с корпоративными критериями безопасности и соответствия. Этот документ содержит подробные инструкции по использованию возможностей дискового шифрования Azure, а также описывает поддерживаемые сценарии и взаимодействие с пользователем.

**ПРИМЕЧАНИЕ.** Выполнение некоторых рекомендаций из этого документа может привести к более интенсивному использованию хранилища, сетевых или вычислительных ресурсов, а следовательно к дополнительным затратам на лицензии или подписки.

## Обзор

Дисковое шифрование Azure позволяет зашифровать диски виртуальных машин IaaS под управлением Windows и Linux. Дисковое шифрование Azure использует стандартные для отрасли функции — [BitLocker](https://technet.microsoft.com/library/cc732774.aspx) в Windows и [DM-Crypt](https://en.wikipedia.org/wiki/Dm-crypt) в Linux, — которые обеспечивают шифрование томов для системных дисков и дисков данных. Это решение интегрировано с [хранилищем ключей Azure](https://azure.microsoft.com/documentation/services/key-vault/), то есть позволяет управлять ключами и секретами дискового шифрования через подписку хранилища ключей. Шифрование выполняется для всех данных на дисках виртуальных машин в хранилище Azure.

> [AZURE.NOTE] В данный момент шифрование дисков Azure для виртуальных машин IaaS под управлением Windows [общедоступно](https://blogs.msdn.microsoft.com/azuresecurity/2016/05/20/azure-disk-encryption-for-windows-virtual-machines-reaches-general-availability/).

### Сценарии шифрования

Шифрование дисков Azure поддерживает следующие сценарии взаимодействия с клиентом:

- включение шифрования для новых виртуальных машин IaaS, при создании которых используются предварительно зашифрованные виртуальные жесткие диски и ключи шифрования;
- включение шифрования для новых виртуальных машин IaaS, созданных из коллекции образов Azure;
- включение шифрования для существующих виртуальных машин IaaS, которые уже работают в Azure.
- отключение шифрования на виртуальных машинах IaaS под управлением Windows.

Когда решение появляется в Microsoft Azure, оно поддерживает следующие возможности для виртуальных машин IaaS:

- интеграция с хранилищем ключей Azure;

- [виртуальные машины IaaS серий A, D и G](https://azure.microsoft.com/pricing/details/virtual-machines/) категории "Стандартный";

- включение шифрования для виртуальных машин IaaS под управлением Windows и Linux;

- отключение шифрования на виртуальных машинах IaaS под управлением Windows;

- включение шифрования на виртуальных машинах IaaS под управлением клиентской ОС Windows;

- включение шифрования для томов с путями подключения.

- Все общедоступные регионы Azure поддерживаются в общедоступной предварительной версии, а регион Австралии поддерживается в общедоступной версии для виртуальных машин IaaS под управлением Windows

В выпуске решения не поддерживаются следующие сценарии, функции и технологии:

- виртуальные машины категории «Базовый» и виртуальные машины IaaS серии DS класса «Стандартный» (хранилище класса Premium);

- виртуальные машины IaaS, созданные с использованием классического метода создания VM;

- включение шифрования диска ОС на виртуальных машинах IaaS под управлением Linux, которые уже работают в Azure;

- отключение шифрования на виртуальной машине IaaS под управлением Linux, включенного с помощью шифрования дисков Azure;

- интеграция с локальной службой управления ключами;

- Windows Server 2016 Technical Preview 3 и более поздних версий;

- файлы Azure (файловый ресурс Azure), сетевая файловая система (NFS), динамические тома, программные системы RAID.


### Функции шифрования

Когда вы включите и развернете дисковое шифрование Azure для виртуальных машин IaaS Azure, в зависимости от конфигурации решения будут доступны следующие возможности:

- шифрование тома операционной системы для защиты загрузочного тома, размещенного в хранилище клиента;

	- шифрование тома операционной системы на виртуальной машине IaaS под управлением Linux, которая уже работает в Azure, в настоящее время не поддерживается; Шифрование тома операционной системы для виртуальной машины IaaS под управлением Linux поддерживается только для сценария предварительно зашифрованного виртуального жесткого диска.)
	
- шифрование томов данных для защиты данных, размещенных в хранилище клиента;

- отключение шифрования на виртуальных машинах IaaS под управлением Windows;

- защита ключей шифрования и секретов в клиентской подписке хранилища ключей Azure;

- информирование о состоянии шифрования зашифрованных виртуальных машин IaaS;

- удаление настроек дискового шифрования из виртуальной машины IaaS.

Дисковое шифрование Azure для виртуальных машин IaaS Windows и Linux предлагается в виде комплексного решения, которое включает расширение дискового шифрования для Windows, расширение дискового шифрования для Linux, командлеты PowerShell для дискового шифрования, командлеты CLI для дискового шифрования и шаблоны диспетчера ресурсов Azure для дискового шифрования. Решение дискового шифрования Azure поддерживается на виртуальных машинах IaaS под управлением ОС Windows или Linux. Дополнительные сведения о поддерживаемых операционных системах приведены ниже в разделе предварительных условий.

**Примечание**. Плата за шифрование дисков Azure для виртуальных машин не взимается.

### Предлагаемые преимущества

Решение управления дисковым шифрованием Azure позволяет решать в облаке следующие задачи:

-   При хранении виртуальные машины IaaS защищаются с помощью стандартных отраслевых технологий шифрования, которые отвечают корпоративным требованиям безопасности и соответствия.

-   Загрузка виртуальных машин IaaS выполняется в соответствии с ключами и политиками, которыми управляет клиент. Можно также проводить аудит их использования в хранилище ключей.


### Рабочий процесс шифрования
Далее описаны основные шаги, которые нужно выполнить, чтобы включить дисковое шифрование для VM под управлением Windows и Linux.

1. Клиент выбирает один из трех сценариев шифрования, перечисленных выше.

2. С помощью шаблона ARM дискового шифрования Azure, командлетов PS или команд CLI клиент соглашается на включение дискового шифрования, а также указывает настройки шифрования.

    - Если клиент выбрал сценарий зашифрованного виртуального жесткого диска, он передает зашифрованный виртуальный жесткий диск в свою учетную запись хранения, а ключи шифрования — в хранилище ключей. Также он указывает настройки шифрования, чтобы включить шифрование на новой виртуальной машине IaaS.

    - Если клиент создает виртуальную машину из коллекции Azure или использует существующую виртуальную машину, которая уже работает в Azure, он указывает настройки шифрования, чтобы включить шифрование на виртуальной машине IaaS.

3. Клиент предоставляет платформе Azure доступ на чтение материала ключа (ключи шифрования BitLocker для среды Windows или парольная фраза для Linux) из хранилища ключей, чтобы включить шифрование виртуальной машины IaaS.

4. Чтобы включить шифрование на VM IaaS в описанных выше сценариях 2 и 3, клиент предоставляет Azure AD идентификатор, который используется для записи материала ключа в хранилище ключей.

5.  Управление службами Azure заносит в модель службы виртуальной машины информацию о шифровании и конфигурации хранилища ключей, а затем подготавливает для клиента зашифрованную виртуальную машину.

![Антивредоносное ПО Майкрософт в Azure](./media/azure-security-disk-encryption/disk-encryption-fig1.JPG)

### Рабочий процесс расшифровки

Далее описаны основные шаги, которые нужно выполнить, чтобы отключить шифрование дисков ВМ под управлением Windows.

1. Клиент должен выбрать метод отключения шифрования (расшифровки) на виртуальной машине IaaS под управлением Windows, работающей в Azure (при помощи шаблона ARM для шифрования дисков Azure или командлетов PS), и задать конфигурацию расшифровки.

2. Этап отключения шифрования поддерживается только на виртуальных машинах IaaS под управлением Windows и не поддерживается на виртуальных машинах IaaS под управлением Linux.

3. На этом этапе для работающей виртуальной машины IaaS под управлением Windows отключается шифрование операционной системы и/или тома данных.

4. Управление службами Azure обновляет модель службы виртуальной машины, и виртуальная машина IaaS под управлением Windows помечается как расшифрованная. Содержимое виртуальной машины больше не шифруется при хранении.

5. При отключении шифрования не удаляется хранилище ключей клиента и материал ключа шифрования (ключи шифрования BitLocker для Windows и парольная фраза для Linux).

## Предварительные требования

Ниже перечислены обязательные условия для включения дискового шифрования Azure на виртуальных машинах Azure IaaS в соответствии со сценариями, перечисленными в разделе общих сведений.

- Необходима действующая подписка Azure, которая позволяет создавать ресурсы Azure в поддерживаемых регионах.

- Дисковое шифрование Azure доступно для следующих SKU Windows Server: Windows Server 2008 R2, Windows Server 2012, Windows Server 2012 R2. Операционная система Windows Server 2008 не поддерживает это решение. В этом выпуске не поддерживается Windows Server 2016 Technical Preview 3.

Шифрование диска Azure поддерживается в клиентах Windows SKU для Windows 8 и Windows 10.

**Примечание.** Прежде чем включать шифрование Azure для Windows Server 2008 R2, НЕОБХОДИМО установить .NET Framework 4.5. Для этого установите необязательное обновление "Microsoft .NET Framework 4.5.2 для Windows Server 2008 R2 для 64-разрядных систем ([KB2901983](https://support.microsoft.com/kb/2901983))" из Центра обновления Windows.

- Шифрование дисков Azure доступно для следующих SKU Linux: Ubuntu, CentOS, SUSE, SUSE Linux Enterprise Server (SLES) и Red Hat Enterprise Linux.

- Все ресурсы (хранилище ключей, учетная запись хранения, виртуальная машина, виртуальная сеть и т. д.) должны относиться к одному региону и одной подписке Azure.

**Примечание**. Дисковое шифрование Azure требует, чтобы хранилище ключей и виртуальные машины находились в одном регионе Azure. Их настройка в отдельных регионах приведет к ошибкам при включении функции дискового шифрования Azure.

- Сведения об установке и настройке хранилища ключей Azure для использования шифрования дисков Azure см. в подразделе **Подключение и настройка хранилища ключей Azure для дискового шифрования Azure** раздела *Предварительные требования* этой статьи.

- Сведения об установке и настройке приложения Azure AD в Azure Active Directory для использования шифрования дисков Azure см. в подразделе **Настройка приложения Azure AD в Azure Active Directory** раздела *Предварительные требования* этой статьи.

- Сведения об установке и настройке политики доступа к хранилищу ключей для приложения Azure AD см. в подразделе **Настройка политики доступа к хранилищу ключей для приложения Azure AD** раздела *Предварительные требования* этой статьи.

- Сведения о подготовке предварительно зашифрованного виртуального жесткого диска Windows см. в разделе **Подготовка предварительно зашифрованного виртуального жесткого диска Windows** приложения к этой статье.

- Сведения о подготовке предварительно зашифрованного виртуального жесткого диска Linux см. в разделе **Подготовка предварительно зашифрованного виртуального жесткого диска Linux** приложения к этой статье.

- Платформа Azure должна иметь доступ к ключам шифрования или секретам, которые расположены в клиентском хранилище ключей Azure. Это необходимо для загрузки и расшифровки тома ОС виртуальной машины. Чтобы предоставить платформе Azure разрешения на доступ к хранилищу ключей, установите свойство **enabledForDiskEncryption** для хранилища ключей. Дополнительные сведения см. в разделе **Подключение и настройка хранилища ключей Azure для дискового шифрования Azure** приложения к этой статье.

- Для URL-адресов секрета и ключа шифрования ключа (KEK) хранилища ключей необходимо включить управление версиями. Это требование управления службами Azure. Ниже приведены примеры допустимых URL-адресов секрета и KEK.

	- Пример допустимого URL-адреса секрета:

		*https://contosovault.vault.azure.net/secrets/BitLockerEncryptionSecretWithKek/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*

	- Пример допустимого URL-адреса KEK:

		*https://contosovault.vault.azure.net/keys/diskencryptionkek/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*

- Шифрование диска Azure не поддерживает указание номеров портов в URL-адресах секрета и KEK хранилища ключей. Ниже приведены примеры поддерживаемых URL-адресов хранилища ключей.

 	- Недопустимый URL-адрес хранилища ключей:

		*https://contosovault.vault.azure.net:443/secrets/contososecret/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*

	- Допустимый URL-адрес хранилища ключей:

		*https://contosovault.vault.azure.net/secrets/contososecret/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*

- Чтобы использовать функцию дискового шифрования Azure, конфигурация конечной точки VM IaaS должна соответствовать следующим требованиям:

	- Виртуальная машина IaaS должна иметь возможность подключиться к конечной точке Azure Active Directory [Login.windows.net], чтобы получить токен для подключения к хранилищу ключей Azure.

	- Виртуальная машина IaaS должна иметь возможность подключиться к конечной точке хранилища ключей Azure, чтобы записать ключи шифрования в хранилище ключей клиента.

	- Виртуальная машина IaaS должна иметь возможность подключиться к конечной точке хранилища Azure, в котором размещен репозиторий расширений Azure, и к учетной записи хранения Azure, в которой размещены файлы виртуального жесткого диска.

**Примечание.** Если ваша политика безопасности ограничивает доступ к Интернету из виртуальных машин Azure, можно разрешить указанный выше URI, с которым требуется взаимодействовать, и настроить определенное правило, чтобы разрешить исходящие подключения к данным IP-адресам.

- Для настройки шифрования диска Azure используйте последнюю версию пакета SDK для Azure PowerShell. Скачайте [Azure PowerShell 1.3.0](https://github.com/Azure/azure-powershell/releases/download/v1.3.0-March2016/azure-powershell.1.3.0.msi) или более поздней версии.

**Примечание**. Шифрование дисков Azure не поддерживается в [пакете SDK для Azure PowerShell версии 1.1.0](https://github.com/Azure/azure-powershell/releases/tag/v1.1.0-January2016). При возникновении ошибок, связанных с использованием Azure PowerShell 1.1.0, ознакомьтесь с записью блога [Azure Disk Encryption Error Related to Azure PowerShell 1.1.0](http://blogs.msdn.com/b/azuresecurity/archive/2016/02/10/azure-disk-encryption-error-related-to-azure-powershell-1-1-0.aspx) (Ошибки шифрования дисков Azure, связанные с Azure PowerShell 1.1.0).

- Чтобы запустить какую-либо команду Azure CLI и связать ее с подпиской Azure, необходимо установить версию Azure CLI.

	- Чтобы установить интерфейс Azure CLI и связать его с подпиской Azure, см. статью [Установка и настройка Azure CLI](../xplat-cli-install.md).

	- Использование Azure CLI для Mac, Linux и Windows с диспетчером ресурсов Azure описано [здесь](azure-cli-arm-commands.md).

- Решение дискового шифрования Azure использует предохранитель внешнего ключа BitLocker для виртуальных машин IaaS под управлением Windows. Если ваши виртуальные машины объединены в домен, не применяйте групповые политики, требующие использования предохранителей TPM. Изучите [эту статью](https://technet.microsoft.com/library/ee706521), чтобы узнать о групповой политике "Разрешить использование BitLocker без совместимого TPM".

- Чтобы создать приложение Azure AD, создать новое хранилище ключей или настроить существующее, а также включить шифрование, требуется сценарий PowerShell для шифрования дисков Azure, который находится [здесь](https://github.com/Azure/azure-powershell/blob/dev/src/ResourceManager/Compute/Commands.Compute/Extension/AzureDiskEncryption/Scripts/AzureDiskEncryptionPreRequisiteSetup.ps1).

### Подключение и настройка хранилища ключей Azure для дискового шифрования Azure

Дисковое шифрование Azure хранит ключи дискового шифрования и секреты в вашем хранилище ключей Azure. Выполните действия, указанные в каждом из разделов ниже, чтобы настроить хранилище ключей для использования с дисковым шифрованием Azure.

#### Создание нового хранилища ключей
Это можно сделать одним из двух способов:

- Используйте шаблон ARM 101-Create-KeyVault, размещенный [здесь](https://github.com/Azure/azure-quickstart-templates/blob/master/101-create-key-vault/azuredeploy.json).
- Используйте командлеты PowerShell хранилища ключей Azure.

**Примечание.** Если для вашей подписки уже настроено хранилище ключей, перейдите к следующему разделу.

#### Подготовка ключа шифрования ключа (необязательно)

Если вы хотите использовать ключ шифрования ключа (KEK), добавьте в хранилище ключей KEK, который будет использован в процессе подготовки. KEK используется как оболочка для ключей шифрования BitLocker, дополнительно повышающая безопасность. Используйте командлет [Add-AzureKeyVaultKey](https://msdn.microsoft.com/library/dn868048.aspx), чтобы создать новый ключ шифрования ключа в хранилище ключей. Дополнительные сведения см. в [документации по хранилищу ключей](https://azure.microsoft.com/documentation/services/key-vault/).

    Add-AzureKeyVaultKey [-VaultName] <string> [-Name] <string> -Destination <string> {HSM | Software}

#### Настройка разрешений для хранилища ключей, предоставляющих платформе Azure доступ к ключам и секретам

Платформа Azure должна иметь доступ к ключам шифрования или секретам, которые расположены в хранилище ключей Azure. Это необходимо для загрузки и расшифровки томов виртуальной машины. Чтобы предоставить платформе Azure доступ к хранилищу ключей, задайте свойство *enabledForDiskEncryption* для хранилища ключей. Это можно сделать с помощью командлета PS хранилища ключей:

    Set-AzureRmKeyVaultAccessPolicy -VaultName <yourVaultName> -ResourceGroupName <yourResourceGroup> -EnabledForDiskEncryption

Для хранилища ключей следует задать свойство *enabledForDiskEncryption*, как указано выше. Для этого можно посетить страницу https://resources.azure.com. Убедитесь, что описанные выше свойства заданы правильно, иначе развертывание завершится ошибкой.

#### Настройка приложения Azure AD в Azure Active Directory

Если шифрование нужно включить на виртуальной машине, уже работающей в Azure, функция дискового шифрования Azure создает ключи шифрования и сохраняет их в хранилище ключей. Чтобы управлять ключами шифрования в хранилище ключей, нужно пройти проверку подлинности Azure AD.

Для этой цели следует создать приложение Azure AD. Подробные инструкции по регистрации приложения можно найти в разделе "Получение удостоверения для приложения" статьи в этой [записи блога](http://blogs.technet.com/b/kv/archive/2015/06/02/azure-key-vault-step-by-step.aspx). В этой записи вы также найдете несколько полезных примеров подготовки и настройки хранилища ключей. Можно использовать проверку подлинности на основе секрета клиента или на основе сертификата клиента в Azure AD.

##### Проверка подлинности в Azure AD на основе секрета клиента

В следующем разделе описаны действия, необходимые для настройки проверки подлинности в Azure AD на основе секрета клиента.

##### Создание нового приложения Azure AD с помощью Azure PowerShell

Используйте этот командлет PowerShell, чтобы создать новое приложение Azure AD:

    $aadClientSecret = “yourSecret”
    $azureAdApplication = New-AzureRmADApplication -DisplayName "<Your Application Display Name>" -HomePage "<https://YourApplicationHomePage>" -IdentifierUris "<https://YouApplicationUri>" -Password $aadClientSecret
    $servicePrincipal = New-AzureRmADServicePrincipal –ApplicationId $azureAdApplication.ApplicationId

**Примечание.** $azureAdApplication.ApplicationId — это идентификатор ClientID Azure AD, а $aadClientSecret — секрет клиента, который потребуется позднее для включения дискового шифрования Azure. Секрет клиента Azure AD следует хранить с соблюдением мер предосторожности.


##### Подготовка идентификатора и секрета клиента Azure AD на портале управления службами Azure

Идентификатор и секрет клиента Azure AD можно подготовить также с помощью портала управления службами Azure по адресу https://manage.windowsazure.com. Для этого нужно сделать следующее:

1\. Перейдите на вкладку Active Directory, как показано ниже.

![Дисковое шифрование Azure](./media/azure-security-disk-encryption/disk-encryption-fig3.JPG)

2\. Нажмите кнопку «Добавить приложение» и введите имя приложения.

![Дисковое шифрование Azure](./media/azure-security-disk-encryption/disk-encryption-fig4.JPG)

3\. Нажмите кнопку со стрелкой и настройте свойства приложения, как показано ниже.

![Дисковое шифрование Azure](./media/azure-security-disk-encryption/disk-encryption-fig5.JPG)

4\. Щелкните флажок в правом нижнем углу, чтобы завершить процесс. Отобразится страница конфигурации приложения. Обратите внимание, что в нижней части страницы есть идентификатор клиента Azure AD, как показано ниже.

![Дисковое шифрование Azure](./media/azure-security-disk-encryption/disk-encryption-fig6.JPG)

5\. Сохраните секрет клиента Azure AD, щелкнув кнопку «Сохранить». Нажмите кнопку "Сохранить" и запишите секретный код из текстового поля ключа. Это и есть секрет клиента Azure AD. Секрет клиента Azure AD следует хранить с соблюдением мер предосторожности.

![Дисковое шифрование Azure](./media/azure-security-disk-encryption/disk-encryption-fig7.JPG)


**Примечание**. Описанный выше процесс не поддерживается на портале.

##### Использование существующего приложения

Для выполнения команд, приведенных ниже, вам потребуется модуль PowerShell Azure AD, который можно получить [здесь](https://technet.microsoft.com/library/jj151815.aspx).

**Примечание.** Эти команды нужно выполнять в новом окне PowerShell. Не вводите эти команды в окне Azure PowerShell или в окне диспетчера ресурсов Azure. Дело в том, что эти командлеты находятся в модуле MSOnline или PowerShell Azure AD.

    $clientSecret = ‘<yourAadClientSecret>’
    $aadClientID = '<Client ID of your AAD app>'
    connect-msolservice
    New-MsolServicePrincipalCredential -AppPrincipalId $aadClientID -Type password -Value $clientSecret

#### Проверка подлинности в Azure AD на основе сертификата

В следующем разделе описаны действия, необходимые для настройки проверки подлинности в Azure AD на основе сертификата.

##### Создание нового приложения Azure AD

Выполните эти командлеты PowerShell, чтобы создать новое приложение Azure AD:

**Примечание.** Замените строку "yourpassword" в приведенном ниже коде на свой надежный пароль и обеспечьте защиту этого пароля.

    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate("C:\certificates\examplecert.pfx", "yourpassword")
    $keyValue = [System.Convert]::ToBase64String($cert.GetRawCertData())
    $azureAdApplication = New-AzureRmADApplication -DisplayName "<Your Application Display Name>" -HomePage "<https://YourApplicationHomePage>" -IdentifierUris "<https://YouApplicationUri>" -KeyValue $keyValue -KeyType AsymmetricX509Cert
    $servicePrincipal = New-AzureRmADServicePrincipal –ApplicationId $azureAdApplication.ApplicationId

Завершив этот шаг, передайте PFX-файл в хранилище ключей и включите политику доступа, которая необходима для развертывания этого сертификата на виртуальной машине.

##### Использование существующего приложения Azure AD
Если вы настраиваете проверку подлинности на основе сертификата для существующего приложения, используйте приведенные ниже командлеты PowerShell. Обязательно выполняйте их в новом окне PowerShell.

    $certLocalPath = 'C:\certs\myaadapp.cer'
    $aadClientID = '<Client ID of your AAD app>'
    connect-msolservice
    $cer = New-Object System.Security.Cryptography.X509Certificates.X509Certificate
    $cer.Import($certLocalPath)
    $binCert = $cer.GetRawCertData()
    $credValue = [System.Convert]::ToBase64String($binCert);
    New-MsolServicePrincipalCredential -AppPrincipalId $aadClientID -Type asymmetric -Value $credValue -Usage verify

Завершив этот шаг, передайте PFX-файл в хранилище ключей и включите политику доступа, которая необходима для развертывания этого сертификата на виртуальной машине.

##### Передача PFX-файла в хранилище ключей
Вы можете ознакомиться с [записью блога](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx), где подробно описана суть этого процесса. Чтобы его выполнить, вам потребуются только командлеты PowerShell, которые приведены ниже. Обязательно выполняйте их из консоли Azure PowerShell:

**Примечание.** Замените строку "yourpassword" в приведенном ниже коде на свой надежный пароль и обеспечьте защиту этого пароля.

    $certLocalPath = 'C:\certs\myaadapp.pfx'
    $certPassword = "yourpassword"
    $resourceGroupName = ‘yourResourceGroup’
    $keyVaultName = ‘yourKeyVaultName’
    $keyVaultSecretName = ‘yourAadCertSecretName’

    $fileContentBytes = get-content $certLocalPath -Encoding Byte
    $fileContentEncoded = [System.Convert]::ToBase64String($fileContentBytes)

    $jsonObject = @"
    {
    "data": "$filecontentencoded",
    "dataType" :"pfx",
    "password": "$certPassword"
    }
    "@

    $jsonObjectBytes = [System.Text.Encoding]::UTF8.GetBytes($jsonObject)
    $jsonEncoded = [System.Convert]::ToBase64String($jsonObjectBytes)

    Switch-AzureMode -Name AzureResourceManager
    $secret = ConvertTo-SecureString -String $jsonEncoded -AsPlainText -Force
    Set-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultSecretName -SecretValue $secret
    Set-AzureRmKeyVaultAccessPolicy -VaultName $keyVaultName -ResourceGroupName $resourceGroupName –EnabledForDeployment

##### Развертывание сертификата из хранилища ключей на существующей виртуальной машине
Передав PFX-файл, выполните следующие действия, чтобы развернуть сертификат из хранилища ключей на существующей виртуальной машине.

    $resourceGroupName = ‘yourResourceGroup’
    $keyVaultName = ‘yourKeyVaultName’
    $keyVaultSecretName = ‘yourAadCertSecretName’
    $vmName = ‘yourVMName’
    $certUrl = (Get-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultSecretName).Id
    $sourceVaultId = (Get-AzureRmKeyVault -VaultName $keyVaultName -ResourceGroupName $resourceGroupName).ResourceId
    $vm = Get-AzureRmVM -ResourceGroupName $resourceGroupName -Name $vmName
    $vm = Add-AzureRmVMSecret -VM $vm -SourceVaultId $sourceVaultId -CertificateStore "My" -CertificateUrl $certUrl
    Update-AzureRmVM -VM $vm  -ResourceGroupName $resourceGroupName


#### Настройка политики доступа к хранилищу ключей для приложения Azure AD

Приложению Azure AD нужны права на доступ к ключам и секретам, которые размещены в хранилище. Используйте командлет [Set-AzureKeyVaultAccessPolicy](https://msdn.microsoft.com/library/azure/dn903607.aspx), чтобы предоставить приложению необходимые разрешения. Здесь в качестве значения параметра –ServicePrincipalName следует использовать идентификатор клиента, который был создан при регистрации приложения. Примеры такой операции можно найти в [этой записи блога](http://blogs.technet.com/b/kv/archive/2015/06/02/azure-key-vault-step-by-step.aspx). Ниже также приведен пример того, как выполнить эту задачу с помощью PowerShell:

    $keyVaultName = ‘yourKeyVaultName’
    $aadClientID = '<youAadAppClientID>'
    Set-AzureRmKeyVaultAccessPolicy -VaultName $keyVaultName -ServicePrincipalName $aadClientID -PermissionsToKeys all -PermissionsToSecrets all

## Терминология

Эта таблица терминов позволит вам понять некоторые общие термины, которые применяются в этой технологии.


| Терминология | Определение |
|-----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Azure AD | Azure AD — это сокращенное обозначение [Azure Active Directory](https://azure.microsoft.com/documentation/services/active-directory/). Учетная запись Azure AD необходима для проверки подлинности, хранения и извлечения секретов из хранилища ключей. |
| Хранилище ключей Azure [AKV] | Хранилище ключей Azure представляет собой службу управления криптографическими ключами. Она основана на аппаратных модулях безопасности, подтвержденных FIPS, и позволяет надежно хранить криптографические ключи и конфиденциальные данные. Подробнее служба описана в документации по [хранилищу ключей](https://azure.microsoft.com/services/key-vault/). |
| ARM | Диспетчер ресурсов Azure |
| BitLocker | [BitLocker](https://technet.microsoft.com/library/hh831713.aspx) является общепризнанной отраслевой технологией шифрования томов Windows, которая используется при дисковом шифровании на виртуальных машинах IaaS Windows. |
| BEK | Ключи шифрования BitLocker (BEK) используются для шифрования загрузочного тома ОС и томов данных. Ключи BitLocker хранятся в клиентском хранилище ключей Azure в виде секретов. |
| Интерфейс командной строки | [Интерфейс командной строки Azure](../xplat-cli-install.md) |
| DM-Crypt | [DM-Crypt](https://en.wikipedia.org/wiki/Dm-crypt) — прозрачная подсистема дискового шифрования на платформе Linux, использующаяся для дискового шифрования на виртуальных машинах IaaS Linux. |
| KEK | Ключ шифрования ключа представляет собой асимметричный ключ (RSA 2048), который применяется для защиты секрета или помещения его в оболочку. Вы можете использовать защищенный HSM-ключ или ключ с программной защитой. Дополнительные сведения см. в документации по [хранилищу ключей Azure](https://azure.microsoft.com/services/key-vault/). |
| Командлеты PS | [Командлеты PowerShell Azure](powershell-install-configure.md) |

## Сценарии развертывания дискового шифрования и взаимодействие с пользователем

Есть несколько сценариев включения дискового шифрования, и последовательность действий будет для них различной. В последующих разделах эти сценарии рассматриваются подробнее.

### Включение шифрования для новых виртуальных машин IaaS, созданных из коллекции Azure

Дисковое шифрование можно включить для новой виртуальной машины IaaS Windows, созданной из коллекции Azure, с помощью шаблона ARM, опубликованного [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-create-new-vm-gallery-image). В шаблоне быстрого запуска Azure нажмите кнопку «Развернуть в Azure», введите параметры шифрования в колонке параметров и нажмите кнопку «ОК». Выберите подписку, группу ресурсов, расположение группы ресурсов, условия и соглашения, а затем нажмите кнопку «Создать», чтобы включить шифрование для новой виртуальной машины IaaS.

**Примечание.** Этот шаблон создает новую зашифрованную виртуальную машину Windows на основе образа из коллекции Windows Server 2012.

В следующей таблице описаны параметры шаблона ARM для сценария создания виртуальной машины из коллекции Azure с помощью идентификатора клиента Azure AD.

| Параметр | Описание|
|-------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| adminUserName | Имя пользователя администратора виртуальной машины |
| adminPassword | Пароль администратора виртуальной машины |
| newStorageAccountName | Имя учетной записи хранения, в которой будут размещены виртуальные жесткие диски операционной системы и данных |
| vmSize | Размер виртуальной машины. Сейчас поддерживаются только серии A, D и G категории «Стандартный» |
| virtualNetworkName | Имя виртуальной сети, к которой будет принадлежать сетевой адаптер виртуальной машины |
| subnetName | Имя подсети виртуальной сети, к которой будет принадлежать сетевой адаптер виртуальной машины |
| AADClientID | Идентификатор клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| AADClientSecret | Секрет клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| keyVaultResourceID, ResourceID | Обозначает конкретный ресурс хранилища ключей в ARM. Значение этого параметра можно получить с помощью командлета PowerShell: (Get-AzureRmKeyVault -VaultName,-ResourceGroupName).ResourceId |
| keyVaultURL | URL-адрес хранилища ключей, в которое будет передан ключ BitLocker. Значение этого параметра можно получить с помощью командлета PowerShell: (Get-AzureRmKeyVault -VaultName,-ResourceGroupName).VaultURI |
| keyEncryptionKeyURL | URL-адрес ключа шифрования ключа, который используется для шифрования созданного ключа BitLocker. Это необязательно. |
| vmName | Имя виртуальной машины, на которой будет выполняться шифрование


**Примечание.** KeyEncryptionKeyURL является необязательным параметром. Вы можете добавить собственный ключ шифрования ключа, чтобы дополнительно защитить ключ шифрования данных (секрет в виде парольной фразы) в хранилище ключей.

### Включение шифрования для новых виртуальных машин IaaS, при создании которых используются зашифрованные виртуальные жесткие диски и ключи шифрования

В этом сценарии шифрование можно включить с помощью шаблона ARM, командлетов PowerShell или команд CLI. В следующих разделах подробно описан шаблон ARM и команды CLI.

#### Использование шаблона ARM

Дисковое шифрование для клиентского зашифрованного виртуального диска можно включить с помощью шаблона ARM, опубликованного [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-create-pre-encrypted-vm). В шаблоне быстрого запуска Azure нажмите кнопку «Развернуть в Azure», введите параметры шифрования в колонке параметров и нажмите кнопку «ОК». Выберите подписку, группу ресурсов, расположение группы ресурсов, условия и соглашения, а затем нажмите кнопку «Создать», чтобы включить шифрование для новой виртуальной машины IaaS.

В следующей таблице описаны параметры шаблона ARM для сценария с использованием клиентского зашифрованного виртуального диска.

| Параметр | Описание|
|-------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| newStorageAccountName | Имя учетной записи хранения, в которой будет размещен зашифрованный виртуальный жесткий диск операционной системы. Эта учетная запись хранения уже должна быть создана в той же группе ресурсов и в том же расположении, что и виртуальная машина |
| osVhdUri | URI виртуального жесткого диска ОС в учетной записи хранения |
| osType | Тип продукта ОС (Windows, Linux) |
| virtualNetworkName | Имя виртуальной сети, к которой будет принадлежать сетевой адаптер виртуальной машины Она должна уже быть создана в той же группе ресурсов и в том же расположении, что и виртуальная машина |
| subnetName | Имя подсети виртуальной сети, к которой будет принадлежать сетевой адаптер виртуальной машины |
| vmSize | Размер виртуальной машины. Сейчас поддерживаются только серии A, D и G категории «Стандартный» |
| keyVaultResourceID | Идентификатор ресурса, который обозначает конкретный ресурс хранилища ключей в ARM. Значение этого параметра можно получить с помощью командлета PowerShell: (Get-AzureRmKeyVault -VaultName &lt;yourKeyVaultName&gt; -ResourceGroupName &lt;yourResourceGroupName&gt;).ResourceId |
| keyVaultSecretUrl | ​URL-адрес ключа дискового шифрования, подготовленного в хранилище ключей |
| keyVaultKekUrl | URL-адрес ключа шифрования ключа, с помощью которого шифруется созданный ключ шифрования диска |
| ​vmName | ​Имя виртуальной машины IaaS   



####Использование командлетов PowerShell

Дисковое шифрование для клиентского зашифрованного виртуального диска можно включить с помощью командлетов PowerShell, опубликованных [здесь](https://msdn.microsoft.com/library/azure/mt603746.aspx).

####С помощью команд CLI

Выполните следующие действия, чтобы включить шифрование диска с помощью команд CLI.

1. Задайте политики доступа к хранилищу ключей:
	- Задайте флаг EnabledForDiskEncryption: azure keyvault set-policy --vault-name <имя\_хранилища\_кючей> --enabled-for-disk-encryption true.
	- Предоставьте приложению Azure AD разрешения на запись секретов в хранилище ключей: azure keyvault set-policy --vault-name <имя\_хранилища\_кючей> --spn <ИД\_клиента\_AAD> --perms-to-keys ["all"] --perms-to-secrets ["all"].
2. Чтобы включить шифрование на существующей или работающей виртуальной машине, введите команду: *azure vm enable-disk-encryption --resource-group <имя\_группы\_ресурсов> --name <имя\_ВМ> --aad-client-id <ИД\_клиента\_AAD> --aad-client-secret <секрет\_клиента\_AAD> --disk-encryption-key-vault-url <URL-адрес\_хранилища\_ключей> --disk-encryption-key-vault-id <ИД\_ресурса\_хранилища\_ключей>*.
3. Узнайте состояние шифрования: *azure vm show-disk-encryption-status --resource-group <имя\_группы\_ресурсов> --name <имя\_ВМ> --json*.
4. Чтобы включить шифрование на новой виртуальной машине с использованием клиентского зашифрованного виртуального жесткого диска, используйте команду azure vm create с такими параметрами:
	- disk-encryption-key-vault-id <ИД\_хранилища\_ключей\_для\_шифрования\_дисков>
	- disk-encryption-key-url <URL-адрес\_хранилища\_ключей\_для\_шифрования\_дисков>
	- key-encryption-key-vault-id <ИД\_хранилища\_ключей\_для\_шифрования\_кючей>
	- key-encryption-key-url <URL-адрес\_хранилища\_ключей\_для\_шифрования\_ключей>


### Включение шифрования на виртуальной машине IaaS Windows, которая уже существует или работает в Azure

В этом сценарии шифрование можно включить с помощью шаблона ARM, командлетов PowerShell или команд CLI. В следующем разделе подробно описано, как это сделать с помощью шаблона ARM и команд CLI.

#### Использование шаблона ARM

Дисковое шифрование можно включить для виртуальной машины IaaS Windows, которая уже существует или работает в Azure, с помощью шаблона ARM, опубликованного [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-running-windows-vm). В шаблоне быстрого запуска Azure нажмите кнопку «Развернуть в Azure», введите параметры шифрования в колонке параметров и нажмите кнопку «ОК». Выберите подписку, группу ресурсов, расположение группы ресурсов, условия и соглашения, а затем нажмите кнопку «Создать», чтобы включить шифрование для существующей или работающей виртуальной машины IaaS.

В следующей таблице описаны параметры шаблона ARM для сценария шифрования виртуальной машины, которая уже существует или работает, с помощью идентификатора клиента Azure AD.

| Параметр | Описание|
|-------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ​AADClientID | ​Идентификатор клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| AADClientSecret | ​Секрет клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| keyVaultName | Имя хранилища ключей, в которое будет передан ключ BitLocker. Значение этого параметра можно получить с помощью командлета: (Get-AzureRmKeyVault -ResourceGroupName <имя\_вашей\_группы\_ресурсов>). Vaultname |
| ​ keyEncryptionKeyURL | URL-адрес ключа шифрования ключа, который используется для шифрования созданного ключа BitLocker. Это необязательный параметр, если выбрать nokek в раскрывающемся списке UseExistingKek. При выборе kek в раскрывающемся списке UseExistingKek требуется указать значение keyEncryptionKeyURL |
| ​volumeType | ​Тип тома, для которого будет выполняться шифрование. Допустимые значения: «ОС», «Данные», «Все» |
| sequenceVersion | Версия последовательности операций с BitLocker. Этот номер версии увеличивается каждый раз, когда шифрование диска выполняется на той же VM |
| ​vmName | ​Имя виртуальной машины, на которой будет выполняться шифрование


**Примечание.** KeyEncryptionKeyURL является необязательным параметром. Вы можете добавить собственный ключ шифрования ключа, чтобы дополнительно защитить ключ шифрования данных (секрет шифрования BitLocker) в хранилище ключей.

#### Использование командлетов PowerShell

Дополнительные сведения о том, как включить шифрование на базе дискового шифрования Azure с помощью командлетов PowerShell, см. в [части 1](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/17/explore-azure-disk-encryption-with-azure-powershell.aspx) и [части 2](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/21/explore-azure-disk-encryption-with-azure-powershell-part-2.aspx) записи блога **Изучение возможностей дискового шифрования Azure с помощью Azure PowerShell**.

#### С помощью команд CLI

Выполните следующие действия, чтобы включить шифрование на виртуальной машине IaaS Windows, которая уже существует или работает в Azure, с помощью команд CLI:

1. Задайте политики доступа к хранилищу ключей:
	- Задайте флаг EnabledForDiskEncryption: azure keyvault set-policy --vault-name <имя\_хранилища\_кючей> --enabled-for-disk-encryption true.
	- Предоставьте приложению Azure AD разрешения на запись секретов в хранилище ключей: azure keyvault set-policy --vault-name <имя\_хранилища\_кючей> --spn <ИД\_клиента\_AAD> --perms-to-keys ["all"] --perms-to-secrets ["all"].
2. Чтобы включить шифрование на существующей или работающей виртуальной машине, введите команду: *azure vm enable-disk-encryption --resource-group <имя\_группы\_ресурсов> --name <имя\_ВМ> --aad-client-id <ИД\_клиента\_AAD> --aad-client-secret <секрет\_клиента\_AAD> --disk-encryption-key-vault-url <URL-адрес\_хранилища\_ключей> --disk-encryption-key-vault-id <ИД\_ресурса\_хранилища\_ключей>*.
3. Узнайте состояние шифрования: *azure vm show-disk-encryption-status --resource-group <имя\_группы\_ресурсов> --name <имя\_ВМ> --json*.
4. Чтобы включить шифрование на новой виртуальной машине с использованием клиентского зашифрованного виртуального жесткого диска, используйте команду azure vm create с такими параметрами:
	- disk-encryption-key-vault-id <ИД\_хранилища\_ключей\_для\_шифрования\_дисков>
	- disk-encryption-key-url <URL-адрес\_хранилища\_ключей\_для\_шифрования\_дисков>
	- key-encryption-key-vault-id <ИД\_хранилища\_ключей\_для\_шифрования\_кючей>
	- key-encryption-key-url <URL-адрес\_хранилища\_ключей\_для\_шифрования\_ключей>


### Включение шифрования на виртуальной машине IaaS Linux, которая уже существует или работает в Azure

Дисковое шифрование можно включить для виртуальной машины IaaS Linux, которая уже существует и работает в Azure, с помощью шаблона ARM, опубликованного [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-running-linux-vm). В шаблоне быстрого запуска Azure нажмите кнопку «Развернуть в Azure», введите параметры шифрования в колонке параметров и нажмите кнопку «ОК». Выберите подписку, группу ресурсов, расположение группы ресурсов, условия и соглашения, а затем нажмите кнопку «Создать», чтобы включить шифрование для существующей или работающей виртуальной машины IaaS.

В следующей таблице описаны параметры шаблона ARM для сценария шифрования виртуальной машины, которая уже существует или работает, с помощью идентификатора клиента Azure AD.

| Параметр | Описание|
|-------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ​AADClientID | ​Идентификатор клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| AADClientSecret | ​Секрет клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| keyVaultName | Имя хранилища ключей, в которое будет передан ключ BitLocker. Значение этого параметра можно получить с помощью командлета: (Get-AzureRmKeyVault -ResourceGroupName <имя\_вашей\_группы\_ресурсов>). Vaultname |
| ​ keyEncryptionKeyURL | URL-адрес ключа шифрования ключа, который используется для шифрования созданного ключа BitLocker. Это необязательный параметр, если выбрать nokek в раскрывающемся списке UseExistingKek. При выборе kek в раскрывающемся списке UseExistingKek требуется указать значение keyEncryptionKeyURL |
| ​volumeType | ​Тип тома, для которого будет выполняться шифрование. Поддерживается допустимое значение «Данные». Шифрование тома ОС не поддерживается на уже запущенной VM Linux |
| sequenceVersion | Версия последовательности операций с BitLocker. Этот номер версии увеличивается каждый раз, когда шифрование диска выполняется на той же VM |
| ​vmName | ​Имя виртуальной машины, на которой будет выполняться шифрование
| passPhrase | Введите надежную парольную фразу, которая будет служить ключом шифрования |                                                                                                                                                                                                                                                      

**Примечание.** KeyEncryptionKeyURL является необязательным параметром. Вы можете добавить собственный ключ шифрования ключа, чтобы дополнительно защитить ключ шифрования данных (секрет в виде парольной фразы) в хранилище ключей.

#### Команды CLI

Дисковое шифрование для клиентского зашифрованного виртуального диска можно включить с помощью команды CLI (сведения об установке CLI см. [здесь](../xplat-cli-install.md)). Выполните следующие действия, чтобы включить шифрование на виртуальной машине IaaS Linux, которая уже существует или работает в Azure, с помощью команд CLI.

1. Задайте политики доступа к хранилищу ключей:
	- Задайте флаг EnabledForDiskEncryption: azure keyvault set-policy --vault-name <имя\_хранилища\_кючей> --enabled-for-disk-encryption true.
	- Предоставьте приложению Azure AD разрешения на запись секретов в хранилище ключей: azure keyvault set-policy --vault-name <имя\_хранилища\_кючей> --spn <ИД\_клиента\_AAD> --perms-to-keys ["all"] --perms-to-secrets ["all"].
2. Чтобы включить шифрование на существующей или работающей виртуальной машине, введите команду: *azure vm enable-disk-encryption --resource-group <имя\_группы\_ресурсов> --name <имя\_ВМ> --aad-client-id <ИД\_клиента\_AAD> --aad-client-secret <секрет\_клиента\_AAD> --disk-encryption-key-vault-url <URL-адрес\_хранилища\_ключей> --disk-encryption-key-vault-id <ИД\_ресурса\_хранилища\_ключей>*.
3. Узнайте состояние шифрования: azure vm show-disk-encryption-status --resource-group <имя\_группы\_ресурсов> --name <имя\_ВМ> --json.
4. Чтобы включить шифрование на новой виртуальной машине с использованием клиентского зашифрованного виртуального жесткого диска, используйте команду azure vm create с такими параметрами:
	- *disk-encryption-key-vault-id <ИД\_хранилища\_ключей\_для\_шифрования\_дисков>*
	- *disk-encryption-key-url <URL-адрес\_хранилища\_ключей\_для\_шифрования\_дисков>*
	- *key-encryption-key-vault-id <ИД\_хранилища\_ключей\_для\_шифрования\_кючей>*
	- *key-encryption-key-url <URL-адрес\_хранилища\_ключей\_для\_шифрования\_ключей>*

### Получение состояния шифрования зашифрованной виртуальной машины IaaS

Состояние шифрования можно узнать с помощью портала управления Azure, [командлетов PowerShell](https://msdn.microsoft.com/library/azure/mt622700.aspx) или команд интерфейса командной строки. В разделах ниже описано, как использовать портал Azure и команды CLI, чтобы получить состояние шифрования.

#### Получение состояния шифрования зашифрованной виртуальной машины IaaS с помощью портала управления Azure

Состояние шифрования виртуальной машины IaaS можно узнать на портале управления Azure. Войдите на портал Azure по адресу https://portal.azure.com/ и щелкните ссылку "Виртуальные машины" в меню слева. Отобразится сводное представление всех виртуальных машин в вашей подписке. Вы можете отфильтровать представление виртуальных машин, выбрав имя подписки из раскрывающегося списка подписок. Щелкните «Столбцы» в верхней части страницы «Виртуальные машины». В колонке выбора столбца выберите столбец «Шифрование диска» и нажмите кнопку «Обновить». Вы увидите, что в столбце шифрования диска отображается состояние шифрования («Включено» или «Не включено») для каждой виртуальной машины, как показано на рисунке ниже.

![Антивредоносное ПО Майкрософт в Azure](./media/azure-security-disk-encryption/disk-encryption-fig2.JPG)

#### Получение состояние шифрования зашифрованной VM IaaS с помощью командлетов PowerShell для дискового шифрования
Состояние шифрования для VM IaaS можно узнать с помощью командлета PS дискового шифрования Get-AzureRmVMDiskEncryptionStatus. Чтобы получить параметры шифрования виртуальной машины, введите в сеансе Azure PowerShell следующую команду:

    PS C:\Windows\System32\WindowsPowerShell\v1.0> Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName <yourResourceGroupName> -VMName <yourVMName>

    OsVolumeEncrypted: True
    OsVolumeEncryptionSettings : {
      "DiskEncryptionKey": {
       SecretUrl":"https://contosovault.vault.azure.net/secrets/BitLockerEncryptionSecretWithKek/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
            "SourceVault": {
            "ReferenceUri": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxx/resourceGroups/xxxxxxx/providers/Mi                            crosoft.KeyVault/vaults/xxxxxxx"
                                }
                            },
                    "KeyEncryptionKey": null
                             }
    DataVolumesEncrypted: True

Параметры OSVolumeEncrypted и DataVolumesEncrypted имеют значения True. Это означает, что оба тома зашифрованы с помощью дискового шифрования Azure. Дополнительные сведения о том, как включить шифрование на базе дискового шифрования Azure с помощью командлетов PowerShell, см. в [части 1](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/17/explore-azure-disk-encryption-with-azure-powershell.aspx) и [части 2](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/21/explore-azure-disk-encryption-with-azure-powershell-part-2.aspx) записи блога **Изучение возможностей дискового шифрования Azure с помощью Azure PowerShell**.

#### Получение состояния шифрования VM IaaS с помощью команды CLI для дискового шифрования

Состояние шифрования для виртуальной машины IaaS можно узнать с помощью команды CLI для дискового шифрования *azure vm show-disk-encryption-status*. Чтобы получить параметры шифрования для виртуальной машины, введите в сеансе Azure CLI такую команду:

    azure vm show-disk-encryption-status --resource-group <yourResourceGroupName> --name <yourVMName> --json  

#### Отключение шифрования на работающих виртуальных машинах IaaS под управлением Windows

Можно отключить шифрование на работающей виртуальной машине IaaS под управлением Windows при помощи шаблона ARM для шифрования дисков Azure или командлетов PS и задать конфигурацию расшифровки. Этап отключения шифрования поддерживается только на виртуальных машинах IaaS под управлением Windows и не поддерживается на виртуальных машинах IaaS под управлением Linux. На этом этапе для работающей виртуальной машины IaaS под управлением Windows отключается шифрование операционной системы и/или тома данных. Невозможно отключить том ОС и оставить том данных зашифрованным. На этапе отключения шифрования управление службами Azure обновляет модель службы виртуальной машины, и виртуальная машина IaaS под управлением Windows помечается как расшифрованная. Содержимое виртуальной машины больше не шифруется при хранении. При отключении шифрования не удаляется хранилище ключей клиента и материал ключа шифрования (ключи шифрования BitLocker для Windows и парольная фраза для Linux).

##### Отключение шифрования на виртуальной машине IaaS под управлением Windows, которая уже существует или работает в Azure, при помощи шаблона ARM

Шифрование дисков для работающей виртуальной машины IaaS под управлением Windows можно отключить с помощью шаблона ARM, опубликованного [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-decrypt-running-windows-vm). В шаблоне быстрого запуска Azure нажмите кнопку "Развернуть в Azure", введите параметры расшифровки в колонке параметров и нажмите кнопку "ОК". Выберите подписку, группу ресурсов, расположение группы ресурсов, условия и соглашения, а затем нажмите кнопку «Создать», чтобы включить шифрование для новой виртуальной машины IaaS.

Сведения о параметрах шаблона ARM для отключения шифрования на работающей виртуальной машине IaaS под управлением Windows:

| ​vmName | ​Имя виртуальной машины, на которой будет выполняться шифрование |
|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ​volumeType | ​Тип тома, для которого будет выполняться расшифровка. Допустимые значения: "ОС", "Данные", "Все". **Примечание**. Невозможно отключить шифрование тома ОС или загрузочного тома на работающей виртуальной машине IaaS под управлением Windows, не отключив шифрование для тома данных. |
| sequenceVersion | Версия последовательности операций с BitLocker. Этот номер версии увеличивается каждый раз, когда расшифровка диска выполняется на той же ВМ. |

##### Отключение шифрования на виртуальной машине IaaS Windows, которая уже существует или работает в Azure, при помощи командлета PS

Командлет PS [Disable-AzureRmVMDiskEncryption](https://msdn.microsoft.com/library/azure/mt715776.aspx) отключает шифрование дисков на виртуальной машине IaaS. Этот командлет поддерживается только на виртуальных машинах под управлением Windows и не поддерживается для виртуальных машин под управлением Linux. Этот командлет устанавливает на виртуальной машине расширение для отключения шифрования. Если для параметра "Имя" не указано значение, создается расширение с именем по умолчанию "AzureDiskEncryption для виртуальных машин под управлением Windows".

**Примечание**. Этот командлет перезагружает виртуальную машину.

## Приложение

### Подключение к подписке

Прежде чем продолжить, внимательно изучите раздел *предварительных требований* в этом документе. Убедитесь, что выполняются все обязательные требования, а затем подключитесь к подписке, выполнив следующие действия.

1\. Запустите сеанс Azure PowerShell и войдите в учетную запись Azure, используя следующую команду:

    Login-AzureRmAccount

2\. Если у вас несколько подписок и нужно указать, какая из них будет использоваться, введите следующую команду, чтобы увидеть подписки своей учетной записи:

    Get-AzureRmSubscription

3\. Чтобы указать подписку, которую нужно использовать, введите:

    Select-AzureRmSubscription -SubscriptionName <Yoursubscriptionname>

4\. Чтобы проверить, правильно ли настроена подписка, введите:

    Get-AzureRmSubscription

5\. Чтобы убедиться, что командлеты дискового шифрования Azure установлены, введите:

    Get-command *diskencryption*

6\. Если вы увидите такие выходные данные, значит командлеты PowerShell для дискового шифрования Azure установлены правильно:

    PS C:\Windows\System32\WindowsPowerShell\v1.0> get-command *diskencryption*
    CommandType  Name                               	 Version    Source                                                             
    Cmdlet       Get-AzureRmVMDiskEncryptionStatus       1.1.0      AzureRM.Compute                                                    
    Cmdlet       Remove-AzureRmVMDiskEncryptionExtension 1.1.0      AzureRM.Compute                                                    
    Cmdlet       Set-AzureRmVMDiskEncryptionExtension    1.1.0      AzureRM.Compute                                                     

### Подготовка предварительно зашифрованного виртуального жесткого диска Windows
В следующем разделе описаны действия, необходимые для подготовки предварительно зашифрованного виртуального жесткого диска Windows к развертыванию в качестве зашифрованного виртуального жесткого диска в Azure IaaS. Эти действия позволяют подготовить и загрузить чистую виртуальную машину Windows (виртуальный жесткий диск) в Hyper-V или Azure.

#### Обновление групповой политики с целью разрешить защиту ОС без TPM
Вам необходимо настроить параметр групповой политики BitLocker, который называется «Дисковое шифрование BitLocker». Он расположен в разделе «Политика локального компьютера\\Конфигурация компьютера\\Административные шаблоны\\Компоненты Windows». Задайте для этого параметра такое значение: *Диски операционной системы — Обязательная дополнительная проверка подлинности при запуске — Разрешить использование BitLocker без совместимого TPM*, как показано на рисунке ниже:

![Антивредоносное ПО Майкрософт в Azure](./media/azure-security-disk-encryption/disk-encryption-fig8.JPG)

#### Установка компонентов BitLocker
Для Windows Server 2012 и более поздних версий используйте такую команду:

    dism /online /Enable-Feature /all /FeatureName:Bitlocker /quiet /norestart

Для Windows Server 2008 R2 используйте такую команду:

    ServerManagerCmd -install BitLockers

#### Подготовка тома операционной системы для BitLocker с помощью bdehdcfg

Выполните следующую команду, чтобы сжать раздел операционной системы и подготовить компьютер к использованию BitLocker.

    bdehdcfg -target c: shrink -quiet

#### Использование BitLocker для защиты тома операционной системы
Используйте команду [manage-bde](https://technet.microsoft.com/library/ff829849.aspx), чтобы включить шифрование на загрузочном томе с помощью предохранителя внешнего ключа, и поместите внешний ключ (BEK-файл) на внешний диск или том. Шифрование будет включено для системного или загрузочного тома после перезагрузки.

    manage-bde -on %systemdrive% -sk [ExternalDriveOrVolume]
    reboot

**Примечание.** Чтобы получить внешний ключ с использованием BitLocker, VM должна быть подготовлена с отдельным виртуальным жестким диском для данных и ресурсов.

#### Подготовка предварительно зашифрованного виртуального жесткого диска Linux

##### Ubuntu 14

1\. Создайте в каталоге /usr/local/sbin/azure\_crypt\_key.sh файл с приведенным ниже содержимым. Обратите внимание на параметр KeyFileName — это имя файла пароля, которое создает Azure.

    #!/bin/sh
    MountPoint=/tmp-keydisk-mount
    KeyFileName=LinuxPassPhraseFileName
    echo "Trying to get the key from disks ..." >&2
    mkdir -p $MountPoint
    modprobe vfat >/dev/null 2>&1
    modprobe ntfs >/dev/null 2>&1
    sleep 2
    OPENED=0
    cd /sys/block
    for DEV in sd*; do
        echo "> Trying device: $DEV ..." >&2
        mount -t vfat -r /dev/${DEV}1 $MountPoint >/dev/null||
        mount -t ntfs -r /dev/${DEV}1 $MountPoint >/dev/null
        if [ -f $MountPoint/$KeyFileName ]; then
                cat $MountPoint/$KeyFileName
                umount $MountPoint 2>/dev/null
                OPENED=1
                break
        fi
        umount $MountPoint 2>/dev/null
    done

      if [ $OPENED -eq 0 ]; then
        echo "FAILED to find suitable passphrase file ..." >&2
        echo -n "Try to enter your password: " >&2
        read -s -r A </dev/console
        echo -n "$A"
     else
        echo "Success loading keyfile!" >&2
    fi


2\. Измените настройки шифрования в */etc/crypttab*. Результат будет выглядеть так:

    Sda5_crypt uuid=xxxxxxxxxxxxxxxxxxxxx none luks,discard,keyscript=/usr/local/sbin/azure_crypt_key.sh

3\. Если вы изменяете файл *azure\_crypt\_key.sh* в Windows, а затем копируете его в Linux, не забудьте выполнить команду *dos2unix /usr/local/sbin/azure\_crypt\_key.sh*. 4. Измените */etc/initramfs-tools/modules*, добавив приведенные ниже строки.

    vfat
    ntfs
    nls_cp437
    nls_utf8
    nls_iso8859-1

5\. Выполните команду *update-initramfs -u -k all*, чтобы обновился параметр initramfs и вступил в силу keyscript.

##### openSUSE 13.2

1\. Измените /etc/dracut.conf add\_drivers+="vfat ntfs nls\_cp437 nls\_iso8859-1".

2\. Закомментируйте следующие строки в конце файла /usr/lib/dracut/modules.d/90crypt/module-setup.sh:

    #    inst_multiple -o \
    #        $systemdutildir/system-generators/systemd-cryptsetup-generator \
    #        $systemdutildir/systemd-cryptsetup \
    #        $systemdsystemunitdir/systemd-ask-password-console.path \
    #        $systemdsystemunitdir/systemd-ask-password-console.service \
    #        $systemdsystemunitdir/cryptsetup.target \
    #        $systemdsystemunitdir/sysinit.target.wants/cryptsetup.target \
    #        systemd-ask-password systemd-tty-ask-password-agent
    #        inst_script "$moddir"/crypt-run-generator.sh /sbin/crypt-run-generator


3\. Добавьте строку DRACUT\_SYSTEMD=0 в начало файла /usr/lib/dracut/modules.d/90crypt/parse-crypt.sh и замените все упоминания if [ -z "$DRACUT\_SYSTEMD" ]; then на if [ 1 ]; then.

4\. Измените файл /usr/lib/dracut/modules.d/90crypt/cryptroot-ask.sh, добавив следующий текст после строки # Open LUKS device.

    MountPoint=/tmp-keydisk-mount
    KeyFileName=LinuxPassPhraseFileName
    echo "Trying to get the key from disks ..." >&2
    mkdir -p $MountPoint >&2
    modprobe vfat >/dev/null >&2
    modprobe ntfs >/dev/null >&2
    for SFS in /dev/sd*; do
       echo "> Trying device:$SFS..." >&2
       mount ${SFS}1 $MountPoint -t vfat -r >&2 ||
       mount ${SFS}1 $MountPoint -t ntfs -r >&2
       if [ -f $MountPoint/$KeyFileName ]; then
          echo "> keyfile got..." >&2
          luksfile=$MountPoint/$KeyFileName
          break
       fi
    done

5\. Запустите dracut – f - v, чтобы обновить initrd.

##### CentOS 7
1\. Измените /etc/dracut.conf add\_drivers+="vfat ntfs nls\_cp437 nls\_iso8859-1".

2\. Закомментируйте следующие строки в конце файла /usr/lib/dracut/modules.d/90crypt/module-setup.sh:

    #        inst_multiple -o \
    #        $systemdutildir/system-generators/systemd-cryptsetup-generator \
    #        $systemdutildir/systemd-cryptsetup \
    #        $systemdsystemunitdir/systemd-ask-password-console.path \
    #        $systemdsystemunitdir/systemd-ask-password-console.service \
    #        $systemdsystemunitdir/cryptsetup.target \
    #        $systemdsystemunitdir/sysinit.target.wants/cryptsetup.target \
    #        systemd-ask-password systemd-tty-ask-password-agent
    #        inst_script "$moddir"/crypt-run-generator.sh /sbin/crypt-run-generator



3\. Добавьте строку DRACUT\_SYSTEMD=0 в начало файла /usr/lib/dracut/modules.d/90crypt/parse-crypt.sh и замените все упоминания if [ -z "$DRACUT\_SYSTEMD" ]; then на if [ 1 ]; then.

4\. Измените файл /usr/lib/dracut/modules.d/90crypt/cryptroot-ask.sh, добавив следующий текст после строки # Open LUKS device.

    MountPoint=/tmp-keydisk-mount
    KeyFileName=LinuxPassPhraseFileName
    echo "Trying to get the key from disks ..." >&2
    mkdir -p $MountPoint >&2
    modprobe vfat >/dev/null >&2
    modprobe ntfs >/dev/null >&2
    for SFS in /dev/sd*; do
    echo "> Trying device:$SFS..." >&2
    mount ${SFS}1 $MountPoint -t vfat -r >&2 ||
    mount ${SFS}1 $MountPoint -t ntfs -r >&2
    if [ -f $MountPoint/$KeyFileName ]; then
        echo "> keyfile got..." >&2
        luksfile=$MountPoint/$KeyFileName
        break
    fi
    done


5\. Запустите /usr/sbin/dracut -f -v, чтобы обновить initrd.

###Передача зашифрованного виртуального жесткого диска в учетную запись хранения Azure
После включения шифрования BitLocker или DM-Crypt следует передать зашифрованный виртуальный жесткий диск в учетную запись хранения.

    Add-AzureRmVhd [-Destination] <Uri> [-LocalFilePath] <FileInfo> [[-NumberOfUploaderThreads] <Int32> ] [[-BaseImageUriToPatch] <Uri> ] [[-OverWrite]] [ <CommonParameters>]

### Передача секрета дискового шифрования для предварительно зашифрованной виртуальной машины в хранилище ключей
Секрет дискового шифрования, полученный ранее, необходимо передать в хранилище ключей в качестве секрета.

#### Секрет дискового шифрования не шифруется с помощью KEK
Используйте [Set-AzureKeyVaultSecret](https://msdn.microsoft.com/library/dn868050.aspx), чтобы подготовить секрет в хранилище ключей. Если вы используете виртуальную машину Windows, с помощью командлета Set-AzureKeyVaultSecret закодируйте BEK-файл как строку Base64 и передайте его в хранилище ключей. Если используется виртуальная машина Linux, пароль кодируется как строка Base64, а затем передается в хранилище ключей. Убедитесь также, что при создании секрета в хранилище ключей были установлены следующие теги.

    "tags":
    {
       “DiskEncryptionKeyEncryptionAlgorithm”: “RSA-OAEP (optional)”
       "DiskEncryptionKeyFileName": "Bek file name (windows) or Passphrase filename (linux)"
    }

    param(
      [Parameter(Mandatory=$True)]
      [String]$BekFilePath = "C:\vm\nbox\2640EE52-41B3-426C-87B9-484232452CE4.BEK",
      [String]$VaultName = "DiskEncryptionTestAus",
      [String]$SecretName = "BitLockerKey"
      )

    #"EAN//ojeIQk="
    $bekFileName = split-path $BekFilePath -leaf
    echo "Bek file name = $bekFileName"

    $secretBytes = [System.IO.File]::ReadAllBytes($BekFilePath);
    $secret = [Convert]::ToBase64String($secretBytes);
    echo "Secret = $secret"

    $secureSecret = ConvertTo-SecureString $secret -AsPlainText -Force
    $tags = @{"DiskEncryptionKeyFileName" = "$bekFileName"}

    echo "Tags = $tags"
    echo "Vault = $VaultName"
    echo "Secret name = $SecretName"
    echo "Adding secret to Key vault"

    Set-AzureKeyVaultSecret -VaultName $VaultName -Name $SecretName -SecretValue $secureSecret -tags $tags


#### Секрет дискового шифрования, зашифрованный с помощью KEK

Перед передачей в хранилище ключей секрет можно зашифровать с помощью ключа шифрования ключа (необязательно). Сначала используйте [API](https://msdn.microsoft.com/library/azure/dn878066.aspx) для создания оболочки, чтобы зашифровать секрет с помощью ключа шифрования ключа. Эта операция возвращает значения, закодированные как URL-адрес в кодировке Base64, которые затем передаются в качестве секрета с помощью командлета [Set-AzureKeyVaultSecret](https://msdn.microsoft.com/library/dn868050.aspx).


##Скачивание руководства
Это руководство можно скачать из [коллекции TechNet](https://gallery.technet.microsoft.com/Azure-Disk-Encryption-for-a0018eb0).


## Дополнительные сведения
[Изучение возможностей дискового шифрования Azure с помощью Azure PowerShell](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/16/explore-azure-disk-encryption-with-azure-powershell.aspx?wa=wsignin1.0)

[Изучение возможностей дискового шифрования Azure с помощью Azure PowerShell — часть 2](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/21/explore-azure-disk-encryption-with-azure-powershell-part-2.aspx)

<!---HONumber=AcomDC_0921_2016-->