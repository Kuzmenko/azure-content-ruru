<properties 
	pageTitle="Шлюз управления данными для фабрики данных | Microsoft Azure"
	description="Настройка шлюза данных для перемещения данных между локальными узлами и облаком. Используйте шлюз управления данными в фабрике данных Azure для перемещения данных." 
	services="data-factory" 
	documentationCenter="" 
	authors="spelluru" 
	manager="jhubbard" 
	editor="monicar"/>

<tags 
	ms.service="data-factory" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="08/30/2016" 
	ms.author="spelluru"/>

# Шлюз управления данными
Шлюз управления данными — это агент клиента, который необходимо установить в локальной среде, чтобы обеспечить копирование данных между облачными и локальными хранилищами данных. Перечень локальных хранилищ данных, поддерживаемых фабрикой данных, приведен в разделе [Поддерживаемые хранилища данных и форматы](data-factory-data-movement-activities.md##supported-data-stores).

Эта статья дополняет пошаговое руководство, приведенное в статье [Перемещение данных между локальными источниками и облаком с помощью шлюза управления данными](data-factory-move-data-between-onprem-and-cloud.md). В руководстве создается конвейер, который использует шлюз для перемещения данных из локальной базы данных SQL Server в большой двоичный объект Azure. В этой статье содержатся подробные сведения об использовании шлюза управления данными.

## Обзор

### Возможности шлюза управления данными
Шлюз управления данными предоставляет следующие возможности.

- Моделирование источников локальных и облачных данных в пределах одной фабрики данных, а также перемещение данных.
- Использование единой панели для мониторинга и управления с возможностью контроля состояния шлюза в колонке фабрики данных.
- Безопасное управление доступом к локальным источникам данных.
	- Изменять настройки корпоративного брандмауэра не требуется. Шлюз только пропускает исходящие HTTP-соединения во внешнюю сеть.
	- Учетные данные для ваших локальных хранилищ данных можно шифровать с помощью личного сертификата.
- Эффективное перемещение данных: данные передаются параллельно, благодаря логике автоматического повторения перемещение не зависит от временных сетевых проблем.

### Поток команд и поток данных
Если для копирования локальных данных в облако либо для передачи данных из облака обратно в локальное хранилище используется действие копирования, то в таких операциях участвует шлюз данных.

Ниже показана обобщенная схема потока данных и этапы копирования через шлюз. ![Поток данных при использовании шлюза](./media/data-factory-data-management-gateway/data-flow-using-gateway.png)

1.	Разработчик создает шлюз для фабрики данных Azure, используя [портал Azure](https://portal.azure.com) или [командлет PowerShell](https://msdn.microsoft.com/library/dn820234.aspx).
2.	Разработчик создает связанную службу для локального хранилища данных, указывая шлюз. В ходе настройки связанной службы разработчик указывает типы аутентификации и учетные данные в приложении настройки учетных данных. Приложение настройки учетных данных проверяет подключение к хранилищу данных и шлюзу и сохраняет учетные данные.
3. Перед сохранением учетных данных в облаке шлюз шифрует их при помощи связанного с ним сертификата (указывается разработчиком).
4. Служба фабрики данных взаимодействует со шлюзом, планируя задания и управляя ими через специальный канал. Этот канал управления использует общую очередь служебной шины Azure. Когда нужно начать задание копирования, фабрика данных добавляет в очередь запрос с указанием учетных данных. После опроса очереди шлюз начинает задание.
5.	Шлюз расшифровывает учетные данные с помощью того же сертификата, после чего подключается к локальному хранилищу данных, используя соответствующий тип аутентификации и учетные данные.
6.	Шлюз копирует данные из локального хранилища в облачное или из облачного обратно в локальное в зависимости от настроек действия копирования в конвейере данных. На этом этапе шлюз напрямую взаимодействует с облачными службами хранилища, такими как хранилище BLOB-объектов Azure, через защищенный канал (HTTPS).

### Рекомендации по использованию шлюза
- Для нескольких локальных источников данных можно использовать один шлюз управления данными. Однако **каждый экземпляр шлюза связан только с одной фабрикой данных Azure** и не может использоваться совместно с другой.
- На компьютере может быть установлен **только один экземпляр шлюза управления данными**. Предположим, у вас есть две фабрики данных, которым необходимо получить доступ к локальным источникам данных. В этом случае вам необходимо установить шлюзы на двух локальных компьютерах. Другими словами, каждый шлюз связан с отдельной фабрикой данных.
- **Шлюз не обязательно устанавливать на том же компьютере, что и источник данных**. Но, если он расположен вблизи источника данных, это сокращает количество времени, требуемого для подключения шлюза к этому источнику. Рекомендуется установить шлюз на компьютере, отличном от того, на котором размещен локальный источник данных. Когда шлюз и источник данных находятся на разных компьютерах, шлюз не конкурирует за использование ресурсов с источником данных.
- У вас может быть **несколько шлюзов на разных компьютерах, подключенных к одному и тому же локальному источнику данных**. Например, имеется два шлюза, обслуживающие две фабрики данных, однако один и тот же локальный источник данных зарегистрирован в обеих фабриках данных.
- Если вы уже установили шлюз на компьютер, который обслуживает сценарий **Power BI**, установите **отдельный шлюз для фабрики данных Azure** на другой машине.
- Шлюз необходимо использовать, даже если используется **ExpressRoute**.
- Источник данных следует считать локальным (то есть защищенным брандмауэром), даже если используется **ExpressRoute**. А для связи между службой и источником данных используется шлюз.
- Необходимо **использовать шлюз**, даже если хранилище данных находится в облаке на **виртуальной машине IaaS Azure**.

## Установка

### Предварительные требования
- Поддерживаемые **операционные системы**: Windows 7, Windows 8, Windows 8.1, Windows 10, Windows Server 2008 R2, Windows Server 2012, Windows Server 2012 R2. В настоящее время установка шлюза управления данными на контроллере домена не поддерживается.
- Требуется .NET Framework 4.5.1 или более поздней версии. При установке шлюза на компьютере под управлением Windows 7 установите .NET Framework 4.5 или более поздней версии. Дополнительные сведения см. в разделе [Требования к системе для .NET Framework](https://msdn.microsoft.com/library/8z6watww.aspx).
- Рекомендуемая **конфигурация** для компьютера шлюза: четырехъядерный процессор с тактовой частотой не менее 2 ГГц, не менее 8 ГБ ОЗУ и 80 ГБ дискового пространства.
- Когда хост-компьютер переходит в спящий режим, шлюз не может отвечать на запросы данных. Поэтому перед установкой шлюза на компьютере следует настроить соответствующую **схему управления питанием**. Если компьютер настроен на использование режима гибернации, во время установки шлюза отобразится соответствующее сообщение.
- Для успешной установки шлюза управления данными и его настройки вы должны обладать правами администратора на компьютере. В локальную группу Windows **Пользователи шлюза управления данными** можно добавить дополнительных пользователей. Участники этой группы могут использовать диспетчер конфигурации шлюза управления данными для настройки шлюза.

Так как циклы копирования выполняются с определенной частотой, ресурсы компьютера (ЦП, память) используются нерегулярно: есть пиковые нагрузки и есть время простоя. Использование ресурсов также зависит от объема перемещаемых данных. Когда выполняется несколько заданий копирования, в пиковые периоды уровень использования ресурсов системы повышается.

### Параметры установки
Шлюз управления данными можно установить одним из следующих способов.

- Скачать установочный пакет MSI из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=39717). Пакет MSI также может использоваться для обновления имеющегося шлюза управления данными до последней версии с сохранением всех параметров.
- Щелкнуть ссылку **Скачивание и установка шлюза данных** в разделе "Установка вручную" или ссылку **Установка непосредственно на этот компьютер** в разделе "Экспресс-установка". В разделе [Перемещение данных между локальными источниками и облаком с помощью шлюза управления данными](data-factory-move-data-between-onprem-and-cloud.md) приведены пошаговые инструкции по экспресс-установке. В случае ручной установки вы перейдете к центру загрузки. Инструкции по скачиванию и установке шлюза из центра загрузки приведены в следующем разделе.

### Рекомендации по установке
1.	Настройте схему управления питанием на хост-компьютере шлюза, отключив спящий режим. Когда хост-компьютер переходит в спящий режим, шлюз не может отвечать на запросы данных.
2.	Создайте резервную копию сертификата, связанного со шлюзом.

### Установка шлюза из центра загрузки
1. Перейдите на [страницу скачивания шлюза управления данными Майкрософт](https://www.microsoft.com/download/details.aspx?id=39717).
2. Щелкните **Скачать**, выберите нужную версию (**32-разрядную** или **64-разрядную**) и нажмите кнопку **Далее**.
3. Сразу запустите **MSI**-файл или сохраните его на жесткий диск и затем запустите.
4. На странице **приветствия** выберите **язык**, после чего нажмите кнопку **Далее**.
5. **Примите** условия лицензионного соглашения и нажмите кнопку **Далее**.
6. Выберите **папку** для установки шлюза, затем нажмите кнопку **Далее**.
7. На странице **Готово к установке** щелкните **Установить**.
8. Нажмите кнопку **Готово** для завершения установки.
9. Получите ключ на портале Azure. Пошаговые инструкции представлены в следующем разделе.
10. Запустите на компьютере **диспетчер конфигурации шлюза управления данными** и на странице **Регистрация шлюза** выполните следующие действия:
	1. Вставьте ключ в текст.
	2. При необходимости щелкните **Показать ключ шлюза**, чтобы просмотреть текст ключа.
	3. Щелкните **Зарегистрировать**.

### Регистрация шлюза с помощью ключа

#### Если логический шлюз на портале еще не создан
Чтобы создать шлюз на портале и найти ключ в колонке **Настройка**, выполните действия из пошагового руководства в статье [Перемещение данных между локальными источниками и облаком с помощью шлюза управления данными](data-factory-move-data-between-onprem-and-cloud.md).

#### Если логический шлюз на портале уже создан
1. На портале Azure перейдите к колонке **Фабрика данных** и щелкните плитку **Связанные службы**.

	![Колонка "Фабрика данных"](media/data-factory-data-management-gateway/data-factory-blade.png)
2. В колонке **Связанные службы** выберите логический **шлюз**, который вы создали на портале.

	![Логический шлюз](media/data-factory-data-management-gateway/data-factory-select-gateway.png)
2. В колонке **Шлюз данных** щелкните **Скачивание и установка шлюза данных**.

	![Ссылка для скачивания на портале](media/data-factory-data-management-gateway/download-and-install-link-on-portal.png)
3. В колонке **Настройка** щелкните **Повторное создание ключа**. Нажмите кнопку "Да" в окне предупреждающего сообщения, внимательно его прочитав.

	![Повторное создание ключа](media/data-factory-data-management-gateway/recreate-key-button.png)
4. Нажмите кнопку "Копировать" рядом с ключом. Ключ cкопируется в буфер обмена.
	
	![Копирование ключа](media/data-factory-data-management-gateway/copy-gateway-key.png)

### Значки и уведомления в области уведомлений
На следующем рисунке показаны некоторые значки панели задач.

![значки на панели задач](./media/data-factory-data-management-gateway/gateway-tray-icons.png)

Если навести курсор на значок или сообщение уведомления на панели задач, появится всплывающее окно со сведениями о состоянии шлюза или операции обновления.

### Порты и брандмауэр
Описанные здесь рекомендации относятся к двум брандмауэрам: к **корпоративному брандмауэру**, работающему на центральном маршрутизаторе организации, и к **брандмауэру Windows**, настроенному в качестве управляющей программы на локальном компьютере, на котором установлен шлюз.

![брандмауэры](./media/data-factory-data-management-gateway/firewalls.png)

На уровне корпоративного брандмауэра необходимо настроить следующие домены и исходящие порты:

| Имена доменов | порты; | Описание |
| ------ | --------- | ------------ |
| *.servicebus.windows.net | 443, 80 | Прослушиватели ретрансляции служебной шины по протоколу TCP (порт 443 требуется для получения маркера контроля доступа). | 
| *.servicebus.windows.net | 9350-9354, 5671 | Дополнительный ретранслятор служебной шины по протоколу TCP | 
| *.core.windows.net | 443 | HTTPS | 
| *.clouddatahub.net | 443 | HTTPS | 
| graph.windows.net | 443 | HTTPS |
| login.windows.net | 443 | HTTPS | 

Эти исходящие порты, как правило, включены на уровне брандмауэра Windows. В противном случае домены и порты можно соответствующим образом настроить на компьютере шлюза.

#### Копирование данных из источника данных в приемник данных

Убедитесь, что правила брандмауэра в корпоративном брандмауэре, брандмауэре Windows на компьютере шлюза и в самом хранилище данных активированы надлежащим образом. Активация этих правил позволяет шлюзу успешно подключаться как к источнику, так и к приемнику. Активируйте правила для каждого хранилища данных, задействованного в операции копирования.

Например, при копировании **данных из локального хранилища в приемник базы данных SQL Azure или приемник хранилища данных SQL Azure** необходимо выполнить следующие действия:

- разрешить исходящие **TCP**-подключения через порт **1433** для брандмауэра Windows и корпоративного брандмауэра;
- в параметрах брандмауэра Azure SQL Server добавить IP-адрес компьютера шлюза в список разрешенных IP-адресов.


### Рекомендации для прокси-сервера
Если для доступа в Интернет в среде вашей корпоративной сети используется прокси-сервер, настройте шлюз управления данными для применения соответствующих параметров прокси-сервера. Прокси-сервер можно настроить на этапе начальной регистрации.

![Настройка прокси-сервера при регистрации](media/data-factory-data-management-gateway/SetProxyDuringRegistration.png)

Шлюз использует прокси-сервер для подключения к облачной службе. Щелкните ссылку **Изменить** во время начальной настройки. Отобразится диалоговое окно **Proxy setting** (Настройка прокси-сервера).

![Настройка прокси-сервера с помощью диспетчера конфигурации](media/data-factory-data-management-gateway/SetProxySettings.png)

Доступны три варианта конфигурации.

- **Без прокси**: шлюз явно не использует никакой прокси-сервер для подключения к облачным службам.
- **Использовать системный прокси**: шлюз использует параметры прокси-сервера, настроенные в файле diahost.exe.config. Если параметры прокси-сервера не настроены в файле diahost.exe.config, то шлюз подключается к облачной службе напрямую без использования прокси-сервера.
- **Использовать настраиваемый прокси**: шлюз использует параметры HTTP-прокси вместо конфигурации, настроенной в файле diahost.exe.config. Необходимо указать адрес и порт. Имя пользователя и пароль являются необязательными и указываются в зависимости от настроек аутентификации прокси-сервера. Все параметры шифруются с помощью сертификата учетных данных шлюза и сохраняются локально на хост-компьютере шлюза.

Служба узла шлюза управления данными автоматически перезапускается после сохранения обновленных параметров прокси-сервера.

После успешной регистрации шлюза, если требуется просмотреть или обновить параметры прокси-сервера, используйте диспетчер конфигурации шлюза управления данными.

1. Запустите диспетчер конфигурации шлюза управления данными.
2. Переключитесь на вкладку **Параметры**.
3. Щелкните ссылку **Изменить** в разделе **HTTP-прокси**, чтобы открыть диалоговое окно **Указание HTTP-прокси**.
4. После нажатия кнопки **Далее** появится диалоговое окно предупреждения, запрашивающее разрешение на сохранение настроек прокси-сервера и перезапуск службы узла шлюза.

При помощи диспетчера конфигурации можно просмотреть и обновить HTTP-прокси.

![Настройка прокси-сервера с помощью диспетчера конфигурации](media/data-factory-data-management-gateway/SetProxyConfigManager.png)

> [AZURE.NOTE] Если настроить на прокси-сервере аутентификацию NTLM, то служба узла шлюза будет запускаться под учетной записью домена. Если через какое-то время вы измените пароль для учетной записи домена, то не забудьте обновить параметры конфигурации службы и перезапустить ее. Учитывая это требование, для доступа к прокси-серверу рекомендуется использовать выделенную учетную запись домена, для которой не требуется часто менять пароль.

### Настройка параметров прокси-сервера в файле diahost.exe.config
Если для HTTP-прокси выбран вариант конфигурации **Использовать системный прокси**, то шлюз использует параметры прокси-сервера, заданные в файле diahost.exe.config. Если параметры прокси-сервера не указаны в файле diahost.exe.config, то шлюз подключается к облачной службе напрямую без использования прокси-сервера. Ниже приводится процедура обновления файла конфигурации.

1.	В проводнике создайте резервную копию исходного файла C:\\Program Files\\Microsoft Data Management Gateway\\2.0\\Shared\\diahost.exe.config.
2.	Запустите файл Notepad.exe с правами администратора и откройте текстовый файл с путем C:\\Program Files\\Microsoft Data Management Gateway\\2.0\\Shared\\diahost.exe.config. Там вы найдете тег по умолчанию для system.net:

			<system.net>
				<defaultProxy useDefaultCredentials="true" />
			</system.net>	

	Затем можно добавить данные прокси-сервера, как показано в следующем примере:

			<system.net>
			      <defaultProxy enabled="true">
			            <proxy bypassonlocal="true" proxyaddress="http://proxy.domain.org:8888/" />
			      </defaultProxy>
			</system.net>

	Внутри тега прокси-сервера можно указать дополнительные свойства, чтобы задать требуемые параметры, например scriptLocation. Сведения о синтаксисе см. в статье [Элемент <proxy> (параметры сети)](https://msdn.microsoft.com/library/sa91de1e.aspx).

			<proxy autoDetect="true|false|unspecified" bypassonlocal="true|false|unspecified" proxyaddress="uriString" scriptLocation="uriString" usesystemdefault="true|false|unspecified "/>

3. Сохраните файл конфигурации в исходном расположении, а затем перезапустите службу узла шлюза управления данными, которая получает изменения. Чтобы перезапустить службу, воспользуйтесь приложением "Службы" на панели управления или откройте **диспетчер конфигурации шлюза управления данными**, нажмите кнопку **Остановить службу**, а затем щелкните **Запустить службу**. Если служба не запускается, вероятно, в измененном файле конфигурации приложения добавлен неправильный синтаксис тегов XML.

Кроме того, необходимо также убедиться, что Microsoft Azure входит в белый список в вашей компании. Список допустимых IP-адресов Microsoft Azure можно скачать из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=41653).

#### Возможные признаки проблем, связанных с брандмауэром и прокси-сервером
Вероятная причина приведенных ниже ошибок — неправильная конфигурация брандмауэра или прокси-сервера, которая блокирует подключение шлюза к фабрике данных для аутентификации. Чтобы настроить брандмауэр и прокси-сервер должным образом, см. предыдущий раздел.

1.	При попытке зарегистрировать шлюз появляется следующая ошибка: "Не удалось зарегистрировать ключ шлюза. Перед повторной попыткой регистрации ключа убедитесь, что шлюз управления данными подключен и на хост-компьютере запущена служба шлюза управления данными".
2.	При открытии диспетчера конфигурации отображается состояние "Отключено" или "Подключение". В средстве просмотра событий Windows в разделе "Журналы приложения и служб" > "Шлюз управления данными" отображается сообщение об ошибке, подобное этому: `Unable to connect to the remote server` `A component of Data Management Gateway has become unresponsive and restarts automatically. Component name: Gateway.`

### Открытие порта 8050 для шифрования учетных данных 
Приложение **настройки учетных данных** использует входящий порт **8050** для ретрансляции учетных данных, которые вы указываете на портале Azure для локальной связанной службы, в шлюз учетных данных. По умолчанию при установке шлюза управления данными программа установки открывается на компьютере шлюза.
 
В случае использования стороннего брандмауэра вы сможете открыть порт 8050 вручную. Если во время установки шлюза возникли проблемы с брандмауэром, попробуйте установить шлюз без настройки брандмауэра, используя следующую команду:

	msiexec /q /i DataManagementGateway.msi NOFIREWALL=1

Если вы не хотите открывать порт 8050 на компьютере шлюза, то настроить учетные данные для хранилища данных с помощью приложения **настройки учетных данных** будет невозможно. Используйте другие механизмы настройки. Например, можно использовать командлет PowerShell [New-AzureRmDataFactoryEncryptValue](https://msdn.microsoft.com/library/mt603802.aspx). Дополнительные сведения о настройке учетных данных хранилища данных см. в разделе [Настройка учетных данных и безопасность](#set-credentials-and-securityy).

## Блокировка изменений 
По умолчанию шлюз управления данными автоматически обновляется, если доступна новая версия. Он не будет обновлен, пока не будут выполнены все запланированные задания. До завершения операции обновления в шлюзе не будут обрабатываться какие-либо дополнительные задачи. Если обновление завершится сбоем, для шлюза будет выполнен откат к предыдущей версии.

Время запланированного обновления см. в следующих местах:

- колонка свойств шлюза на портале Azure;
- домашняя страница диспетчера конфигурации шлюза управления данными;
- сообщение в области уведомлений.

На вкладке "Главная" диспетчера конфигурации шлюза управления данными отображается расписание обновления, а также время последнего обновления или установки шлюза.

![Планирование обновлений](media/data-factory-data-management-gateway/UpdateSection.png)

Вы можете установить обновление сразу или дождаться, пока шлюз не будет автоматически обновлен в запланированное время. На следующем изображении показано сообщение уведомления на странице диспетчера конфигурации шлюза вместе с кнопкой "Обновить", которую можно нажать, чтобы установить обновление немедленно.

![Обновление диспетчера конфигураций DMG](./media/data-factory-data-management-gateway/gateway-auto-update-config-manager.png)

Сообщение уведомления на панели задач выглядит следующим образом:

![Сообщение на панели задач](./media/data-factory-data-management-gateway/gateway-auto-update-tray-message.png)

На панели задач отображается состояние операции обновления (выполняемой вручную или автоматически). В следующий раз при запуске диспетчера конфигурации шлюза на панели уведомлений отобразится сообщение об обновлении шлюза и ссылка на [раздел о новых возможностях](data-factory-gateway-release-notes.md).

### Включение или отключение функции автоматического обновления
Чтобы включить или отключить функцию автоматического обновления, сделайте следующее:

1. Запустите Windows PowerShell на компьютере шлюза.
2. Перейдите в папку C:\\Program Files\\Microsoft Data Management Gateway\\2.0\\PowerShellScript.
3. Выполните следующую команду, чтобы отключить функцию автоматического обновления.

		.\GatewayAutoUpdateToggle.ps1  -off

4. Чтобы снова включить ее:
	
		.\GatewayAutoUpdateToggle.ps1  -on  

## Менеджер конфигураций 
После установки шлюза вы можете запустить диспетчер конфигурации шлюза управления данными одним из приведенных ниже способов.

- Для этого введите текст **шлюз управления данными** в окне **Поиск**.
- Выполните исполняемый файл **ConfigManager.exe** в папке **C:\\Program Files\\Microsoft Data Management Gateway\\2.0\\Shared**.
 
### главная страница
Главная страница позволяет сделать следующее:

- Просмотреть состояние шлюза (подключенного к облачной службе и т.д.).
- выполнить **регистрацию** с помощью ключа с портала;
- **остановить** и запустить **службу узла шлюза управления данными** на компьютере шлюза;
- **запланировать обновления** на определенное время дня;
- просмотреть дату **последнего обновления** шлюза.

### Страница «Параметры»
Страница "Параметры" позволяет выполнить следующее:

- Просмотреть, изменить и экспортировать **сертификат**, который используется шлюзом. Этот сертификат используется для шифрования учетных данных источника данных.
- Изменить **HTTPS-порт** для конечной точки. шлюз открывает порт для настройки учетных данных источника данных;
- Просмотреть **состояние** конечной точки.
- Представление **SSL-сертификат** используется для обмена данными по протоколу SSL между порталом и шлюзом, чтобы задать учетные данные для источников данных.

### Страница "Диагностика"
Страница "Диагностика" позволяет сделать следующее:

- Включить подробное **ведение журнала**, просмотреть журналы в средстве просмотра событий и отправить журналы в корпорацию Майкрософт в случае сбоя.
- **Проверить подключение** к источнику данных.

### Страница справки
На странице "Справка" отображается следующая информация:

- краткое описание шлюза;
- номер версии;
- ссылки на справку в Интернете, заявление о конфиденциальности и лицензионное соглашение.

## Устранение неполадок

- Более подробную информацию можно найти в журналах шлюза в журналах событий Windows. Их можно найти в **средстве просмотра событий** Windows в разделе **Журналы приложения и служб** > **Шлюз управления данными**. Устраняя связанные со шлюзом ошибки, обращайте внимание на события уровня ошибок.
- Если после **изменения сертификата** шлюз перестанет работать, перезапустите **службу шлюза управления данными** с помощью диспетчера конфигурации шлюза управления данными Microsoft или приложения "Службы" на панели управления. Если ошибка сохраняется, может потребоваться предоставить пользователю службы шлюза управления данными явные разрешения для доступа к сертификату в диспетчере сертификатов (certmgr.msc). По умолчанию для службы используется учетная запись пользователя **NT Service\\DIAHostService**.
- Если приложение **Диспетчер учетных записей** не может **зашифровать** учетные данные, когда вы нажимаете кнопку "Зашифровать" в редакторе фабрики данных, проверьте, запущено ли это приложение на **компьютере шлюза**. Если это не так, запустите приложение на компьютере шлюза и еще раз попробуйте зашифровать учетные данные.
- Если возникают ошибки, связанные с подключением к хранилищу данных или с драйверами, выполните перечисленные ниже действия.
	- На машине шлюза запустите **диспетчер конфигурации шлюза управления данными**.
	- Перейдите на вкладку **Диагностика**.
	- Выберите или введите соответствующие значения в поля группы **Проверить подключение к локальному источнику данных с помощью этого шлюза**.
	- Щелкните **Проверка подключения**, чтобы проверить возможность подключения к локальному источнику данных с компьютера шлюза, используя сведения о подключении и учетные данные. Если после установки драйвера тестовое подключение по-прежнему не работает, перезапустите шлюз для того, чтобы получить последние изменения.

	![Проверить подключение](./media/data-factory-data-management-gateway/TestConnection.png)

### Отправка журналов шлюза в корпорацию Майкрософт
Возможно, при обращении в службу поддержки Майкрософт с проблемами в работе шлюза вас попросят предоставить журналы шлюза. Выпуск шлюза позволяет легко предоставить требуемые журналы всего двумя щелчками в диспетчере конфигурации шлюза.

1. Переключитесь на вкладку **Диагностика** диспетчера конфигурации шлюза.
 
	![Шлюз управления данными — вкладка "Диагностика"](media/data-factory-data-management-gateway/data-management-gateway-diagnostics-tab.png)
2. Щелкните ссылку **Отправить журналы**, чтобы открыть приведенное ниже диалоговое окно.

	![Шлюз управления данными — отправка журналов](media/data-factory-data-management-gateway/data-management-gateway-send-logs-dialog.png)
3. (Необязательно.) Щелкните **Просмотреть журналы**, чтобы просмотреть журналы в средстве просмотра событий.
4. (Необязательно.) Щелкните **Конфиденциальность**, чтобы просмотреть заявление о конфиденциальности Microsoft Online Services.
3. Выбрав все, что нужно передать, щелкните **Отправить журналы**, чтобы отправить журналы за последние семь дней в корпорацию Майкрософт для диагностики и устранения неполадок. Вы увидите состояние отправки журналов, как показано на изображении ниже.

	![Шлюз управления данными — состояние отправки журналов](media/data-factory-data-management-gateway/data-management-gateway-send-logs-status.png)
4. После завершения отправки появится диалоговое окно, как показано на изображении ниже.
	
	![Шлюз управления данными — состояние отправки журналов](media/data-factory-data-management-gateway/data-management-gateway-send-logs-result.png)
5. Запишите **идентификатор отчета** и передайте его в службу поддержки Майкрософт. Идентификатор отчета используется для поиска журналов шлюза, которые вы передали для устранения неполадок. Кроме того, этот идентификатор сохраняется в средстве просмотра событий для справки. Его можно найти, просмотрев идентификатор события "25" и проверив дату и время.
	
	![Шлюз управления данными — идентификатор отчета об отправке журналов](media/data-factory-data-management-gateway/data-management-gateway-send-logs-report-id.png)

### Архивация журналов шлюза на хост-компьютере шлюза
Существует несколько сценариев, в которых при наличии проблем в работе шлюза вы не можете передать журналы шлюза напрямую:

- вы вручную устанавливаете и регистрируете шлюз;
- вы пытаетесь зарегистрировать шлюз с помощью повторно созданного ключа в диспетчере конфигурации;
- вы пытаетесь отправить журналы, но к службе узла шлюза не удается подключиться.

В таких случаях можно сохранить журналы шлюза в ZIP-файл и позже предоставить их при обращении в службу поддержки Майкрософт. Например, произошла ошибка при регистрации шлюза, как показано на изображении ниже.

![Шлюз управления данными — ошибка регистрации](media/data-factory-data-management-gateway/data-management-gateway-registration-error.png)

Щелкните ссылку **Архивировать журналы шлюза**, чтобы заархивировать и сохранить журналы, а затем передайте полученный ZIP-файл в службу поддержки Майкрософт.

![Шлюз управления данными — архивация журналов](media/data-factory-data-management-gateway/data-management-gateway-archive-logs.png)

### Шлюз находится в сети с ограниченной функциональностью 
Шлюз может находиться в состоянии **в сети с ограниченной функциональностью** по одной из следующих причин.

- Шлюзу не удается подключиться к облачной службе через служебную шину.
- Облачной службе не удается подключиться к шлюзу через служебную шину

Если шлюз находится в сети с ограниченной функциональностью, то вы не сможете использовать мастер копирования фабрики данных, чтобы создавать конвейеры данных для копирования данных между локальными хранилищами данных.

Устранить или обойти эту проблему (состояние "в сети с ограниченной функциональностью") можно, определив ее причину (шлюзу не удается подключиться к облачной службы) или иным способом. В следующих разделах описываются эти методы обхода проблемы.

#### Шлюзу не удается подключиться к облачной службе через служебную шину
Выполните следующие действия, чтобы перевести шлюз в состояние "в сети".

1. Откройте исходящие порты 9350–9354 в брандмауэре Windows на компьютере шлюза и в корпоративном брандмауэре. Дополнительные сведения см. в разделе [Порты и брандмауэр](#ports-and-firewall).
2. Настройте параметры прокси-сервера на шлюзе. Дополнительные сведения см. в разделе [Рекомендации для прокси-сервера](#proxy-server-considerations).

В качестве обхода проблемы используйте редактор фабрики данных на портале Azure, Visual Studio или Azure PowerShell.

#### Ошибка: облачной службе не удается подключиться к шлюзу через служебную шину.
Выполните следующие действия, чтобы перевести шлюз в состояние "в сети".
 
1. Откройте исходящие порты 5671 и 9350–9354 в брандмауэре Windows на компьютере шлюза и в корпоративном брандмауэре. Дополнительные сведения см. в разделе [Порты и брандмауэр](#ports-and-firewall).
2. Настройте параметры прокси-сервера на шлюзе. Дополнительные сведения см. в разделе [Рекомендации для прокси-сервера](#proxy-server-considerations).
3. Удалите ограничение статических IP-адресов на прокси-сервере.

В качестве обхода проблемы можно использовать редактор фабрики данных на портале Azure, Visual Studio или Azure PowerShell.
 
## Перемещение шлюза с одного компьютера на другой
Этот раздел содержит процедуру перемещения клиента шлюза с одного компьютера на другой.

2. На портале перейдите на **главную страницу фабрики данных**, а затем щелкните плитку **Связанные службы**.

	![Ссылка на шлюзы данных](./media/data-factory-data-management-gateway/DataGatewaysLink.png)
3. Выберите нужный шлюз в разделе **ШЛЮЗЫ ДАННЫХ** в колонке **Связанные службы**.
	
	![Колонка «Связанные службы» с выбранным шлюзом](./media/data-factory-data-management-gateway/LinkedServiceBladeWithGateway.png)
4. В колонке **Шлюз данных** щелкните **Загрузить и установить шлюз данных**.
	
	![Ссылка на шлюз загрузки](./media/data-factory-data-management-gateway/DownloadGatewayLink.png)
5. В колонке **Настройка** щелкните **Скачивание и установка шлюза данных**, а затем следуйте инструкциям по установке шлюза данных на компьютере.

	![Колонка «Настройка»](./media/data-factory-data-management-gateway/ConfigureBlade.png)
6. Не закрывайте **диспетчер конфигурации шлюза управления данными**.
 
	![Менеджер конфигураций](./media/data-factory-data-management-gateway/ConfigurationManager.png)
7. В колонке **Настройка** на портале щелкните **Повторное создание ключа** на панели команд и щелкните **Да** в окне с предупреждением. Скопируйте ключ в буфер обмена с помощью **кнопки копирования** рядом с текстом ключа. Шлюз на старом компьютере прекращает работу сразу же, как только будет повторно создан ключ.
	
	![Повторное создание ключа](./media/data-factory-data-management-gateway/RecreateKey.png)
	 
8. Вставьте **ключ** в текстовое поле на странице **Регистрация шлюза** в **диспетчере конфигурации шлюза управления данными** на новом компьютере. (Необязательно) Чтобы увидеть текст ключа, установите флажок **Показать ключ шлюза**.
 
	![Копирование и регистрация ключа](./media/data-factory-data-management-gateway/CopyKeyAndRegister.png)
9. Щелкните **Зарегистрировать**, чтобы зарегистрировать шлюз в облачной службе.
10. На вкладке **Параметры** щелкните **Изменить**, чтобы выбрать сертификат, который использовался на старом шлюзе, затем введите **пароль** и щелкните **Готово**.
 
	![Выбор сертификата](./media/data-factory-data-management-gateway/SpecifyCertificate.png)

	Вы можете экспортировать сертификат из старого шлюза следующим образом. Запустите диспетчер конфигурации шлюза управления данными на старом компьютере, перейдите на вкладку **Сертификат**, нажмите кнопку **Экспорт** и следуйте инструкциям на экране.
10. После успешной регистрации шлюза вы увидите, что на главной странице диспетчера конфигурации шлюза значение параметра **Регистрация** изменилось на **Зарегистрировано**, а параметр **Состояние** получил значение **Запущено**.

## Шифрование учетных данных 
Для шифрования учетных данных в редакторе фабрики данных выполните следующие действия:

1. Запустите веб-браузер на **компьютере шлюза** и перейдите на [портал Azure](http://portal.azure.com). Найдите нужную фабрику данных и откройте ее в колонке **Фабрика данных**, а затем выберите **Создать и развернуть**, чтобы запустить редактор фабрики данных.
1. Щелкните имеющуюся **связанную службу** в представлении в виде дерева, чтобы просмотреть определение JSON для этой службы, или создайте связанную службу, которой требуется шлюз управления данными (например, SQL Server или Oracle).
2. В редакторе JSON для свойства **gatewayName** укажите имя шлюза.
3. Введите имя сервера в качестве значения для свойства **Data Source** в строке **connectionString**.
4. Введите имя базы данных в качестве значения для свойства **Initial Catalog** в строке **connectionString**.
5. Нажмите кнопку **Зашифровать** на панели команд, чтобы запустить ClickOnce-приложение **Диспетчер учетных данных**. Откроется диалоговое окно **Setting Credentials** (Настройка учетных данных). ![Диалоговое окно "Настройка учетных данных"](./media/data-factory-data-management-gateway/setting-credentials-dialog.png)
6. В диалоговом окне **Настройка учетных данных** выполните следующие действия.
	1.	Выберите тип **проверки подлинности**, который служба фабрики данных будет использовать для подключения к базе данных.
	2.	В поле **ИМЯ ПОЛЬЗОВАТЕЛЯ** укажите имя пользователя с доступом к базе данных.
	3.	В поле **ПАРОЛЬ** укажите пароль этого пользователя.
	4.	Нажмите кнопку **ОК**, чтобы зашифровать учетные данные и закрыть диалоговое окно.
5.	Теперь в **connectionString** должно появиться свойство **encryptedCredential**.
		
			{
	    		"name": "SqlServerLinkedService",
		    	"properties": {
		        	"type": "OnPremisesSqlServer",
			        "description": "",
		    	    "typeProperties": {
		    	        "connectionString": "data source=myserver;initial catalog=mydatabase;Integrated Security=False;EncryptedCredential=eyJDb25uZWN0aW9uU3R",
		            	"gatewayName": "adftutorialgateway"
		        	}
		    	}
			}

Если для доступа к порталу используется компьютер, отличный от компьютера шлюза, необходимо убедиться в том, что диспетчер учетных данных может подключиться к компьютеру шлюза. Если приложению не удается подключиться к компьютеру шлюза, вы не сможете задать учетные данные для источника данных и проверить подключение к нему.

Когда вы используете приложение **настройки учетных данных**, портал шифрует учетные данные с помощью сертификата, который указан на вкладке **Сертификат** в **диспетчере конфигурации шлюза** на компьютере шлюза.

Если вам нужен способ шифрования учетных данных на основе API, используйте командлет PowerShell [New-AzureRmDataFactoryEncryptValue](https://msdn.microsoft.com/library/mt603802.aspx). Командлет шифрует учетные данные с помощью сертификата, который настроен в шлюзе. Зашифрованные учетные данные добавляются в элемент **EncryptedCredential** в **connectionString** в JSON. JSON используется в командлете [New AzureRmDataFactoryLinkedService](https://msdn.microsoft.com/library/mt603647.aspx) или редакторе фабрики данных.

	"connectionString": "Data Source=<servername>;Initial Catalog=<databasename>;Integrated Security=True;EncryptedCredential=<encrypted credential>",

Для настройки учетных данных при помощи редактора фабрики данных существует еще один способ. Если при помощи редактора создать связанную службу SQL Server и ввести учетные данные в виде обычного текста, то эти учетные данные будут шифроваться с помощью сертификата, который принадлежит службе фабрики данных. Сертификат, который настроен для шлюза, НЕ используется. Хотя этот способ работает быстрее в некоторых случаях, он менее безопасен. Поэтому мы рекомендуем использовать его только для целей разработки и тестирования.


## Командлеты PowerShell 
В этом разделе описывается, как создать и зарегистрировать шлюз с использованием командлетов Azure PowerShell.

1. Запустите модуль **Azure PowerShell** в режиме администратора.
2. Войдите в учетную запись Azure, выполнив следующую команду и введя свои учетные данные Azure.

	Login-AzureRmAccount
2. Используйте командлет **New-AzureRmDataFactoryGateway** для создания логического шлюза следующим образом:

		$MyDMG = New-AzureRmDataFactoryGateway -Name <gatewayName> -DataFactoryName <dataFactoryName> -ResourceGroupName ADF –Description <desc>

	**Пример команды и выходных данных**:


		PS C:\> $MyDMG = New-AzureRmDataFactoryGateway -Name MyGateway -DataFactoryName $df -ResourceGroupName ADF –Description “gateway for walkthrough”

		Name              : MyGateway
		Description       : gateway for walkthrough
		Version           :
		Status            : NeedRegistration
		VersionStatus     : None
		CreateTime        : 9/28/2014 10:58:22
		RegisterTime      :
		LastConnectTime   :
		ExpiryTime        :
		ProvisioningState : Succeeded
		Key               : ADF#00000000-0000-4fb8-a867-947877aef6cb@fda06d87-f446-43b1-9485-78af26b8bab0@4707262b-dc25-4fe5-881c-c8a7c3c569fe@wu#nfU4aBlq/heRyYFZ2Xt/CD+7i73PEO521Sj2AFOCmiI

	
4. В Azure PowerShell перейдите в папку **C:\\Program Files\\Microsoft Data Management Gateway\\2.0\\PowerShellScript**. Выполните сценарий **RegisterGateway.ps1**, связанный с локальной переменной **$Key**, как показано в следующей команде. Этот сценарий регистрирует агент клиента, установленный на вашем компьютере с логическим шлюзом, созданным ранее.

		PS C:\> .\RegisterGateway.ps1 $MyDMG.Key
		
		Agent registration is successful!

	С помощью параметра IsRegisterOnRemoteMachine можно зарегистрировать шлюз на удаленном компьютере. Пример:
		
		.\RegisterGateway.ps1 $MyDMG.Key -IsRegisterOnRemoteMachine true

5. Вы можете использовать командлет **Get-AzureRmDataFactoryGateway**, чтобы получить список шлюзов своей фабрики данных. Если в поле **Состояние** указано значение **Подключено**, шлюз готов к эксплуатации.

		Get-AzureRmDataFactoryGateway -DataFactoryName <dataFactoryName> -ResourceGroupName ADF

Вы можете удалить шлюз, используя командлет **Remove-AzureRmDataFactoryGateway**, или обновить описание шлюза, используя командлет **Set-AzureRmDataFactoryGateway**. Дополнительную информацию о синтаксисе и другую информацию об этих командлетах см. в "Справочных материалах по командлетам фабрики данных".

### Вывод списка шлюзов с помощью PowerShell

	Get-AzureRmDataFactoryGateway -DataFactoryName jasoncopyusingstoredprocedure -ResourceGroupName ADF_ResourceGroup

### Удаление шлюза с помощью PowerShell
	
	Remove-AzureRmDataFactoryGateway -Name JasonHDMG_byPSRemote -ResourceGroupName ADF_ResourceGroup -DataFactoryName jasoncopyusingstoredprocedure -Force 


## Дальнейшие действия
- См. статью [Перемещение данных между локальными источниками и облаком с помощью шлюза управления данными](data-factory-move-data-between-onprem-and-cloud.md). В руководстве создается конвейер, который использует шлюз для перемещения данных из локальной базы данных SQL Server в большой двоичный объект Azure.

<!---HONumber=AcomDC_0921_2016-->