<properties
	pageTitle="Разработка и выполнение Функций Azure локально | Microsoft Azure"
	description="Узнайте, как писать и тестировать код для Функций Azure в Visual Studio перед их запуском в службе приложений Azure."
	services="functions"
	documentationCenter="na"
	authors="tdykstra"
	manager="erikre"
	editor=""/>

<tags
	ms.service="functions"
	ms.workload="na"
	ms.tgt_pltfrm="multiple"
	ms.devlang="multiple"
	ms.topic="article"
	ms.date="08/22/2016"
	ms.author="glenga"/>

# Как писать и тестировать код для Функций Azure в Visual Studio

## Обзор

Эта статья описывает, как выполнять [Функции Azure](functions-overview.md) локально, скачав в репозитории GitHub архив [WebJobs.Script](https://github.com/Azure/azure-webjobs-sdk-script/) и запустив включенное в него решение Visual Studio.

Среда выполнения для Функций Azure — это реализация проекта WebJobs.Script с открытым кодом. Этот проект, в свою очередь, основывается на [пакете SDK для веб-заданий Azure](../app-service-web/websites-dotnet-webjobs-sdk.md); обе платформы можно запустить локально. Но вам нужно будет подключиться к учетной записи хранения Azure, так как в пакете SDK для веб-заданий используются компоненты учетной записи хранения, не поддерживаемые в эмуляторе хранения.

Портал Azure позволяет легко писать и тестировать код, но иногда бывает удобно работать с проектом локально до его запуска в Azure. Например, с помощью [IntelliSense](https://msdn.microsoft.com/library/hcw1s69b.aspx) в Visual Studio легче писать код на некоторых языках, поддерживаемых Функциями Azure. Также в локальном расположении можно быстрее и проще выполнить удаленную отладку функций, а также отладку и настройку точек останова как в коде функции, так и в коде сервера скриптов веб-заданий.

>[AZURE.NOTE] Функции Azure сейчас доступны в режиме предварительной версии, так как базовые возможности и средства все еще разрабатываются. Процедуры, описанные в этой статье, не полностью соответствуют процессу локальной разработки в окончательный версии, и мы будем рады [получить от вас отзывы и комментарии](https://feedback.azure.com/forums/355860-azure-functions).

## Предварительные требования

### Учетная запись Azure с приложением функций

В этой статье предполагается, что вы уже работали с [Функциями Azure](functions-overview.md) на портале Azure и знакомы с такими понятиями, как [триггеры, привязки и объект JobHost](functions-reference.md).

При локальном запуске функций вы получаете выходные данные в окне консоли, но вам также пригодится и панель мониторинга в динамическом приложении функций для просмотра журналов и вызова функций.

### Visual Studio 2015 с пакетом Azure SDK для .NET последней версии

Если у вас нет Visual Studio 2015 или последнего пакета Azure SDK, [скачайте пакет Azure SDK для Visual Studio 2015](http://go.microsoft.com/fwlink/?linkid=518003). Visual Studio 2015 автоматически устанавливается с помощью пакета SDK (если это не было сделано ранее).

### Условные предварительные требования

Некоторые ресурсы Azure и программное обеспечение необходимы только для выполнения определенных функций, например:

* Ресурсы Azure
	* Service Bus
	* простые таблицы;
	* DocumentDB
	* Концентраторы событий
	* Центры уведомлений

* компиляторы и обработчики скриптов;
	* F#;
	* BASH;
	* Python
	* PHP

Подробные сведения об этих требованиях, включая обязательные переменные среды, см. на [вики-страницах репозитория с архивом WebJobs.Script](https://github.com/Azure/azure-webjobs-sdk-script/wiki/home)

Если вы намерены активно участвовать в развитии проекта WebJobs.SDK, следует выполнить все условные предварительные требования, чтобы проводить полный набор тестов.

## Локальный запуск

1. [Клонируйте](https://github.com/Azure/azure-webjobs-sdk-script/) или [скачайте](https://github.com/Azure/azure-webjobs-sdk-script/archive/master.zip) в репозитории архив Webjobs.Script.

2. Задайте переменные среды для строк подключения к хранилищу.

	* AzureWebJobsStorage
	* AzureWebJobsDashboard

	Эти значения можно получить на портале службы приложений в колонке **Параметры приложения** для приложения функций.

	а. В колонке **Приложение функций** щелкните **Параметры приложения функций**.

	![Щелкните "Параметры приложения функций"](./media/functions-run-local/clickfuncappsettings.png)
 
	b. В колонке **Параметры приложения функций** щелкните **Перейти к параметрам службы приложений**.

	![Щелкните "Параметры службы приложений"](./media/functions-run-local/clickappsvcsettings.png)
 
	c. В колонке **Параметры** щелкните **Параметры приложения**.

	![Щелкните "Параметры приложения"](./media/functions-run-local/clickappsettings.png)
 
	г) Прокрутите колонку **Параметры приложения** вниз до раздела **Параметры приложения** с настройками пакета SDK для веб-заданий.

	![Параметры веб-заданий](./media/functions-run-local/wjsettings.png)

	д. Задайте переменную среды с тем же именем и значением, как и для параметра приложения `AzureWebJobsStorage`.

	Е. Повторите эту операцию для параметра приложения `AzureWebJobsDashboard`.

2. Создайте переменную среды с именем AzureWebJobsServiceBus и присвойте ей значение, соответствующее строке подключения к служебной шине.

	Эта переменная среды нужна для привязок служебной шины, но мы рекомендуем создать ее, даже если вы их не используете. В некоторых случаях (независимо от использования привязок) из-за отсутствия строки подключения к служебной шине могут возникать исключения.

3. Убедитесь, что заданы все нужные переменные среды. (См. предыдущий раздел [Условные предварительные требования](#conditional-prerequisites).)

4. Запустите Visual Studio и откройте решение WebJobs.Script.

6. Укажите запускаемый проект. Если вам нужны функции, которые используют триггеры HTTP или веб-перехватчика, выберите **WebJobs.Script.WebHost**; в противном случае выберите **WebJobs.Script.Host**.

4. Если вы выбрали запускаемый проект WebJobs.Script.Host:

	а. В **обозревателе решений** щелкните правой кнопкой мыши проект WebJobs.Script.Host и выберите пункт **Свойства**.

	b. На вкладке **Отладка** в окне **Свойства проекта** установите для параметра **Аргументы командной строки** значение `..\..\..\..\sample`.

	![Аргументы командной строки](./media/functions-run-local/cmdlineargs.png)

	Это относительный путь к папке *sample* в решении. Папка *sample* содержит файл *host.json*, в котором указаны глобальные параметры, и отдельные папки для примеров функций.

	Чтобы быстро приступить к работе, используйте предоставленную папку *sample*. Позже вы сможете добавить собственные функции в папку *sample* или использовать любую другую папку с файлом *host.json* и папками функций.

5. Если вы выбрали запускаемый проект WebJobs.Script.WebHost:

	а. Присвойте переменной среды AzureWebJobsScriptRoot значение, в котором указан полный путь к папке `sample`.

	b. Перезапустите Visual Studio, чтобы вступило в силу новое значение переменной среды.

	Дополнительные сведения о запуске функций триггера HTTP см. в разделе с описанием [ключей API](#api-keys).

5. Откройте файл *sample\\host.json* и добавьте свойство `functions`, чтобы указать нужные функции для выполнения.

	Например, следующий код JSON сообщит объекту JobHost пакета SDK для веб-заданий, что нужно искать только две функции.

		{
		  "functions": [ "TimerTrigger-CSharp", "QueueTrigger-CSharp"],
		  "id": "5a709861cab44e68bfed5d2c2fe7fc0c"
		}

	Если вы используете собственную папку вместо предоставленной папки *sample*, поместите в нее только те функции, которые будете выполнять. Тогда свойство `functions` в файле *host.json* можно не указывать.
 
6. Выполните сборку и запуск решения.

	В окне консоли вы увидите, что JobHost находит только те функции, которые указаны в файле `host.json`.

		Found the following functions:
		Host.Functions.QueueTrigger-CSharp
		Host.Functions.TimerTrigger-CSharp
		Job host started

	При запуске проекта WebHost откроется пустая страница браузера, так как по основному URL-адресу проекта нет содержимого для обслуживания. Дополнительные сведения об URL-адресах для использования функций триггера HTTP см. в разделе с описанием [ключей API](#apikeys).

## Просмотр выходных данных функции

Перейдите к панели мониторинга приложения функций. Здесь можно просматривать вызовы функций и выходные данные журналов.

Панель мониторинга доступна по адресу:

	https://{function app name}.scm.azurewebsites.net/azurejobs/#/functions

Страница **Функции** содержит список выполненных функций и список вызовов функций.

![Сведения о вызове](./media/functions-run-local/invocationdetail.png)

Щелкните строку вызова функции, чтобы перейти на страницу **Сведения о вызове** и просмотреть время запуска функции, приблизительное время выполнения и состояние выполнения. Нажмите кнопку **Переключить вывод**, чтобы просмотреть записи журнала, созданные этой функцией.

![Сведения о вызове](./media/functions-run-local/invocationdetail.png)

## <a id="apikeys"></a> Ключи API для триггеров HTTP

Чтобы запустить функцию HTTP или веб-перехватчика, вам понадобится ключ API, если только в файл *function.json* не включен параметр `"authLevel": "anonymous"`.

Например, если ключ API — `12345`, при запущенном проекте WebJobs.Script.WebHost функцию *HttpTrigger* можно вызвать по следующему URL-адресу:

	http://localhost:28549/api/httptrigger?code=12345

(Также ключ API можно поместить в заголовок HTTP `x-functions-key`.)

Ключи API хранятся в файлах `.json` в папке [App\_Data/secrets](https://github.com/Azure/azure-webjobs-sdk-script/tree/master/src/WebJobs.Script.WebHost/App_Data/secrets) проекта WebJobs.Script.WebHost.

### Ключи API, которые применяются ко всем функциям HTTP и веб-перехватчика

В папке *App\_Data/secrets* есть файл *Host.json* с двумя ключами:

```json
{
  "masterKey": "hyexydhln844f2mb7hyexydhln844f2mb7",
  "functionKey": "7hyexydhn844f2mb7hyexydhln844f2mb7"
}
```

Свойство `functionKey` хранит ключ, который можно использовать для любой функции HTTP или веб-перехватчика, кроме тех, для которых эта возможность переопределена явным образом. Благодаря этому вам не нужно определять новые ключи API для каждой новой функции.

Свойство `masterKey` хранит ключ, который полезен в некоторых ситуациях тестирования.

* Если вы вызываете функцию веб-перехватчика с использованием главного ключа, пакет SDK для веб-заданий не проверяет подпись поставщика веб-перехватчика.

* Если вы вызываете функцию HTTP или веб-перехватчика с использованием главного ключа, функция будет запущена, даже если она отключена в файле *function.json*. Таким образом на портале Azure кнопка **Запуск** будет работать даже при отключенных функциях.
 
### Ключи API, которые применяются к отдельным функциям

Файлы с именами в формате *{имя\_функции}.json* содержат ключи API для соответствующих функций. Например, файл с приведенным ниже содержимым в формате JSON и именем *App\_Data/secrets/HttpTrigger.json* задает ключ API для функции `HttpTrigger`.

```json
{
  "key": "844f2mdhn844f2mb7hyexydhln844f2mb7"
}
```

## Использование ссылок на пакет NuGet в функциях  

В связи со способом обработки ссылок на пакеты NuGet необходимо задействовать файл *project.json* во время работы узла. Узел отслеживает изменения в файле и запускает восстановление при их обнаружении. Кроме того, файл *NuGet.exe* (рекомендуется версия 3.3.0) должен находиться в вашей папке, либо в папке с файлом *NuGet.exe* должна быть задана переменная среды с именем AzureWebJobs\_NuGetPath.

## Устранение неполадок

Если переменные среды изменяются во время работы Visual Studio, они не будут применены автоматически. Если вы добавляете или изменяете переменную среды после запуска Visual Studio, программу следует закрыть и перезапустить, чтобы новые значения вступили в силу.

При отладке можно получить дополнительные сведения об исключениях, выбрав элемент **Исключения среды CLR** в окне **Параметры исключений** (нажмите клавиши CTRL+ALT+E, чтобы открыть это окно).

Альтернативный способ получить эти сведения — указать точку останова в блоке `catch` основного цикла для сервера скриптов. Пример можно посмотреть в проекте WebJobs.Script в методе `RunAndBlock` файла *Host/ScriptHostManager.cs*.

## Дальнейшие действия

Для получения дополнительных сведений см. следующие ресурсы:

* [Справочник разработчика по функциям Azure](functions-reference.md)
* [Справочник разработчика C# по функциям Azure](functions-reference-csharp.md)
* [Справочник разработчика F# по функциям Azure](functions-reference-fsharp.md)
* [Справочник разработчика NodeJS по функциям Azure](functions-reference-node.md)
* [Azure Functions triggers and bindings (Триггеры и привязки в Функциях Azure)](functions-triggers-bindings.md)

<!---HONumber=AcomDC_0921_2016-->