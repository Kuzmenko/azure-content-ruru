<properties
   pageTitle="Ошибка резервного копирования виртуальной машины Azure: ";Не удалось запросить состояние моментального снимка в агенте ВМ. Истекло время ожидания для подзадачи моментального снимка ВМ"; | Microsoft Azure"
   description="Симптомы, причины и способы устранения проблем при резервном копировании виртуальной машины Azure, связанных с невозможностью запросить состояние моментальных снимков в агенте виртуальной машины. Ошибка ";Истекло время ожидания для подзадачи моментального снимка ВМ";"
   services="backup"
   documentationCenter=""
   authors="genlin"
   manager="jwhit"
   editor=""/>

<tags
    ms.service="backup"
    ms.workload="storage-backup-recovery"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="07/14/2016"
    ms.author="jimpark; markgal;genli"/>

# Ошибка резервного копирования виртуальной машины Azure: "Не удалось запросить состояние моментального снимка в агенте ВМ. Истекло время ожидания для подзадачи моментального снимка ВМ"

## Сводка

Когда виртуальная машина будет зарегистрирована в службе архивации Azure и для нее будет составлено расписание, служба архивации Azure в установленное время запустит задание резервного копирования. Она свяжется с модулем резервного копирования на виртуальной машине, который создаст снимок текущего состояния. При некоторых условиях создание моментального снимка невозможно, и это приводит к сбою резервного копирования. В этой статье описываются шаги по устранению неполадок, связанных с ошибками резервного копирования виртуальных машин Azure при превышении времени ожидания моментального снимка.

[AZURE.INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

## Симптом

Резервное копирование виртуальной машины IaaS в Microsoft Azure завершается сбоем, и в сведениях об ошибке задания на портале Azure отображается следующее сообщение об ошибке:

**Не удалось запросить состояние моментального снимка в агенте ВМ. Истекло время ожидания для подзадачи моментального снимка ВМ.**

## Причина:
Существует четыре основные причины этой ошибки:

- Виртуальная машина не подключена к Интернету.
- Устарел агент виртуальной машины Microsoft Azure, установленный на виртуальной машине (для виртуальных машин Linux).
- Не удалось обновить или загрузить расширение резервного копирования.
- Не удалось получить состояние моментальных снимков или создать моментальные снимки.

## Причина 1. Виртуальная машина не подключена к Интернету.
Согласно требованиям к развертыванию виртуальная машина не имеет доступа к Интернету или существуют ограничения на доступ к инфраструктуре Azure.

Для правильной работы расширения резервного копирования требуется возможность подключения к общедоступным IP-адресам Azure. Это связано с тем, что для управления моментальными снимками виртуальной машины это расширение отправляет команды к конечной точке хранилища Azure (URL-адрес HTTP). Если расширение не имеет доступа к общедоступному Интернету, резервное копирование завершится сбоем.

### Решение
В этом случае для устранения проблемы можно применить один из следующих методов:

- Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений.
- Создание пути для прохождения трафика HTTP

### Добавление диапазонов IP-адресов центра обработки данных Azure в список разрешений

1. Получите [список IP-адресов центра обработки данных Azure ](https://www.microsoft.com/download/details.aspx?id=41653) для добавления в список разрешений.
2. Разблокируйте IP-адреса с помощью командлета New-NetRoute. Запустите этот командлет на виртуальной машине Azure в окне PowerShell с повышенными привилегиями (от имени администратора).
3. Добавьте правила в группу безопасности сети (если она настроена) для доступа к IP-адресам.

### Создание пути для прохождения трафика HTTP

1. При наличии каких-либо ограничений сети (например, группы безопасности сети) разверните прокси-сервер HTTP для перенаправления трафика.
2. Если вы используете группу безопасности сети, добавьте правила, чтобы разрешить доступ к Интернету с прокси-сервера HTTP.

Узнайте, как [настроить прокси-сервер HTTP для резервного копирования виртуальной машины](backup-azure-vms-prepare.md#using-an-http-proxy-for-vm-backups).

## Причина 2. Устарел агент виртуальной машины Microsoft Azure, установленный на виртуальной машине (для виртуальных машин Linux)

### Решение
Большая часть неполадок, связанных с агентом или расширением на виртуальных машинах Linux, вызваны проблемами с устаревшим агентом виртуальной машины. В общем случае для устранения таких проблем прежде всего сделайте следующее.

1. [Установите последнюю версию агента виртуальной машины Azure](https://github.com/Azure/WALinuxAgent).
2. Убедитесь, что на виртуальной машине запущен агент Azure. Для этого выполните команду ```ps -e```.

    Если нужный процесс не запущен, используйте следующие команды для его перезапуска.

    Для Ubuntu: ```service walinuxagent start```.

    Для других дистрибутивов: ```service waagent start
```.

3. [Настройте автоматический перезапуск агента](https://github.com/Azure/WALinuxAgent/wiki/Known-Issues#mitigate_agent_crash).

4. Снова запустите резервное копирование для проверки. Если ошибки повторяются, для дальнейшей отладки соберите журналы из следующих папок.

    Мы просим клиентов предоставить следующие журналы виртуальной машины:

    - /var/lib/waagent/*.xml
    - /var/log/waagent.log
    - /var/log/azure/*

Если вас попросят включить подробное ведение журналов для waagent, выполните следующие действия.

1. В файле /etc/waagent.conf найдите такую строку:

    Enable verbose logging (y|n)

2. Для параметра **Logs.Verbose** измените значение с n на y.
3. Сохраните изменения и перезапустите waagent, как описано выше в этом разделе.

## Причина 3. Не удалось обновить или загрузить расширение резервного копирования
Если не удается загрузить расширения, получить моментальный снимок состояния невозможно, и резервное копирование завершится сбоем.

### Решение
Для гостевых систем Windows.

1. Убедитесь, что служба iaasvmprovider включена и для нее установлен автоматический тип запуска.
2. Если это не так, включите службу и проверьте, будет ли успешно выполнено следующее резервное копирование.

Для гостевой ОС Linux.

Последняя версия Linux VMSnapshot (расширение резервной копии) — 1.0.91.0.

Если расширение резервной копии по-прежнему не удается обновить или загрузить, попробуйте принудительно перезагрузить расширение VMSnapshot, удалив это расширение. Расширение будет перезагружено при следующей попытке резервного копирования.

### Удаление расширения

1. Перейдите на [портал Azure](https://portal.azure.com/).
2. Найдите виртуальную машину, с которой возникли проблемы при резервном копировании.
3. Щелкните **Параметры**.
4. Щелкните **Расширения**.
5. Щелкните **Расширение Vmsnapshot**.
6. Щелкните **Удалить**.

После этого расширение будет повторно установлено при следующем запуске резервного копирования.

## Причина 4. Не удалось получить состояние моментальных снимков или создать моментальные снимки
Резервное копирование виртуальных машин зависит от команды моментального снимка в базовом хранилище. Резервное копирование может завершиться сбоем, если эта задача не имеет доступа к хранилищу или если возникнет задержка в получении моментальных снимков.

### Решение
Сбой задачи создания снимка может быть вызван следующими условиями.

| Причина: | Решение |
| ----- | ----- |
| Виртуальные машины, для которых настроено резервное копирование Microsoft SQL Server. По умолчанию при резервном копировании виртуальной машины выполняется полное резервное копирование VSS на виртуальных машинах Windows. Если на виртуальной машине запущен сервер на основе SQL Server и настроено резервное копирование SQL Server, при выполнении моментального снимка может возникать задержка. | Если возникают ошибки резервного копирования из-за проблем с моментальными снимками, задайте следующий ключ реестра.<br><br>[HKEY\_LOCAL\_MACHINE\\SOFTWARE\\MICROSOFT\\BCDRAGENT] "USEVSSCOPYBACKUP"="TRUE" |
| Состояние виртуальной машины отображается неправильно из-за того, что работа виртуальной машины была завершена в сеансе удаленного рабочего стола. Когда вы завершаете работу виртуальной машины в сеансе удаленного рабочего стола, следует убедиться, что состояние виртуальной машины правильно отображается на портале. | Если это не так, завершите работу виртуальной машины на портале с помощью операции "Завершение работы" на панели мониторинга виртуальной машины. |
| Для нескольких виртуальных машин из одной облачной службы резервное копирование выполняется в одно и то же время. | Рекомендуется распределить виртуальные машины из одной облачной службы так, чтобы резервное копирование выполнялось в разное время. |
| Виртуальная машина использует большие ресурсы процессора или памяти. | Если виртуальная машина работает с высоким уровнем загрузки ЦП (более 90 %) или использует большой объем памяти, задача создания моментального снимка помещается в очередь и время ее ожидания истекает. В таких ситуациях попробуйте резервное копирование по запросу. |
|Виртуальная машина не может получить адрес узла или структуры от DHCP.|Для работы резервного копирования службы архивации на виртуальной машине IaaS DHCP должна быть включена для учетной записи гостя. Если виртуальная машина не может получить адрес узла или структуры в виде ответа DHCP 245, она не сможет загрузить или запустить расширения. Если вам нужен статический частный IP-адрес, следует настроить его через платформу. DHCP для виртуальной машины следует оставить включенным. См. дополнительные сведения в статье [Настройка статического внутреннего частного IP-адреса](../virtual-network/virtual-networks-reserved-private-ip.md).|

<!---HONumber=AcomDC_0921_2016-->