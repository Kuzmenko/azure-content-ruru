<properties
	pageTitle="Моделирование мультитенантности в Поиске Azure | Microsoft Azure | Размещенная облачная служба поиска"
	description="Узнайте о распространенных шаблонах разработки мультитенантных приложений SaaS с использованием Поиска Azure."
	services="search"
	authors="ashmaka"
	documentationCenter=""/>

<tags
	ms.service="search"
	ms.devlang="NA"
	ms.workload="search"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.date="09/20/2016"
	ms.author="ashmaka"/>

# Шаблоны разработки для мультитенантных приложений SaaS и Поиска Azure

Мультитенантным называется приложение, предоставляющее одинаковые службы и возможности любому числу клиентов, каждый из которых не может видеть или совместно использовать данные любого другого клиента. В этом документе рассматриваются стратегии изоляции клиентов в мультитенантных приложениях на основе Поиска Azure.

## Основные понятия Поиска Azure
Являясь решением поиска как услуги, Поиск Azure позволяет разработчикам добавлять широкие возможности поиска в приложения без необходимости управлять какой-либо инфраструктурой или становиться экспертом в области поиска. Данные передаются в службу и затем сохраняются в облаке. С помощью простых запросов к API Поиска Azure можно изменять и искать данные. Обзор данной службы можно найти в [этой статье](http://aka.ms/whatisazsearch). Прежде чем перейти к обсуждению шаблонов разработки, важно усвоить некоторые основные понятия, используемые в Поиске Azure.

### Службы поиска, индексы, поля и документы
При использовании Поиска Azure пользователь подписывается на _службу поиска_. После передачи в Поиск Azure данные сохраняются в _индексе_ в службе поиска. В одной службе может существовать множество индексов. Чтобы оперировать привычными понятиями баз данных, службу поиска можно сравнить с базой данных, а индексы в службе — с таблицами в базе данных.

Каждый индекс в службе поиска имеет свою собственную схему, которая определяется рядом настраиваемых _полей_. Данные добавляются в индекс Поиска Azure в виде отдельных _документов_. Каждый документ необходимо передать в определенный индекс, при этом данный документ должен соответствовать схеме индекса. При поиске данных с использованием Поиска Azure выполняются запросы полнотекстового поиска в определенном индексе. Чтобы провести аналогию этих понятий с базой данных, поля можно сравнить со столбцами в таблице, а документы — со строками.

### Масштабируемость
Любую службу Поиска Azure в [ценовой категории](https://azure.microsoft.com/pricing/details/search/) "Стандартный" можно масштабировать по двум измерениям: хранилищу и доступности.
* Можно добавлять _секции_ для увеличения хранилища службы поиска.
* Чтобы увеличить производительность запросов, которые может обработать служба поиска, в нее можно добавлять _реплики_.

Добавление и удаление секций и реплик в любое время позволяет увеличивать емкость службы поиска по мере роста объема данных и трафика, необходимых приложению. Чтобы служба поиска выполняла [соглашение об уровне обслуживания](https://azure.microsoft.com/support/legal/sla/search/v1_0/) чтения, требуется две реплики. Чтобы служба поиска выполняла [соглашение об уровне обслуживания](https://azure.microsoft.com/support/legal/sla/search/v1_0/) чтения и записи, требуется три реплики.


### Ограничения служб и индексов в Поиске Azure
В Поиске Azure существует несколько разных [ценовых категорий](https://azure.microsoft.com/pricing/details/search/), каждая из которых имеет свои [ограничения и квоты](search-limits-quotas-capacity.md). Некоторые из этих ограничений действуют на уровне службы, некоторые — на уровне индекса, а некоторые — на уровне секции.


| | базовая; | Standard1 | Standard2 | Standard3 | Standard3 HD |
|----------------------------------|-----------|-------------|-------------|-------------|---------------|
| Максимальное число реплик на службу | 3 | 12 | 12 | 12 | 12 |
| Максимальное число секций на службу | 1 | 12 | 12 | 12 | 1 |
| Максимальное число единиц поиска ((число реплик) * (число секций)) на службу | 3 | 36 | 36 | 36 | 12 |
| Максимальное число документов на службу | 1 млн | 180 млн | 720 млн | 1,4 млрд | 200 млн |
| Максимальный объем хранилища на службу | 2 ГБ | 300 ГБ | 1,2 ТБ | 2,4 ТБ | 200 ГБ |
| Максимальное число документов на секцию | 1 млн | 15 млн | 60 млн | 120 млн | 200 млн |
| Максимальный объем хранилища на секцию | 2 ГБ | 25 ГБ | 100 ГБ | 200 ГБ | 200 ГБ |
| Максимальное число индексов на службу | 5 | 50 | 200 | 200 | 1000 |


#### S3, высокая плотность
В ценовой категории S3 Поиска Azure существует вариант с режимом высокой плотности (HD), специально предназначенный для мультитенантных сценариев. В режиме высокой плотности ограничения SKU S3 несколько отличаются от стандартной конфигурации S3:
* Может быть до 1000 индексов на службе, а не 200.
* В службе может храниться до 200 ГБ данных, а не до 2,4 ТБ.
* В службе может быть только 1 секция, а не 12.

Уровень S3 HD идеально подходит для приложений с поддержкой SaaS, реализующих модель с индексом для каждого клиента, описанную ниже.


## Рекомендации для мультитенантных приложений
Мультитенантные приложения должны эффективно распределять ресурсы между клиентами, сохраняя при этом определенный уровень конфиденциальности между различными клиентами. Существует несколько рекомендаций по проектированию архитектуры подобного приложения.

* _Изоляции клиентов_. Разработчики приложений должны принять соответствующие меры, чтобы клиенты не имели возможности получить неавторизованный или нежелательный доступ к данным других клиентов. Помимо реализации конфиденциальности данных, стратегии изоляции клиентов требуют эффективного управления общими ресурсами и защиты от "шумных соседей".
* _Стоимость облачных ресурсов._ Как и любое другое приложение, программные решения должны обладать конкурентоспособной ценой в составе мультитенантного приложения.
* _Простота эксплуатации._ При разработке мультитенантной архитектуры важно учесть влияние на эксплуатацию и сложность приложения. Поиск Azure реализует [соглашение об уровне обслуживания 99,9 %](https://azure.microsoft.com/support/legal/sla/search/v1_0/).
* _Размещение по всему миру_. Мультитенантным приложениям может потребоваться эффективно обслуживать клиенты по всему миру.
* _Масштабируемость_. Разработчики приложений должны решить, как сохранить относительно низкий уровень сложности приложения и спроектировать приложение, которое можно масштабировать, чтобы обслуживать множество клиентов с учетом их размера данных и рабочей нагрузки.

Поиск Azure предлагает несколько границ, с помощью которых можно изолировать данные и рабочую нагрузку клиентов.

## Моделирование мультитенантности с использованием Поиска Azure
В случае мультитенантого сценария разработчик приложений использует одну или несколько служб поиска и разделяет их клиентов между службами и индексами. При моделировании мультитенантного сценария для Поиска Azure применяется несколько распространенных шаблонов.

1. _Индекс на каждого клиента_. Каждый клиент имеет собственный индекс в службе поиска, используемой совместно с другими клиентами.
1. _Служба на каждого клиента_. Каждый клиент имеет собственную выделенную службу Поиска Azure, что обеспечивает высочайший уровень разделения данных и рабочих нагрузок.
1. _Сочетание обоих вариантов_. Более активным клиентам большого размера назначаются выделенные службы, а небольшим клиентам назначаются отдельные индексы в общих службах.

## 1\. Индекс на каждого клиента
![Изображение модели с индексом на каждого клиента](./media/search-modeling-multitenant-saas-applications/azure-search-index-per-tenant.png)

В модели с индексом на каждого клиента несколько клиентов занимают одну службу Поиска Azure, в которой у каждого клиента есть собственный индекс.

Это обеспечивает изоляцию данных клиентов, так как все запросы на поиск и операции с документами выполняются на уровне индекса в Поиске Azure. На прикладном уровне имеется понимание необходимости перенаправлять трафик различных клиентов к соответствующим индексам, управляя при этом ресурсами всех клиентов на уровне службы.

Ключевой атрибут модели с индексом на каждого клиента заключается в том, что разработчик приложений может неравномерно распределить емкость службы поиска между подписанными на нее клиентами приложения. Если рабочая нагрузка неравномерно распределена между клиентами, то можно распределить оптимальное сочетание клиентов между индексами службы поиска, чтобы обслуживать ресурсоемкие высокоактивные клиенты, одновременно обслуживая длинную очередь менее активных клиентов. Недостаток модели заключается в том, что она не подходит для ситуаций, в которых все клиенты одновременно являются высокоактивными.

Модель с индексом на каждого клиента служит основой для модели с переменными затратами, в которой вся служба Поиска Azure приобретается предварительно, а затем последовательно заполняется клиентами. Это позволяет выделить неиспользуемую емкость для пробных и бесплатных учетных записей.

Для приложений, развертываемых по всему миру, модель с индексом на каждого клиента может быть не самой эффективной. Если клиенты приложения распределены по всему миру, то может потребоваться отдельная служба в каждом регионе, что может привести к повторным затратам в каждом из них.

Поиск Azure позволяет масштабировать емкость за счет увеличения как отдельных индексов, так и общего числа индексов. Если выбрана соответствующая ценовая категория, то во всю службу поиска можно будет добавить секции и реплики, когда какой-либо индекс в службе станет слишком большим с точки зрения потребляемых ресурсов хранения или трафика.

Если общее число индексов для одной службы становится слишком большим, то для обработки новых клиентов следует подготовить еще одну службу. Если требуется перемещать индексы между службами поиска по мере добавления новых служб, то данные из индекса нужно вручную копировать в другой индекс, так как Поиск Azure не разрешает перемещать индексы.


## 2) Служба на каждого клиента
![Изображение модели со службой на каждого клиента](./media/search-modeling-multitenant-saas-applications/azure-search-service-per-tenant.png)

В архитектуре со службой на каждого клиента каждый клиент имеет свою собственную службу поиска.

В этой модели приложение обеспечивает максимальный уровень изоляции своих клиентов. Каждая служба имеет выделенное хранилище и пропускную способность для обработки запросов на поиск, а также отдельные ключи API.

Модель со службой на каждого клиента отлично подойдет для приложений, в которых каждому клиенту требуется много ресурсов или рабочие нагрузки клиентов мало отличаются между собой, так как ресурсы не являются общими для рабочих нагрузок разных клиентов.

Данная модель также дает преимущества модели с прогнозируемыми, фиксированными затратами. Какие-либо первоначальные вложения во всю службу поиска отсутствуют, пока она не заполнится клиентами, однако затраты на каждого клиента выше, чем в модели с индексом на каждого клиента.

Модель со службой на каждого клиента — удачный выбор для приложений, развертываемых по всему миру. С помощью географически распределенных клиентов легко разместить службу для каждого клиента в соответствующем регионе.

При такой схеме трудности масштабирования возникают, когда отдельным клиентам перестает хватать емкости их службы. Поиск Azure в настоящее время не поддерживает изменение ценовой категории для службы поиска, поэтому все данные придется вручную скопировать в новую службу.

## 3\. Совмещение обеих моделей
Еще один шаблон для моделирования мультитенантности подразумевает совмещение модели с индексом на каждый клиента и модели со службой на каждый клиент.

При совмещении двух шаблонов наибольшие клиенты приложения могут занимать выделенные службы, а длинная очередь менее активных клиентов меньшего размера может занимать индексы в общей службе. Эта модель обеспечивает наибольшим клиентам постоянную высокую производительность обслуживания службой, помогая при этом защитить небольшие клиенты от "шумных соседей".

Тем не менее, для реализации этой стратегии понадобится спрогнозировать, каким клиентам потребуется выделенная служба, а каким — индекс в общей службе. Повышается сложность приложения, так как необходимо управлять обеими моделям мультитенантности.

## Достижение большей степени детализации
Приведенные выше шаблоны проектирования для моделирования мультитенантных сценариев в Поиске Azure рассчитаны на универсальную область применения, в которой каждый клиент — это целый экземпляр приложения. Однако иногда приложения могут обрабатывать несколько областей меньшего размера.

Если область применения модели со службой на каждого клиента и модели с индексом на каждого клиента недостаточно мала, можно смоделировать индекс для повышения степени детализации.

Чтобы один индекс функционировал по-разному для разных клиентских конечных точек, в него можно добавить поля, которые задают определенное значение для каждого возможного клиента. Каждый раз, клиент вызывает Поиск Azure для запроса или изменения индекса, код из клиентского приложения определяет соответствующее значение этого поля с использованием [фильтра](https://msdn.microsoft.com/library/azure/dn798921.aspx) Поиска Azure. Это осуществляется во время выполнения запроса.

Данный метод может использоваться для реализации отдельных учетных записей пользователей, отдельных уровней разрешений и даже полностью отдельных приложений.

## Дальнейшие действия
Поиск Azure — привлекательное решение для многих приложений. Вы можете прочитать [больше о надежных возможностях этой службы](http://aka.ms/whatisazsearch). При оценке различных шаблонов разработки для мультитенантных приложений рассмотрите [различные ценовые категории](https://azure.microsoft.com/pricing/details/search/) и соответствующие [ограничения службы](search-limits-quotas-capacity.md), чтоб подобрать наилучшее решение Поиска Azure для рабочих нагрузок приложения и архитектур любого размера.

Любые вопросы о Поиске Azure и мультитенантных сценариях можно отправить на электронный адрес azuresearch_contact@microsoft.com.

<!---HONumber=AcomDC_0921_2016-->