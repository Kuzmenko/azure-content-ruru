<properties 
	pageTitle="Создание среды службы приложений с внутренним балансировщиком нагрузки с помощью шаблонов Azure Resource Manager | Microsoft Azure" 
	description="Узнайте, как создать ASE с внутренним балансировщиком нагрузки с помощью шаблонов Azure Resource Manager." 
	services="app-service" 
	documentationCenter="" 
	authors="stefsch" 
	manager="nirma" 
	editor=""/>

<tags 
	ms.service="app-service" 
	ms.workload="na" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="09/21/2016" 
	ms.author="stefsch"/>

# Создание среды службы приложений с внутренним балансировщиком нагрузки с помощью шаблонов Azure Resource Manager

## Обзор ##
Вместо общедоступного виртуального IP-адреса для создания среды службы приложений (ASE) можно использовать внутренний адрес виртуальной сети. Этот внутренний адрес принадлежит компоненту Azure, который называется внутренним балансировщиком нагрузки. Среду ASE с внутренним балансировщиком нагрузки можно создать на портале Azure. Ее также можно создать автоматически с помощью шаблонов Azure Resource Manager. В этой статье описаны действия и синтаксис, необходимые для создания ASE с внутренним балансировщиком нагрузки с помощью шаблонов Azure Resource Manager.

Автоматическое создание среды ASE с внутренним балансировщиком нагрузки предусматривает три шага:
1. Сначала в виртуальной сети создается базовая среда ASE, для чего вместо общедоступного виртуального IP-адреса используется адрес внутреннего балансировщика нагрузки. Кроме того, на этом шаге ASE с внутренним балансировщиком нагрузки присваивается имя корневого домена.
2. После создания ASE с внутренним балансировщиком нагрузки загружается SSL-сертификат.
3. Переданный SSL-сертификат явным образом назначается ASE с внутренним балансировщиком нагрузки в качестве SSL-сертификата по умолчанию. Этот сертификат будет использоваться для передачи SSL-трафика на приложения в ASE с внутренним балансировщиком нагрузки, если при обращении к ним используется общий корневой домен, назначенный этой среде ASE (например, https://someapp.mycustomrootcomain.com).

## Создание базовой среды ASE с внутренним балансировщиком нагрузки ##
Пример шаблона Azure Resource Manager и соответствующий файл параметров доступны [на сайте GitHub][quickstartilbasecreate].

Большинство параметров в файле *azuredeploy.parameters.json* используются при создании как ASE с внутренним балансировщиком нагрузки, так и ASE с привязкой к общедоступному виртуальному IP-адресу. Ниже приведены параметры с особыми примечаниями и уникальные параметры, используемые при создании ASE с внутренним балансировщиком нагрузки.


- *interalLoadBalancingMode*. В большинстве случаев для этого параметра нужно задать значение 3. В таком случае HTTP- и HTTPS-трафик на портах 80 и 443 и порты канала данных и канала управления, прослушиваемые FTP-службой в ASE, будут привязаны к внутреннему адресу виртуальной сети, выделенному внутренним балансировщиком нагрузки. Если задать для этого свойства значение 2, к адресу внутреннего балансировщика нагрузки будут привязаны только порты, связанные со службой FTP (канала данных и канала управления), а HTTP- и HTTP-трафик останется привязанным к общедоступному виртуальному IP-адресу.
-  *dnsSuffix*. Этот параметр определяет корневой домен по умолчанию, который будет назначен ASE. В общедоступной версии службы приложений Azure корневой домен по умолчанию для всех веб-приложений — *azurewebsites.net*. Однако так как ASE с внутренним балансировщиком нагрузки является внутренней для виртуальной сети пользователя, бессмысленно использовать корневой домен по умолчанию общедоступной службы. Вместо этого ASE с внутренним балансировщиком нагрузки необходимо назначить корневой домен по умолчанию, который целесообразно использовать в пределах внутренней виртуальной сети компании. Например, гипотетическая компания Contoso может использовать корневой домен по умолчанию *internal-contoso.com* для приложений, которые должны быть разрешаемыми и доступными только в виртуальной сети компании Contoso.
-  *ipSslAddressCount*. Для этого параметра в файле *azuredeploy.json* автоматически задается значение 0, так как ASE с внутренним балансировщиком нагрузки назначен только адрес внутреннего балансировщика нагрузки. Для ASE с внутренним балансировщиком нагрузки нет явно заданных адресов SSL на основе IP, поэтому для пула этих адресов необходимо задать значение 0. В противном случае произойдет ошибка подготовки.

Когда файл *azuredeploy.parameters.json* для ASE с внутренним балансировщиком нагрузки будет заполнен, можно приступить к созданию соответствующей среды с помощью приведенного ниже фрагмента кода Powershell. Измените пути к файлам в соответствии с расположением файлов шаблонов Azure Resource Manager на вашем компьютере. Кроме того, введите собственные значения для имени развертывания Azure Resource Manager и группы ресурсов.

    $templatePath="PATH\azuredeploy.json"
    $parameterPath="PATH\azuredeploy.parameters.json"
    
    New-AzureRmResourceGroupDeployment -Name "CHANGEME" -ResourceGroupName "YOUR-RG-NAME-HERE" -TemplateFile $templatePath -TemplateParameterFile $parameterPath

После отправки шаблона Azure Resource Manager для создания ASE с внутренним балансировщиком нагрузки потребуется несколько часов. Созданная ASE с внутренним балансировщиком нагрузки появится на портале в списке сред службы приложений для подписки, использованной для развертывания.

## Загрузка и настройка SSL-сертификата по умолчанию ##

После создания среды ASE с внутренним балансировщиком нагрузки ей необходимо назначить SSL-сертификат по умолчанию, который будет использоваться для установки SSL-подключений к приложениям. Если DNS-суффикс по умолчанию среды ASE все той же гипотетической компании Contoso — *internal-contoso.com*, то для подключения к *https://some-random-app.internal-contoso.com* требуется SSL-сертификат, действительный для домена **.internal contoso.com*.

Есть множество способов получить действительный SSL-сертификат, в частности можно получить сертификат от внутреннего центра сертификации, приобрести его у внешнего поставщика и использовать самозаверяющий сертификат. Независимо от источника SSL-сертификата для него необходимо соответствующим образом настроить следующие атрибуты:

- *Субъект* — для этого атрибута необходимо задать значение **.имя\_корневого\_домена.com*.
- *Альтернативное имя субъекта* — этот атрибут должен содержать два значения: **.имя\_корневого\_домена.com* и **.scm.имя\_корневого\_домена.com*. Вторая запись требуется, так как для SSL-подключений к сайту SCM или Kudu, связанному с каждым приложением, будет использоваться адрес в формате *имя\_приложения.scm.имя\_корневого\_домена.com*.

После получения действительного SSL-сертификата требуется выполнить еще два дополнительных подготовительных действия. SSL-сертификат необходимо преобразовать в PFX-файл и сохранить в таком формате. PFX-файл должен содержать все промежуточные и корневые сертификаты, а также быть защищен паролем.

Затем PFX-файл необходимо преобразовать в строку Base64, так как SSL-сертификат будет загружен с использованием шаблона Azure Resource Manager. Эти шаблоны представлены в виде текстовых файлов. Такое преобразование требуется, чтобы добавить PFX-файл в качестве параметра шаблона.

В приведенном ниже фрагменте кода Powershell показано, как создать самозаверяющий сертификат, экспортировать его в формате PFX-файла, преобразовать PFX-файл в строку в кодировке Base64 и сохранить эту строку в отдельном файле. Код Powershell для преобразования в строку в кодировке Base64 взят из [блога сценариев Powershell][examplebase64encoding].

    $certificate = New-SelfSignedCertificate -certstorelocation cert:\localmachine\my -dnsname "*.internal-contoso.com","*.scm.internal-contoso.com"

    $certThumbprint = "cert:\localMachine\my" + $certificate.Thumbprint
    $password = ConvertTo-SecureString -String "CHANGETHISPASSWORD" -Force -AsPlainText

    $fileName = "exportedcert.pfx"
    Export-PfxCertificate -cert $certThumbprint -FilePath $fileName -Password $password     
    
    $fileContentBytes = get-content -encoding byte $fileName
    $fileContentEncoded = [System.Convert]::ToBase64String($fileContentBytes)
    $fileContentEncoded | set-content ($fileName + ".b64")
    
Когда SSL-сертификат будет создан и преобразован в строку в кодировке Base64, можно приступить к [настройке SSL-сертификата по умолчанию][configuringDefaultSSLCertificate] с использованием шаблона Azure Resource Manager, размещенного на сайте GitHub.

Ниже перечислены параметры, содержащиеся в файле *azuredeploy.parameters.json*.

- *appServiceEnvironmentName* — имя настраиваемой ASE с внутренним балансировщиком нагрузки.
- *existingAseLocation* — текстовая строка, содержащая регион Azure, где развернута ASE с внутренним балансировщиком нагрузки. Например, South Central US.
- *pfxBlobString* — представление PFX-файла в виде строки в кодировке Base64. Нужно скопировать строку, содержащуюся в файле exportedcert.pfx.b64, и вставить ее в качестве значения атрибута *pfxBlobString* в фрагменте кода выше.
- *password* — пароль, используемый для защиты PFX-файла.
- *certificateThumbprint* — отпечаток сертификата. Если вы получите это значение из Powershell (например, значение *$certificate.Thumbprint* в приведенном выше фрагменте кода), его можно использовать без каких-либо изменений. Однако если вы скопируете это значение в диалоговом окне сертификатов Windows, в нем нужно удалить лишние пробелы. Значение атрибута *certificateThumbprint* должно выглядеть следующим образом: AF3143EB61D43F6727842115BB7F17BBCECAECAE.
- *certificateName* — понятный идентификатор строки для идентификации сертификата, который пользователь может выбрать по своему усмотрению. Это имя используется как часть уникального идентификатора Azure Resource Manager для сущности *Microsoft.Web/certificates*, представляющей SSL-сертификат. Имя **должно** заканчиваться таким суффиксом: \_имя\_ASE\_InternalLoadBalancingASE. Этот суффикс сообщает порталу о том, что для обеспечения безопасности ASE с поддержкой ILB используется сертификат.


Ниже приведен сокращенный пример файла *azuredeploy.parameters.json*.


    {
         "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json",
         "contentVersion": "1.0.0.0",
         "parameters": {
              "appServiceEnvironmentName": {
                   "value": "yourASENameHere"
              },
              "existingAseLocation": {
                   "value": "East US 2"
              },
              "pfxBlobString": {
                   "value": "MIIKcAIBAz...snip...snip...pkCAgfQ"
              },
              "password": {
                   "value": "PASSWORDGOESHERE"
              },
              "certificateThumbprint": {
                   "value": "AF3143EB61D43F6727842115BB7F17BBCECAECAE"
              },
              "certificateName": {
                   "value": "DefaultCertificateFor_yourASENameHere_InternalLoadBalancingASE"
              }
         }
    }

Когда файл *azuredeploy.parameters.json* будет заполнен, переходите к настройке SSL-сертификата по умолчанию, используя приведенный ниже фрагмент кода Powershell. Измените пути к файлам в соответствии с расположением файлов шаблонов Azure Resource Manager на вашем компьютере. Кроме того, введите собственные значения для имени развертывания Azure Resource Manager и группы ресурсов.

    $templatePath="PATH\azuredeploy.json"
    $parameterPath="PATH\azuredeploy.parameters.json"
    
    New-AzureRmResourceGroupDeployment -Name "CHANGEME" -ResourceGroupName "YOUR-RG-NAME-HERE" -TemplateFile $templatePath -TemplateParameterFile $parameterPath

После отправки шаблона Azure Resource Manager применение изменений для одного внешнего интерфейса ASE займет примерно сорок минут. Например, для среды ASE с размером по умолчанию, содержащей два внешних интерфейса, реализация шаблона займет примерно один час и двадцать минут. Во время выполнения шаблона нельзя масштабировать среду ASE.

Когда шаблон будет реализован, к приложениям в среде ASE с внутренним балансировщиком нагрузки можно будет получать доступ по протоколу HTTPS, а подключения будут защищены с помощью SSL-сертификата по умолчанию. SSL-сертификат по умолчанию будет использоваться, если обращение к приложениям в ASE с внутренним балансировщиком нагрузки осуществляется с помощью сочетания имени приложения и имени узла по умолчанию. Например, в *https://mycustomapp.internal-contoso.com* будет использоваться SSL-сертификат по умолчанию для **.internal contoso.com*.

Так же как и для приложений в общедоступной мультитенантной службе, разработчики могут настроить для отдельных приложений пользовательские имена узлов и уникальные привязки сертификатов SNI SSL.


## Приступая к работе

Чтобы начать работу со средами службы приложений, см. статью [Введение в среду службы приложений](app-service-app-service-environment-intro.md)

Все статьи и практические руководства, посвященные средам службы приложений, доступны в [файле сведений для сред службы приложений](../app-service/app-service-app-service-environments-readme.md).

[AZURE.INCLUDE [app-service-web-whats-changed](../../includes/app-service-web-whats-changed.md)]

[AZURE.INCLUDE [app-service-web-try-app-service](../../includes/app-service-web-try-app-service.md)]

<!-- LINKS -->
[quickstartilbasecreate]: https://azure.microsoft.com/documentation/templates/201-web-app-ase-ilb-create/
[examplebase64encoding]: http://powershellscripts.blogspot.com/2007/02/base64-encode-file.html
[configuringDefaultSSLCertificate]: https://azure.microsoft.com/documentation/templates/201-web-app-ase-ilb-configure-default-ssl/
 

<!---HONumber=AcomDC_0921_2016-->