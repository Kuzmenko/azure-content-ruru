<properties
	pageTitle="Функции высокой доступности кластера HDInsight (Hadoop) под управлением Linux | Microsoft Azure"
	description="Узнайте, как использование дополнительного головного узла позволяет повысить надежность и доступность кластеров HDInsight под управлением Linux. Вы узнаете, как это влияет на службы Hadoop, такие как Ambari и Hive, а также как подключиться к каждому отдельному головному узлу с помощью SSH."
	services="hdinsight"
	editor="cgronlun"
	manager="jhubbard"
	authors="Blackmist"
	documentationCenter=""
	tags="azure-portal"/>

<tags
	ms.service="hdinsight"
	ms.workload="big-data"
	ms.tgt_pltfrm="na"
	ms.devlang="multiple"
	ms.topic="article"
	ms.date="09/13/2016"
	ms.author="larryfr"/>

#Доступность и надежность кластеров Hadoop в HDInsight

Платформа Hadoop обеспечивает высокий уровень доступности и надежности, распределяя избыточные копии служб и данных между узлами в кластере. Однако стандартные дистрибутивы Hadoop обычно имеют один головной узел. Любой сбой такого узла может вызвать прекращение работы кластера.

Для решения этой потенциальной проблемы кластеры HDInsight под управлением Linux в Azure предоставляют два головных узла для повышения доступности и надежности выполняемых служб и заданий Hadoop.

> [AZURE.NOTE] Действия, описанные в этом документе, относятся только к кластерам HDInsight под управлением Linux. Если вы используете кластер под управлением Windows, см. статью [Доступность и надежность кластеров Hadoop под управлением Windows в HDInsight](hdinsight-high-availability.md).

##Основные сведения об узлах

Узлы в кластере HDInsight реализуются с помощью виртуальных машин Azure. В случае сбоя узел переводится в автономный режим и взамен неисправного создается новый узел. Когда узел находится в автономном режиме, используется второй узел того же типа, пока не будет подключен новый узел.

> [AZURE.NOTE] Если сбой узла происходит в процессе анализа данных, ход выполнения этого задания будет утрачен. Задание, выполняемое неисправным узлом, будет передано другому узлу.

В следующих разделах рассматриваются отдельные типы узлов, которые используются с HDInsight. Не все типы узлов используются для определенного типа кластера. Например, тип кластера Hadoop не будет содержать узлы Nimbus. Дополнительные сведения об узлах, используемых типами кластера HDInsight, см. в разделе о типах кластеров статьи [Создание кластеров Hadoop под управлением Linux в HDInsight](hdinsight-hadoop-provision-linux-clusters.md#cluster-types).

###Головные узлы

В некоторых реализациях Hadoop есть только один головной узел, на котором размещены службы и компоненты, управляющие сбоями рабочих узлов без перебоев в работе. Однако любые отключения основных служб, работающих на головном узле, приводят к прекращению работы кластера.

В кластерах HDInsight предусмотрен дополнительный головной узел, на котором основные службы и компоненты могут продолжать работу в случае сбоя основного.

> [AZURE.IMPORTANT] Оба головных узла активны и работают в кластере одновременно. Некоторые службы, например HDFS или YARN, в отдельно взятый момент времени активны только на одном головном узле (а на другом находятся в «режиме ожидания»). Другие службы, например HiveServer2 или Hive MetaStore, активны одновременно на обоих головных узлах.

Головные узлы (и другие узлы в HDInsight) включают числовое значение как часть имени узла. Например, `hn0-CLUSTERNAME` или `hn4-CLUSTERNAME`.

> [AZURE.IMPORTANT] Числовое значение не зависит от того, каким является узел: основным или дополнительным. Это значение служит только для определения уникального имени каждого узла.

###Узлы Nimbus

В кластерах Storm узлы Nimbus предоставляют Hadoop JobTracker похожие функциональные возможности путем распределения и мониторинга обработки на рабочих узлах. HDInsight предоставляет два узла Nimbus для типа кластера Storm.

###Узлы Zookeeper

Узлы [ZooKeeper](http://zookeeper.apache.org/) (ZK) используются для выбора лидера основных служб на головных узлах, а также для уведомления служб, узлов данных (рабочих узлов) и шлюзов о том, на каком головном узле активна основная служба. По умолчанию HDInsight предоставляет три узла ZooKeeper.

###Рабочие узлы

Рабочие узлы выполняют анализ данных при отправке задания в кластер. Если происходит сбой рабочего узла, выполняемая задача отправляется на другой рабочий узел. По умолчанию HDInsight создает 4 рабочих узла. Это количество можно изменить в соответствии с потребностями пользователя как во время создания кластера, так и после.

###Граничный узел

Граничный узел не участвует активно в анализе данных в кластере. Его используют разработчики или специалисты по обработке и анализу данных при работе с Hadoop. Граничный узел находится в той же виртуальной сети Azure, что и другие узлы в кластере, и может получать непосредственный доступ ко всем остальным узлам. Поскольку он не участвует в анализе данных для кластера, его можно использовать без опасения отнять ресурсы у критически важных служб или заданий анализа Hadoop.

В настоящее время R Server в HDInsight является единственным типом кластера, который по умолчанию предоставляет граничный узел. В R Server в HDInsight граничный узел используется для локального тестирования кода R на узле перед его отправкой в кластер для распределенной обработки.

[Создание кластера HDInsight под управлением Linux с Hue на граничном узле](https://azure.microsoft.com/documentation/templates/hdinsight-linux-with-hue-on-edge-node/) является примером шаблона, который можно использовать для создания кластера типа Hadoop с граничным узлом.


## Доступ к узлам

Доступ к кластеру через Интернет осуществляется через открытый шлюз и ограничивается подключением к головным узлам и граничному узлу (при наличии в кластере HDInsight сервера R Server). На доступ к службам, работающим на головном узле, не влияет наличие нескольких головных узлов, т. к. открытый шлюз направляет запросы на тот головной узел, на котором размещается запрошенная служба. Например, если служба Ambari размещена на дополнительном головном узле, шлюз будет направлять входящие запросы для Ambari на этот узел.

При подключении к кластеру с помощью SSH через порт 22 (порт SSH по умолчанию) выполняется подключение к основному головному узлу, а при подключении через порт 23 — к дополнительному головному узлу. Например, `ssh username@mycluster-ssh.azurehdinsight.net` будет подключаться к основному головному узлу кластера с именем __mycluster__.

> [AZURE.NOTE] Это также касается протоколов, основанных на SSH, например протокола передачи файлов SSH (SFTP).

К граничному узлу с R Server в кластерах HDInsight также можно получать непосредственный доступ с помощью SSH через порт 22. Например, `ssh username@RServer.mycluster.ssh.azurehdinsight.net` подключится к граничному узлу для R Server в кластере HDInsight с именем __mycluster__.

### Внутренние полные доменные имена (FQDN)

Узлы в кластере HDInsight имеют внутренний IP-адрес и полное доменное имя, доступ к которым возможен только из кластера (например, в ходе сеанса SSH на головном узле или посредством задания, выполняемого в кластере). При доступе к службам в кластере с помощью внутреннего FQDN или IP-адреса следует использовать Ambari для проверки IP-адреса или FQDN, которые будут использоваться для доступа к службе.

Например, служба Oozie может выполняться только на одном головном узле, и при использовании команды `oozie` в сеансе SSH требуется URL-адрес службы. Его можно получить из Ambari с помощью следующей команды:

	curl -u admin:PASSWORD "https://CLUSTERNAME.azurehdinsight.net/api/v1/clusters/CLUSTERNAME/configurations?type=oozie-site&tag=TOPOLOGY_RESOLVED" | grep oozie.base.url

Будет возвращено примерно следующее значение, содержащее внутренний URL-адрес для использования с командой `oozie`:

	"oozie.base.url": "http://hn0-CLUSTERNAME-randomcharacters.cx.internal.cloudapp.net:11000/oozie"

### Доступ к узлам других типов

К узлам, которые недоступны напрямую через Интернет, можно подключаться следующими способами.

* __SSH__: после подключения к головному узлу с помощью SSH можно затем использовать SSH с головного узла для подключения к другим узлам в кластере.
* __Туннель SSH__: если необходим доступ к веб-службе, размещенной на неподключенном к Интернету узле, следует [использовать туннель SSH](hdinsight-linux-ambari-ssh-tunnel.md).
* __Виртуальная сеть Azure__: если кластер HDInsight является частью виртуальной сети Azure, любой ресурс в той же виртуальной сети может напрямую получать доступ ко всем узлам в кластере.

## Проверка состояния службы

Состояние служб, работающих на головных узлах, можно проверить с помощью веб-интерфейса Ambari или Ambari REST API.

###Веб-интерфейс Ambari

Веб-интерфейс Ambari можно просмотреть по адресу https://CLUSTERNAME.azurehdinsight.net. Замените **CLUSTERNAME** именем кластера. При появлении запроса введите учетные данные пользователя HTTP для кластера. По умолчанию используются имя пользователя HTTP **admin** и пароль, который вы ввели при создании кластера.

После входа на страницу Ambari слева вы увидите список установленных служб.

![Установленные службы](./media/hdinsight-high-availability-linux/services.png)

Существует ряд значков, которые могут отображаться рядом со службой и указывать ее состояние. Все оповещения, связанные с той или иной службой, можно просмотреть, щелкнув ссылку **Оповещения** в верхней части страницы. Чтобы просмотреть дополнительные сведения о службе, выберите ее.

На странице службы содержатся сведения о состоянии и конфигурации каждой службы, но не указывается, на каком головном узле она работает. Чтобы просмотреть эти сведения, щелкните ссылку **Узлы** в верхней части страницы. Отобразятся узлы кластера, включая головные.

![список узлов](./media/hdinsight-high-availability-linux/hosts.png)

Если выбрать ссылку на один из головных узлов, отобразятся службы и компоненты, работающие на этом узле.

![Состояние компонента](./media/hdinsight-high-availability-linux/nodeservices.png)

###Ambari REST API

Ambari REST API доступен через Интернет, а открытый шлюз обрабатывает запросы маршрутизации к головному узлу, на котором в настоящее время размещается REST API.

Чтобы проверить состояние службы с помощью интерфейса Ambari REST API, можно воспользоваться следующей командой:

	curl -u admin:PASSWORD https://CLUSTERNAME.azurehdinsight.net/api/v1/clusters/CLUSTERNAME/services/SERVICENAME?fields=ServiceInfo/state

* Замените **PASSWORD** паролем учетной записи пользователя (администратора) HTTP.

* Замените **CLUSTERNAME** именем кластера.

* Замените **SERVICENAME** именем службы, состояние которой нужно проверить.

Например, чтобы проверить состояние службы **HDFS** в кластере с именем **mycluster** и паролем **password**, нужно применить следующую команду:

	curl -u admin:password https://mycluster.azurehdinsight.net/api/v1/clusters/mycluster/services/HDFS?fields=ServiceInfo/state

Ответ будет выглядеть примерно так:

	{
	  "href" : "http://hn0-CLUSTERNAME.randomcharacters.cx.internal.cloudapp.net:8080/api/v1/clusters/mycluster/services/HDFS?fields=ServiceInfo/state",
	  "ServiceInfo" : {
	    "cluster_name" : "mycluster",
	    "service_name" : "HDFS",
	    "state" : "STARTED"
	  }
	}

URL-адрес указывает, что сейчас служба работает на узле с именем __hn0-CLUSTERNAME__.

Состояние указывает, что служба в настоящий момент запущена (**STARTED**).

Если вам неизвестно, какие службы установлены в кластере, их список можно получить с помощью следующей команды:

	curl -u admin:PASSWORD https://CLUSTERNAME.azurehdinsight.net/api/v1/clusters/CLUSTERNAME/services

####Компоненты служб

Иногда службы содержат компоненты, состояние которых может потребоваться проверить по отдельности. Например, служба HDFS содержит компонент NameNode. Чтобы просмотреть сведения о компоненте, используйте следующую команду:

	curl -u admin:PASSWORD https://CLUSTERNAME.azurehdinsight.net/api/v1/clusters/CLUSTERNAME/services/SERVICE/components/component

Если вам неизвестно, какие компоненты содержатся в службе, можно получить их список с помощью следующей команды:

	curl -u admin:PASSWORD https://CLUSTERNAME.azurehdinsight.net/api/v1/clusters/CLUSTERNAME/services/SERVICE/components/component
    
## Доступ к файлам журнала на головных узлах

###SSH

Если подключение к головному узлу установлено через SSH, файлы журнала можно найти в папке **/var/log**. Например, в папке **/var/log/hadoop-yarn/yarn** содержатся журналы для YARN.

Каждый головной узел может иметь уникальные записи журнала, поэтому следует проверить журналы на обоих узлах.

###SFTP

Кроме того, к головному узлу можно подключаться с помощью протокола передачи файлов SSH или безопасного протокола передачи файлов (SFTP) и напрямую загружать файлы журналов.

Как и при использовании клиента SSH, при подключении к кластеру необходимо указать имя учетной записи пользователя SSH и адрес SSH кластера. Пример: `sftp username@mycluster-ssh.azurehdinsight.net`. Необходимо также указать пароль для учетной записи при появлении запроса или предоставить открытый ключ, используя параметр `-i`.

После подключения отобразится строка `sftp>`. Из этой строки можно изменять каталоги, отправлять и загружать файлы. Например, следующие команды изменяют каталоги на каталог **/var/log/hadoop/hdfs**, а затем загружают все файлы в каталоге.

    cd /var/log/hadoop/hdfs
    get *

Для просмотра списка доступных команд введите `help` в строке `sftp>`.

> [AZURE.NOTE] Некоторые графические интерфейсы позволяют визуализировать файловую систему при подключении по протоколу SFTP. Например, [MobaXTerm](http://mobaxterm.mobatek.net/) позволяет просматривать файловую систему с помощью интерфейса, похожего на проводник Windows.


###Ambari

> [AZURE.NOTE] Для доступа к файлам журнала через Ambari требуется туннель SSH, так как веб-сайты отдельных служб не отображаются для всех пользователей в Интернете. Сведения об использовании туннеля SSH можно найти в разделе [Использование туннелирования SSH для доступа к веб-интерфейсу Ambari, ResourceManager, JobHistory, NameNode, Oozie и другим веб-интерфейсам](hdinsight-linux-ambari-ssh-tunnel.md).

В веб-интерфейсе Ambari выберите службу, для которой нужно просмотреть журналы (например, YARN), а затем щелкните **Быстрые ссылки**, чтобы выбрать головной узел, журналы которого следует просмотреть.

![Использование быстрых ссылок для просмотра журналов](./media/hdinsight-high-availability-linux/viewlogs.png)

## Настройка размера узла ##

Размер узла можно выбрать только во время создания кластера. Список различных размеров виртуальных машин, доступных для HDInsight, включая количество ядер, объем памяти и локального хранилища для каждого из них, можно найти на [странице цен на HDInsight](https://azure.microsoft.com/pricing/details/hdinsight/).

При создании нового кластера можно указать размер узлов. Далее приведены сведения о том, как указать размер узла с помощью [портала Azure][preview-portal], [Azure PowerShell][azure-powershell] и [Azure CLI][azure-cli].

* **Портал Azure**. При создании кластера можно задать размер (ценовую категорию) головного и рабочего узлов и узла ZooKeeper (если используется типом кластера) для этого кластера:

	![Изображение мастера создания кластера с выбором размера узла](./media/hdinsight-high-availability-linux/headnodesize.png)

* **Azure CLI**. При использовании команды `azure hdinsight cluster create` можно задать размер головного и рабочего узлов и узла ZooKeeper с помощью параметров `--headNodeSize`, `--workerNodeSize` и `--zookeeperNodeSize`.

* **Azure PowerShell**. При использовании командлета `New-AzureRmHDInsightCluster` можно задать размер головного и рабочего узлов и узла ZooKeeper с помощью параметров `-HeadNodeVMSize`, `-WorkerNodeSize` и `-ZookeeperNodeSize`.

##Дальнейшие действия

В этом документе вы узнали, как Azure HDInsight обеспечивает высокую доступность для Hadoop. Чтобы получить дополнительные сведения, см. следующие ресурсы:

- [Справочник по REST Ambari](https://github.com/apache/ambari/blob/trunk/ambari-server/docs/api/v1/index.md)

- [Установка и настройка CLI Azure](../xplat-cli-install.md)

- [Установка и настройка Azure PowerShell](../powershell-install-configure.md)

- [Управление кластерами HDInsight с помощью Ambari](hdinsight-hadoop-manage-ambari.md)

- [«Подготовка кластеров HDInsight на основе Linux»](hdinsight-hadoop-provision-linux-clusters.md)

[preview-portal]: https://portal.azure.com/
[azure-powershell]: ../powershell-install-configure.md
[azure-cli]: ../xplat-cli-install.md

<!---HONumber=AcomDC_0921_2016-->