<properties
   pageTitle="Безопасность на уровне строк в Power BI Embedded"
   description="Сведения о безопасности на уровне строк в Power BI Embedded"
   services="power-bi-embedded"
   documentationCenter=""
   authors="mgblythe"
   manager="NA"
   editor=""
   tags=""/>
<tags
   ms.service="power-bi-embedded"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="powerbi"
   ms.date="07/05/2016"
   ms.author="mblythe"/>

# Безопасность на уровне строк в Power BI Embedded

Безопасность на уровне строк можно использовать для ограничения доступа пользователей к определенным данным отчета или набора данных. При этом несколько различных пользователей могут работать в одном и том же отчете, но видеть разные данные. В Power BI Embedded теперь поддерживаются наборы данных, для которых настроена безопасность на уровне строк.

![](media\power-bi-embedded-rls\pbi-embedded-rls-flow-1.png)

Чтобы воспользоваться преимуществами безопасности на уровне строк, важно понять суть трех основных понятий: "Пользователи", "Роли" и "Правила". Давайте подробнее рассмотрим каждое из них.

**Пользователи** — это фактические пользователи, просматривающие отчеты. В Power BI Embedded пользователи идентифицируются по свойству username в маркере приложения.

**Роли**. Пользователям назначаются роли. Роль — это контейнер правил, которому можно присвоить имя "Менеджер по продажам" или "Торговый представитель". В Power BI Embedded пользователи идентифицируются по свойству roles в маркере приложения.

**Правила**. У ролей есть правила, представляющие собой фактические фильтры, которые будут применяться к данным. Это может быть просто "Страна — США" или что-то гораздо более динамичное.

### Пример

Далее в этой статье представлен пример настройки безопасности на уровне строк, а затем ее применения во встроенном приложении. В нашем примере используется PBIX-файл с [примером анализа данных о продажах](http://go.microsoft.com/fwlink/?LinkID=780547).

![](media\power-bi-embedded-rls\pbi-embedded-rls-scenario-2.png)

В нашем примере анализа данных о продажах показаны продажи для всех розничных магазинов определенной сети. Если не использовать безопасность на уровне строк, все региональные менеджеры, которые входят в систему и просматривают отчет, будут видеть одни и те же данные. Руководство решило, что каждый региональный менеджер должен видеть данные по продажам только тех магазинов, которыми он управляет. Для этого мы используем безопасность на уровне строк.

Безопасность на уровне строк настраивается в Power BI Desktop. После открытия набора данных и отчета можно перейти на представление схемы.

![](media\power-bi-embedded-rls\pbi-embedded-rls-diagram-view-3.png)

Ниже приведены некоторые примечания по этой схеме.

-	Все показатели, например **Общий объем продаж**, хранятся в таблице фактов **Продажи**.
-	Есть четыре дополнительных связанных таблицы измерений: **Позиция**, **Время**, **Хранилище** и **Район**.
-	Стрелки на линиях связей указывают, каким образом фильтры могут передаваться из одной таблицы в другую. Например, если фильтр размещен в таблице **Время для столбца даты**, на текущей схеме он будет отфильтровывать только значения в таблице **Продажи**. Так как все стрелки на линиях связей указывают на таблицу "Продажи", этот фильтр не будет влиять на остальные таблицы.
-	В таблице **Район** указаны менеджеры по каждому району.

    ![](media\power-bi-embedded-rls\pbi-embedded-rls-district-table-4.png)

Если в рамках этой схемы к столбцу **Региональный менеджер** в таблице "Район" применить фильтр, соответствующий пользователю, просматривающему отчет, таблицы **Хранилище** и **Продажи** будут также отфильтрованы. В результате отобразятся данные только для этого конкретного регионального менеджера.

Этот процесс описывается далее.

1.	На вкладке "Моделирование" щелкните **Управление ролями**. ![](media\power-bi-embedded-rls\pbi-embedded-rls-modeling-tab-5.png)

2.	Создайте роль с именем **Менеджер**. ![](media\power-bi-embedded-rls\pbi-embedded-rls-manager-role-6.png)

3.	В таблице **Район** введите следующее выражение DAX: **[Региональный менеджер] = USERNAME()**. ![](media\power-bi-embedded-rls\pbi-embedded-rls-manager-role-7.png)

4.	Чтобы убедиться, что правила работают, на вкладке **Моделирование** щелкните **Просмотреть как роли**, а затем введите следующую команду: ![](media\power-bi-embedded-rls\pbi-embedded-rls-view-as-roles-8.png)

    Теперь данные в отчетах будут отображаться таким образом, как будто вы вошли под именем **Эндрю Ma**.

При применении такого фильтра будут отфильтрованы все записи в таблицах **Район**, **Хранилище** и **Продажи**. Тем не менее из-за направления фильтра на линиях связей между таблицами **Продажи** и **Время**, **Продажи** и **Позиция**, а также **Позиция** и **Время** эти таблицы не будут отфильтрованы.

![](media\power-bi-embedded-rls\pbi-embedded-rls-diagram-view-9.png)

В нашем примере это приемлемый вариант, но если нужно, чтобы менеджеры не видели позиции не своих продаж, можно включить двунаправленную перекрестную фильтрацию для связи и направить фильтр безопасности в обоих направлениях. Для этого нужно изменить связи между таблицами **Продажи** и **Элемент** следующим образом:

![](media\power-bi-embedded-rls\pbi-embedded-rls-edit-relationship-10.png)

Теперь фильтры могут также направляться из таблицы "Продажи" в таблицу **Позиция**.

![](media\power-bi-embedded-rls\pbi-embedded-rls-diagram-view-11.png)

**Примечание**. При использовании режима DirectQuery для данных необходимо включить двунаправленную перекрестную фильтрацию, выбрав два следующих параметра:

1.	**Файл** -> **Параметры и настройки** -> **Предварительная версия функций** -> **Enable cross filtering in both directions for DirectQuery** (Включение перекрестной фильтрации в обоих направлениях для DirectQuery);
2.	**Файл** -> **Параметры и настройки** -> **DirectQuery** -> **Allow unrestricted measure in DirectQuery mode** (Разрешить неограниченный показатель в режиме DirectQuery).


Дополнительные сведения о двунаправленной перекрестной фильтрации см. в техническом документе [Bidirectional cross-filtering in SQL Server Analysis Services 2016 and Power BI Desktop](http://download.microsoft.com/download/2/7/8/2782DF95-3E0D-40CD-BFC8-749A2882E109/Bidirectional cross-filtering in Analysis Services 2016 and Power BI.docx) \(Двунаправленная перекрестная фильтрации в службах SQL Server Analysis Services 2016 и Power BI Desktop).

Это последнее, что нужно сделать в Power BI Desktop. Но необходимо проделать еще некоторую работу, чтобы правила безопасности на уровне строк, которые мы определили, работали в Power BI Embedded. Пользователи проходят проверку подлинности и авторизацию в приложении, а для предоставления им доступа к определенному отчету Power BI Embedded используются маркеры приложений. В Power BI Embedded нет сведений о том, кем является конкретный пользователь. Для работы безопасности на уровне строк потребуется передать некоторый дополнительный контекст как часть вашего маркера приложения.
-	**username** (необязательно) — используется с безопасностью на уровне строк. Это строка, с помощью которой можно идентифицировать пользователя при применении правил безопасности на уровне строк. См. статью Using Row Level Security with Power BI Embedded (Использование безопасности на уровне строк в Power BI Embedded).
-	**roles** — строка, содержащая роли, которые выбираются при применении правил безопасности на уровне строк. При выборе нескольких ролей их нужно передавать в виде массива строк.

Если задано свойство username, необходимо также передать по крайней мере одно значение для свойства roles.

Весь маркер приложения будет выглядеть примерно так:

![](media\power-bi-embedded-rls\pbi-embedded-rls-app-token-string-12.png)

Теперь вся работа проделана, и если пользователь войдет в наше приложение, чтобы просмотреть этот отчет, он увидит только те данные, к которым ему предоставлен доступ, как определено в безопасности на уровне строк.

![](media\power-bi-embedded-rls\pbi-embedded-rls-dashboard-13.png)

## Дополнительные материалы
[Безопасность на уровне строк в Power](https://powerbi.microsoft.com/ru-RU/documentation/powerbi-admin-rls/)

<!----HONumber=AcomDC_0907_2016-->