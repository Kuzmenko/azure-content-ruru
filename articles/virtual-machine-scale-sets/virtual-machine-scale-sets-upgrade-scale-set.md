<properties
	pageTitle="Развертывание приложения в наборах масштабирования виртуальных машин | Microsoft Azure"
	description="Развертывание приложения в наборах масштабирования виртуальных машин"
	services="virtual-machine-scale-sets"
	documentationCenter=""
	authors="gbowerman"
	manager="timlt"
	editor=""
	tags="azure-resource-manager"/>

<tags
	ms.service="virtual-machine-scale-sets"
	ms.workload="na"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/13/2016"
	ms.author="guybo"/>


# Обновление набора масштабирования виртуальных машин

В этой статье описывается, как развернуть обновление операционной системы в наборе масштабирования виртуальных машин Azure без каких-либо простоев. В данном контексте обновление ОС либо изменяет версию или SKU операционной системы, либо изменяет универсальный код ресурса (URI) пользовательского образа. Обновление без простоя означает обновление виртуальных машин по одной или группами (например, одновременно в одном домене сбоя), а не всех сразу. Таким образом все виртуальные машины, которые не обновляются, могут продолжать работу.

Чтобы избежать неоднозначности, следует различать три типа возможных обновлений операционной системы:

1. Изменение версии или SKU образа платформы. Например, изменение версии Ubuntu 14.04.2-LTS с 14.04.201506100 на 14.04.201507060 или изменение SKU Ubuntu 15.10/(последний выпуск) на Ubuntu 16.04.0-LTS/(последний выпуск). Этот сценарий описан в данной статье.

2. Вы создали новую версию пользовательского образа и хотите изменить универсальный код ресурса (URI), указывающий на этот образ (properties > virtualMachineProfile > storageProfile > osDisk > image > uri). Этот сценарий описан в данной статье.

3. Обновление путем частичной замены операционной системы на виртуальной машине (например, установка исправления для системы безопасности, использование Центра обновления Windows и т. д.). Этот сценарий поддерживается, но не описан в данной статье.

Требования к первым двум типам обновлений поддерживаются. Что касается третьего, по крайней мере на текущий момент, вам потребуется создать новый набор масштабирования, чтобы использовать этот тип обновления. В этой статье рассматриваются первые два типа обновления. Примечание. В статье не рассматриваются наборы масштабирования виртуальных машин, которые развернуты как часть кластера [Service Fabric](https://azure.microsoft.com/services/service-fabric/).

Основная последовательность изменения версии или SKU ОС образа платформы или универсального кода ресурса (URI) пользовательского образа выглядит следующим образом:

* Получение модели набора масштабирования виртуальных машин.

* Изменение значения версии, SKU или универсального кода ресурса (URI) в модели.

* Обновление модели.

* Выполнение вызова manualUpgrade для виртуальных машинах в наборе масштабирования. Этот шаг применяется только в том случае, если свойству upgradePolicy набора масштабирования присвоено значение Manual. Если присвоено значение Automatic, то все виртуальные машины обновляются одновременно, что приводит к простою.


Учтя эти общие сведения, давайте посмотрим, как можно обновить версию набора масштабирования в PowerShell и с помощью REST API. В статье приведены примеры для образа платформы, но, к счастью, мы предоставили достаточно информации, чтобы вы могли адаптировать этот процесс для пользовательского образа.

## PowerShell

В этом примере версия набора масштабирования виртуальных машин Windows обновляется до значения "4.0.20160229". После обновления модели выполняется поочередное обновление экземпляров виртуальной машины.

```powershell
$rgname = "myrg"
$vmssname = "myvmss"
$newversion = "4.0.20160229"
$instanceid = "1"

# get the VMSS model
$vmss = Get-AzureRmVmss -ResourceGroupName $rgname -VMScaleSetName $vmssname

# set the new version in the model data
$vmss.virtualMachineProfile.storageProfile.imageReference.version = $newversion

# update the VMSS model
Update-AzureRmVmss -ResourceGroupName $rgname -Name $vmssname -VirtualMachineScaleSet $vmss

# now start updating instances
Update-AzureRmVmssInstance -ResourceGroupName $rgname -VMScaleSetName $vmssname -InstanceId $instanceId
```

В случае обновления универсального кода ресурса (URI) для пользовательского образа вместо изменения версии образа платформы следует заменить строку "set the new version" примерно следующей.

```powershell
# set the new version in the model data
$vmss.virtualMachineProfile.storageProfile.osDisk.image.uri= $newURI
```


## С помощью REST API

Ниже приведена пара примеров на Python, использующих REST API Azure для развертывания обновления версии ОС. Оба используют упрощенную библиотеку [azurerm](https://pypi.python.org/pypi/azurerm), содержащую функции оболочки REST API Azure, для выполнения операции GET с моделью набора масштабирования и последующего выполнения операции PUT с обновленной моделью. Они также просматривают представления экземпляров виртуальных машин для идентификации виртуальных машин по домену обновления.

### vmssupgrade

vmssupgrade — это сценарий Python, предназначенный для развертывания обновления ОС в работающем наборе масштабирования виртуальных машин. При этом обновление осуществляется в доменах обновления поочередно. Этот сценарий можно найти [здесь](https://github.com/gbowerman/vmsstools).

![Снимок экрана vmssupgrade](./media/virtual-machine-scale-sets-upgrade-scale-set/vmssupgrade-screenshot.png)

Этот сценарий позволяет выбрать конкретные виртуальные машины для обновления или указать домен обновления. Он поддерживает изменение версии образа платформы или универсального кода ресурса (URI) пользовательского образа.

### vmsseditor

Это универсальный редактор наборов масштабирования виртуальных машин, отображающий состояние виртуальных машин в виде тепловой карты, в которой одна строка представляет один домен обновления. Помимо прочего, можно обновить модель для набора масштабирования виртуальных машин, указав новую версию, SKU или универсальный код ресурса (URI) пользовательского образа, а затем выбрать домены сбоя для обновления. После этого все виртуальные машины в данном домене обновления будут обновлены до новой модели. Кроме того, можно выполнить последовательное обновление на основе выбранного размера пакета. vmsseditor можно найти в следующем [репозитории GitHub](https://github.com/gbowerman/vmssdashboard).

Например, здесь модель набора масштабирования уже обновлена до Ubuntu 14.04-2LTS версии 14.04.201507060. Обратите внимание, что данный снимок экрана устарел, так как с момента его создания были добавлены многие другие параметры.

![Снимок экрана vmsseditor 1](./media/virtual-machine-scale-sets-upgrade-scale-set/vmssEditor1.png)

Если нажать кнопку "Upgrade" (Обновить), а затем — "Get Details" (Получить сведения), то начнется обновление виртуальных машин в домене обновления UD 0.

![Снимок экрана vmsseditor 2](./media/virtual-machine-scale-sets-upgrade-scale-set/vmssEditor2.png)

<!---HONumber=AcomDC_0921_2016-->