<properties
	pageTitle="Области, разрешения и предоставление согласия для Azure AD версии 2.0 | Microsoft Azure"
	description="Описание авторизации в конечной точке Azure AD версии 2.0, включая области, разрешение и предоставление согласия."
	services="active-directory"
	documentationCenter=""
	authors="dstrockis"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/16/2016"
	ms.author="dastrock"/>

# Области, разрешения и предоставление согласия для конечной точки версии 2.0

Приложения, интегрируемые с Azure AD, придерживаются определенной модели авторизации, позволяющей пользователям контролировать способ получения приложением доступа к их данным. Реализация версии 2.0 этой модели авторизации была обновлена, в результате чего изменился механизм взаимодействия приложения с Azure AD. В этой статье рассматриваются основные аспекты этой модели авторизации, включая области, разрешения и согласие на их предоставление.

> [AZURE.NOTE]
	Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0. Чтобы определить, следует ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).

## Области и разрешения

В Azure AD реализован протокол авторизации [OAuth 2.0](active-directory-v2-protocols.md). Это метод, позволяющий сторонним приложениям получать доступ к размещенным в Интернете ресурсам от имени пользователя. Любой размещенный в Интернете ресурс, интегрируемый с Azure AD, получает идентификатор ресурса или **URI идентификатора приложения**. К примеру, ниже приведены некоторые из размещенных в Интернете ресурсов Майкрософт:

- Единый API почты Office 365: `https://outlook.office.com`
- API Graph Azure AD: `https://graph.windows.net`
- Microsoft Graph: `https://graph.microsoft.com`

Это касается любых сторонних ресурсов, интегрированных с Azure AD. Любой из этих ресурсов также может определять набор разрешений, с помощью которых можно разделять функции ресурса на меньшие блоки. Например, в Microsoft Graph определено несколько разрешений:

- чтение календаря пользователя;
- запись в календарь пользователя;
- отправка сообщений в качестве пользователя.
- [и пр.](https://graph.microsoft.io)

Определив эти разрешения, ресурс обеспечивает точный контроль данных и внешнего доступа к ним. Стороннее приложение может запрашивать эти разрешения у пользователя, который должен будет предоставить их, чтобы приложение могло действовать от его имени. Путем фрагментации функций ресурса на меньшие наборы разрешений сторонние приложения можно настроить таким образом, чтобы они запрашивали только определенные разрешения, необходимые им для выполнения своей задачи. Такой подход также позволяет пользователям точно знать, как приложение будет использовать их данные, давая им большую уверенность в отсутствии вредоносных целей в работе приложения.

В Azure AD и OAuth эти разрешения называются **области**. Иногда их также называют **разрешениями OAuth2**. В Azure AD область представляется как строковое значение. Рассмотрим пример для Microsoft Graph. Значение области для каждого разрешения следующее:

- чтение календаря пользователя: `Calendar.Read`;
- запись в календарь пользователя: `Mail.ReadWrite`;
- Отправка сообщений в качестве пользователя: `Mail.Send`.

Приложение может запросить эти разрешения, указав области в запросах к конечной точке версии 2.0, как описано ниже.


## Согласие на предоставление разрешений

В запросе авторизации [OpenID Connect или OAuth 2.0](active-directory-v2-protocols.md) приложение может запросить необходимые разрешения с помощью параметра запроса `scope`. Например, при входе пользователя в приложение оно отправит запрос следующего вида (разрывы строк — для удобства чтения):

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=
https%3A%2F%2Fgraph.microsoft.com%2Fcalendar.read%20
https%3A%2F%2Fgraph.microsoft.com%2Fmail.send
&state=12345
```

Параметр `scope` — это запрашиваемый приложением список областей с разделителями-пробелами. Каждая отдельная область указывается путем добавления значения области к идентификатору ресурса (URI идентификатора приложения). Приведенный выше запрос указывает, что приложению требуется разрешение на чтение календаря пользователя и отправку сообщений от лица пользователя.

После того как пользователь введет учетные данные, конечная точка версии 2.0 проверит наличие соответствующей записи **согласия пользователя**. Если пользователь ранее не давал согласие на предоставление какого-либо из запрашиваемых разрешений, конечная точка версии 2.0 предложит пользователю сделать это.

![Снимок экрана предоставления разрешений рабочей учетной записи](../media/active-directory-v2-flows/work_account_consent.png)

После того как пользователь одобрит разрешение, факт согласия будет записан, чтобы пользователю не пришлось повторно давать его при входе в дальнейшем.

## Использование разрешений

После того как пользователь предоставит разрешения для приложения, оно может получать маркеры доступа, представляющие разрешение приложения на определенный уровень доступа к ресурсу. Каждый маркер доступа можно использовать для одного ресурса, но в нем будет закодировано каждое разрешение, предоставленное приложению для этого ресурса. Чтобы получить маркер доступа, приложение может отправить запрос на конечную точку маркеров версии 2.0:

```
POST common/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
	"grant_type": "authorization_code",
	"client_id": "6731de76-14a6-49ae-97bc-6eba6914391e",
	"scope": "https://outlook.office.com/mail.read https://outlook.office.com/mail.send",
	"code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
	"redirect_uri": "https://localhost/myapp",
	"client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

Полученный маркер доступа можно использовать в HTTP-запросах к ресурсу. Он гарантированно укажет ресурсу, что у приложения есть необходимое разрешение для выполнения определенной задачи.

Дополнительные сведения о протоколе OAuth 2.0 и способах получения маркеров доступа можно найти в [справочнике по протоколу конечной точки версии 2.0](active-directory-v2-protocols.md).

## Области OpenId Connect

Реализация OpenID Connect версии 2.0 содержит несколько четко определенных областей, которые не применяются к какому-либо конкретному ресурсу: `openid`, `email`, `profile` и `offline_access`.

#### OpenId

Если приложение выполняет вход с помощью [OpenID Connect](active-directory-v2-protocols.md#openid-connect-sign-in-flow), оно должно запросить область `openid`. В рабочей учетной записи область `openid` отобразится на экране предоставления разрешения в виде разрешения "Выполнение входа", а в личной ученой записи Майкрософт — в виде разрешения "Просмотр профиля и подключение к приложениям и службам с помощью учетной записи Майкрософт". Это разрешение позволяет приложению получать уникальный идентификатор для пользователя в виде утверждения `sub`. Оно также предоставляет приложению доступ к конечной точке сведений о пользователе. Область `openid` также можно использовать на конечной точке маркеров версии 2.0 для получения маркеров "id\_token", которые можно использовать для защиты HTTP-вызовов между разными компонентами приложения.

#### Email

Область `email` можно включать вместе с областью `openid` и любыми другими. Она предоставляет приложению доступ к основному электронному адресу пользователя в виде утверждения `email`. Утверждение `email` будет включено в маркеры, только если электронный адрес связан с учетной записью пользователя (а это не всегда так). При использовании области `email` приложение должно быть готово обрабатывать случаи, когда утверждение `email` отсутствует в маркере.

#### Профиль

Область `profile` можно включать вместе с областью `openid` и любыми другими. Она предоставляет приложению доступ к широкому набору сведений о пользователе. К ним, в частности, относятся имя и фамилия пользователя, предпочтительное имя пользователя, идентификатор объекта и т. д. Полный список утверждений профиля, доступных в маркерах id\_token для конкретного пользователя, см. в [справочнике по маркерам версии 2.0](active-directory-v2-tokens.md).

#### Offline\_Access

[Область `offline_access`](http://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess) позволяет приложению получать доступ к ресурсам от имени пользователя в течение длительного времени. На экране предоставления разрешения рабочей учетной записи эта область отображается в виде разрешения "Постоянный доступ к вашим данным". На экране предоставления разрешения личной учетной записи Майкрософт она отображается в виде разрешения "Постоянный доступ к вашим сведениям". Когда пользователь подтвердит область `offline_access`, приложение сможет получать маркеры обновления от конечной точки маркеров версии 2.0. Маркеры обновления действуют в течение долгого времени и позволяют приложению получать новые маркеры доступы по мере истечения срока действия старых.

Если приложение не запрашивает область `offline_access`, оно не получит маркеры обновления. Это значит, что при использовании кода авторизации в [потоке кода авторизации OAuth 2.0](active-directory-v2-protocols.md#oauth2-authorization-code-flow) вы получите только маркер доступа из конечной точки `/token`. Маркер доступа будет действительным короткое время (обычно один час), но в конечном итоге срок его действия истечет. В этот момент приложение будет необходимо перенаправить пользователя обратно в конечную точку `/authorize`, чтобы получить новый код авторизации. При этом пользователю может потребоваться повторно ввести учетные данные или повторно предоставить разрешения в зависимости от типа приложения.

Дополнительные сведения о том, как получать и использовать маркеры обновления, можно найти в [справочнике по протоколу версии 2.0](active-directory-v2-protocols.md).

<!---HONumber=AcomDC_0921_2016-->