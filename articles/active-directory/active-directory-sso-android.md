<properties
	pageTitle="Как включить единый вход для нескольких приложений Android с помощью ADAL | Microsoft Azure"
	description="Эта статья содержит информацию о том, как с помощью функций пакета SDK ADAL включить единый вход для нескольких приложений. "
	services="active-directory"
	documentationCenter=""
	authors="brandwe"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="android"
	ms.devlang="java"
	ms.topic="article"
	ms.date="09/16/2016"
	ms.author="brandwe"/>


# Как включить единый вход для нескольких приложений Android с помощью ADAL


Сегодня пользователи рассчитывают на возможность единого входа, позволяющую вводить учетные данные только один раз с последующим автоматическим входом в разные приложения. Сложность ввода имени пользователя и пароля на маленьком экране, часто с дополнительной проверкой подлинности, например посредством звонка по телефону или кода в SMS, приводит к неудовлетворенности пользователя, если ему приходится это делать больше одного раза.

Кроме того, если вы работаете с платформой удостоверений, которую могут использовать другие приложения, включая учетные записи Майкрософт и рабочую учетную запись Office 365, пользователи ожидают, что эти учетные данные будут доступны во всех приложениях независимо от поставщика.

Платформа удостоверений (Майкрософт), а также пакет SDK для этой платформы делают всю сложную работу за вас, предоставляя пользователям возможность единого входа либо во все используемые ими приложения, либо (с помощью брокера и приложений проверки подлинности) на всем устройстве.

В этом пошаговом руководстве описывается, как настроить пакет SDK в приложении, чтобы ваши пользователи смогли воспользоваться этими преимуществами.

Руководство применимо при работе с такими службами:

* Azure Active Directory
* Azure Active Directory B2C
* Azure Active Directory B2B
* Условный доступ к Azure Active Directory

Обратите внимание, что в документе ниже предполагается, что вы знаете о том, как [подготовить приложения на устаревшем портале для Azure Active Directory](active-directory-how-to-integrate.md), а также что вы интегрировали приложение с [пакетом Android SDK для Microsoft Identity](https://github.com/AzureAD/azure-activedirectory-library-for-android).

## Понятия, описывающие возможности единого входа с помощью платформы Microsoft Identity

### Брокеры Microsoft Identity

Корпорация Майкрософт предоставляет приложения для всех мобильных платформ, которые позволяют привязывать учетные данные к приложениям от разных поставщиков, а также разрешают использовать специальные расширенные компоненты, требующие единого безопасного расположения для проверки учетных данных. Они называются **брокеры**. В iOS и Android брокеры доступны в скачиваемых приложениях. Эти приложения пользователи устанавливают самостоятельно, либо их может передавать на устройство сотрудника компания, частично или полностью управляющая такими устройствами. Брокеры поддерживают управление безопасностью только для некоторых приложений или для всего устройства в зависимости от требований ИТ-администраторов. В Windows этот компонент предоставляется средством выбора учетной записи, встроенным в операционную систему (его техническое название — брокер веб-проверки подлинности).

Чтобы узнать, как мы используем эти брокеры и как клиенты могут увидеть их в потоке входа с помощью платформы Microsoft Identity, ознакомьтесь с дополнительными сведениями.

### Способы входа на мобильные устройства

Доступ к учетным данным на устройствах с поддержкой платформы Microsoft Identity осуществляется в рамках двух основных подходов:

* вход без брокера;
* вход с брокером.

#### Вход без брокера

Вход без брокера — это встроенная возможность входа в приложение с использованием локального хранилища на устройстве. Хотя доступ к этом хранилищу может осуществляться из других приложений, учетные данные строго привязаны к использующему их приложению или набору приложений. Такой подход вы, вероятно, использовали во многих мобильных приложениях, в которых имя пользователя и пароль вводятся непосредственно в приложении.

Такой способ входа отличается следующими преимуществами:

-  пользовательский интерфейс полностью реализован в приложении;
-  учетные данные можно передавать в приложения, подписанные с использованием одного и того же сертификата, что создает возможность единого входа во все ваши приложения;
-  управление процедурой входа в рамках приложения возможно как до, так и после входа.

Такой способ входа имеет следующие недостатки:

- пользователь не может выполнять единый вход во всех приложениях, в которых используется компонент Microsoft Identity. Единый вход доступен только в приложениях с собственными настроенными компонентами Microsoft Identity;
- в приложении не удается использовать расширенные бизнес-функции и компоненты, включая условный доступ или набор продуктов InTune;
- приложение не поддерживает проверку подлинности бизнес-пользователей на основе сертификатов.

Ниже показано, как с помощью пакетов SDK для Microsoft Identity можно включить единый вход, используя общее хранилище приложений.

```
+------------+ +------------+  +-------------+
|            | |            |  |             |
|   App 1    | |   App 2    |  |   App 3     |
|            | |            |  |             |
|            | |            |  |             |
+------------+ +------------+  +-------------+
| Azure SDK  | | Azure SDK  |  | Azure SDK   |
+------------+-+------------+--+-------------+
|                                            |
|            App Shared Storage              |
+--------------------------------------------+
```

#### Вход с брокером

Вход с брокером — это вход, выполняемый в приложении брокера с использованием хранилища и системы безопасности брокера для предоставления учетных данных всем приложениям на устройстве, которые используют платформу Microsoft Identity. Это означает, что ваши приложения используют брокер для входа пользователей в систему. В iOS и Android брокеры доступны в скачиваемых приложениях. Эти приложения пользователи устанавливают самостоятельно, либо их может передавать на устройство сотрудника компания, управляющая такими устройствами. Пример этого типа приложений — приложение Azure Authenticator в iOS. В Windows этот компонент предоставляется средством выбора учетной записи, встроенным в операционную систему (его техническое название — брокер веб-проверки подлинности). Этот способ входа зависит от платформы. При неправильном управлении он может мешать работе пользователей. Возможно, вы знакомы с этим способом входа, если у вас установлено приложение Facebook, с помощью которого вы входите в другие приложения. Платформа Microsoft Identity использует этот же принцип.

В iOS это реализовано в виде анимированного "перехода", в рамках которого ваше приложение переходит на задний план, а приложения Azure Authenticator — на передний, что позволяет пользователю выбрать учетную запись для входа.

В Android и Windows для удобства пользователя средство выбора учетной записи отображается поверх приложения.

#### Способы вызова брокера

После установки на устройство совместимого брокера (например, приложения Azure Authenticator) пакеты SDK для Microsoft Identity автоматически вызывают его, когда пользователь хочет войти с помощью любой учетной записи платформы Microsoft Identity. Это может быть персональная учетная запись Майкрософт, рабочая или учебная учетная запись либо учетная запись, предоставленная и размещенная в Azure с использованием продуктов B2C и B2B. Сверхнадежные алгоритмы защиты и шифрование гарантируют безопасность во время запрашивания учетных данных и их доставки вашему приложению. Точные технические сведения об этих механизмах не публикуются, но в их разработке участвовали компании Apple и Google.

**Разработчик может выбрать, будет ли SDK Microsoft Identity вызывать брокера или использовать поток без помощи брокера.** Если разработчик решит не использовать поток с брокером, он не сможет предоставить пользователям преимущества единого входа с помощью учетных данных, уже добавленных на устройство. Кроме того, он не сможет включить в приложение такие бизнес-функции Майкрософт, как условный доступ, возможности управления InTune и проверка подлинности на основе сертификатов.

Такой способ входа отличается следующими преимуществами:

-  пользователь выполняет единый вход во всех приложениях независимо от поставщика;
-  в приложении можно использовать расширенные бизнес-функции и компоненты, включая условный доступ или набор продуктов InTune;
-  приложение может поддерживать проверку подлинности бизнес-пользователей на основе сертификатов;
- более безопасная процедура входа — удостоверение приложения и пользователь проверяются приложением брокера с использованием шифрования и дополнительных алгоритмов безопасности.

Такой способ входа имеет следующие недостатки:

- в iOS пользователь выходит из приложения во время выбора учетных данных;
- невозможность управления процедурой входа пользователей в приложении.



Ниже показано, как с помощью пакетов SDK для Microsoft Identity можно включить единый вход, используя приложение брокера.

```
+------------+ +------------+   +-------------+
|            | |            |   |             |
|   App 1    | |   App 2    |   |   Someone   |
|            | |            |   |    Else's   |
|            | |            |   |     App     |
+------------+ +------------+   +-------------+
| Azure SDK  | | Azure SDK  |   | Azure SDK   |
+-----+------+-+-----+------+-  +-------+-----+
      |              |                  |
      |       +------v------+           |
      |       |             |           |
      |       | Microsoft   |           |
      +-------> Broker      |^----------+
              | Application
              |             |
              +-------------+
              |             |
              |   Broker    |
              |   Storage   |
              |             |
              +-------------+

```
              
Теперь, вооружившись базовыми сведениями, вы сможете лучше понимать возможности единого входа и эффективнее реализовывать их в своем приложении с помощью платформы Microsoft Identity и пакетов SDK.


## Включение единого входа для нескольких приложений с помощью ADAL

Дальше мы воспользуемся пакетом SDK ADAL для Android, чтобы:

- включить единый вход без помощи брокера для набора приложений;
- включить поддержку единого входа с помощью брокера.


### Включение единого входа без брокера

Когда для приложений включен единый вход без брокера, большей частью связанных с этой функцией процессов управляют пакеты SDK для Microsoft Identity. Сюда входит поиск нужного пользователя в кэше, а также хранение списка вошедших пользователей для выполнения запросов.

Включить единый вход для своих приложений можно так:

1. Убедитесь, что все приложения используют один идентификатор клиента или приложения.
* Убедитесь, что все приложения имеют один набор SharedUserID.
* Убедитесь, что все приложения используют один самозаверяющий сертификат из магазина Google Play для общего доступа к хранилищу.

#### Шаг 1. Использование одного идентификатора клиента или приложения для всех приложений в наборе

Чтобы платформа Microsoft Identity получила разрешение на использование в приложениях общих маркеров, всем этим приложениям нужно предоставить один и тот же идентификатор клиента или приложения. Это уникальный идентификатор, предоставленный вам при регистрации первого приложения на портале.

Возможно, вы еще не знаете, как службе Microsoft Identity различать разные приложения, ведь она использует только один идентификатор приложения. Все дело в **URI перенаправления**. Каждое приложение может иметь несколько кодов URI перенаправления, зарегистрированных на портале подключения. Каждое приложение в наборе получит уникальный код URI перенаправления. Вот как это выглядит:

URI перенаправления App1: `msauth://com.example.userapp/IcB5PxIyvbLkbFVtBI%2FitkW%2Fejk%3D`

URI перенаправления App2: `msauth://com.example.userapp1/KmB7PxIytyLkbGHuI%2UitkW%2Fejk%4E`

URI перенаправления App3: `msauth://com.example.userapp2/Pt85PxIyvbLkbKUtBI%2SitkW%2Fejk%9F`

....

Эти элементы вложены в один и тот же идентификатор клиента или приложения. Найти их можно по коду URI перенаправления, возвращаемого нам в конфигурации пакета SDK.

```
+-------------------+
|                   |
|  Client ID        |
+---------+---------+
          |
          |           +-----------------------------------+
          |           |  App 1 Redirect URI               |
          +----------^+                                   |
          |           +-----------------------------------+
          |
          |           +-----------------------------------+
          +----------^+  App 2 Redirect URI               |
          |           |                                   |
          |           +-----------------------------------+
          |
          +----------^+-----------------------------------+
                      |  App 3 Redirect URI               |
                      |                                   |
                      +-----------------------------------+

```


*Обратите внимание, что формат URI перенаправления представлен ниже. Вы можете использовать любой код URI перенаправления, если не хотите использовать брокер. В таком случае он будет выглядеть как показано выше.*


#### Шаг 2. Настройка общего хранилища в Android

Настройка идентификатора `SharedUserID` не описана в этом документе. См. соответствующие инструкции в документации по Google Android в разделе [Манифест](http://developer.android.com/guide/topics/manifest/manifest-element.html). Важно, что именно вы решаете, как следует назвать идентификатор sharedUserID, и используете его во всех ваших приложениях.

После того как вы добавите идентификатор `SharedUserID` во все свои приложения, вы сможете использовать единый вход.

> [AZURE.WARNING] 
Когда вы предоставите общий доступ к хранилищу всем своим приложениям, любое из них сможет удалить пользователей или, что еще хуже, все маркеры в приложении. Это может иметь катастрофические последствия, особенно если от маркеров зависит фоновая работа некоторых приложений. Общий доступ к хранилищу означает, что все операции удаления с помощью пакета SDK для Microsoft Identity теперь следует выполнять крайне осторожно.

Вот и все! Теперь пакет SDK для Microsoft Identity передаст учетные данные во все приложения. Кроме того, во все экземпляры приложений будет отправлен список пользователей.

### Включение единого входа с брокером

Возможность приложения использовать любой брокер, который установлен на устройстве, **по умолчанию отключена**. Чтобы пользоваться приложением с брокером, необходимо выполнить дополнительную настройку и добавить код в приложение.

Вот как это сделать:

1. Включите режим брокера в вызове пакета SDK MS, осуществляемом в коде приложения.
2. Укажите новый код URI перенаправления для самого приложения и его регистрации.
3. Настройте требуемые разрешения в манифесте Android.


#### Шаг 1. Включение режима брокера в приложении
Возможность использовать в приложении брокер включается во время создания параметров или при первоначальной настройке экземпляра проверки подлинности. Это можно сделать, настроив тип ApplicationSettings в коде.

```
AuthenticationSettings.Instance.setUseBroker(true);
```


#### Шаг 2. Настройка нового кода URI перенаправления в схеме URL-адреса

Вы можете обеспечить возврат маркеров учетных данных в нужное приложение. Для этого нужно убедиться, что способ выполнения обратного вызова к приложению доступен для проверки операционной системой Android. Операционная система Android использует хэш сертификата в магазине Google Play. Стороннее приложение не сможет подделать его. Следовательно, мы будем использовать его с кодом URI приложения брокера, обеспечивая тем самым возврат маркеров в нужное приложение. Вам нужно указать этот уникальный код URI перенаправления в приложении, а также выбрать его в качестве URI перенаправления на нашем портале разработчиков.

Формат кода URI перенаправления должен быть таким:

`msauth://packagename/Base64UrlencodedSignature`

например: *msauth://com.example.userapp/IcB5PxIyvbLkbFVtBI%2FitkW%2Fejk%3D*

Этот URI перенаправления должен быть указан при регистрации приложения на [классическом портале Azure](https://manage.windowsazure.com/). Дополнительные сведения о регистрации приложения Azure AD см. в статье [Интеграция с Azure Active Directory](active-directory-how-to-integrate.md).


#### Шаг 3. Настройка требуемых разрешений в приложении

В нашем приложении брокера в Android используется функция диспетчера учетных записей ОС Android для управления учетными данными в разных приложениях. Чтобы использовать брокер в приложении Android, ваш манифест приложения должен содержать разрешения на использование учетных записей AccountManager. Дополнительную информацию об этом см. [в документации Google по использованию диспетчера учетных записей](http://developer.android.com/reference/android/accounts/AccountManager.html).

Речь идет о следующих разрешениях:

```
GET_ACCOUNTS
USE_CREDENTIALS
MANAGE_ACCOUNTS
```

### Вы настроили единый вход!

Теперь пакет SDK для Microsoft Identity будет автоматически предоставлять учетные данные для приложений и вызывать брокер, если таковой есть на устройстве.

<!---HONumber=AcomDC_0921_2016-->