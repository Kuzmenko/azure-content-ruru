<properties
	pageTitle="Справочник по маркерам версии 2.0 в Azure AD | Microsoft Azure"
	description="Типы маркеров и утверждений, выдаваемых конечной точкой версии 2.0"
	services="active-directory"
	documentationCenter=""
	authors="dstrockis"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/16/2016"
	ms.author="dastrock"/>

# Справочник по маркерам версии 2.0

Конечная точка версии 2.0 выдает несколько типов маркеров при обработке каждого [потока проверки подлинности](active-directory-v2-flows.md). В этом документе описывается формат, характеристики безопасности и содержимое каждого типа маркера.

> [AZURE.NOTE]
	Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0. Чтобы определить, следует ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).

## Типы маркеров

Конечная точка версии 2.0 поддерживает [протокол авторизации OAuth 2.0](active-directory-v2-protocols.md), использующий как маркеры доступа, так и маркеры обновления. Она также поддерживает проверку подлинности и вход с помощью [OpenID Connect](active-directory-v2-protocols.md#openid-connect-sign-in-flow), вводя третий тип маркера — "id\_token". Каждый из этих маркеров представляется как "токен носителя".

Токен носителя — это упрощенный маркер безопасности, предоставляющий его носителя (предъявителю) доступ к защищенному ресурсу. В этом смысле предъявителем является любая сторона, которая может предъявить маркер. Несмотря на то, что для получения токена носителя сторона должны сначала пройти проверку подлинности в Azure AD, если действия, необходимые для защиты маркера при его передаче и хранении не выполняются, его может перехватить и использовать несанкционированная сторона. Хотя в некоторых маркерах безопасности для предотвращения несанкционированного использования применяется специальный встроенный механизм, в токенах носителя такого механизма нет, и они должны передаваться по защищенному каналу, например с использованием стандарта безопасности транспортного уровня (HTTPS). Если токен носителя передается в незашифрованном виде, злоумышленник может использовать атаку "злоумышленник в середине", чтобы получить токен и использовать его для несанкционированного доступа к защищенному ресурсу. Те же принципы безопасности применяются при сохранении или кэшировании токенов носителя для последующего использования. Необходимо всегда проверять, что приложение передает и сохраняет токены носителя безопасным образом. Дополнительные сведения о безопасности в случае применения токенов носителя см. в [RFC 6750, раздел 5](http://tools.ietf.org/html/rfc6750).

Многие маркеры, выданные конечной точной версии 2.0, реализуются в виде веб-маркеров JSON (JWT). Маркер JWT — это компактное и безопасное для URL-адреса средство передачи информации между двумя сторонами. Сведения, содержащиеся в маркерах JWT, называются "утверждениями" информации о носителе и субъекте токена. Утверждения в маркерах JWT — это объекты JSON, закодированные и сериализованные для передачи. Поскольку выдаваемые конечной точкой версии 2.0 маркеры JWT подписываются, но не зашифровываются, их содержимое можно без труда изучить с целью отладки. Дополнительные сведения о маркерах JWT можно найти в [спецификации JWT](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html).

## Маркеры id\_token

Маркеры "id\_token" — это разновидность маркера безопасности входа, который приложение получается при проверке подлинности с использованием [OpenID Connect](active-directory-v2-protocols.md#openid-connect-sign-in-flow). Они представлены в виде [маркеров JWT](#types-of-tokens) и содержат утверждения, которые можно использовать для входа пользователя в приложение. Вы можете использовать утверждения в маркере "id\_token" на свое усмотрение. Как правило, их используют для отображения сведений об учетной записи или управления доступом в приложении. Конечная точка версии 2.0 выдает только один тип маркера "id\_token", содержащий постоянный набор утверждений независимо от типа вошедшего пользователя. То есть формат и содержимое маркеров "id\_token" будут одинаковыми для пользователей как с личными учетными записями Майкрософт, так и с рабочими или учебными учетными записями.

На текущий момент маркеры "id\_token" подписываются, но не зашифровываются. Когда приложение получает маркер "id\_token", оно должно [проверить подпись](#validating-tokens), чтобы подтвердить подлинность маркера и проверить несколько содержащихся в нем утверждений для подтверждения его действительности. Утверждения, проверяемые приложением, зависят от требований сценария, но некоторые [стандартные проверки утверждений](#validating-tokens) приложение должно выполнять в каждом сценарии.

Полное описание утверждений в маркерах "id\_token" приведено ниже вместе с примером такого маркера. Обратите внимание, что утверждения в маркерах "id\_token" не возвращаются в определенном порядке. Кроме того, в любой момент в маркеры "id\_token" можно добавлять новые утверждения. При этом сбоев в работе приложения возникать не должно. В следующем списке приведены утверждения, которые приложение гарантированно понимает на момент написания этой статьи. При необходимости дополнительные сведения можно найти в [Спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html).

#### Пример маркера id\_token

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiI2NzMxZGU3Ni0xNGE2LTQ5YWUtOTdiYy02ZWJhNjkxNDM5MWUiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vYjk0MTk4MTgtMDlhZi00OWMyLWIwYzMtNjUzYWRjMWYzNzZlL3YyLjAiLCJpYXQiOjE0NTIyODUzMzEsIm5iZiI6MTQ1MjI4NTMzMSwiZXhwIjoxNDUyMjg5MjMxLCJuYW1lIjoiQmFiZSBSdXRoIiwibm9uY2UiOiIxMjM0NSIsIm9pZCI6ImExZGJkZGU4LWU0ZjktNDU3MS1hZDkzLTMwNTllMzc1MGQyMyIsInByZWZlcnJlZF91c2VybmFtZSI6InRoZWdyZWF0YmFtYmlub0BueXkub25taWNyb3NvZnQuY29tIiwic3ViIjoiTUY0Zi1nZ1dNRWppMTJLeW5KVU5RWnBoYVVUdkxjUXVnNWpkRjJubDAxUSIsInRpZCI6ImI5NDE5ODE4LTA5YWYtNDljMi1iMGMzLTY1M2FkYzFmMzc2ZSIsInZlciI6IjIuMCJ9.p_rYdrtJ1oCmgDBggNHB9O38KTnLCMGbMDODdirdmZbmJcTHiZDdtTc-hguu3krhbtOsoYM2HJeZM3Wsbp_YcfSKDY--X_NobMNsxbT7bqZHxDnA2jTMyrmt5v2EKUnEeVtSiJXyO3JWUq9R0dO-m4o9_8jGP6zHtR62zLaotTBYHmgeKpZgTFB9WtUq8DVdyMn_HSvQEfz-LWqckbcTwM_9RNKoGRVk38KChVJo4z5LkksYRarDo8QgQ7xEKmYmPvRr_I7gvM2bmlZQds2OeqWLB1NSNbFZqyFOCgYn3bAQ-nEQSKwBaA36jYGPOVG2r2Qv1uKcpSOxzxaQybzYpQ
```

> [AZURE.TIP] В целях обучения попробуйте изучить утверждения в примере маркера "id\_token", скопировав его в [calebb.net](https://calebb.net).

#### Утверждения в маркерах id\_token
| Имя | Утверждение | Пример значения | Описание |
| ----------------------- | ------------------------------- | ------------ | --------------------------------- |
| Аудитория | `aud` | `6731de76-14a6-49ae-97bc-6eba6914391e` | Определяет целевого получателя маркера. В маркерах "id\_token" целевая аудитория обозначена идентификатором приложения, назначенным ему на портале регистрации приложений. Приложение должно проверить это значение и отклонить маркер, если он ему не соответствует. |
| Издатель | `iss` | `https://login.microsoftonline.com/b9419818-09af-49c2-b0c3-653adc1f376e/v2.0 ` | Определяет службу маркеров безопасности (STS), которая создает и возвращает маркер, а также клиент Azure AD, в котором пользователь прошел проверку подлинности. Приложение должно проверить утверждение издателя и убедиться, что маркер пришел от конечной точки версии 2.0. Ему также следует использовать часть утверждения, содержащую GUID, для ограничения списка клиентов, которым разрешено входить в приложение. GUID, который указывает, что пользователь является потребителем с учетной записью Майкрософт: `9188040d-6c67-4c5b-b112-36a304b66dad`. |
| Выдано в | `iat` | `1452285331` | Время выдачи маркера в виде времени эпохи. |
| Время окончания срока действия | `exp` | `1452289231` | Время окончания срока действия маркера в виде времени эпохи. Приложение должно использовать это утверждение для проверки действительности срока действия маркера. |
| До | `nbf` | `1452285331` | Время начала срока действия маркера в виде времени эпохи. Обычно оно совпадает со временем выдачи. Приложение должно использовать это утверждение для проверки действительности срока действия маркера. |
| Версия | `ver` | `2.0` | Версия маркера "id\_token", как указано в Azure AD. Для конечной точки версии 2.0 используется значение `2.0`. |
| Идентификатор клиента | `tid` | `b9419818-09af-49c2-b0c3-653adc1f376e` | Идентификатор GUID, представляющий клиент Azure AD, который служит источником пользователя. Для рабочих и учебных учетных записей значением GUID будет неизменяемый идентификатор клиента организации, к которой принадлежит пользователь. Для личных учетных записей значением будет `9188040d-6c67-4c5b-b112-36a304b66dad`. Чтобы получить это утверждение, необходимо указать область `profile`. |
| Хэш-код | `c_hash` | `SGCPtt01wxwfgnYZy2VJtQ` | Хэш-код включается в состав маркеров "id\_token", только если маркер выдается вместе с кодом авторизации OAuth 2.0. Его можно использовать для проверки подлинности кода авторизации. Дополнительные сведения о выполнении этой проверки можно найти в [спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html). |
| Хэш маркера доступа | `at_hash` | `SGCPtt01wxwfgnYZy2VJtQ` | Хэш маркера доступа включается в состав маркеров "id\_token", только если маркер выдается вместе с маркером доступа OAuth 2.0. Его можно использовать для проверки подлинности маркера доступа. Дополнительные сведения о выполнении этой проверки можно найти в [спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html). |
| Специальное утверждение | `nonce` | `12345` | Специальные утверждения используются для предотвращения атак с использованием воспроизведения маркера. Приложение может указать специальное утверждение в запросе авторизации с помощью параметра запроса `nonce`. Значение, указанное вами в запросе, будет использовано в утверждении `nonce` маркера "id\_token" без изменений. Это позволяет приложению проверять это значение на соответствие значению, указанному в запросе, что связывает сеанс приложения с определенным маркером "id\_token". Приложение должно выполнять эту проверку во время процесса проверки маркера "id\_token". |
| Имя | `name` | `Babe Ruth` | Утверждение имени предоставляет удобное для восприятия значение, определяющее субъект маркера. Это значение не обязательно должно быть уникальным. Оно изменяемо и предназначено только для отображения. Чтобы получить это утверждение, необходимо указать область `profile`. |
| Email | `email` | `thegreatbambino@nyy.onmicrosoft.com` | Основной адрес электронной почты, связанный с учетной записью пользователя (если она существует). Его значение изменяемо и со временем может меняться для определенного пользователя. Чтобы получить это утверждение, необходимо указать область `email`. |
| Предпочтительное имя пользователя | `preferred_username` | `thegreatbambino@nyy.onmicrosoft.com` | Основное имя пользователя, используемое для представления пользователя на конечной точке версии 2.0. Это может быть адрес электронной почты, телефонный номер или универсальное имя пользователя без определенного формата. Его значение изменяемо и со временем может меняться для определенного пользователя. Чтобы получить это утверждение, необходимо указать область `profile`. |
| Субъект | `sub` | `MF4f-ggWMEji12KynJUNQZphaUTvLcQug5jdF2nl01Q` | Субъект, в отношении которого маркер утверждает сведения, например данные о пользователе приложения. Это значение является неизменным, его невозможно назначить другому объекту или использовать повторно. Следовательно, это значение можно использовать для безопасного проведения проверок авторизации, например, когда токен используется для доступа к ресурсу. Так как субъект всегда присутствует в выдаваемых Azure AD токенах, мы советуем использовать это значение в системе авторизации общего назначения. |
| ObjectId | `oid` | `a1dbdde8-e4f9-4571-ad93-3059e3750d23` | Идентификатор объекта рабочей или учебной учетной записи в системе Azure AD. Это утверждения не выдается для личных учетных записей Майкрософт. Чтобы получить это утверждение, необходимо указать область `profile`. |


## Маркеры доступа

На данный момент маркеры доступа, выданные конечной точкой версии 2.0, поддерживаются только службами Майкрософт. В рамках поддерживаемых в настоящее время сценариев приложениям не требуется выполнять проверку или изучение маркеров доступа. Маркеры доступа можно считать полностью непрозрачными: это просто строки, которые приложение может передавать Майкрософт через HTTP-запросы.

В ближайшем будущем конечная точка версии 2.0 позволит приложениям получать маркеры доступа от других клиентов. После появления такой возможности в эту статью будет добавлена информация, необходимая приложению для проверки подлинности маркера доступа и других похожих задач.

Когда вы запрашиваете маркер доступа у конечной точки версии 2.0, она также возвращает некоторые метаданные о маркере доступа для приложения. Эти сведения включают время окончания срока действия маркера доступа и области, для которых он действителен. Благодаря этому приложение может выполнять интеллектуальное кэширование маркеров доступа без необходимости анализа самого маркера.

## Маркеры обновления

Маркеры обновления — это маркеры безопасности, которые приложение может использовать для получения новых маркеров доступа в потоке OAuth 2.0. За счет этого приложение может получить длительный доступ к ресурсам от лица пользователя без необходимости участия самого пользователя.

Маркеры обновления относятся к нескольким ресурсам. Иными словами, маркер обновления, полученный при запросе маркера для одного ресурса, можно обменять на маркеры доступа к совершенно другому ресурсу.

Чтобы получить обновление в ответе маркера, приложение должно запросить область `offline_acesss` и получить ее. Дополнительные сведения об области `offline_access` можно найти в [этой статье о предоставлении разрешений и областях](active-directory-v2-scopes.md).

Маркеры обновления абсолютно непрозрачны для приложения и всегда будут таковыми. Они выдаются конечной точкой версии 2.0 Azure AD, и только эта точка может проверять и интерпретировать их. Они действительны в течение продолжительного времени, но при создании приложение не следует ожидать, что срок действия маркера обновления неограничен. Маркеры обновления могут стать недействительными в любое время по разным причинам. Единственный способ, которым приложение может выяснить, является ли маркер действительным, — попытаться использовать его путем отправки запроса маркера на конечную точку версии 2.0.

При обмене маркера обновления на новый маркер доступа (если при этом приложению предоставлена область `offline_access`) вы получите новый маркер обновления в ответе маркера. Сохраняйте новый маркер обновления, заменив им использованный в запросе. Такой подход обеспечит максимальный срок действия маркеров обновления.

## Проверка маркеров

В настоящее время приложениям нужно проверять только маркеры "id\_token". Для проверки маркера "id\_token" приложение должно проверить подпись маркера и содержащиеся в нем утверждения.

<!-- TODO: Link -->
Мы предоставляем библиотеки и примеры кода, демонстрирующие удобный способ проверки маркеров. Дальнейшие сведения приведены специально для желающих понять суть происходящего. Для проверки маркеров JWT также доступны несколько сторонних библиотек с открытым исходным кодом. Среди них вы найдете как минимум один вариант для каждой платформы и языка.

#### Проверка подписи
Маркер JWT содержит три сегмента, разделенных символом `.`. Первый сегмент называется **заголовок**, второй — **тело**, а третий — **подпись**. Сегмент подписи можно использовать для проверки подлинности маркера "id\_token", чтобы приложение доверяло ему.

Маркеры "id\_token" подписываются при помощи стандартных отраслевых алгоритмов асимметричного шифрования, таких как RSA 256. Заголовок маркера "id\_token" содержит сведения о ключе и методе шифрования, используемых для подписания маркера:

```
{
  "typ": "JWT",
  "alg": "RS256",
  "kid": "MnC_VZcATfM5pOYiJHMba9goEKY"
}
```

Утверждение `alg` определяет алгоритм, использованный для подписания токена, а утверждение `kid` — конкретный открытый ключ, использованный для подписания токена.

В любой момент времени конечная точка версии 2.0 может подписать маркер "id\_token" с использованием любой пары частных и общедоступных ключей из определенного их набора. Конечная точка версии 2.0 периодически изменяет возможный набор ключей, поэтому при создании приложения необходимо обеспечить автоматическую обработку подобных изменений ключей. Рекомендуем проверять наличие обновлений общедоступных ключей, используемых конечной точкой версии 2.0, каждые 24 часа.

Данные ключа подписи, необходимые для проверки подписи, можно найти в документе метаданных OpenID Connect по ссылке:

```
https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration
```

> [AZURE.TIP] Попробуйте ввести этот URL-адрес в браузере.

Этот документ метаданных представляет собой объект JSON, содержащий несколько ценных блоков информации, таких как расположение различных конечных точек, необходимых для проверки подлинности OpenID Connect.

Он также включает `jwks_uri`, который содержит расположение набора общедоступных ключей, использованных для подписания маркеров. Документ JSON, который находится в `jwks_uri`, содержит все сведения об открытых ключах, используемые в конкретный момент времени. Приложение может использовать утверждение `kid` в заголовке маркера JWT, чтобы выбрать открытый ключ в этом документе, использованный для подписания определенного маркера. Затем оно может выполнить проверку подписи с использованием правильного общедоступного ключа и указанного алгоритма.

Выполнение проверки подписи выходит за рамки этого документа. Если вам требуется помощь в этом вопросе, воспользуйтесь всевозможными библиотеками с открытым исходным кодом.

#### Проверка утверждений
Когда приложение получает маркер "id\_token" после входа пользователя, ему также требуется выполнить несколько проверок утверждений в этом маркере. Помимо прочего, к ним относятся:

- Утверждение **Аудитория**. Необходимо для подтверждения того, что маркер "id\_token" действительно должен был быть выдан вашему приложению.
- Утверждения **Выдано в** и **Время окончания срока действия**. Необходимы для подтверждения того, что срок действия маркера идентификации не истек.
- Утверждение **Издатель**. Необходимо для подтверждения того, что маркер был действительно выдан приложению конечной точкой версии 2.0.
- **Специальное утверждение**. Необходимо во избежание атаки с использованием воспроизведения маркеров.
- и многое другое...

Полный список проверок утверждений, которые должно выполнять ваше приложение, см. в [спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html#IDTokenValidation).

Подробные сведения об ожидаемых значениях для этих утверждений можно найти выше в [разделе "id\_token](#id_tokens).


## Время существования маркеров

Следующие сведения о сроках действия маркеров приведены исключительно в целях ознакомления, поскольку они могут пригодиться при разработке и отладке приложений. При создании приложения не следует ожидать постоянства какого-либо из указанных сроков, поскольку они могут и будут изменяться в любой момент времени.

| Маркер | Срок действия | Описание |
| ----------------------- | ------------------------------- | ------------ |
| Маркеры "id\_token" (рабочие или учебные учетные записи). | 1 час | Маркеры "id\_token" обычно действительны в течение часа. Веб-приложение может использовать тот же срок действия в рамках собственного сеанса с пользователем (рекомендуется) или выбрать совершенно другое время проведения сеанса. Если приложению требуется получить новый "id\_token", ему потребуется лишь отправить новый запрос на вход на конечную точку авторизации версии 2.0. Если у пользователя запущен сеанс браузера с конечной точкой версии 2.0, возможно, вводить учетные данные повторно не придется. |
| Маркеры "id\_token" (личные учетные записи) | 24 часа | Маркеры "id\_token" для личных учетных записей обычно действительны в течение 24 часов. Веб-приложение может использовать тот же срок действия в рамках собственного сеанса с пользователем (рекомендуется) или выбрать совершенно другое время проведения сеанса. Если приложению требуется получить новый "id\_token", ему потребуется лишь отправить новый запрос на вход на конечную точку авторизации версии 2.0. Если у пользователя запущен сеанс браузера с конечной точкой версии 2.0, возможно, вводить учетные данные повторно не придется. |
| Маркеры доступа (рабочие или учебные учетные записи) | 1 час | Указывается в ответах маркера как часть метаданных маркера. |
| Маркеры доступа (личные учетные записи) | 1 час | Указывается в ответах маркера как часть метаданных маркера. Срок действия маркеров доступа, выданных от имени личных учетных записей, можно изменить, но обычно он составляет один час. |
| Маркеры обновления (рабочая или учебная учетная запись) | До 14 дней | Один маркер обновления действителен до 14 дней. Однако маркер обновления может стать недействительным в любое время по различным причинам, поэтому приложение должно использовать маркер обновления, пока срок его действия не истечет, либо пока приложение не заменит его новым маркером. Маркер обновления также станет недействительным, если последний раз пользователь вводил учетные данные более 90 дней назад. |
| Маркеры обновления (личные учетные записи) | До 1 года | Один маркер обновления действителен до 1 года. Однако маркер обновления может стать недействительным в любое время по различным причинам, поэтому приложение должно использовать маркер обновления, пока срок его действия не истечет. |
| Коды авторизации (рабочие или школьные учетные записи) | 10 минут | Срок действия кодов авторизации специально ограничен, поэтому сразу же по получении их следует обменивать на маркеры доступа и обновления. |
| Коды авторизации (личные учетные записи) | 5 мин | Срок действия кодов авторизации специально ограничен, поэтому сразу же по получении их следует обменивать на маркеры доступа и обновления. Коды авторизации, выданные от имени личных учетных записей, также одноразовые. |

<!---HONumber=AcomDC_0921_2016-->