<properties
	pageTitle="Неявный поток Azure AD версии 2.0 | Microsoft Azure"
	description="Сведения о создании веб-приложений с помощью реализации неявного потока данных в одностраничных приложениях Azure AD версии 2.0."
	services="active-directory"
	documentationCenter=""
	authors="dstrockis"
	manager="msmbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/16/2016"
	ms.author="dastrock"/>

# Протоколы приложений версии 2.0. Одностраничные приложения с использованием неявного потока
Благодаря конечной точке версии 2.0 пользователи могут входить в одностраничные приложения, используя личные и рабочие учетные записи Майкрософт. Во время проверки подлинности одностраничные и другие приложения JavaScript, которые запускаются в основном в браузере, сталкиваются с некоторыми проблемами.

- Характеристики безопасности этих приложений значительно отличаются от традиционных серверных веб-приложений.
- Многие серверы авторизации и поставщики удостоверений не поддерживают запросы CORS.
- Полностраничный браузер перенаправляет пользователя из приложения, взаимодействие с которым становится особенно агрессивным.

Для этих приложений (AngularJS, Ember.js, React.js и т. д.) Azure AD поддерживает поток OAuth 2.0 Implicit Grant. Подробное описание неявного потока данных см. в [Спецификации OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-4.2). Его основное преимущество заключается в том, что приложение получает маркеры из Azure AD без предоставления учетных данных внутреннему серверу. Так, приложение может авторизовать пользователей, поддерживать сеансы и получать маркеры для других веб-API — и все это из клиентского кода JavaScript. Во время использования неявного потока данных необходимо обращать внимание на некоторые важные вопросы безопасности, касающиеся, в частности, [клиента](http://tools.ietf.org/html/rfc6749#section-10.3) и [маскировки под другого пользователя](http://tools.ietf.org/html/rfc6749#section-10.3).

Если для добавления проверки подлинности в приложение JavaScript вы хотите использовать неявный поток данных и Azure AD, рекомендуем использовать библиотеку открытого исходного кода JavaScript [adal.js](https://github.com/AzureAD/azure-activedirectory-library-for-js). [Здесь](active-directory-appmodel-v2-overview.md#getting-started) можно найти несколько учебников по AngularJS, которые помогут приступить к работе.

Тем не менее, в одностраничном приложении можно обойтись без использования библиотеки. Отправлять сообщения протокола в таком случае нужно самостоятельно. Для этого выполните следующие шаги.

> [AZURE.NOTE]
	Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0. Чтобы определить, следует ли вам использовать конечную точку 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).
    
## Схема протокола
Весь неявный поток входа выглядит примерно следующим образом (каждый этап подробно рассматривается ниже).

![Дорожки OpenID Connect](../media/active-directory-v2-flows/convergence_scenarios_implicit.png)

## Отправка запроса на вход

Для первого входа пользователя в приложение можно отправить запрос на авторизацию [OpenID Connect](active-directory-v2-protocols-oidc.md) и получить `id_token` из конечной точки версии 2.0:

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=id_token+token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&scope=openid%20https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&response_mode=fragment
&state=12345
&nonce=678910
```

> [AZURE.TIP] Чтобы выполнить этот запрос, щелкните ссылку ниже! После входа в браузере будет выполнено перенаправление на адрес `https://localhost/myapp/` с `id_token` в адресной строке. <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=id_token+token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=openid%20https%3A%2F%2Fgraph.microsoft.com%2Fmail.read&response_mode=fragment&state=12345&nonce=678910" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a>

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------- |
| tenant | обязательно | Значение `{tenant}` в пути запроса можно использовать для контроля того, кто может выполнять вход в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| response\_type | обязательно | Должен включать `id_token` для входа в OpenID Connect. Этот параметр также может содержать значение `token` параметра response\_type (тип ответа). Использование `token` здесь позволяет приложению получать токен доступа непосредственно от конечной точки авторизации, при этом отправлять новый запрос на вход в эту конечную точку не требуется. При использовании типа ответа `token` параметр `scope` должен содержать область, определяющую ресурсы, для которых необходимо выдавать токен. |
| redirect\_uri | рекомендуется | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | обязательно | Список областей с разделителями-пробелами. При использовании OpenID Connect он должен содержать область `openid`, преобразующуюся в разрешение "Выполнение входа" в пользовательском интерфейсе предоставления согласия. Если требуется доступ к дополнительным данным пользователя, можно также указать [области](active-directory-v2-scopes.md) `email` или `profile`. Этот запрос может также включать другие области в зависимости от ресурсов, к которым требуется получить доступ. |
| response\_mode | рекомендуется | Указывает метод, с помощью которого результирующий маркер будет отправлен приложению. Должен иметь значение `fragment` для неявного потока. |
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе токена. Это может быть строка любого контента. Как правило, для [предотвращения подделки межсайтовых запросов](http://tools.ietf.org/html/rfc6749#section-10.12) используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| nonce | обязательно | Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного токена "id\_token" в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения токена. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. |
| prompt | необязательный | Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — "login", "none" и "consent". При значении `prompt=login` пользователю придется вводить учетные данные по запросу. Единый вход не сработает. Значение `prompt=none` является противоположным — оно гарантирует, что интерактивные запросы не будут выводиться ни при каких обстоятельствах. Если запрос не удастся завершить автоматически через единый вход, конечная точка версии 2.0 вернет ошибку. После входа пользователя `prompt=consent` откроет диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению. |
| login\_hint | необязательный | Можно применять для предварительного заполнения поля имени пользователя или электронного адреса на странице входа пользователя (если имя пользователя известно заранее). Зачастую этот параметр используется в приложениях при повторной проверке подлинности. При этом имя пользователя извлекается во время предыдущего входа с помощью утверждения `preferred_username`. |
| domain\_hint | необязательный | Может использоваться значение `consumers` или `organizations`. Если используется этот параметр, процесс обнаружения на основе электронной почты, который проходит пользователь на странице входа в приложение версии 2.0, пропускается, что существенно оптимизирует работу. Обычно этот параметр используется в приложениях при повторной проверке подлинности. Для этого значение утверждения `tid` извлекается из параметра id\_token. Если значение утверждения `tid` — `9188040d-6c67-4c5b-b112-36a304b66dad`, следует использовать `domain_hint=consumers`. Или используйте `domain_hint=organizations`. |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка версии 2.0 также обеспечит согласие пользователя на предоставление разрешений, указанных в параметре запроса `scope`. Если пользователь не предоставил какие-либо из этих разрешений, конечная точка запросит их у пользователя. Подробные сведения о [разрешениях, согласии на предоставление и мультитенантных приложениях можно найти здесь](active-directory-v2-scopes.md).

После того как пользователь пройдет проверку подлинности и предоставит разрешения, конечная точка версии 2.0 вернет приложению ответ на указанный `redirect_uri` с помощью метода, указанного в параметре `response_mode`.

#### Успешный ответ

Успешный ответ с использованием `response_mode=fragment` и `response_type=id_token+token` выглядит следующим образом (разрывы строк — для удобства чтения):

```
GET https://localhost/myapp/#
access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&token_type=Bearer
&expires_in=3599
&scope=https%3a%2f%2fgraph.microsoft.com%2fmail.read 
&id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&state=12345
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| access\_token | Указывается, если параметр `response_type` содержит значение `token`. Это маркер доступа, запрошенный приложением. В данном случае для Microsoft Graph. Этот маркер не следует расшифровывать или каким-либо иным образом проверять. Его можно рассматривать как непрозрачную строку. |
| token\_type | Указывается, если параметр `response_type` содержит значение `token`. Всегда используется значение `Bearer`. |
| expires\_in | Указывается, если параметр `response_type` содержит значение `token`. Указывает количество секунд, в течение которых маркер остается допустимым (для кэширования). |
| scope | Указывается, если параметр `response_type` содержит значение `token`. Указывает области, для которых будет допустимым access\_token. |
| id\_token | Токен "id\_token", запрошенный приложением. Вы можете использовать токен "id\_token" для проверки удостоверения пользователя и запуска сеанса с пользователем. Дополнительные сведения о токенах "id\_token" и их содержимом можно найти в [справочном материале по токенам конечной точки версии 2.0](active-directory-v2-tokens.md). |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |


#### Сообщение об ошибке
Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение обрабатывало их должным образом:

```
GET https://localhost/myapp/#
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

## Проверка токена "id\_token"
Для проверки подлинности пользователя недостаточно просто получить токен "id\_token". Вам также потребуется проверить подпись токена "id\_token" и утверждения в нем в соответствии с требованиями приложения. В конечной точке версии 2.0 для подписи маркеров и проверки их правильности используются [веб-маркеры JSON (JWTs)](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) и шифрование с открытым ключом.

Вы можете выбрать проверку `id_token` в клиентском коде, но обычно `id_token` отправляется на проверку внутреннему серверу. После проверки подписи токена id\_token вам потребуется проверить несколько утверждений. Дополнительные сведения, в том числе о [проверке токенов](active-directory-v2-tokens.md#validating-tokens) и [информацию о смене ключей подписи](active-directory-v2-tokens.md#validating-tokens), см. в [справочнике по токенам версии 2.0](active-directory-v2-tokens.md). Советуем использовать библиотеку для синтаксического анализа и проверки токенов. Для большинства языков и платформ доступна по крайней мере одна такая библиотека.
<!--TODO: Improve the information on this-->

Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария. Ниже приведены некоторые из стандартных проверок:

- Обеспечение регистрации пользователя или организации в приложении.
- Предоставление пользователю необходимого уровня авторизации и привилегий.
- Обеспечение определенного уровня проверки подлинности, например многофакторной проверки подлинности.

Дополнительные сведения об утверждениях в параметре id\_token можно найти в [справочнике по токенам конечной точки версии 2.0](active-directory-v2-tokens.md).

После полной проверки токена "id\_token" вы можете начать сеанс с пользователем и использовать утверждения в токене "id\_token" для получения сведений о пользователе в приложении. Эти сведения можно использовать для отображения, записей, авторизации и т. д.

## Получение маркеров доступа

Теперь, когда пользователь вошел в одностраничное приложение, можно получить маркеры доступа для вызова веб-API, защищенных с помощью Azure AD, например [Microsoft Graph](https://graph.microsoft.io). Даже если вы уже получили токен с использованием параметра response\_type со значением `token`, этот метод можно использовать для получения токенов к дополнительным ресурсам. При наличии этих токенов пользователям не нужно повторно выполнять вход.

В обычных потоках OpenID Connect и OAuth маркеры можно получить, отправив запрос к конечной точке версии 2.0 `/token`. Однако конечная точка версии 2.0 не поддерживает запросы CORS. Поэтому получать и обновлять маркеры с помощью вызовов AJAX невозможно. Вместо этого для получения новых маркеров для других веб-API можно использовать неявный поток данных в скрытом iframe.

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read&response_mode=fragment
&state=12345&nonce=678910
&prompt=none
&domain_hint=organizations
&login_hint=myuser@mycompany.com
```

> [AZURE.TIP] Попробуйте скопировать и вставить запрос, показанный ниже, на вкладку браузера. (Не забудьте заменить значения `domain_hint` и `login_hint` на правильные значения для вашего пользователя.)

```
https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read&response_mode=fragment&state=12345&nonce=678910&prompt=none&domain_hint={{consumers-or-organizations}}&login_hint={{your-username}}
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------- |
| tenant | обязательно | Значение `{tenant}` в пути запроса можно использовать для контроля того, кто может выполнять вход в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| response\_type | обязательно | Должен включать `id_token` для входа в OpenID Connect. Параметр также может содержать другие типы response\_types, например `code`. |
| redirect\_uri | рекомендуется | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | обязательно | Список областей с разделителями-пробелами. Для получения токенов укажите все [области](active-directory-v2-scopes.md), необходимые для соответствующего ресурса. |
| response\_mode | рекомендуется | Указывает метод, с помощью которого результирующий маркер будет отправлен приложению. Может иметь значение `query`, `form_post` или `fragment`. |
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе токена. Это может быть строка любого контента. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| nonce | обязательно | Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного токена "id\_token" в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения токена. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. |
| prompt | обязательно | Для обновления и получения токенов в скрытом запросе iframe следует использовать `prompt=none`. Таким образом, запрос iframe не зависает на странице входа приложения версии 2.0 и сразу же возвращает данные. |
| login\_hint | обязательно | Для обновления и получения маркеров в скрытом запросе iframe необходимо включить в эту подсказку имя пользователя. Это позволяет различать сеансы пользователя в определенный момент времени. Имя пользователя можно извлечь из предыдущей операции входа с помощью утверждения `preferred_username`. |
| domain\_hint | обязательно | Может использоваться значение `consumers` или `organizations`. Для обновления и получения маркеров в скрытом запросе iframe необходимо включить в запрос domain\_hint. Необходимо извлечь значение утверждения `tid` из параметра id\_token предыдущей операции входа, чтобы определить, какое значение следует использовать. Если значение утверждения `tid` — `9188040d-6c67-4c5b-b112-36a304b66dad`, следует использовать `domain_hint=consumers`. Или используйте `domain_hint=organizations`. |

Благодаря параметру `prompt=none` этот запрос успешно выполнится или немедленно завершится с ошибкой, и вы вернетесь к своему приложению. Успешный ответ будет отправлен в ваше приложение на указанный `redirect_uri` с помощью метода, заданного в параметре `response_mode`.

#### Успешный ответ
Успешный ответ с использованием метода `response_mode=fragment` выглядит следующим образом:

```
GET https://localhost/myapp/#
access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&state=12345
&token_type=Bearer
&expires_in=3599
&scope=https%3A%2F%2Fgraph.windows.net%2Fdirectory.read
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| access\_token | Маркер, запрошенный приложением. |
| token\_type | Всегда будет использоваться значение `Bearer`. |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |
| expires\_in | Срок действия маркера доступа (в секундах). |
| scope | Области, для которых действителен маркер доступа. |

#### Сообщение об ошибке
Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение правильно обрабатывало их. Если вы используете `prompt=none`, отобразится следующая ошибка.

```
GET https://localhost/myapp/#
error=user_authentication_required
&error_description=the+request+could+not+be+completed+silently
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

После появления этой ошибки в запросе iframe пользователю необходимо войти еще раз в интерактивном режиме для получения нового маркера. Этот случай можно обрабатывать любым способом, который лучше всего подходит для вашего приложения.

## Обновление маркеров

Срок действия маркеров `id_token` и `access_token` очень короткий, поэтому приложение должно быть готово периодически обновлять их. Чтобы обновить маркер любого типа, выполните тот же скрытый запрос iframe, приведенный выше, используя параметр `prompt=none` для управления поведением Azure AD. Чтобы получить новый `id_token`, обязательно используйте `response_type=id_token` и `scope=openid`, а также параметр `nonce`.


## Отправка запроса на выход

Сейчас конечная точка версии 2.0 не поддерживает `end_session_endpoint` OpenID Connect. Это значит, что приложение не может отправлять запросы на конечную точку версии 2.0 для прекращения сеанса пользователя и очистки файлов cookie, установленных конечной точкой версии 2.0. Для выполнения выхода пользователя приложение может просто завершить собственный сеанс с пользователем, не затрагивая сеанс пользователя с конечной точкой версии 2.0. При следующей попытке входа пользователь увидит страницу выбора учетной записи с перечнем учетных записей, в которые выполнен вход. На этой странице пользователь может выйти из любой учетной записи, тем самым завершая сеанс с конечной точкой версии 2.0.

<!--

When you wish to sign the user out of the  app, it is not sufficient to clear your app's cookies or otherwise end the session with the user.  You must also redirect the user to the v2.0 endpoint for sign out.  If you fail to do so, the user will be able to re-authenticate to your app without entering their credentials again, because they will have a valid single sign-on session with the v2.0 endpoint.

You can simply redirect the user to the `end_session_endpoint` listed in the OpenID Connect metadata document:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/logout?
post_logout_redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
```

| Parameter | | Description |
| ----------------------- | ------------------------------- | ------------ |
| post_logout_redirect_uri | recommended | The URL which the user should be redirected to after successful logout.  If not included, the user will be shown a generic message by the v2.0 endpoint.  |

-->

<!---HONumber=AcomDC_0921_2016-->