<properties
	pageTitle="Конечная точка Azure AD версии 2.0 | Microsoft Azure"
	description="Сравнение первоначальной версии Azure AD и конечных точек версии 2.0."
	services="active-directory"
	documentationCenter=""
	authors="dstrockis"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/16/2016"
	ms.author="dastrock"/>

# В чем отличия конечной точки версии 2.0?

Если вы знакомы с Azure Active Directory или интегрировали приложения с Azure AD в прошлом, то можете столкнуться с некоторыми неожиданными отличиями в конечной точке версии 2.0. Они описаны в этом документе.

> [AZURE.NOTE]
	Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0. Чтобы определить, следует ли вам использовать конечную точку 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).


## Учетные записи Майкрософт и Azure AD
Конечная точка версии 2.0 позволяет разработчикам создавать приложения, поддерживающие вход с учетными записями Майкрософт и Azure AD с использованием одной конечной точки проверки подлинности. Это дает возможность разрабатывать приложения, которые полностью не зависят от учетных записей. Конечно, *можно* сообщить приложению, какая учетная запись используется в сеансе, но это необязательно.

Например, если приложение вызывает [Microsoft Graph](https://graph.microsoft.io), корпоративным пользователям будут доступны некоторые дополнительные функции и данные, такие как сайты SharePoint или данные каталога. Но многие действия, такие как [чтение почты пользователя](https://graph.microsoft.io/docs/api-reference/v1.0/resources/message), можно выполнять с помощью одного кода для учетных записей Майкрософт и Azure AD.

Теперь интеграция приложения с учетными записями Майкрософт и Azure AD — один простой процесс. Вы можете использовать один набор конечных точек, одну библиотеку и один процесс регистрации приложения для получения доступа как к потребительскому, так и корпоративному миру. Дополнительные сведения о конечной точке версии 2.0 см. в этом [обзоре](active-directory-appmodel-v2-overview.md).


## Новый портал регистрации приложений
Конечную точку версии 2.0 можно зарегистрировать только в новом расположении: [apps.dev.microsoft.com](https://apps.dev.microsoft.com). Это портал, где вы можете получить идентификатор приложения, настроить внешний вид страницы входа и т. д. Для доступа к порталу нужна только учетная запись Майкрософт — личная, рабочая или учебная.

Мы продолжим расширять возможности этого портала регистрации приложений. Наша цель — сделать этот портал новым ресурсом, где вы сможете управлять всем, что связано с вашими приложениями Майкрософт.


## Один идентификатор приложения для всех платформ
В первоначальной версии службы Azure Active Directory можно было зарегистрировать несколько различных приложений для одного проекта. Вам приходилось использовать отдельные регистрации для собственных клиентов и веб-приложений:

![Старый пользовательский интерфейс регистрации приложения](../media/active-directory-v2-flows/old_app_registration.PNG)

Например, если вы создали и веб-сайт, и приложение для iOS, вам было необходимо зарегистрировать их отдельно с использованием двух различных идентификаторов приложений. Если у вас был веб-сайт и серверный веб-API, вы могли зарегистрировать их как отдельные приложения в Azure AD. Если у вас было приложение для iOS и Android, вы также могли зарегистрировать два различных приложения.

<!-- You may have even registered different apps for each of your build environments - one for dev, one for test, and one for production. -->

Теперь же вам необходима всего лишь одна регистрация и один идентификатор приложения для каждого проекта. Можно добавить несколько "платформ" для каждого проекта и предоставить соответствующие данные для каждой добавляемой платформы. Конечно, вы можете создавать столько приложений, сколько хотите, в зависимости от требований, но в большинстве случаев потребуется только один идентификатор приложения.

<!-- You can also label a particular platform as "production-ready" when it is ready to be published to the outside world, and use that same Application Id safely in your development environments. -->

Мы стремимся к тому, чтобы упростить управление приложениями и их разработку, а также создать консолидированное представление проекта, с которым вы можете работать.


## Области, а не ресурсы
В первоначальной версии службы Azure AD приложение могло вести себя как **ресурс** или получатель маркеров. Ресурс можно определить несколько **областей** или **разрешений oAuth2**, которые он распознает, позволяя клиентским приложениям запрашивать маркеры к этому ресурсу для определенного набора областей. Рассмотрим API Azure AD Graph в качестве примера ресурса.

- Идентификатор ресурса или `AppID URI`: `https://graph.windows.net/`
- Области или `OAuth2Permissions`: `Directory.Read`, `Directory.Write` и т. п.

Все это справедливо и для конечной точки версии 2.0. Приложение по-прежнему может вести себя как ресурс, определять области и идентифицироваться по URI. Клиентские приложения по-прежнему могут запрашивать доступ к этим областям. Однако способ запроса клиентами этих разрешений изменился. В прошлом запрос авторизации OAuth 2.0 в Azure AD выглядел так:

```
GET https://login.microsoftonline.com/common/oauth2/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e
&resource=https%3A%2F%2Fgraph.windows.net%2F
...
```

где параметр **resource** указывает, к какому ресурсу клиентское приложение запрашивает авторизацию. Служба Azure AD определяла разрешения, необходимые приложению, на основе статической конфигурации на портале Azure и выдавала маркеры соответствующим образом. Теперь же запрос авторизации OAuth 2.0 выглядит так:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e
&scope=https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20https%3A%2F%2Fgraph.windows.net%2Fdirectory.write
...
```

где параметр **scope** указывает, для каких ресурсов и разрешений приложение запрашивает авторизацию. Нужный ресурс по-прежнему присутствует в запросе — просто он состоит из каждого значения параметра области. Используя параметр области таким образом, конечная точка версии 2.0 обладает улучшенной совместимостью со спецификацией OAuth 2.0 и улучшенной поддержкой отраслевых стандартов. Это также позволяет приложениям реализовать [добавочное согласие](#incremental-and-dynamic-consent), описанное в следующем разделе.

## Добавочное и динамическое согласие
Приложения, зарегистрированные в общедоступной службе Azure AD, должны были указывать необходимые разрешения OAuth 2.0 на портале Azure во время создания приложения:

![Пользовательский интерфейс регистрации разрешений](../media/active-directory-v2-flows/app_reg_permissions.PNG)

Разрешения, необходимые приложению, настраивались **статически**. Хотя это позволяло хранить конфигурацию приложения на портале и упрощало код, для разработчиков появлялись определенные сложности.

- Приложению должны были быть известны все разрешения, которые могли понадобиться во время создания приложения. Добавить разрешения в дальнейшем было не так просто.
- Приложению заранее должны были быть известны все ресурсы, к которым оно будет обращаться. Было трудно создавать приложения, использующие произвольное количество ресурсов.
- Приложение должно было запрашивать все разрешения, которые могли потребоваться при первом входе пользователя в систему. В некоторых случаях это приводило к получению большого списка разрешений, из-за чего пользователи не разрешали приложению доступ при первоначальном входе.

В конечной точке версии 2.0 можно указывать разрешения, необходимые приложению, **динамически** во время обычного использования приложения. Для этого можно указать области, требуемые приложению в любой момент времени, включив их в параметр `scope` авторизации запроса:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e
&scope=https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20https%3A%2F%2Fgraph.windows.net%2Fdirectory.write
...
```

Пример выше запрашивает разрешение на чтение данных каталога пользователя Azure AD, а также на запись данных в каталог. Если пользователи предоставили эти разрешения в прошлом для этого конкретного приложения, они просто введут свои учетные данные и войдут в приложение. Если пользователи не предоставили какие-либо из этих разрешений, конечная точка версии 2.0 запросит у пользователя эти разрешения. Подробнее см. в разделе о [разрешениях, согласии и областях](active-directory-v2-scopes.md).

Возможность приложения динамически запрашивать разрешения с помощью параметра `scope` дает вам полный контроль над взаимодействием с пользователями. При желании можно запросить все разрешения в первоначальном запросе авторизации. Или же, если приложению требуется множество разрешений, вы можете запрашивать их у пользователей постепенно, когда они попытаются применять некоторые функции приложения с течением времени.

## Хорошо известные области

#### Автономный доступ
Конечной точке версии 2.0 могут потребоваться новые хорошо известные разрешения для приложений — область `offline_access`. Всем приложения требуется запросить это разрешение, если им необходимо доступ к ресурсам от имени пользователя в течение длительного времени, даже если пользователь не работает с приложением активно. Область `offline_access` отображается в диалоговых окнах запроса согласия как разрешение "Доступ к данным в автономном режиме", которое пользователь должен принять. Запрос разрешения `offline_access` позволит веб-приложению получать маркеры обновления OAuth 2.0 от конечной точки версии 2.0. У маркеров обновления длительный срок действия, и их можно заменить на новые маркеры доступа OAuth 2.0 на значительные периоды доступа.

Если приложение не запрашивает область `offline_access`, оно не получит маркеры обновления. Это значит, что при использовании кода авторизации в [потоке кода авторизации OAuth 2.0](active-directory-v2-protocols.md#oauth2-authorization-code-flow) вы получите только маркер доступа из конечной точки `/token`. Маркер доступа будет действительным короткое время (обычно один час), но в конечном итоге срок его действия истечет. В этот момент приложение будет необходимо перенаправить пользователя обратно в конечную точку `/authorize`, чтобы получить новый код авторизации. При этом пользователю может потребоваться повторно ввести учетные данные или повторно предоставить разрешения в зависимости от типа приложения.

Подробнее о протоколе OAuth 2.0, маркерах обновления и доступа см. в [справочнике по протоколу версии 2.0](active-directory-v2-protocols.md).

#### OpenID, профиль и электронная почта

В исходной службе Azure Active Directory самый простой поток входа OpenID Connect содержит массу информации о пользователе в результирующем маркере идентификации (id\_token). Утверждения в id\_token могут содержать имя пользователя, предпочтительное имя пользователя, адрес электронной почты, идентификатор объекта и другие сведения.

Сейчас мы ограничиваем сведения, доступные вашему приложению с помощью области `openid`. Теперь область "openid" позволит пользователю только войти в приложение и получить соответствующий идентификатор. Чтобы получить личные сведения о пользователе в приложении, приложение должно запросить дополнительные разрешения у пользователя. Мы представляем две новые области — `email` и `profile`, которые позволяют сделать это.

Область `email` довольно проста. С ее помощью приложение получает доступ к основному адресу электронной почты пользователя через утверждение `email` в маркере id\_token. С помощью области `profile` приложение может получить другие основные сведения о пользователе: имя, предпочтительное имя пользователя, идентификатор объекта и т. д.

Это позволяет создать код приложения с минимальным разглашением сведений. Вы можете запросить у пользователя только те сведения, которые необходимы приложению для выполнения задания. Дополнительные сведения об этих областях см. в [справочной статье об области версии 2.0](active-directory-v2-scopes.md).

## Утверждения маркера

Утверждения в маркерах, выданных конечной точкой версии 2.0, не совпадают с маркерами, выданными конечными точками общедоступной службы Azure AD — приложения, переходящие на новую службу, не должны предполагать, что конкретное утверждение будет существовать в маркерах удостоверения или доступа. Маркеры, выданные конечной точкой версии 2.0, соответствуют спецификациям OAuth 2.0 и OpenID Connect, но могут использовать отличную от общедоступной службы Azure AD семантику.

Подробнее об утверждениях, выдаваемых в маркерах версии 2.0, см. в [справочнике по маркерам версии 2.0](active-directory-v2-tokens.md).

## Ограничения
Существует несколько ограничений, которые следует учитывать при использовании точки версии 2.0. Изучите [документ об ограничениях версии 2.0](active-directory-v2-limitations.md), чтобы узнать, применимы ли эти ограничения к вашему сценарию.

<!---HONumber=AcomDC_0921_2016-->