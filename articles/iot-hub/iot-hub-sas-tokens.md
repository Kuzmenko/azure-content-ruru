<properties
 pageTitle="Создание маркеров безопасности центра IoT | Microsoft Azure"
 description="Описание различных типов маркеров безопасности (таких, как SAS и X.509), используемых центром IoT, и способы их создания."
 services="iot-hub"
 documentationCenter=".net"
 authors="fsautomata"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="tbd"
 ms.date="06/07/2016"
 ms.author="elioda"/>

# Использование маркеров безопасности центра IoT и сертификатов X.509

Центр IoT использует маркеры безопасности для проверки подлинности устройств и служб, чтобы избежать отправки ключей по сети. Кроме того, маркеры безопасности ограничены по времени и области действия. [Пакеты SDK Azure для центра IoT][lnk-apis-sdks] автоматически создают маркеры без специальной конфигурации. Однако в некоторых случаях требуется, чтобы пользователь напрямую создал и использовал маркеры. В их число входит непосредственное использование поверхностей MQTT, AMQP или HTTP или реализация схемы службы маркеров, как описано в [руководстве по центру IoT][lnk-guidance-security].

Центр IoT также позволяет устройствам использовать сертификаты X.509 для проверки подлинности с помощью центра IoT. Центр IoT поддерживает проверку подлинности на основе сертификатов X.509 для устройств через протоколы AMQP, AMQP, WebSockets и HTTP-протоколы.

Содержание статьи

* Формат маркеров безопасности и способы их создания.
* Основные варианты использования маркеров безопасности для проверки подлинности устройств и серверных служб.
* Поддерживаемые сертификаты X.509 для проверки подлинности устройств.
* Процесс регистрации клиентского сертификата X.509, привязанного к конкретному устройству.
* Поток среды выполнения между устройством и центром IoT с использованием клиентского сертификата X.509 для проверки подлинности.


## Структура маркера безопасности
Маркеры безопасности используются для предоставления устройствам и службам ограниченного по времени доступа к определенным функциям в центре IoT. Чтобы гарантировать подключение только авторизованных устройств и служб, маркеры безопасности должны быть подписаны с помощью ключа политики общего доступа или симметричного ключа, сохраненного с удостоверением устройства в реестре удостоверений.

Маркер, подписанный с помощью ключа политики общего доступа, предоставляет доступа ко всем функциям, связанным с разрешениями политики общего доступа. См. [раздел о безопасности руководства для разработчиков центра IoT][lnk-devguide-security]. С другой стороны, маркер, подписанный с помощью симметричного ключа удостоверения устройства, предоставляет только разрешение **DeviceConnect** для связанного удостоверения устройства.

Маркер безопасности имеет следующий формат:

    SharedAccessSignature sig={signature-string}&se={expiry}&skn={policyName}&sr={URL-encoded-resourceURI}

Это ожидаемые значения:

| Значение | Описание |
| ----- | ----------- |
| {signature} | Строка подписи HMAC-SHA256 формата `{URL-encoded-resourceURI} + "\n" + expiry`. **Важно!** Ключ шифруется в кодировке base64 и используется для вычислений HMAC-SHA256. |
| {resourceURI} | Начинающийся с имени узла центра IoT (без протокола) префикс URI (по сегменту) для конечных точек, доступ к которым можно получить с помощью этого маркера. Например, `myHub.azure-devices.net/devices/device1` |
| {expiry} | Строки в формате UTF8, отображающие количество секунд с начала эры 00:00:00 (в формате UTC) 1 января 1970 г. |
| {URL-encoded-resourceURI} | Строчное URL-кодирование строчного URL ресурса |
| {policyName} | Имя политики общего доступа, к которой относится этот маркер. Отсутствует, если маркеры относятся к учетным данным реестра устройства. |

**Обратите внимание**, что префикс универсального кода ресурса (URI) вычисляется по сегменту, а не по символу. Например, `/a/b` — это префикс для `/a/b/c`, а не для `/a/bc`.

Это функция Node, которая вычисляет маркер на основе входных данных `resourceUri, signingKey, policyName, expiresInMins`. В следующих разделах будет показано, как инициализировать различные входные данные для различных сценариев использования маркеров.

    var crypto = require('crypto');

    var generateSasToken = function(resourceUri, signingKey, policyName, expiresInMins) {
        resourceUri = encodeURIComponent(resourceUri.toLowerCase()).toLowerCase();

        // Set expiration in seconds
        var expires = (Date.now() / 1000) + expiresInMins * 60;
        expires = Math.ceil(expires);
        var toSign = resourceUri + '\n' + expires;

        // using crypto
        var decodedPassword = new Buffer(signingKey, 'base64').toString('binary');
        const hmac = crypto.createHmac('sha256', decodedPassword);
        hmac.update(toSign);
        var base64signature = hmac.digest('base64');
        var base64UriEncoded = encodeURIComponent(base64signature);

        // construct autorization string
        var token = "SharedAccessSignature sr=" + resourceUri + "&sig="
        + base64UriEncoded + "&se=" + expires;
        if (policyName) token += "&skn="+policyName;
        // console.log("signature:" + token);
        return token;
    };
 
 Для сравнения ниже приведен аналогичный код Python:
 
    from base64 import b64encode, b64decode
    from hashlib import sha256
    from hmac import HMAC
    from urllib import urlencode
    
    def generate_sas_token(uri, key, policy_name='device', expiry=3600):
        ttl = time() + expiry
        sign_key = "%s\n%d" % (uri, int(ttl))
        signature = b64encode(HMAC(b64decode(key), sign_key, sha256).digest())
     
        return 'SharedAccessSignature ' + urlencode({
            'sr' :  uri,
            'sig': signature,
            'se' : str(int(ttl)),
            'skn': policy_name
        })

> [AZURE.NOTE] Поскольку срок действия маркера проверяется на компьютерах центра IoT, важно обеспечить минимальное смещение на часах компьютера, где создается маркер.

## Использование маркеров SAS в качестве устройства

Существует два способа получения разрешений **DeviceConnect** для центра IoT с маркерами безопасности: с помощью ключа удостоверения устройства или ключа политики общего доступа.

Кроме того, следует отметить, что все функциональные возможности, доступные с устройств, намеренно предоставляются в конечных точках с префиксом `/devices/{deviceId}`.

> [AZURE.IMPORTANT] Единственный способ проверки подлинности конкретного устройства в центре IoT предполагает использование симметричного ключа удостоверения устройства. В случаях, когда для доступа к функциям устройства применяется политика общего доступа, решение должно считать компонент, который выдает маркер безопасности, доверенным компонентом.

Далее указаны конечные точки, доступные с устройства (вне зависимости от протокола).

| Конечная точка | Функции |
| ----- | ----------- |
| .`{iot hub host name}/devices/{deviceId}/messages/events` | Отправка сообщений с устройства в облако. |
| .`{iot hub host name}/devices/{deviceId}/devicebound` | Получение сообщений из облака на устройство. |

### Использование симметричного ключа в реестре удостоверений

Если для создания маркера используется симметричный ключ удостоверения устройства, то элемент policyName (`skn`) пропускается.

Например, маркер, созданный для доступа ко всем функциям устройства, должен иметь следующие параметры:

* универсальный код ресурса (URI): `{IoT hub name}.azure-devices.net/devices/{device id}`;
* ключ подписывания: любой симметричный ключ для удостоверения `{device id}`;
* имя политики не требуется;
* время окончания срока действия.

Далее приведен пример использования функции Node:

    var endpoint ="myhub.azure-devices.net/devices/device1";
    var deviceKey ="...";

    var token = generateSasToken(endpoint, deviceKey, null, 60);

Результат, предоставляющий доступ ко всем возможностям устройства device1, будет иметь следующий вид:

    SharedAccessSignature sr=myhub.azure-devices.net%2fdevices%2fdevice1&sig=13y8ejUk2z7PLmvtwR5RqlGBOVwiq7rQR3WZ5xZX3N4%3D&se=1456971697

> [AZURE.NOTE] Можно создать маркер безопасности с помощью инструмента .NET [Обозреватель устройств][lnk-device-explorer].

### Использование политики общего доступа

При создании маркера из политики общего доступа в поле имени политики `skn` должно быть указано имя используемой политики. Также требуется, чтобы эта политика предоставляла разрешение **DeviceConnect**.

Существует два основных сценария использования политик общего доступа для доступа к возможностям устройств:

* [облачные шлюзы протоколов][lnk-azure-protocol-gateway];
* [службы маркеров][lnk-devguide-security], используемые для реализации настраиваемых схем аутентификации.

Так как политика общего доступа может предоставлять доступ для подключения в качестве любого устройства, при создании маркеров безопасности важно использовать правильный URI ресурса. Этот момент имеет особое значение для служб маркеров, которые должны определять область действия маркера для конкретного устройства с помощью URI ресурса. Он менее критичен для шлюзов протоколов, так как они уже обрабатывают трафик для всех устройств.

Например, служба маркеров, использующая предварительно созданную политику общего доступа с именем **device**, создаст маркер со следующими параметрами:

* универсальный код ресурса (URI): `{IoT hub name}.azure-devices.net/devices/{device id}`;
* ключ подписывания: один из ключей политики `device`;
* имя политики: `device`;
* время окончания срока действия.

Далее приведен пример использования функции Node:

    var endpoint ="myhub.azure-devices.net/devices/device1";
    var policyName = 'device';
    var policyKey = '...';

    var token = generateSasToken(endpoint, policyKey, policyName, 60);

Результат, предоставляющий доступ ко всем возможностям устройства device1, будет иметь следующий вид:

    SharedAccessSignature sr=myhub.azure-devices.net%2fdevices%2fdevice1&sig=13y8ejUk2z7PLmvtwR5RqlGBOVwiq7rQR3WZ5xZX3N4%3D&se=1456971697&skn=device

Шлюз протокола может использовать этот же маркер для всех устройств, задав `myhub.azure-devices.net/devices` в качестве универсального кода ресурса (URI).

## Использование маркеров безопасности из компонентов службы

Компоненты службы могут создавать маркеры безопасности только с помощью политик общего доступа, предоставляющих соответствующие разрешения, как описано в [разделе "Безопасность" руководства разработчика по центру Azure IoT][lnk-devguide-security].

Ниже приведены функции службы, предоставляемые в конечных точках.

| Конечная точка | Функции |
| ----- | ----------- |
| .`{iot hub host name}/devices` | Создание, обновление, извлечение и удаление удостоверений устройств. |
| `{iot hub host name}/messages/events` | Получение сообщений с устройства в облако. |
| .`{iot hub host name}/servicebound/feedback` | Получение ответа на сообщения, отправляемые из облака на устройство. |
| `{iot hub host name}/devicebound` | Отправка сообщений из облака на устройство. |

Например, служба, использующая предварительно созданную политику общего доступа с именем **registryRead**, создаст маркер со следующими параметрами:

* универсальный код ресурса (URI): `{IoT hub name}.azure-devices.net/devices`;
* ключ подписывания: один из ключей политики `registryRead`;
* имя политики: `registryRead`;
* время окончания срока действия.

    var endpoint ="myhub.azure-devices.net/devices"; var policyName = 'device'; var policyKey = '...';

    var token = generateSasToken(endpoint, policyKey, policyName, 60);

Результат, предоставляющий доступ для чтения всех идентификаторов устройств, будет иметь следующий вид:

    SharedAccessSignature sr=myhub.azure-devices.net%2fdevices&sig=JdyscqTpXdEJs49elIUCcohw2DlFDR3zfH5KqGJo4r4%3D&se=1456973447&skn=registryRead

## Поддерживаемые сертификаты X.509

Вы можете использовать любой сертификат X.509 для проверки подлинности устройства с помощью центра IoT. А именно:

-   **Существующий сертификат X.509**. Возможно, устройство уже имеет связанный сертификат X.509. Устройство может использовать этот сертификат для проверки подлинности с помощью центра IoT.

-   **Самостоятельно сформированный и самозаверяющий сертификат X-509**. Производитель устройства или внутренний специалист по развертыванию может создать эти сертификаты и сохранить соответствующий закрытый ключ (и сертификат) на устройстве. Для этого вы можете использовать такие инструменты, как [OpenSSL] и служебная программа [Windows SelfSignedCertificate].

-   **Сертификат X.509, подписанный центром сертификации**. Вы также можете использовать сертификат X.509, созданный и подписанный центром сертификации (ЦС), для идентификации устройства и проверки подлинности устройства с помощью центра IoT.

Для аутентификации устройство может использовать только один из вариантов: либо сертификат X.509, либо маркер безопасности.

## Регистрация сертификата X.509 клиента для устройства

[Пакет SDK службы Azure IoT для C#][lnk-service-sdk] \(версия 1.0.8+) поддерживает регистрацию устройства, которое использует клиентский сертификат X.509 для аутентификации. Другие интерфейсы API (например, импорт и экспорт устройств) также поддерживают клиентские сертификаты X.509.

### Поддержка C#

Класс **RegistryManager** предоставляет программный способ регистрации устройства. В частности, методы **AddDeviceAsync** и **UpdateDeviceAsync** позволяют пользователю регистрировать и обновлять устройства в реестре удостоверений устройств центра IoT. Эти два метода используют экземпляр **устройства** в качестве входных данных. Класс **Устройство** включает свойство **Проверка подлинности**, которое позволяет пользователю указывать основной и дополнительный отпечатки сертификата X.509. Отпечаток представляет хэш SHA-1 сертификата X.509 (сохраненного с помощью двоичного кодирования DER). Пользователи могут указать основной или вторичный отпечаток или оба отпечатка сразу. Основной и вторичный отпечатки поддерживаются для обработки сценариев переключения сертификатов.

> [AZURE.NOTE] Центр IoT не требует и не хранит весь клиентский сертификат X.509, а только его отпечаток.

Ниже приведен пример фрагмента кода C# для регистрации устройства с использованием клиентского сертификата X.509.

```
var device = new Device(deviceId)
{
  Authentication = new AuthenticationMechanism()
  {
    X509Thumbprint = new X509Thumbprint()
    {
      PrimaryThumbprint = "921BC9694ADEB8929D4F7FE4B9A3A6DE58B0790B"
    }
  }
};
RegistryManager registryManager = RegistryManager.CreateFromConnectionString(deviceGatewayConnectionString);
await registryManager.AddDeviceAsync(device);
```

## Использование клиентского сертификата X.509 во время выполнения операций среды выполнения

[Пакет SDK для устройств Azure IoT для .NET][lnk-client-sdk] \(версия 1.0.11+) поддерживает использование клиентских сертификатов X.509.

### Поддержка C#

Класс **DeviceAuthenticationWithX509Certificate** поддерживает создание экземпляров **DeviceClient** с помощью клиентского сертификата X.509.

Ниже приведен образец фрагмента кода:

```
var authMethod = new DeviceAuthenticationWithX509Certificate("<device id>", x509Certificate);

var deviceClient = DeviceClient.Create("<IotHub DNS HostName>", authMethod);
```

[lnk-apis-sdks]: https://github.com/Azure/azure-iot-sdks/blob/master/readme.md
[lnk-guidance-security]: iot-hub-guidance.md#customauth
[lnk-devguide-security]: iot-hub-devguide.md#security
[lnk-azure-protocol-gateway]: iot-hub-protocol-gateway.md
[lnk-device-explorer]: https://github.com/Azure/azure-iot-sdks/blob/master/tools/DeviceExplorer/doc/how_to_use_device_explorer.md

[OpenSSL]: https://www.openssl.org/
[Windows SelfSignedCertificate]: https://technet.microsoft.com/library/hh848633
[lnk-service-sdk]: https://github.com/Azure/azure-iot-sdks/tree/master/csharp/service
[lnk-client-sdk]: https://github.com/Azure/azure-iot-sdks/tree/master/csharp/device

<!---HONumber=AcomDC_0914_2016-->