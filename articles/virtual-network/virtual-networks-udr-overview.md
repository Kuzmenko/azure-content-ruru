<properties 
   pageTitle="Что такое определяемые пользователем маршруты и IP-пересылка?"
   description="Узнайте, как использовать определяемые пользователем маршруты и IP-пересылку для перенаправления трафика на сетевые виртуальные устройства в Azure."
   services="virtual-network"
   documentationCenter="na"
   authors="jimdial"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="get-started-article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="03/15/2016"
   ms.author="jdial" />

# Что такое определяемые пользователем маршруты и IP-пересылка?
При добавлении виртуальных машин в виртуальной сети (VNet) в Azure можно заметить, что они могут автоматически связываться между собой по сети. Несмотря на то что виртуальные машины находятся в разных подсетях, не нужно указывать шлюз. Это также относится к общедоступному подключению виртуальных машин через Интернет и даже по локальной сети при наличии гибридного подключения Azure к вашему центру обработки данных.

Этот обмен данными возможен, так как Azure использует ряд системных маршрутов для определения передачи IP-трафика. Системные маршруты управляют обменом данных в следующих случаях:

- в одной и той же подсети;
- из одной подсети в другую в виртуальной сети;
- из виртуальных машин в Интернет;
- из одной виртуальной сети в другую через VPN-шлюз;
- из виртуальной сети в локальную сеть через VPN-шлюз.

На рисунке ниже показана простая система, состоящая из виртуальной сети, двух подсетей и нескольких виртуальных машин, а также системных маршрутов для передачи IP-трафика.

![Системные маршруты в Azure](./media/virtual-networks-udr-overview/Figure1.png)

Несмотря на то что при использовании системных маршрутов трафик для развертывания передается автоматически, существуют случаи, когда требуется управлять маршрутизацией пакетов через виртуальное устройство. Для этого нужно создать определяемые пользователем маршруты, которые указывают, чтобы при следующем прыжке пакеты, передаваемые в конкретную подсеть, передавались в виртуальное устройство, и включить IP-пересылку для виртуальной машины, работающей в качестве виртуального устройства.

На следующем рисунке показан пример определяемых пользователем маршрутов и IP-пересылки для принудительной отправки пакетов, передаваемых из одной подсети во вторую подсеть, в виртуальным модуль в третьей подсети.

![Системные маршруты в Azure](./media/virtual-networks-udr-overview/Figure2.png)

>[AZURE.IMPORTANT] Определяемые пользователем маршруты применяются только к трафику, выходящему из подсети. Например, нельзя создать маршруты, чтобы указать, как трафик поступает в подсеть из Интернета. Кроме того, устройство, на которое вы пересылаете трафик, не может находиться в подсети, из которой происходит трафик. Всегда создавайте отдельную подсеть для устройств.

## Маршрутизация ресурсов
Пакеты маршрутизируются по сети TCP/IP на основе таблицы маршрутов, определенной на каждом узле физической сети. Таблица маршрутов — набор отдельных маршрутов, с помощью которой определяется, куда пересылать пакеты по IP-адресу назначения. Маршрут состоит из следующих частей:

|Свойство|Описание|Ограничения|Рекомендации|
|---|---|---|---|
| Префикс адреса | Маршрутизация CIDR назначения, к которой относится маршрут, например 10.1.0.0/16.|Должен быть допустимым диапазоном CIDR, представляющим адреса в Интернете, виртуальной сети Azure или локальном центре данных.|Проследите, чтобы в параметре **Префикс адреса** не содержался адрес для параметра **Адрес следующего прыжка**, иначе пакеты войдут в цикл: они будут переходить от источника к следующему прыжку, не попадая в место назначения. |
| Тип следующего прыжка | Тип прыжка Azure, куда должны отправляться пакеты. | Необходимо установить одно из следующих значений. <br/> **Виртуальная сеть**. Представляет локальную виртуальную сеть. Например, при наличии двух подсетей (10.1.0.0/16 и 10.2.0.0/16) в одной и той же виртуальной сети у следующего прыжка маршрута для каждой подсети в таблице маршрутов будет значение *Виртуальная сеть*. <br/>**Шлюз виртуальной сети**. Представляет шлюз VPN типа «сеть-сеть» Azure. <br/> **Интернет**. Представляет используемый по умолчанию шлюз Интернета, предоставленный инфраструктурой Azure. <br/> **Виртуальное устройство**. Представляет виртуальное устройство, добавленное в виртуальную сеть Azure. <br/>**None** (Нет). Представляет «черную дыру». Пакеты, пересылаемые в «черную дыру», вообще никуда не пересылаются.| Вы можете использовать тип **None** (Нет), чтобы остановить поток пакетов в заданное место назначения. | 
| Адрес следующего прыжка | Параметр адреса следующего прыжка содержит IP-адрес, на который должны быть переадресованы пакеты. Значения следующего прыжка допускаются только в маршрутах, где следующий тип перехода — *Виртуальное устройство*.| Должно быть доступным IP-адресом. | Если IP-адрес представляет виртуальную машину, не забудьте включить [IP-пересылку](#IP-forwarding) в Azure для виртуальной машины. |

В Azure PowerShell некоторые значения NextHopType называются по-другому:
- "Виртуальная сеть" — VnetLocal,
- "Шлюз виртуальной сети" — VirtualNetworkGateway,
- "Виртуальное устройство" — VirtualAppliance,
- "Интернет" — Internet,
- None (Нет) — None.

### Системные маршруты
Каждая подсеть, созданная в виртуальной сети, автоматически связывается с таблицей маршрутов, которая содержит следующие правила для системных маршрутов:

- **Локальное правило виртуальной сети**: это правило создается автоматически для каждой подсети в виртуальной сети. Оно указывает, что существует прямая связь между виртуальными машинами в виртуальной сети, без промежуточного следующего прыжка.
- **Правило локальной среды**: это правило применяется для всего трафика, предназначенного для локального диапазона адресов; оно использует VPN-шлюз в качестве назначения следующего прыжка.
- **Правило Интернета**: это правило обрабатывает весь трафик, направляемый в общедоступный Интернет; оно использует шлюз Интернета инфраструктуры в качестве следующего прыжка для всего трафика, предназначенного для Интернета.

### Определяемые пользователем маршруты
Для большинства сред достаточно только системных маршрутов, уже определенных в среде Azure. Тем не менее, в конкретных случаях может потребоваться создать таблицу маршрутов и добавить один или несколько маршрутов, например:

- Принудительное туннелирование для доступа к Интернету через вашу локальную сеть.
- Использование виртуальных устройств в среде Azure.

В приведенном выше сценарии необходимо будет создать таблицу маршрутов и добавить в нее определяемые пользователем маршруты. Можно использовать несколько таблиц маршрутов, и одна таблица маршрутов может быть связана с одной или несколькими подсетями. А каждая подсеть может быть связана только с одной таблицей маршрутов. Все виртуальные машины и облачные службы в подсети используют таблицу маршрутов, связанную с этой подсетью.

Пока c подсетью не связана таблица маршрутов, она использует системные маршруты. После того, как эта связь установлена, маршрутизация выполняется по совпадению наиболее длинного префикса (LPM) среди определяемых пользователем маршрутов и системных маршрутов. При наличии более одного маршрута с одинаковыми совпадающими значениями LPM маршрут выбирается по источнику в следующем порядке:

1. определяемый пользователем маршрут;
1. маршрут BGP (если используется ExpressRoute);
1. Системные маршруты

Информацию о создании определяемых пользователем маршрутов см. в статье [Как создать маршруты и включить IP-пересылку в Azure](virtual-network-create-udr-arm-template.md).

>[AZURE.IMPORTANT] Определяемые пользователем маршруты применяются только для виртуальных машин и облачных служб Azure. Например, если нужно добавить виртуальное устройство брандмауэра между локальной сетью и Azure, необходимо создать пользовательский маршрут для ваших таблиц маршрутов Azure, который будет перенаправлять на виртуальное устройство весь трафик, поступающий в локальное адресное пространство. Также можно добавить пользовательский маршрут для подсети GatewaySubnet, чтобы весь трафик через виртуальное устройство перенаправлялся из локального расположения в Azure. Такая возможность появился только недавно.

### Маршруты BGP
При наличии подключения ExpressRoute между локальной сетью и Azure можно включить BGP, чтобы распространить маршруты из локальной сети в Azure. Эти маршруты BGP используются так же, как и системные маршруты и определенные пользователем маршруты в каждой подсети Azure. Дополнительную информацию см. в разделе [Введение в ExpressRoute](../expressroute/expressroute-introduction.md).

>[AZURE.IMPORTANT] Вы можете настроить среду Azure для использования принудительного туннелирования через локальную сеть, создав определяемый пользователем маршрут для подсети 0.0.0.0/0, использующий в качестве следующего прыжка шлюз VPN. Тем не менее, это работает только при использовании шлюза VPN, не ExpressRoute. Для ExpressRoute принудительное туннелирование настраивается с помощью BGP.

## IP-пересылка
Как описано выше, одной из основных причин для создания определяемого пользователем маршрута является переадресация трафика в виртуальное устройство. Виртуальное устройство — это просто виртуальная машина, которая запускает приложение, используемое для обработки сетевого трафика определенным образом, например, как брандмауэр или устройство NAT.

Эта виртуальная машина виртуального устройства должна иметь возможность получать входящий трафик, предназначенный не ей. Чтобы разрешить виртуальной машине получать трафик, направленный по другим назначениям, для нее необходимо включить IP-пересылку. Это нужно сделать в среде Azure, а не в операционной системе на виртуальной машине.

## Дальнейшие действия

- Узнайте, как [создать маршруты в модели развертывания диспетчера ресурсов](virtual-network-create-udr-arm-template.md) и связать их с подсетями.
- Узнайте, как [создать маршруты в классической модели развертывания](virtual-network-create-udr-classic-ps.md) и связать их с подсетями.

<!---HONumber=AcomDC_0810_2016--->